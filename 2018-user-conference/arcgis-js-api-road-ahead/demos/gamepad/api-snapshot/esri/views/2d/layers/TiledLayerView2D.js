// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/extendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Error ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../engine/BitmapContainer ../engine/BitmapSource ../engine/BitmapTile ../engine/Canvas2DContainer ./LayerView2D ../tiling/TileInfoView ../tiling/TileQueue ../tiling/TileStrategy ../../layers/RefreshableLayerView".split(" "),function(y,z,l,m,e,n,f,p,q,g,r,t,u,v,w,x){var h=[0,0];return function(d){function c(){var a=
null!==d&&d.apply(this,arguments)||this;a._tileStrategy=null;a._tileInfoView=null;a._fetchQueue=null;a._tileRequests=new Map;a.container=new r;a.layer=null;return a}l(c,d);c.prototype.initialize=function(){var a=this.layer.tileInfo,a=a&&a.spatialReference,b;a||(b=new e("layerview:tiling-information-missing","The layer doesn't provide tiling information",{layer:this.layer}));a.equals(this.view.spatialReference)||(b=new e("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",
{layer:this.layer}));b&&this.addResolvingPromise(n.reject(b))};c.prototype.hitTest=function(a,b){return null};c.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")};c.prototype.attach=function(){var a=this;this._tileContainer=new p;this.container.addChild(this._tileContainer);this._tileInfoView=new u(this.layer.tileInfo,this.layer.fullExtent);this._fetchQueue=new v({tileInfoView:this._tileInfoView,
tileServers:this.layer.tileServers,concurrency:this.layer.url&&-1!==this.layer.url.indexOf("tiles.arcgis.com")?12:6,process:function(b,c){return a.fetchTile(b,c)}});this._tileStrategy=new w({cachePolicy:"keep",acquireTile:function(b){return a.acquireTile(b)},releaseTile:function(b){return a.releaseTile(b)},tileInfoView:this._tileInfoView})};c.prototype.detach=function(){this._tileStrategy.destroy();this._fetchQueue.clear();this.container.removeChild(this._tileContainer);this._fetchQueue=this._tileStrategy=
this._tileInfoView=this._tileContainer=null};c.prototype.moveStart=function(){this.requestUpdate()};c.prototype.viewChange=function(){this.requestUpdate()};c.prototype.moveEnd=function(){this.requestUpdate()};c.prototype.doRefresh=function(){var a=this;this.updateRequested||this.suspended||(this._fetchQueue.reset(),this._tileStrategy.tiles.forEach(function(b){return a._enqueueTileFetch(b)}),this.notifyChange("updating"))};c.prototype.isUpdating=function(){var a=!0;this._tileRequests.forEach(function(b){a=
a&&b.isFulfilled()});return!a};c.prototype.getTileBounds=function(a,b){return this._tileInfoView.getTileBounds(a,b)};c.prototype.getTileCoords=function(a,b){return this._tileInfoView.getTileCoords(a,b)};c.prototype.getTileResolution=function(a){return this._tileInfoView.getTileResolution(a)};c.prototype.acquireTile=function(a){var b=g.default.pool.acquire();b.key.set(a);a=this._tileInfoView.getTileCoords(h,b.key);b.x=a[0];b.y=a[1];b.resolution=this._tileInfoView.getTileResolution(b.key);a=this._tileInfoView.tileInfo.size;
b.width=a[0];b.height=a[1];this._enqueueTileFetch(b);this.requestUpdate();return b};c.prototype.releaseTile=function(a){var b=this,c=this._tileRequests.get(a);c&&!c.isFulfilled()&&c.cancel();this._tileRequests.delete(a);this._tileContainer.removeChild(a);a.once("detach",function(){g.default.pool.release(a);b.requestUpdate()});this.requestUpdate()};c.prototype.fetchTile=function(a,b){var c=this;if(b=this.layer.tilemapCache){var k=a.level,d=a.row,e=a.col;return b.fetchAvailabilityUpsample(k,d,e,a).then(function(){return c._fetchImage(a)}).catch(function(){a.level=
k;a.row=d;a.col=e;return c._fetchImage(a)})}return this._fetchImage(a)};c.prototype._enqueueTileFetch=function(a){var b=this;if(!this._fetchQueue.has(a.key)){var c=this._fetchQueue.push(a.key).then(function(c){a.source=c;a.once("attach",function(){return b.requestUpdate()});b._tileContainer.addChild(a);b.requestUpdate()});this._tileRequests.set(a,c)}};c.prototype._fetchImage=function(a){var b=this;return this.layer.fetchTile(a.level,a.row,a.col,{timestamp:this.refreshTimestamp}).then(function(c){c=
q.default.pool.acquire(c);d=b.getTileCoords(h,a);c.x=d[0];c.y=d[1];c.resolution=b.getTileResolution(a);return c;var d})};return c=m([f.subclass("esri.views.2d.layers.TiledLayerView2D")],c)}(f.declared(t,x))});