// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper dojo/has ../../../../../../core/Logger ../../../../../../core/libs/earcut/earcut ../../color ../../definitions ../../enums ../../number ../../TileClipper ../../WGLDisplayRecord ../Tesselator ./WGLMeshTemplate".split(" "),function(w,C,F,G,H,I,J,K,B,m,L,D,M,N){Object.defineProperty(C,"__esModule",{value:!0});var O=H.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLFillTemplate"),u=[],A=[];w=function(w){function l(b,a,d,e,
c,g,f,k){var h=w.call(this)||this;h.fillColor=e;h.tl=c;h.br=g;h.aux=f;h.isBFS=k;h.geometryType=B.WGLGeometryType.FILL;h.useLibtess=!1;e=G("esri-featurelayer-webgl");h.useLibtess="libtess"===((e||{}).tesselator||"libtess");h.useLibtess&&(h._tesselator=new M.default);h.vvFlags=a;h._materialStore=b;h.materialId=h._materialStore.createSpriteMaterial(d,h.geometryType,a);h._tileClipper=new L.TileClipper(0,0,0,1,8);h._tileClipper.setExtent(512);return h}F(l,w);l.fromSimpleFill=function(b,a,d,e,c,g){void 0===
g&&(g=!1);d=(d=d.color)&&J.premultiplyAlphaRGBA(d)||0;if(!e)return new l(b,a,null,d,0,0,0,g);var f=e.rect;c=f.x+1;var k=f.y+1,h=f.x+1+e.width,E=f.y+1+e.height,f=m.i1616to32(c,k),r=m.i1616to32(h,E);c=m.i8888to32(m.nextHighestPowerOfTwo(h-c),m.nextHighestPowerOfTwo(E-k),0,0);return new l(b,a,e,d,f,r,c,g)};l.fromPictureFill=function(b,a,d,e,c,g){void 0===g&&(g=!1);c=K.PICTURE_FILL_COLOR;var f=e.rect,k=f.x+1+e.width,h=f.y+1+e.height,f=m.i1616to32(f.x+1,f.y+1),k=m.i1616to32(k,h);d=m.i8888to32(m.nextHighestPowerOfTwo(d.width),
m.nextHighestPowerOfTwo(d.height),0,0);return new l(b,a,e,c,f,k,d,g)};l.prototype.writeMesh=function(b,a,d,e,c,g,f){u.length=0;if("esriGeometryPolygon"!==d)O.error("Unable to handle geometryType: "+d);else{var k=c.geometry,k=(c=this._isClippingRequired(k))?this._clip(k,!this.useLibtess):k.rings;return this.useLibtess?this._writeMeshLibtess(b,a,d,e,k,c,g,f):this._writeMeshEarcut(b,a,d,e,k,c,g,f)}};l.prototype._isClippingRequired=function(b){var a=0;for(b=b.rings;a<b.length;a++){var d=b[a],e=d.length;
if(!(3>e)){var c=d[0][0],g=d[0][1];if(-8>c||520<c||-8>g||520<g)return!0;for(var f=1;f<e;++f)if(c+=d[f][0],g+=d[f][1],-8>c||520<c||-8>g||520<g)return!0}}return!1};l.prototype._clip=function(b,a){var d;this._tileClipper.reset(3);for(var e=0,c=b.rings;e<c.length;e++){var g=c[e],f=g.length;if(!(3>f)){b=g[0][0];d=g[0][1];this._tileClipper.moveTo(b,d);for(var k=1;k<f;++k)b+=g[k][0],d+=g[k][1],this._tileClipper.lineTo(b,d);this._tileClipper.close()}}return this._tileClipper.result(a)};l.prototype._writeMeshLibtess=
function(b,a,d,e,c,g,f,k){if(c&&c.length){d=this._materialStore.get(this.materialId);f=[];var h=a.indexVector;a=a.get("geometry");var l=new D(e,this.geometryType,this.materialId),r=this._getOffset(a,d);l.vertexFrom=r;l.indexFrom=h.length;b.push(l);this._tesselator.beginPolygon(u,f);for(b=0;b<c.length;b++){var v=c[b];if(!(3>v.length)){this._tesselator.beginContour();var p=void 0,t=void 0;g?(p=v[0].x,t=v[0].y):(p=v[0][0],t=v[0][1]);var n=[p,t,0];this._tesselator.addVertex(n,n);for(n=1;n<v.length-1;n++){var q=
void 0,m=void 0;g?(p=v[n].x,t=v[n].y):(q=v[n][0],m=v[n][1],p+=q,t+=m);q=[p,t,0];this._tesselator.addVertex(q,q)}this._tesselator.endContour()}}this._tesselator.endPolygon();this._writeVerticesLibTess(l,a,e,u,d,k);this._writeIndicesLibTess(l,h,r,f)}};l.prototype._writeMeshEarcut=function(b,a,d,e,c,g,f,k){if(c&&c.length){d=this._materialStore.get(this.materialId);f=a.indexVector;a=a.get("geometry");var h=new D(e,this.geometryType,this.materialId),l=this._getOffset(a,d);h.vertexFrom=l;h.indexFrom=f.length;
b.push(h);for(var r=b=0,m=0;m<c.length;m++){var p=c[m],t=r,n=void 0,q=void 0;g?(n=p[0].x,q=p[0].y):(n=p[0][0],q=p[0][1]);u[r++]=n;u[r++]=q;for(var w=0,x=1;x<p.length;++x){var y=void 0,z=void 0;g?(y=n,z=q,n=p[x].x,q=p[x].y,y=n-y,z=q-z):(y=p[x][0],z=p[x][1],n+=y,q+=z);w-=y*(q+q+z);u[r++]=n;u[r++]=q}0<w?(0<t-b&&(this._write(h,f,a,l,e,u,A,b,t,d,k),b=t),A.length=0):0>w?0<t-b?A.push(.5*(t-b)):r=t:r=t}0<r-b&&this._write(h,f,a,l,e,u,A,b,r,d,k);u.length=A.length=0}};l.prototype._write=function(b,a,d,e,c,g,
f,k,h,l,m){e=I(g.slice(k,h),f,2);e.length&&(k=this._getOffset(d,l),this._writeVertices(b,d,c,g,f,l,m),this._writeIndices(b,a,k,e))};l.prototype._getOffset=function(b,a){a=a.materialKeyInfo.hasVV()?8:6;return b.length/a};l.prototype._writeVertices=function(b,a,d,e,c,g,f){for(c=0;c<e.length;c+=2){var k=m.i1616to32(e[c],e[c+1]);a.push(k);a.push(d);a.push(this.fillColor);a.push(this.tl);a.push(this.br);a.push(this.aux);this._writeVV(a,f,g);b.vertexCount++}};l.prototype._writeIndices=function(b,a,d,e){for(var c=
0;c<e.length;c+=3)a.push(d+e[c]),a.push(d+e[c+1]),a.push(d+e[c+2]),b.indexCount+=3};l.prototype._writeVerticesLibTess=function(b,a,d,e,c,g){for(var f=0;f<e.length;f+=2){var k=m.i1616to32(e[f],e[f+1]);a.push(k);a.push(d);a.push(this.fillColor);a.push(this.tl);a.push(this.br);a.push(this.aux);this._writeVV(a,g,c);b.vertexCount++}};l.prototype._writeIndicesLibTess=function(b,a,d,e){for(var c=0;c<e.length;c++)a.push(d+e[c]),b.indexCount++};l.prototype._writeVV=function(b,a,d){d.materialKeyInfo.hasVV()&&
(this.isBFS?(b.push(4294967295),b.push(4294967295)):(b.push(a[B.VVType.COLOR]),b.push(a[B.VVType.OPACITY])))};return l}(N.default);C.default=w});