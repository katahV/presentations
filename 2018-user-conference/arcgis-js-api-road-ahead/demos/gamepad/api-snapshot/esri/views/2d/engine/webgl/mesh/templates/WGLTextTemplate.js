// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Logger ../../../../../../core/screenUtils ../../color ../../definitions ../../enums ../../Geometry ../../number ../../TextShaping ../../WGLDisplayRecord ./WGLMeshTemplate".split(" "),function(w,x,C,D,p,z,E,u,t,r,A,B,F){Object.defineProperty(x,"__esModule",{value:!0});var G=D.getLogger("esri.views.2d.engine.webgl.WGLTextTemplate"),H=function(){function p(c,h,a,b,e,d,f,g,m){this.materialId=c;this.vertexOffsetUpperLeft=
h;this.vertexOffsetUpperRight=a;this.vertexOffsetLowerLeft=b;this.vertexOffsetLowerRight=e;this.texFontSizeUpperLeft=d;this.texFontSizeUpperRight=f;this.texFontSizeLowerLeft=g;this.texFontSizeLowerRight=m}p.from=function(c,h,a,b,e){var d=c.glyphMosaicItem,f=d.rect,g=d.metrics,m=Math.round(f.x/4),k=Math.round(f.y/4),d=m+Math.round(f.width/4),v=k+Math.round(f.height/4);c=new t.Point(c.x+0+g.left-4,c.y+-17-g.top-4);var f=new t.Point(c.x+f.width,c.y+f.height),g=new t.Point(c.x,f.y),q=new t.Point(f.x,
c.y);if(a){var n=Math.cos(a);a=Math.sin(a);c.rotate(n,a);f.rotate(n,a);g.rotate(n,a);q.rotate(n,a)}a=r.i1616to32(32*c.x,32*c.y);c=r.i1616to32(32*q.x,32*q.y);g=r.i1616to32(32*g.x,32*g.y);f=r.i1616to32(32*f.x,32*f.y);q=r.i8888to32(m,k,b,e);k=r.i8888to32(d,k,b,e);m=r.i8888to32(m,v,b,e);b=r.i8888to32(d,v,b,e);return new p(h,a,c,g,f,q,k,m,b)};return p}();w=function(t){function c(h,a,b,c,d,f,g,m,k,v,q,n,l,p,r,I,y){var e=t.call(this)||this;e.color=b;e.textSize=c;e.xOffset=d;e.yOffset=f;e.haloColor=g;e.haloSize=
m;e.shapingXOffset=k;e.shapingYOffset=v;e.textPropColor=q;e.textPropSize=n;e.textPropAngle=l;e.textPropHAnchor=p;e.textPropVAnchor=r;e.textPropHaloColor=I;e.textPropHaloSize=y;e.geometryType=u.WGLGeometryType.TEXT;e._materialStore=h;e.vvFlags=a;return e}C(c,t);c.fromText=function(h,a,b,e,d){var f=b.haloColor;d=(b.color&&z.premultiplyAlphaRGBA(b.color))|0;var g=b.font.size,m=b.xoffset/b.font.size*24,k=b.yoffset/b.font.size*24,f=(f&&z.premultiplyAlphaRGBA(f))|0,v=10*p.pt2px(p.toPt(b.haloSize||0)),q=
d||E.PICTURE_FILL_COLOR,n=p.pt2px(b.font.size),l=b.angle*Math.PI/180,r=p.pt2px(b.xoffset),t=p.pt2px(b.yoffset),u="left"===b.horizontalAlignment?0:"right"===b.horizontalAlignment?1:.5,y="top"===b.verticalAlignment?0:"bottom"===b.verticalAlignment?1:.5,w=f||4294967295,x=p.pt2px(p.toPt(b.haloSize||0));h=new c(h,a,d,g,r,t,f,v,m,k,q,n,l,u,y,w,x);h.computeGlyphs(e,b.text,!1,!1);return h};c.prototype.writeMesh=function(h,a,b,e,d,f,g){f=a.indexVector;var c=a.get("geometry");a=a.get("visibility");var k=this._getOffset(c);
switch(b){case "esriGeometryPoint":d=d.geometry;b=d.x;d=d.y;this._writeVertices(h,f,c,a,k,e,b,d,g);break;case "esriGeometryPolygon":if(d.centroid){d=d.centroid;b=d.x;d=d.y;this._writeVertices(h,f,c,a,k,e,b,d,g);break}default:G.error("Unable to handle geometryType: "+b)}};c.prototype.computeGlyphs=function(c,a,b,e){if(!a||!a.length)return this._computedGlyphs=[],null;a=(new A([c],240,24,0,[this.shapingXOffset,this.shapingYOffset],this.textPropHAnchor,this.textPropVAnchor,.5)).getShaping(a,b);b=Array(a.length);
for(var d=0;d<a.length;d++){var f=this.textPropAngle,g=this.textSize,h=this.haloSize,k=this._materialStore.createGlyphMaterial(a[d].glyphMosaicItem,u.WGLGeometryType.TEXT,this.vvFlags);b[d]=H.from(a[d],k,f,g,h)}this._computedGlyphs=b;return e?A.getBox(a,[c]):null};c.prototype._getOffset=function(c){return c.length/(this.vvFlags?9:5)};c.prototype._writeVertices=function(c,a,b,e,d,f,g,m,k){var h=this._computedGlyphs;g+=this.xOffset;var q=m+this.yOffset;m=r.i1616to32(2*g,2*q);g=r.i1616to32(2*g+1,2*q);
q=0;if(this.haloSize)for(var n=0;n<h.length;n++,q+=4){var l=h[n].materialId,p=this._materialStore.get(l),l=new B(f,this.geometryType,l);l.vertexFrom=d;l.indexFrom=a.length;this._writeVertex(l,b,e,f,g,this.haloColor,h[n],p,k);this._writeIndices(l,a,d+q);c.push(l)}for(n=0;n<h.length;n++,q+=4)l=h[n].materialId,p=this._materialStore.get(l),l=new B(f,this.geometryType,l),l.vertexFrom=d,l.indexFrom=a.length,this._writeVertex(l,b,e,f,m,this.color,h[n],p,k),this._writeIndices(l,a,d+q),c.push(l)};c.prototype._writeVertex=
function(c,a,b,e,d,f,g,m,k){a.push(d);a.push(e);a.push(f);a.push(g.vertexOffsetUpperLeft);a.push(g.texFontSizeUpperLeft);this._writeVV(a,k,m);a.push(d);a.push(e);a.push(f);a.push(g.vertexOffsetUpperRight);a.push(g.texFontSizeUpperRight);this._writeVV(a,k,m);a.push(d);a.push(e);a.push(f);a.push(g.vertexOffsetLowerLeft);a.push(g.texFontSizeLowerLeft);this._writeVV(a,k,m);a.push(d);a.push(e);a.push(f);a.push(g.vertexOffsetLowerRight);a.push(g.texFontSizeLowerRight);this._writeVV(a,k,m);b.push(4294967295);
c.vertexCount+=4};c.prototype._writeVV=function(c,a,b){b.materialKeyInfo.hasVV()&&(c.push(a[u.VVType.SIZE]),c.push(a[u.VVType.COLOR]),c.push(a[u.VVType.OPACITY]),c.push(a[u.VVType.ROTATION]))};c.prototype._writeIndices=function(c,a,b){a.push(b+0);a.push(b+1);a.push(b+2);a.push(b+1);a.push(b+3);a.push(b+2);c.indexCount+=6};return c}(F.default);x.default=w});