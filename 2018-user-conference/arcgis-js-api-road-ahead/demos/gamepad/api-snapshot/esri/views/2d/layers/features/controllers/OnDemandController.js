// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/declareExtendsHelper ../../../../../core/tsSupport/decorateHelper ../../../../../core/tsSupport/assignHelper dojo/has ../../../../../geometry ../../../../../core/Error ../../../../../core/Logger ../../../../../core/promiseUtils ../../../../../core/promiseUtils ../../../../../core/accessorSupport/decorators ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/graphics/data/FeatureSetReader ../../../../../layers/graphics/data/FeatureStore ../../../../../layers/support/FeatureProcessing ../../../../../tasks/operations/query ../../../../../tasks/support/QuantizationParameters ../../../../../tasks/support/Query ../../../ViewState ./BaseController ../../../tiling/TileInfoView ../../../tiling/TileQueue".split(" "),
function(h,t,z,l,u,p,A,B,C,D,v,m,w,E,F,G,x,H,q,I,r,J,K){Object.defineProperty(t,"__esModule",{value:!0});var L=C.getLogger("esri.views.2d.layers.features.controllers.OnDemandController");h=p("esri-featurelayer-webgl");p=p("esri-mobile");var y=h&&"object"===typeof h&&null!=h.maxDrillLevel?h.maxDrillLevel:p?1:4,M=h&&"object"===typeof h&&null!=h.maxRecordCountFactor?h.maxRecordCountFactor:p?1:3,N=h&&"object"===typeof h&&null!=h.enablePBFQuery?h.enablePBFQuery:!1;r=function(h){function c(){var a=null!==
h&&h.apply(this,arguments)||this;a.type="on-demand";a._queryInfoHash=null;a._processingInMainThread=!1;a._promises=new Map;a._readers=new Map;return a}z(c,h);c.prototype.initialize=function(){var a=this;this._tileQueue=new K({tileInfoView:new J(this.tileStore.tileInfo),process:function(e){return a._fetchFeatureSet(e)}});this.handles.add(this.watch("processor",this._switchProcessor.bind(this)))};c.prototype.destroy=function(){this._promises.forEach(function(a){return a.cancel()});this._promises.clear();
this.store&&(this.store.destroy(),this._set("store",null));this._readers.clear()};Object.defineProperty(c.prototype,"processing",{get:function(){return G.fromWorker(this.configuration.processing)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return 0<this._promises.size},enumerable:!0,configurable:!0});c.prototype.refresh=function(){};c.prototype.setViewState=function(a){this._tileQueue.pause();this._tileQueue.state=I.fromJSON(a);this._tileQueue.resume()};
c.prototype.queryFeatures=function(a){return this.store.executeQuery(q.fromJSON(a))};c.prototype.queryFeatureCount=function(a){return this.store.executeQueryForCount(q.fromJSON(a))};c.prototype.queryObjectIds=function(a){return this.store.executeQueryForIds(q.fromJSON(a))};c.prototype.queryExtent=function(a){return this.store.executeQueryForExtent(q.fromJSON(a))};c.prototype.onTileAdded=function(a){this._fetchTile(a)};c.prototype.onTileRemoved=function(a){var e=this._promises.get(a),b=this._readers.get(a);
this._readers.delete(a);e&&(e.cancel(),this._promises.delete(a),this.notifyChange("updating"));b&&this.store.unload(b)};c.prototype._switchProcessor=function(a,e){this.handles.remove("processor");var b=a.queryInfo,k=b.orderByFields,d=b.outFields;a=b.definitionExpression;e=b.gdbVersion;var f=b.historicMoment,b=b.pixelBuffer;d&&d.sort();k&&k.sort();k=JSON.stringify({definitionExpression:a,outFields:d,orderByFields:k,gdbVersion:e,pixelBuffer:b,historicMoment:f});this._tileQueue.pause();this._queryInfoHash!==
k&&(this._readers.clear(),this.store&&this.store.destroy(),this._set("store",new F.default({definitionExpression:a,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference,cacheSpatialQueries:!0,gdbVersion:e,historicMoment:null!=f&&new Date(f)})),this._queryInfoHash=k);this._tileQueue.reset();a=0;for(e=this.tileStore.tiles;a<e.length;a++)f=e[a],this._tileQueue.has(f.key)||this._fetchTile(f);this._tileQueue.resume()};
c.prototype._fetchTile=function(a){var e=this,b=this._tileQueue.push(a.key).then(function(b){e._cleanupPromise(a);var d=e.processor.queryInfo.orderByFields;if((!d||!d.length)&&b){var f=e.service.objectIdField;b.features.sort(function(a,b){return a.attributes[f]-b.attributes[f]})}e.processor.onTileData(a,b)}).catch(function(b){e._cleanupPromise(a);"cancel"!==b.dojoType&&(e.processor.onTileError(a,b.message),L.error("query-error",{error:b}));return v.reject(b)});this._promises.set(a,b);this.notifyChange("updating")};
c.prototype._fetchFeatureSet=function(a){var e=this,b=this.tileStore.findByKey(a),k=this._getQuantizationParameters(b),d=this.processor.queryInfo;a=d.pixelBuffer*b.resolution;var f=b.bounds.slice(),c=new Set;f[0]-=a;f[1]-=a;f[2]+=a;f[3]+=a;return this._readers.has(b)?this.store.executeQuery(this._createQuery(f,k,d)):this._drillQuery({geometryType:null,features:null,fields:null,transform:null,spatialReference:null},c,f,d,k).then(function(a){var b=d.orderByFields;if(b){var b=b[0].split(" "),e=b[0];
"DESC"===b[1]&&a.features.sort(function(a,b){return b.attributes[e]-a.attributes[e]})}return a}).then(function(a){return e._wrapPoints(a,d)}).then(function(a){return a.features.length?a:null}).then(function(a){var g=a?E.createFeatureSetReader(a):null;g&&e.store.load(g);e._readers.set(b,g);var c=e.service.objectIdField;if(a&&d.returnCentroid){var h=new Map,g=e._createQuery(f,k,d);g.objectIds=[];for(var n=0,m=a.features;n<m.length;n++){var l=m[n];if(!l.centroid){var p=l.attributes[c];h.set(p,l);g.objectIds.push(p)}}return g.objectIds.length?
e.store.executeQuery(g).then(function(b){var d=0;for(b=b.features;d<b.length;d++){var e=b[d];h.get(e.attributes[c]).centroid=e.centroid}return a}):a}return a})};c.prototype._drillQuery=function(a,e,b,c,d,f){var k=this;void 0===f&&(f=0);return this._query(b,c,d,f>=y).then(function(g){if(!a.geometryType){a.fields=g.fields;a.geometryType=g.geometryType;a.objectIdFieldName=g.objectIdFieldName;a.transform=g.transform;a.spatialReference=g.spatialReference;if(!g.exceededTransferLimit){a.features=g.features;
return}a.features=[]}if(f<y&&g.exceededTransferLimit){f++;var h=(b[2]-b[0])/2,n=(b[3]-b[1])/2;g=[b[0]+h,b[1]+n,b[2],b[3]];var l=[b[0],b[1],b[2]-h,b[3]-n],m=[b[0]+h,b[1],b[2],b[3]-n];return D.all([k._drillQuery(a,e,[b[0],b[1]+n,b[2]-h,b[3]],c,d,f),k._drillQuery(a,e,g,c,d,f),k._drillQuery(a,e,l,c,d,f),k._drillQuery(a,e,m,c,d,f)])}if("esriGeometryPoint"!==g.geometryType)for(h=k.service.objectIdField,n=0,g=g.features;n<g.length;n++)l=g[n],m=l.attributes[h],e.has(m)||(e.add(m),a.features.push(l));else a.features=
a.features.concat(g.features.concat())}).then(function(){return a})};c.prototype._query=function(a,e,b,c){var d=this;void 0===c&&(c=!0);var f=this._createQuery(a,b,e,c);a=this.service.source;return(N?x.executeQueryPBF(a,f):x.executeQuery(a,f)).then(function(a){return a.data}).then(function(a){return d._applyProcessing(a,f)})};c.prototype._createQuery=function(a,e,b,c){void 0===c&&(c=!0);var d=new q,f=this.processor.queryInfo.historicMoment;d.maxRecordCountFactor=M;d.gdbVersion=this.processor.queryInfo.gdbVersion;
d.historicMoment=null!=f?new Date(f):null;d.outFields=this.processor.queryInfo.outFields;d.where=this.processor.queryInfo.definitionExpression||"1\x3d1";d.geometry=A.Extent.fromJSON({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.spatialReference});this.service.capabilities.query.supportsQuantization?(d.quantizationParameters=e,"esriGeometryPolyline"===this.service.geometryType&&(d.maxAllowableOffset=e.tolerance)):d.maxAllowableOffset=e.tolerance;d.resultType="tile";d.returnExceededLimitFeatures=
c;d.returnGeometry=!0;d.returnCentroid=b.returnCentroid;d.orderByFields=b.orderByFields;return d};c.prototype._applyProcessing=function(a,e){var b=this.processing;if(!b)return a;if(this._processingInMainThread)return this.remoteClient.invoke("executeProcessing",{query:e.toJSON(),featureSet:JSON.stringify(a)}).then(function(a){return JSON.parse(a)});try{var c=b.process(a,e,b.options);return c?c:v.reject(new B("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(d){return this._processingInMainThread=
!0,this.remoteClient.invoke("executeProcessing",{query:e.toJSON(),featureSet:JSON.stringify(a)}).then(function(a){return JSON.parse(a)})}};c.prototype._getQuantizationParameters=function(a){return H.default.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:a.resolution,extent:{xmin:a.bounds[0],ymin:a.bounds[1],xmax:a.bounds[2],ymax:a.bounds[3],spatialReference:this.spatialReference}})};c.prototype._wrapPoints=function(a,e){if(0===a.features.length)return a;var b=e.returnCentroid;e=e.pixelBuffer;
var c=a.geometryType,d=a.spatialReference,f=a.transform;if("esriGeometryPoint"!==c&&"esriGeometryMultipoint"!==c&&!b||!w.isWrappable(d))return a;b=a.features;d=w.getInfo(d);f=Math.round((d.valid[1]-d.valid[0])/f.scale[0]);if(512===f){d=[];for(c=0;c<b.length;c++){var h=b[c],g=h.geometry,h=h.attributes;g&&(g.x<e?(g={geometry:u({},g),attributes:h},g.geometry.x+=f,d.push(g)):g.x>512-e&&(g={geometry:u({},g),attributes:h},g.geometry.x-=f,d.push(g)))}b.push.apply(b,d)}else for(d=0;d<b.length;d++)if(g=b[d].geometry)g.x<
-e?g.x+=f:g.x>512+e&&(g.x-=f);return a};c.prototype._cleanupPromise=function(a){this._promises.delete(a);this.notifyChange("updating")};l([m.property()],c.prototype,"configuration",void 0);l([m.property({readOnly:!0,dependsOn:["configuration"]})],c.prototype,"processing",null);l([m.property({readOnly:!0})],c.prototype,"store",void 0);l([m.property()],c.prototype,"updating",null);return c=l([m.subclass()],c)}(m.declared(r.default));t.default=r});