// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports dojo/has dojo/promise/all ./fontUtils ./Rect ./RectangleBinPack ../../../webgl/Texture".split(" "),function(B,C,D,y,z,A,x,g){return function(){function e(b,c,a){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=0;this._glyphIndex={};this._textures=[];this._rangePromises=new Map;(0>=b||0>=c)&&console.error("Glyph mosaic width and height must be greater than zero!");this.width=b;this.height=c;this._glyphSource=a;this._binPack=new x(b-4,c-4);this._glyphData.push(new Uint8Array(b*
c));this._dirties.push(!0);this._textures.push(void 0)}e.prototype.getGlyphItems=function(b,c){var a=this,q=z.getFullyQualifiedFontName(b),h=[],e=this._glyphSource;b=new Set;for(var g=1/256,m=0;m<c.length;m++)b.add(Math.floor(c[m]*g));var w=[];b.forEach(function(b){if(256>=b){var c=q+b;a._rangePromises.has(c)?w.push(a._rangePromises.get(c)):(b=e.getRange(q,b).always(function(){a._rangePromises["delete"](c)}),a._rangePromises.set(c,b),w.push(b))}});return y(w).then(function(b){var r=a._glyphIndex[q];
r||(r={},a._glyphIndex[q]=r);for(var g=0;g<c.length;g++){b=c[g];var d=r[b];if(d)h[b]={rect:d.rect,metrics:d.metrics,page:d.page};else{var k=e.getGlyph(q,b);if(k&&k.metrics){var d=k.metrics,f=void 0;if(0===d.width)f=new A(0,0,0,0);else{var n=d.width+6,t=d.height+6,p=n%4?4-n%4:4,l=t%4?4-t%4:4;1===p&&(p=5);1===l&&(l=5);f=a._binPack.allocate(n+p,t+l);f.isEmpty&&(a._dirties[a._currentPage]||(a._glyphData[a._currentPage]=null),a._currentPage=a._glyphData.length,a._glyphData.push(new Uint8Array(a.width*
a.height)),a._dirties.push(!0),a._textures.push(void 0),a._binPack=new x(a.width-4,a.height-4),f=a._binPack.allocate(n+p,t+l));var p=a._glyphData[a._currentPage],k=k.bitmap,m=l=void 0;if(k)for(var u=0;u<t;u++)for(var l=n*u,m=a.width*(f.y+u+1)+f.x,v=0;v<n;v++)p[m+v+1]=k[l+v]}r[b]={rect:f,metrics:d,tileIDs:null,page:a._currentPage};h[b]={rect:f,metrics:d,page:a._currentPage};a._dirties[a._currentPage]=!0}}}return h})};e.prototype.bind=function(b,c,a,e){this._textures[a]||(this._textures[a]=new g(b,
{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var h=this._textures[a];h.setSamplingMode(c);this._dirties[a]&&h.setData(this._glyphData[a]);b.bindTexture(h,e);this._dirties[a]=!1};e.prototype.dispose=function(){this._binPack=null;for(var b=0,c=this._textures;b<c.length;b++){var a=c[b];a&&a.dispose()}this._textures.length=0;this._glyphData.length=0};return e}()});