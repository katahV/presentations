// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../../core/tsSupport/extendsHelper ../../../../../../core/Logger ../../enums ../../MaterialInfo ../../Utils ../../visualVariablesUtils ../../WGLDisplayObject ../VertexVector ../templates/meshTemplateUtils ../templates/WGLMarkerTemplate ../../util/Matcher ../../util/serializationUtils ../../util/vvFlagUtils ../../util/Writer".split(" "),function(F,z,N,I,e,A,B,G,J,l,u,K,C,D,t,H){Object.defineProperty(z,"__esModule",{value:!0});var x=I.getLogger("esri.views.2d.engine.webgl.WGLMeshFactory"),
y=function(){function c(){this._materials=[]}c.prototype.insert=function(a){var b=this._materials.length;this._materials.push(a);return b};c.prototype.createSpriteMaterial=function(a,b,d){var f=this._materials.length;a=A.default.fromSprite(a,b,d);this._materials.push(a);return f};c.prototype.createGlyphMaterial=function(a,b,d){var f=this._materials.length;a=A.default.fromGlyph(a,b,d);this._materials.push(a);return f};c.prototype.get=function(a){return this._materials[a]};c.prototype.serialize=function(a){D.serializeList(a,
this._materials);return a};c.deserialize=function(a){var b=new c;b._materials=D.deserializeList(a,A.default);return b};return c}();z.MaterialStore=y;var L=function(){function c(a,b,d){this.displayObjects=a;this.vertexVectorsMap=b;this._materials=d}c.prototype.get=function(a){return this.vertexVectorsMap[a]};c.prototype.pushDisplayObject=function(a){this.displayObjects.push(a)};c.prototype.encode=function(a,b){var d=D.serializeList(new H.default(Uint32Array,this._guessSize()),this.displayObjects).buffer(),
f=this._materials.serialize(new H.default(Uint32Array)).buffer(),g={};b.push(d);b.push(f);for(var c in this.vertexVectorsMap){var h=this.vertexVectorsMap[c];g[c]={};h.transfer(g[c],b)}a.displayObjects=d;a.materialStore=f;a.vertexBuffersMap=g;this.destroy()};c.prototype.destroy=function(){this.displayObjects=this.vertexVectorsMap=null};c.prototype._guessSize=function(){for(var a=this.displayObjects,b=Math.min(a.length,4),d=0,f=0;f<b;f++)d=Math.max(d,a[f].displayRecords.length);return 2*(12*a.length+
a.length*d*40)};return c}(),M=function(){function c(){this._vvMap=new Map}c.prototype.set=function(a,b){this._vvMap.set(a,b)};c.prototype.getValue=function(a,b,d){return this._vvMap.has(a)?this._vvMap.get(a)(b,d):0};return c}();F=function(){function c(a,b,d,f,c,e,h,E,r){this._matcher=a;this._materials=d;this._geometryType=f;this._idField=c;this._pixelRatio=r;this._vvMap=null;this._vvFlags=h;this._vvBuf=new ArrayBuffer(16);this._vvBufU32=new Uint32Array(this._vvBuf);this._vvBufF32=new Float32Array(this._vvBuf);
this._createVVFunctionMap(e,b,E)}c.from=function(a,b,d,f,g,e,h){switch(a.type){case "simple":return c._fromSimpleRenderer(a,b,d,f,g,e,h);case "unique-value":case "uniqueValue":return c._fromUniqueValueRenderer(a,b,d,f,g,e,h);case "class-breaks":case "classBreaks":return c._fromClassBreaksRenderer(a,b,d,f,g,e,h);default:return x.error("Tried to create WGLMeshFactory from an unknown renderer type!"),null}};Object.defineProperty(c.prototype,"materials",{get:function(){return this._materials},enumerable:!0,
configurable:!0});c.prototype.createMeshData=function(a){var b=Array(e.WGLGeometryType.COUNT),d=this._matcher.getDefault(),c=!!t.getMarkerVVFlags(this._vvFlags),g=!!t.getFillVVFlags(this._vvFlags),p=!!t.getLineVVFlags(this._vvFlags,!0)||!!t.getLineVVFlags(this._vvFlags,!1),h=!!t.getTextVVFlags(this._vvFlags);d&&1===d.length&&d[0]instanceof K.default?(b[e.WGLGeometryType.MARKER]=new l.VertexVectors(e.WGLGeometryType.MARKER,c,a),b[e.WGLGeometryType.FILL]=new l.VertexVectors(e.WGLGeometryType.FILL,g,
0),b[e.WGLGeometryType.LINE]=new l.VertexVectors(e.WGLGeometryType.LINE,p,0),b[e.WGLGeometryType.TEXT]=new l.VertexVectors(e.WGLGeometryType.TEXT,h,0)):(b[e.WGLGeometryType.MARKER]=new l.VertexVectors(e.WGLGeometryType.MARKER,c,a),b[e.WGLGeometryType.FILL]=new l.VertexVectors(e.WGLGeometryType.FILL,g,a),b[e.WGLGeometryType.LINE]=new l.VertexVectors(e.WGLGeometryType.LINE,p,a),b[e.WGLGeometryType.TEXT]=new l.VertexVectors(e.WGLGeometryType.TEXT,h,a));return new L([],b,this._materials)};c.prototype.write=
function(a,b,d){var c=1===this._matcher.size()&&this._matcher.getDefault()||this._matcher.match(b,d),g=b.attributes[this._idField],e=new J(g);this._computeVV(b,d);if(c){for(d=0;d<c.length;d++){var h=c[d],E=a.get(h.geometryType);h.writeMesh(e.displayRecords,E,this._geometryType,g,b,this._pixelRatio,this._vvBufU32)}a.pushDisplayObject(e)}};c.prototype._isErrorVV=function(a){return null===a||isNaN(a)||Infinity===a};c.prototype._computeVV=function(a,b){if(!this._vvMap)return 0;var d=this._vvMap.getValue(e.VVType.SIZE,
a,b),c=this._vvMap.getValue(e.VVType.COLOR,a,b),g=this._vvMap.getValue(e.VVType.OPACITY,a,b);a=this._vvMap.getValue(e.VVType.ROTATION,a,b);this._vvBufF32[e.VVType.SIZE]=this._isErrorVV(d)?NaN:d;this._vvBufF32[e.VVType.COLOR]=this._isErrorVV(c)?NaN:c;this._vvBufF32[e.VVType.OPACITY]=this._isErrorVV(g)?NaN:g;this._vvBufF32[e.VVType.ROTATION]=this._isErrorVV(a)?NaN:a;return 0};c.prototype._createVVFunctionMap=function(a,b,d){if(a&&a.length)for(var c=0;c<a.length;c++){var g=a[c],e=B.getVVType(g.type);
if(g=this._createGetValueFunction(g,b,d))this._vvMap||(this._vvMap=new M),this._vvMap.set(e,g)}};c.prototype._createGetValueFunction=function(a,b,c){if(B.getVVType(a.type)===e.VVType.SIZE){var d=G.getTypeOfSizeVisualVariable(a);return d===e.WGLVVFlag.SIZE_SCALE_STOPS?null:this._createNormalizedFunction(a,b,c,d===e.WGLVVFlag.SIZE_UNIT_VALUE&&function(c){return G.getVisualVariableSizeValueRepresentationRatio(c,a.valueRepresentation)})}return this._createNormalizedFunction(a,b,c)};c.prototype._createNormalizedFunction=
function(a,c,d,e){var b=a.field;if(b){if("string"===typeof b){var f=a.normalizationField;return f?function(a){if(a.attributes[b]&&a.attributes[f])return a=a.attributes[b]/a.attributes[f],e?e(a):a}:e?function(a){return e(a.attributes[b])}:function(a){return a.attributes[b]}}if("function"===typeof b)return x.error("Function field types are not currently supported.\n                      Please use a valueExpression instead"),function(a){};x.error("The field for a vv must be a string or a number, but got "+
typeof b);return function(a){}}if(a.valueExpression&&"$view.scale"!==a.valueExpression)return B.createArcadeFunction({valueExpression:a.valueExpression,spatialReference:d,layer:c},e);x.error("Unable to create a normalized function for visual variable: "+a);return function(a){}};c._fromSimpleRenderer=function(a,b,d,e,g,p,h){var f=a.getSymbols();a=a.visualVariables;var r=t.getVVFlags(a),m=new C.default,k=new y;f.length&&m.setDefault(u.createMeshTemplates([],k,f[0],d,r,h));return new c(m,b,k,e,g,a,r,
p,h)};c._fromUniqueValueRenderer=function(a,b,d,e,g,p,h){var f=a.uniqueValueInfos,r=a.visualVariables,m=t.getVVFlags(r),k=[a.field];a.field2&&k.push(a.field2);a.field3&&k.push(a.field3);for(var n=a.valueExpression,k=new C.MapMatcher(k,a.fieldDelimiter,n?{valueExpression:n,spatialReference:p,layer:b}:null),n=new y,q=a.backgroundFillSymbol,q=q&&u.createMeshTemplates([],n,q,d,m,h),l=0;l<f.length;l++){var v=f[l],w=u.createMeshTemplates([],n,v.symbol,d,m,h);k.add(v.value,q?q.concat(w):w)}if(a=a.defaultSymbol)d=
u.createMeshTemplates([],n,a,d,m,h),k.setDefault(q?q.concat(d):d);return new c(k,b,n,e,g,r,m,p,h)};c._fromClassBreaksRenderer=function(a,b,d,e,g,l,h){for(var f=a.isMaxInclusive,r=a.visualVariables,m=a.valueExpression,k=a.normalizationField,n=a.normalizationTotal,q=a.normalizationType,p=t.getVVFlags(r),f=new C.IntervalMatcher(a.field,f,m?{valueExpression:m,spatialReference:l,layer:b}:null,{normalizationField:k,normalizationTotal:n,normalizationType:q}),m=new y,k=(k=a.backgroundFillSymbol)&&u.createMeshTemplates([],
m,k,d,p,h,!0),n=0,q=a.classBreakInfos;n<q.length;n++){var v=q[n],w=u.createMeshTemplates([],m,v.symbol,d,p,h);f.add({min:v.minValue,max:v.maxValue},k?k.concat(w):w)}if(a=a.defaultSymbol)d=u.createMeshTemplates([],m,a,d,p,h),f.setDefault(k?k.concat(d):d);return new c(f,b,m,e,g,r,p,l,h)};return c}();z.default=F});