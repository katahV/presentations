// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../request ../../../../core/Error ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../geometry/SpatialReference ../../../../geometry/support/webMercatorUtils ../../../../tasks/QueryTask ../../../../tasks/support/Query ./I3SBinaryReader ../../support/projectionUtils ../support/symbolColorUtils".split(" "),function(U,e,E,l,m,F,t,G,H,I,J,u,K){function q(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function v(a,b,c,d,h,g){if(null!=
c){var f=c.mbs;b!==d&&(f=L,u.mbsToMbs(c.mbs,d,f,b));if(0!==w(a,f)&&(g(c),c.children))for(f=0;f<c.children.length;++f)v(a,b,h[c.children[f].id],d,h,g)}}function w(a,b){var c=b[0],d=b[1],h=b[2];b=b[3];var g=0;if(c<a[0])var f=a[0]-c,g=g+f*f;d<a[1]&&(f=a[1]-d,g+=f*f);h<a[2]&&(f=a[2]-h,g+=f*f);c>a[3]&&(f=c-a[3],g+=f*f);d>a[4]&&(f=d-a[4],g+=f*f);h>a[5]&&(f=h-a[5],g+=f*f);if(g>b*b)return 0;if(0<g)return 1;g=Infinity;c-a[0]<g&&(g=c-a[0]);d-a[1]<g&&(g=d-a[1]);h-a[2]<g&&(g=h-a[2]);a[3]-c<g&&(g=a[3]-c);a[4]-
d<g&&(g=a[4]-d);a[5]-h<g&&(g=a[5]-h);return g>b?2:1}function r(a,b,c){var d=[],h=c&&c.missingFields;c=c&&c.originalFields;for(var g=0;g<a.length;g++){for(var f=a[g],e=f.toLowerCase(),k=!1,n=0,x=b;n<x.length;n++){var y=x[n];if(e===y.name.toLowerCase()){d.push(y.name);k=!0;c&&c.push(f);break}}!k&&h&&h.push(f)}return d}function M(a,b){return a.filter(function(a){return a.toLowerCase()!==b.toLowerCase()}).concat([b])}function N(a,b,c,d){b.sort(function(a,b){return a.attributes[c]-b.attributes[c]});var h=
b.map(function(a){return a.attributes[c]}),g=[],f=r(d,a.fields,{originalFields:g});return z(a,h,f).then(function(a){for(var c=0;c<b.length;c++){var d=b[c],h=a[c];d.attributes={};for(var e=0;e<g.length;e++)d.attributes[g[e]]=h[f[e]]}return b})}function O(a,b){for(var c=[],d=0;d<a.length;d++){var h=a[d];h in b.attributes||c.push(h)}return c}function z(a,b,c){if(null!=a.maxRecordCount&&b.length>a.maxRecordCount){var d=P(b,a.maxRecordCount);return m.all(d.map(function(b){return z(a,b,c)})).then(Q)}d=
new I({objectIds:b,outFields:c,orderByFields:[a.objectIdField]});return(new H(a.parsedUrl.path)).execute(d).then(function(a){return a&&a.features&&a.features.length===b.length?a.features.map(function(a){return a.attributes}):m.reject(new l("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function R(a,b,c,d,h){for(var g=[],f=0;f<b.attributeData.length;f++){var e=b.attributeData[f],k=a[f];k&&-1!==d.indexOf(k.name)&&(e=F.makeAbsolute(e.href,b.baseUrl),
g.push({url:e,storageInfo:k}))}return m.eachAlways(g.map(function(a){return E(a.url,{responseType:"array-buffer"}).then(function(b){return J.readBinaryAttribute(a.storageInfo,b.data)})})).then(function(a){var b=[];if(!h.ignoreUnavailableFields&&a.some(function(a){return null==a.value})){for(var b=[],d=0;d<a.length;d++)null==a[d].value&&b.push({name:g[d].storageInfo.name,error:a[d].error});return m.reject(new l("scenelayer:attribute-request-failed","Request for scene layer attributes failed",{failedAttributes:b}))}for(var f=
0;f<c.length;f++){for(var e=c[f],k={},d=0;d<a.length;d++)null!=a[d].value&&(k[g[d].storageInfo.name]=A(a[d].value,e));b.push(k)}return b})}function A(a,b){b=a[b];return a instanceof Int16Array?b===S?null:b:a instanceof Int32Array?b===T?null:b:b!==b?null:b}function P(a,b){var c=a.length;b=Math.ceil(c/b);for(var d=[],h=0;h<b;h++)d.push(a.slice(Math.floor(c*h/b),Math.floor(c*(h+1)/b)));return d}function Q(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(a[c]);return b}function B(a){var b=new t(q(a.store.indexCRS||
a.store.geographicCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function C(a){var b=new t(q(a.store.vertexCRS||a.store.projectedCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function p(a,b,c){if(!G.canProject(a,b))throw new l("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===c&&a.isGeographic)throw new l("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",
{});}function D(a,b,c){var d=B(a);a=C(a);p(d,b,c);p(a,b,c)}Object.defineProperty(e,"__esModule",{value:!0});e.DDS_ENCODING_STRING="image/vnd-ms.dds";e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"];e.extractWkid=q;e.getAppropriateTextureEncoding=function(a,b){if(Array.isArray(a)){if(b&&(b=a.indexOf(e.DDS_ENCODING_STRING),-1<b))return b;for(b=0;b<a.length;b++)if(-1<e.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b]))return b;throw Error("Could not find appropriate texture encoding (among "+
a.toString()+")");}return-1};e.findIntersectingNodes=v;e.buildTopNodeMap=function(a,b,c,d){if(0>=b)a.clear();else for(c&&a.set(c,d),c=function(){var b=Number.POSITIVE_INFINITY,c;a.forEach(function(a,d){a<b&&(c=d,b=a)});a.delete(c)};a.size>b;)c()};var L=[0,0,0,0];e.intersectBoundingBoxWithMbs=w;e.findFieldsCaseInsensitive=r;e.whenGraphicAttributes=function(a,b,c,d,h,g){var f=!0===(g&&g.populateObjectId),e=g.ignoreUnavailableFields?void 0:[],k=1===d.length&&"*"===d[0];!k&&f&&(d=M(d,c));d=k?d:r(d,a.fields,
{missingFields:e});if(e&&0!==e.length)return m.reject(new l("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:e}));if(0===b.length)return m.resolve(b);var f=a.associatedLayer,e=a.attributeStorageInfo,n=k?a.fields.map(function(a){return a.name}):d;if(f)return N(f,b,c,n);a=O(n,b[0]);return 0===a.length?m.resolve(b):e?(h=h(),null==h?m.reject(new l("scenelayer:feature-not-loaded","Tried to query attributes for unloaded features")):R(e,h.node,h.indices,a,
g).then(function(a){for(var c=0;c<b.length;c++){for(var d=0,f=n;d<f.length;d++){var g=f[d];g in a[c]||(a[c][g]=b[c].attributes[g])}b[c].attributes=a[c]}return b})):m.reject(new l("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var S=-Math.pow(2,15),T=-Math.pow(2,31);e.getCachedAttributeValue=A;e.convertFlatRangesToOffsets=function(a,b,c){void 0===c&&(c=2);b=null!=b?b:a.length/c;for(var d=new Uint32Array(b+1),e=0;e<b;e++){var g=a[e*c];d[e]=3*g;
var f=(e-1)*c+1;if(0<=f&&g-1!==a[f])throw new l("Face ranges are not continuous");}d[d.length-1]=3*(a[(b-1)*c+1]+1);return d};e.getIndexCrs=B;e.getVertexCrs=C;e.getCacheKeySuffix=function(a,b){return b===u.SphericalECEFSpatialReference?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};e.checkSpatialReference=p;e.checkSpatialReferences=D;e.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null!=a.geometryType&&"triangles"!==
a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new l("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{});};e.checkSceneLayerCompatibleWithView=function(a,b){D(a,b.spatialReference,b.viewingMode)};e.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null==a.geometryType||
"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new l("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});};e.checkPointCloudLayerCompatibleWithView=function(a,b){p(a.spatialReference,b.spatialReference,b.viewingMode)};e.encodeSymbolColor=K.encodeSymbolColor;e.rendererNeedsTextures=
function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===a.type||"class-breaks"===a.type)&&null==a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(var b=0;b<a.length;b++){var c=a[b];if("mesh-3d"!==c.type||0===c.symbolLayers.length)return!0;for(var d=0,c=c.symbolLayers.items;d<c.length;d++){var e=c[d];if("fill"!==e.type||null==e.material||"replace"!==e.material.colorMixMode)return!0}}return!1}});