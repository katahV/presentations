// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["./IdGen","./Util","./gl-matrix","../parts/Model","./IntervalUtilities"],function(r,H,I,K,y){var m=H.assert,l=I.mat4d,n=I.vec3d,F=H.VertexAttrConstants,L=new r,M=new r,z=function(h,l,m,n,r){var x=M.gen(h.getId());this.getId=function(){return x};this.geometry=h;this.materials=l;this.transformation=m;this.instanceParameters=n;this.origin=r};r=function(h){var r=this,N=L.gen(h.idHint);this.getId=function(){return N};var O=h.name,J=null!=h.castShadow?h.castShadow:!0,x=h.metadata||{},v;this.getParentLayer=
function(){return v};this.addParentLayer=function(a){m(void 0===v,"Object3D can only be added to a single Layer");v=a};this.removeParentLayer=function(a){v=void 0};var e,u;if(Array.isArray(h.geometries)){m(h.materials.length===h.geometries.length,"Object3D: materials don't match geometries");m(h.transformations.length===h.geometries.length,"Object3D: transformations don't match geometries");e=Array(h.geometries.length);u=h.geometries.slice();for(var q=0;q<h.geometries.length;q++)m(h.materials[q]instanceof
Array,"Object3D: materials parameter must be array of array"),e[q]=new z(h.geometries[q],h.materials[q].slice(),l.create(h.transformations[q]),h.instanceParameters?h.instanceParameters.slice():void 0)}else e=[],u=[];var C=l.identity();h=function(){this.min=n.create();this.max=n.create();this.center=n.create();this.init=function(){n.set3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.min);n.set3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.max)}};var t=new h,p=new h,G=!0,A,E;
this.getNumGeometryRecords=function(){return e.length};this.getFirstGeometryIndex=function(a){a=u.indexOf(a);m(-1<a,"Object3D.getFirstGeometryIndex: geometry not found");return a};this.findGeometryRecords=function(a){for(var b=[],c=0;c<u.length;c++)u[c]===a&&b.push(e[c]);return b};this.getGeometryRecord=function(a){m(0<=a&&a<e.length,"Object3d.getGeometryDataByIndex: index out of range");return e[a]};this.getGeometryRecords=function(){return e};this.addGeometry=function(a,b,c,d,f){m(b instanceof Array,
"Object3D.addGeometry: materials must be array");u.push(a);a=new z(a,b.slice(),l.create(c),d,f);e.push(a);this.notifyDirty("objGeometryAdded",a);B();return a};this.hasGeometry=function(a){return-1<u.indexOf(a)};this.removeGeometry=function(a){var b=e.splice(a,1)[0];u.splice(a,1);this.notifyDirty("objGeometryRemoved",b);B();return b};this.replaceGeometry=function(a,b){m(0<=a&&a<e.length,"Object3d.replaceGeometry: index out of range");var c=e[a],d=new z(b,c.materials,c.transformation);e[a]=d;u[a]=b;
this.notifyDirty("objGeometryReplaced",[c,d]);B();return c.geometry};this.replaceGeometryMaterials=function(a,b){m(0<=a&&a<e.length,"Object3d.replaceGeometryMaterials: index out of range");var c=e[a],d=c.materials;b=new z(c.geometry,b.slice(),c.transformation);e[a]=b;this.notifyDirty("objGeometryReplaced",[c,b]);return d};this.geometryVertexAttrsUpdated=function(a){this.notifyDirty("vertexAttrsUpdated",e[a]);B()};this.geometryColorAttrsUpdated=function(a){this.notifyDirty("colorAttrsUpdated",e[a])};
var k={},w={};this.getHiddenIndexRanges=function(a){return k[a.getId()]};this.getVisibleIndexRanges=function(a){return w[a.getId()]};this.isAllHidden=function(){for(var a=0;a<e.length;a++){var b=e[a],c=b.geometry.getData().getFaces().length,b=this.getVisibleIndexRanges(b);if(!b)return!1;for(var d=0;d<c;d++){var f=b[d];if(!f||0<f.length)return!1}}return!0};this.setFacerangeColors=function(a){var b=this.getGeometryRecords();if(1!=b.length)console.warn("face range colors currently support only one geometry record");
else{var b=b[0].geometry,c=b.getData().getVertexAttr();null==b.backupColors&&(b.backupColors=c[F.COLOR].data,c[F.COLOR].data=new Uint8Array(b.backupColors,0,b.backupColors.byteLength));c=c[F.COLOR].data;if(null!=c){for(var d=0;d<a.length;d++){var f=a[d],e=f.color;for(q=null==f.faceRanges?0:12*f.faceRanges[0];q<(null==f.faceRanges?c.length:12*(f.faceRanges[1]+1));q++)c[q]=null!=e?255*e[q%4]:b.backupColors[q]}this.geometryColorAttrsUpdated(0)}}};this.isPartiallyHidden=function(){for(var a=0;a<e.length;a++){var b=
e[a],c=b.geometry.getData().getFaces().length;if(b=this.getHiddenIndexRanges(b))for(var d=0;d<c;d++){var f=b[d];if(f&&0<f.length)return!0}}return!1};this.hideFaceRange=function(a,b){var c=a.getId();void 0===k[c]&&(k[c]={},w[c]={});for(var d=0;d<a.geometry.getData().getFaces().length;d++){void 0===k[c][d]&&(k[c][d]=[],w[c][d]=[]);var f=y.copyIntervals(b);y.convertFaceToIndexRange(f,3);var e=a.geometry.getData().getFaces()[d].componentRange,f=y.intersectIntervals(f,e),f=y.offsetIntervals(f,-e[0]);k[c][d]=
k[c][d].concat(f);k[c][d]=y.mergeIntervals(k[c][d]);0===k.length?(delete w[c],delete k[c]):(f=a.geometry.getData().getFaces()[d].indices.position.length,w[c][d]=y.invertIntervals(k[c][d],f-1))}this.notifyDirty("hideFaceRange",a)};this.hideAllFaceRanges=function(){k={};w={};for(var a=0;a<e.length;a++){var b=e[a],c=b.getId();k[c]={};w[c]={};for(var d=b.geometry.getData().getFaces().length,f=0;f<d;f++){var h=b.geometry.getData().getFaces()[f].indices.position.length;k[c][f]=[0,h-1];w[c][f]=[]}this.notifyDirty("hideFaceRange",
b)}return!0};this.unhideAllFaceRange=function(){k={};w={};this.notifyDirty("unhideAllFaceRange")};this.getFaceRangeIndexFromTriangleNr=function(a){var b=x.faceRanges,c;if(null!=b&&1<b.length)for(var d=0;d<b.length;d++)if(b[d][0]<=a&&b[d][1]>a){c=d;break}return c};this.getFaceRangeFromTriangleNr=function(a){a=this.getFaceRangeIndexFromTriangleNr(a);var b=x.faceRanges;return a?[b[a]]:null};this.setGeometryTransformation=function(a,b){m(0<=a&&a<e.length,"Object3d.setGeometryTransformation: index out of range");
var c=e[a];b=new z(c.geometry,c.materials,l.create(b));e[a]=b;this.notifyDirty("objGeometryReplaced",[c,b]);B()};this.getObjectTransformation=function(){return l.create(C)};this.setObjectTransformation=function(a){l.set(a,C);B();this.notifyDirty("objTransformation")};this.getCombinedTransformation=function(a,b){b=b||l.create();l.multiply(C,a.transformation,b);return b};this.getCastShadow=function(){return J};this.setCastShadow=function(a){J=a};this.getMetadata=function(){return x};this.getName=function(){return O};
this.getBBMin=function(a){D();return a?t.min:p.min};this.getBBMax=function(a){D();return a?t.max:p.max};this.getCenter=function(a){D();return a?t.center:p.center};this.getBSRadiusApprox=function(){D();return A};this.getBSRadiusApproxScaled=function(){D();return E};var D=function(){if(G){t.init();p.init();for(var a=n.create(),b=n.create(),c=0;c<e.length;++c)for(var d=u[c],f=0,h=d.getNumGroups();f<h;++f){var g=d.getBoundingInfo(f);l.multiplyVec3(e[c].transformation,g.getBBMin(),a);l.multiplyVec3(e[c].transformation,
g.getBBMax(),b);for(g=0;3>g;++g){if(a[g]>b[g]){var k=a[g];a[g]=b[g];b[g]=k}t.min[g]=Math.min(t.min[g],a[g]);t.max[g]=Math.max(t.max[g],b[g])}l.multiplyVec3(C,a);l.multiplyVec3(C,b);for(g=0;3>g;++g)a[g]>b[g]&&(k=a[g],a[g]=b[g],b[g]=k),p.min[g]=Math.min(p.min[g],a[g]),p.max[g]=Math.max(p.max[g],b[g])}n.lerp(t.min,t.max,.5,t.center);n.lerp(p.min,p.max,.5,p.center);for(c=E=A=0;c<e.length;++c)for(d=u[c],f=0,h=d.getNumGroups();f<h;++f)g=d.getBoundingInfo(f),b=e[c].transformation,l.multiplyVec3(b,g.getCenter(),
a),A=Math.max(A,n.dist(a,t.center)+g.getBSRadius(f)),E=Math.max(E,A*Math.max(Math.max(Math.sqrt(b[0]*b[0]+b[4]*b[4]+b[8]*b[8]),Math.sqrt(b[1]*b[1]+b[5]*b[5]+b[9]*b[9])),Math.sqrt(b[2]*b[2]+b[6]*b[6]+b[10]*b[10])));G=!1}},B=function(){G=!0;var a={bbMin:p.min,bbMax:p.max,center:p.center,bsRadius:A};v&&v.notifyObjectBBChanged(r,a)};this.notifyDirty=function(a,b,c,d){v&&(c=c||K.ContentType.OBJECT,v.notifyDirty(a,b,c,d||this))}};r.GeometryRecord=z;r.paramsFromOldConstructor=function(h,l,m,n,r,x,v){return{name:h,
geometries:l,materials:m,transformations:n,castShadow:r,metadata:x,idHint:v}};return r});