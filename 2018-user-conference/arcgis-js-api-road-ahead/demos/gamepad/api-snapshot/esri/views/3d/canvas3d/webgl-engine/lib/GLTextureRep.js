// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["./Util","./GLUtil"],function(k,w){return function(t,x,y,a){var g={},e={},h=[],n=[],m=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),z=m?a.getParameter(m.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,p=Math.min(8,z),q=!0,C=function(){var b=a.createTexture(),c=0;this.incRefCnt=function(){++c};this.decRefCnt=function(){--c;k.assert(0<=c)};this.getRefCnt=function(){return c};this.getGLName=function(){return b}},
D=function(b){var c=g[b];void 0!==c&&(a.deleteTexture(c.getGLName()),delete g[b])};this.resetNeedsRender=function(){q=!1};this.needsRender=function(){return q};this.aquire=function(b,c,d){var f=g[b];if(void 0===f){f=new C;k.assert(void 0===g[b]);g[b]=f;var l=t[b];k.assert(void 0!==l);l.setUnloadFunc(D);var e=f.getGLName();E(e,l,c,d);l.renderGl?l.renderGl(e,a):l.deferredLoading()?8>this.getLoadingCount()?A(b,e):h.push([b,e]):l.loadGl(function(){q=!0},e,a,x,y());q=!0}f.incRefCnt();return f.getGLName()};
this.release=function(a){a=g[a];void 0!==a&&(a.decRefCnt(),k.assert(0<=a.getRefCnt()))};this.getLoadingCount=function(){return Object.keys(e).length};this.getIsLoaded=function(a){if(void 0===g[a]||void 0!==e[a])return!1;for(var b=0,d=h.length;b<d;++b)if(h[b][0]===a)return!1;return!0};this.addTextureListener=function(a){k.assert(-1===n.indexOf(a));n.push(a)};this.removeTextureListener=function(a){a=n.indexOf(a);k.assert(-1!==a);n.splice(a,1)};this.getTexture=function(a){return t[a]};this.setMaxAnisotropy=
function(b){if(m&&(b=k.clamp(b,1,z),b!==p)){p=b;for(var c in g)b=g[c].getGLName(),a.bindTexture(a.TEXTURE_2D,b),a.texParameterf(a.TEXTURE_2D,m.TEXTURE_MAX_ANISOTROPY_EXT,p)}};this.getMaxAnisotropy=function(){return p};for(var u=new Uint8Array(256),B=new Uint8Array(256),r=0,v=u.length;r<v;++r)u[r]=255,B[r]=0!==(r+1)%4?255:0;var E=function(b,c,d,f){a.bindTexture(a.TEXTURE_2D,b);c.params&&c.params.wrapClamp&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));if(void 0!==d)if(Array.isArray(d.id)){b=d.num;k.assert(d.id.length===b*b);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,256*b,256*b,0,a.RGBA,a.UNSIGNED_BYTE,null);c=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,c);for(f=0;f<b;f++)for(var e=0;e<b;e++)a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,g[d.id[f*b+e]].getGLName(),0),w.checkFramebufferStatus(a.FRAMEBUFFER,a),a.copyTexSubImage2D(a.TEXTURE_2D,0,256*e,256*f,0,0,256,256);a.generateMipmap(a.TEXTURE_2D);
a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR);a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteFramebuffer(c)}else a.texImage2D(a.TEXTURE_2D,0,a.RGBA,d.width,d.height,0,a.RGBA,a.UNSIGNED_BYTE,null),w.copyTextureToTexture(g[d.id].getGLName(),b,d.x,d.y,0,0,d.width,d.height,a);else a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),void 0!==f&&f?a.texImage2D(a.TEXTURE_2D,0,a.RGBA,8,8,0,a.RGBA,a.UNSIGNED_BYTE,B):a.texImage2D(a.TEXTURE_2D,0,a.RGBA,8,8,0,a.RGBA,a.UNSIGNED_BYTE,
u);m&&a.texParameterf(a.TEXTURE_2D,m.TEXTURE_MAX_ANISOTROPY_EXT,p)},G=function(a){if(a in e){delete e[a];var b=Object.keys(g),d=Object.keys(e);n.forEach(function(c){c(a,b,d)});F()}},A=function(b,c){k.assert(void 0===e[b]);e[b]=!0;var d=t[b];k.assert(void 0!==d);setTimeout(function(){d.loadGl(function(){G(b);q=!0},c,a,x,y())},0)},F=function(){var b=[],c;c=0;for(v=h.length;c<v;++c){var d=h[c][0],f=g[d];void 0!==f&&(0===f.getRefCnt()?(a.deleteTexture(f.getGLName()),delete g[d]):b.push(h[c]))}h=b;b=Math.min(8-
Object.keys(e).length,h.length);for(c=0;c<b;++c)A(h[c][0],h[c][1]);h.splice(0,b)}}});