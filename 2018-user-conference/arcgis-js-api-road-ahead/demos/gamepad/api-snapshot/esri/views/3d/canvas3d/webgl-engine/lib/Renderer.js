// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("./IntervalUtilities ./ModelDirtyTypes ./Float32ArrayList ./InstanceBufferData ./VertexBufferLayout ../materials/internal/SimpleGLMaterial ../materials/internal/TexOnlyGLMaterial ./GLFBO ./GLVBO ./GLSLProgram ./bitset ./Util ./gl-matrix".split(" "),function(Gb,Zb,Pb,$b,Hb,rb,ab,ac,sb,bb,bc,n,ba){var m=n.assert,tb=n.subtractObjects,cb=n.array2object,ub=n.objectEmpty,Aa=n.getFirstObjectValue,vb=n.setMatrixTranslation3,cc=ba.vec2d,w=ba.mat4d,db=ba.vec3d,G=ba.vec4d,dc=n.VertexAttrConstants,Qb=
function(m,c,f,n,a,x,ec,D){this.name=m;this.from=c;this.to=f;this.displayedIndexRange=n;this.transformation=a;this.instanceParameters=x;this.idx=ec;this.dataId=D;null!=a&&(this.transformationNormal=w.create(),w.set(a,this.transformationNormal),w.inverse(this.transformationNormal,this.transformationNormal),w.transpose(this.transformationNormal,this.transformationNormal))},fc=function(w,c,f,m){var a=G.create(w),x=G.create(c),n=G.create(f),D=db.create(m);this.setUniforms=function(c){c.uniform4fv("lightAmbient",
a);c.uniform4fv("lightDiffuse",x);c.uniform4fv("lightSpecular",n);c.uniform3fv("lightDirection",D)};this.set=function(c){c.ambient&&G.set(c.ambient,a);c.diffuse&&G.set(c.diffuse,x);c.specular&&G.set(c.specular,n);c.direction&&db.set(c.direction,D)};this.get=function(){return{ambient:a,diffuse:x,specular:n,direction:D}};this.getLightDirection=function(){return D};this.getLightAmbient=function(){return a};this.getLightDiffuse=function(){return x};this.getLightSpecular=function(){return n}};return function(n,
c,f,G,a,x){function ba(){var b=N.clone();b.and(pa);return b}function D(b){return b.material.getDrawMode(a)===a.LINES?gc:hc}function Ba(b){return b.material}var S=new fc([1,1,1,1],[1,1,1,1],[1,1,1,1],[0,1,0]),r={},u={},A=[],B=[[],[],[],[],[]],wb=0,pa,La,N,ca=0,O=0,T=0,qa,Ma,K,da=1;a.enable(a.DEPTH_TEST);a.enable(a.CULL_FACE);a.disable(a.BLEND);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);var Ca=a.getContextAttributes().alpha?a.RGBA:a.RGB,eb={angleInstancedArrays:a.getExtension("ANGLE_instanced_arrays")},
U=!0,q={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMap:null,origin:void 0,pixelRatio:null,instanceParameters:void 0,extensions:eb};this.dispose=function(){var b,d,e;for(b in r)for(d in Ib(b),e=r[b],e.origin2data)e.origin2data[d].vbo.dispose();r=null;for(b in u)for(d in Ib(b),e=u[b],e.origin2data)e.origin2data[d].vbo.dispose();u=null;ea.dispose();V.dispose();ra&&a.deleteTexture(ra);ra=null;a.deleteTexture(P);P=null};this.setLightingData=
function(b){S.set(b);U=!0};this.getLightingData=function(){return S.get()};this.setPixelRatio=function(b){da=b;U=!0};this.getPixelRatio=function(){return da};this.addExternalRenderer=function(b,d){m(b<B.length,"invalid slot for external renderer");B[b].push(d);d.setContext(a);d.setTextureRep&&d.setTextureRep(G);return U=!0};this.removeExternalRenderer=function(b,d){m(b<B.length,"invalid slot for external renderer");b=B[b];for(var a=0;a<b.length;a++)if(b[a]===d)return b[a]=b[b.length-1],b.pop(),U=
!0;return!1};this.getExternalRenderers=function(){return B};this.resetNeedsRender=function(){U=!1;for(var b=0;b<B.length;b++)for(var d=B[b],a=0;a<d.length;a++)d[a].resetNeedsRender&&d[a].resetNeedsRender()};this.needsRender=function(){if(U)return!0;for(var b=0;b<B.length;b++)for(var d=B[b],a=0;a<d.length;a++)if(!d[a].needsRender||d[a].needsRender())return!0;return!1};var E,fa=0,sa=0,Da=0,Ea=0,Fa=0,Na=0;this.getCombinedStats=function(){var b={trianglesRendered:fa,drawCallsInstanced:sa,drawCallsAngleInstanced:Da,
drawCallsMerged:Ea,drawCallsFragmented:Fa,instancesDrawnAngle:Na},d=0,a=0,h=0,W,k,g,c;for(W in u)for(g in k=u[W],k.origin2data)c=k.origin2data[g],d+=c.buffer.getArray().length,a+=c.buffer.getSize(),h+=c.optimalCount;for(W in r)for(g in k=r[W],k.origin2data)c=k.origin2data[g],d+=c.buffer.getArray().length,a+=c.buffer.getSize(),h+=c.optimalCount;b.VBOallocatedSize=4*d/1024;b.VBOusedSize=4*a/1024;b.VBOoptimalSize=4*h/1024;return b};this.setContent=function(b){for(var a={},e=0,h=b.length;e<h;++e)a[b[e].uniqueName]=
b[e];b=void 0===E?b:tb(a,E);e=void 0===E?[]:tb(E,a);E=a;this.modify(b,e)};this.setSelectionObject=function(b,a){b?(pa=xb(cb([b])),La=void 0,null!=a&&1==a.length&&(La=[[3*a[0][0],3*a[0][1]]]),N&&(K=ba())):La=K=pa=void 0;U=!0};this.setHighlightObjects=function(b,a){"object"!==typeof a&&(a={});var d=0<T&&(Date.now()-Ma)/1E3<T;ca="number"===typeof a.fadeInTime?a.fadeInTime:.2;O="number"===typeof a.fadeOutTime?a.fadeOutTime:.5;qa="number"===typeof a.holdTime?a.holdTime:1;T=0<=qa?qa+ca+O:0;b&&0!==b.length?
(Ma=Date.now(),N=xb(cb(b)),pa&&(K=ba())):(d||(Ma=Date.now()),ca=0,T=O);U=!0};var hc=new rb(n,[.1,.2,.9,.4],a.EQUAL),gc=new rb(n,[.1,.2,.9,.4],a.EQUAL,a.LINES),P=a.createTexture();a.bindTexture(a.TEXTURE_2D,P);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,4,4,0,a.RGBA,
a.UNSIGNED_BYTE,null);var X=!1;if(Ca===a.RGBA){c=new Uint8Array(64);for(var ga=0;64>ga;ga++)c[ga]=255;var ra=a.createTexture();a.bindTexture(a.TEXTURE_2D,ra);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,4,4,0,a.RGBA,a.UNSIGNED_BYTE,c);var ta=new ab(n,ra,[1,1,1,1],!0,a.ALWAYS)}c=function(b,d,e,h,c){Na=sa=Ea=fa=Fa=Da=0;X=!1;Oa(b.projectionMatrix);for(var k=0;3>k;k++)Pa("material",k,b,e,h),ha(k,b,d,void 0,void 0,Ba,e);Pa("material",3,b,e,h);if(pa){h=
pa;for(var k=La,g=0;4>g;++g)ha(g,b,d,h,k,D,e)}ha(3,b,d,void 0,void 0,Ba,e);if(N)if(h=(Date.now()-Ma)/1E3,0<=qa&&h>=T)K=N=void 0;else{fb[3]=h<ca?.7/ca*h:0<=qa&&h>T-O?.7*(1-(h-(T-O))/O):.7;ea.setSize(b.width,b.height);ea.bind();a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);a.viewport(0,0,b.width,b.height);for(h=0;4>h;++h)ha(h,b,d,N,void 0,Ba,e);if(K)for(h=K,k=0;4>k;++k)ha(k,b,d,h,void 0,D,e);b=b.viewport;a.viewport(b[0],b[1],b[2],b[3]);a.bindFramebuffer(a.FRAMEBUFFER,c);Qa.bind(a,Y);Qa.bindView(a,
Y);V.bind();V.setPointers(Qa.getProgram());a.drawArrays(a.TRIANGLE_STRIP,0,V.getNum());Qa.release(a,Y)}a.bindBuffer(a.ARRAY_BUFFER,null);bb.unuse(a);ta&&!c&&(a.blendFuncSeparate(a.ZERO,a.ONE,a.ONE,a.ZERO),ta.bind(a,Y),ta.bindView(a,Y),V.bind(),V.setPointers(ta.getProgram()),a.drawArrays(a.TRIANGLE_STRIP,0,V.getNum()),ta.release(a),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA));wb++};ga=function(b,d,e,h,c){Na=sa=Ea=fa=Fa=Da=0;X=!1;Oa(b.projectionMatrix);q.view=b.viewMatrix;q.proj=b.projectionMatrix;
q.viewInvTransp=b.viewInverseTransposeMatrix;Z[0]=b.near;Z[1]=b.far;q.nearFar=Z;q.lightingData=S;q.viewport=b.fullViewport;q.framebufferTex=P;q.shadowMap=e;q.pixelRatio=da;q.instanceParameters=void 0;h=A.length;var k=!0;for(c=0;c<h;c++){var g=A[c][1];g.instanced&&(b=g.instanced,!(e=b.material)||e.isVisible&&!e.isVisible()||(Ra(b,e,q,Infinity,d,null,null,!1),k=!0));g.merged&&(b=g.merged,!(e=b.material)||e.isVisible&&!e.isVisible()||(k&&(k=e.getProgram(),k.use(),k.uniformMatrix4fv("model",Q),k.hasUniform("modelNormal")&&
k.uniformMatrix4fv("modelNormal",Q),k=!1),gb(b,e,q,Infinity)))}a.bindBuffer(a.ARRAY_BUFFER,null);bb.unuse(a);wb++};this.render=x?ga:c;var Pa=function(a,d,e,h,c){for(var b=B[d],g=0;g<b.length;g++)b[g].render(a,d,e,S,h,c)};this.renderSimple=function(a,d,e,h,c){Oa(a.projectionMatrix);c=function(a){return a[e]};for(var b=0;4>b;++b)Pa(e,b,a,h),ha(b,a,d,void 0,void 0,c,h)};var Z=cc.create(),ha=function(a,d,e,h,c,k,g){q.view=d.viewMatrix;q.proj=d.projectionMatrix;q.viewInvTransp=d.viewInverseTransposeMatrix;
Z[0]=d.near;Z[1]=d.far;q.nearFar=Z;q.lightingData=S;q.viewport=d.fullViewport;q.framebufferTex=P;q.shadowMap=g;q.pixelRatio=da;q.instanceParameters=void 0;for(var b in u)d=u[b],(g=k(d))&&g.beginSlot(a)&&(!g.isVisible||g.isVisible())&&Ra(d,g,q,a,e,h,c,!1);if(h)for(b in r)d=r[b],(g=k(d))&&g.beginSlot(a)&&(!g.isVisible||g.isVisible())&&Ra(d,g,q,a,null,h,c,!0);else{e=n.getProgramsUsingUniform("model");h=n.getProgramsUsingUniform("modelNormal");for(c=0;c<e.length;c++)d=e[c],d.use(),d.uniformMatrix4fv("model",
Q),-1<h.indexOf(d)&&d.uniformMatrix4fv("modelNormal",Q);for(b in r)d=r[b],(g=k(d))&&g.beginSlot(a)&&(!g.isVisible||g.isVisible())&&gb(d,g,q,a)}},Ra=function(b,d,e,h,c,k,g,ic){var W=!1,l=e.viewport,ia=d.getDrawMode(a),q=eb.angleInstancedArrays,n;for(n in b.origin2data){var r=b.origin2data[n];e.origin=r.origin;var u=!1;if(d.instanced)for(var w in r.perGeometryDataInfo){var m=r.perGeometryDataInfo[w];3!==h||X||(a.bindTexture(a.TEXTURE_2D,P),a.copyTexImage2D(a.TEXTURE_2D,0,Ca,l[0],l[1],l[2],l[3],0),a.clear(a.DEPTH_BUFFER_BIT),
X=!0);W||(d.bind(a,e),W=!0);u||(r.vbo.bind(),r.vbo.setPointers(d.getProgram()),d.bindView(a,e),u=!0);m.instanceBuffer.bind();m.instanceBuffer.setPointers(d.getProgram());var f=m.to-m.from,x=m.refCount;ia===a.TRIANGLES&&(fa+=x*f/3);q.drawArraysInstancedANGLE(ia,m.from,f,x);Da++;Na+=x}else{var m=r.instances,A;for(A in m){var f=m[A],x=f.idx,B=f.displayedIndexRange;g&&(B=g);B&&0===B.length||c&&!c.get(x)||k&&!k.get(x)||(3!==h||X||(a.bindTexture(a.TEXTURE_2D,P),a.copyTexImage2D(a.TEXTURE_2D,0,Ca,l[0],l[1],
l[2],l[3],0),a.clear(a.DEPTH_BUFFER_BIT),X=!0),W||(d.bind(a,e),W=!0),u||(r.vbo.bind(),r.vbo.setPointers(d.getProgram()),d.bindView(a,e),u=!0),ic||d.bindInstance(a,f),sa++,ia===a.TRIANGLES&&(fa+=(f.to-f.from)/3),B?hb(B,f.from,ia):a.drawArrays(ia,f.from,f.to-f.from))}}}W&&d.release(a,e)},hb=function(b,d,e){for(var h=0;h<b.length;h++){var c=b[h];a.drawArrays(e,c[0]+d,c[1]-c[0])}Fa+=b.length-1},gb=function(b,d,e,h){var c=!1,k=e.viewport,g;for(g in b.origin2data){var f=b.origin2data[g];e.origin=f.origin;
if(!f.displayedIndexRange||0!==f.displayedIndexRange.length){3!==h||X||(a.bindTexture(a.TEXTURE_2D,P),a.copyTexImage2D(a.TEXTURE_2D,0,Ca,k[0],k[1],k[2],k[3],0),a.clear(a.DEPTH_BUFFER_BIT),X=!0);c||(d.bind(a,e),c=!0);f.vbo.bind();f.vbo.setPointers(d.getProgram());d.bindView(a,e);Ea++;var r=d.getDrawMode(a);r===a.TRIANGLES&&(fa+=f.vbo.getNum()/3);f.displayedIndexRange?hb(f.displayedIndexRange,0,r):a.drawArrays(r,0,f.vbo.getNum())}}c&&d.release(a,e)},Oa=function(a){for(var b=n.getProgramsUsingUniform("proj"),
e=0;e<b.length;e++)b[e].uniformMatrix4fv("proj",a);if(S)for(b=n.getProgramsUsingUniform("lightDirection"),e=0;e<b.length;e++)S.setUniforms(b[e])};this.print=function(){console.log("number of materials (merged/instanced): "+Object.keys(r).length+"/"+Object.keys(u).length);var a=0,d,e,h;for(d in r)for(h in e=r[d],e.origin2data)a+=Object.keys(e.origin2data[h].instances).length;var c=0;for(d in u)for(h in e=u[d],e.origin2data)c+=Object.keys(e.origin2data[h].instances).length;console.log("number of instances (merged/instanced):"+
a+"/"+c)};this.isEmpty=function(){for(var a in u){var d=u[a],e;for(e in d.origin2data)if(!ub(d.origin2data[e].instances))return!1}for(a in r)for(e in d=r[a],d.origin2data)if(!ub(d.origin2data[e].instances))return!1;return!0};this.modify=function(b,d,e,h){var c=[],k=[];Rb(b,c,k);var g=[],q=[];Rb(d,g,q);var n=[];if(e)for(var l=Zb.UpdateTypes,ia=0;ia<e.length;ia++){var B=e[ia],A=B.renderGeometry,D=Jb(A),E=B.updateType;if(E&l.FACERANGE){var G=A,P=D,X=n,ba=G.material.getId(),S=(P?u:r)[ba].origin2data[G.origin.id],
T=S.instances[G.uniqueName];T&&(T.displayedIndexRange=G.displayedIndexRange,P||X.push(S))}if(E&l.VERTEXATTRS||!D&&E&l.TRANSFORMATION){var ua=A,V=D,N=ua.material,pa=N.getId(),O=(V?u:r)[pa].origin2data[ua.origin.id],K=O.instances[ua.uniqueName],fa=void 0,ha=void 0;if(!V){var Z=ua.origin.vec3;vb(va,-Z[0],-Z[1],-Z[2]);w.multiply(va,ua.transformation,Sa);w.inverse(Sa,Ta);w.transpose(Ta);fa=Sa;ha=Ta}var Q=N.getVertexBufferLayout().getStride();m(K.from+N.getOutputAmount(Aa(ua.data.faces.indices).length)/
Q===K.to,"material VBO layout has changed");N.fillInterleaved(ua.data,fa,ha,ua.instanceParameters,O.buffer.getArray(),K.from*Q);O.vbo.updateSubData(O.buffer.getArray(),K.from*Q,K.to*Q)}else if(D&&E&l.TRANSFORMATION){var Ga=A,ca=Ga.origin.vec3,qa=(D?u:r)[Ga.material.getId()].origin2data[Ga.origin.id],Ha=qa.instances[Ga.uniqueName];vb(va,-ca[0],-ca[1],-ca[2]);w.multiply(va,Ga.transformation,Ha.transformation);w.inverse(Ha.transformation,Ha.transformationNormal);w.transpose(Ha.transformationNormal,Ha.transformationNormal);
var ra=qa.perGeometryDataInfo[Ga.data.id],Ua=ra.instanceBufferData;if(Ua){var ga=Ua.getSlot(Ga.idx);Ua.fill(ga,0,Ha.transformation);Ua.fill(ga,16,Ha.transformationNormal);var ta=Ua.getOffset(ga);ra.instanceBuffer.updateSubData(Ua.getArray(),ta,ta+32)}}else if(E&l.COLORATTRS){var Ia=A,Y=Ia.material,La=Y.getId(),Ma=Ia.origin.id,da=(Jb(Ia)?u:r)[La].origin2data[Ma],ib=da.instances[Ia.uniqueName],Ca={};Ca[dc.COLOR]=!0;var ea=Y.getVertexBufferLayout().getStride();m(ib.from+Y.getOutputAmount(Aa(Ia.data.faces.indices).length)/
ea===ib.to,"material VBO layout has changed");Y.fillInterleaved(Ia.data,void 0,void 0,Ia.instanceParameters,da.buffer.getArray(),ib.from*ea,Ca);da.vbo.updateSubData(da.buffer.getArray(),ib.from*ea,ib.to*ea)}}var sa=[],Da=Sb(c,g,!1),Va;for(Va in Da){var Ea=Da[Va],jb;for(jb in Ea){var aa=Ea[jb],wa=aa.optimalCount,xa=aa.material,Fa=xa.getVertexBufferLayout(),ja=Fa.getStride(),ka=r[Va];if(void 0===ka){m(0<wa);var Na=xa.getRenderPriority(),ka={material:f.aquire(xa),materialDepthShadowMap:f.aquireDepthShadowMap(xa),
materialNormal:f.aquireNormal(xa),materialDepth:f.aquireDepth(xa),origin2data:{}};r[Va]=ka;x&&Tb(ka,Na,"merged")}var t=ka.origin2data[jb];void 0===t&&(m(0<wa),t={instances:{},vbo:new sb(void 0,Fa,a),buffer:new Pb(wa),optimalCount:0,origin:aa.origin},ka.origin2data[jb]=t);var H,Wa,Xa,Ya;if(0<wa){var la=t.buffer.getSize(),Qa=t.buffer.getArray(),yb=wa<aa.sparseCount/2,yb=yb|t.buffer.resize(yb?wa:aa.sparseCount),kb=aa.toRemove;if(yb){var la=0,db=t.buffer.getArray(),Ba=!1,F,zb;H=0;for(Wa=kb.length;H<Wa;++H)F=
t.instances[kb[H].uniqueName],t.optimalCount-=(F.to-F.from)*ja,delete t.instances[kb[H].uniqueName];var Ab={};for(zb in t.instances)F=t.instances[zb],m(void 0===Ab[F.from]),Ab[F.from]=F;for(zb in Ab)F=Ab[zb],Xa=F.from*ja,Ya=F.to*ja,db.set(Qa.subarray(Xa,Ya),la),F.from=la/ja,la+=Ya-Xa,F.to=la/ja,F.displayedIndexRange&&(Ba=!0);m(la==t.optimalCount)}else for(H=0,Wa=kb.length;H<Wa;++H){var Bb=kb[H].uniqueName;m(void 0!==t.instances[Bb]);Xa=t.instances[Bb].from*ja;Ya=t.instances[Bb].to*ja;t.buffer.erase(Xa,
Ya);delete t.instances[Bb];t.optimalCount-=Ya-Xa}vb(va,-aa.origin[0],-aa.origin[1],-aa.origin[2]);var Oa=aa.toAdd;H=0;for(Wa=Oa.length;H<Wa;++H){var ma=Oa[H],Pa=ma.data;w.multiply(va,ma.transformation,Sa);w.inverse(Sa,Ta);w.transpose(Ta);var Ra=la;xa.fillInterleaved(Pa,Sa,Ta,ma.instanceParameters,t.buffer.getArray(),la);var Kb=xa.getOutputAmount(Aa(Pa.faces.indices).length),rb=Ra+Kb;m(void 0===t.instances[ma.uniqueName]);F=new Qb(ma.name,Ra/ja,rb/ja,ma.displayedIndexRange,void 0,void 0,ma.idx);ma.displayedIndexRange&&
(Ba=!0);t.instances[ma.uniqueName]=F;t.optimalCount+=Kb;la+=Kb}m(t.optimalCount===wa);t.vbo.setData(t.buffer.getArray(),t.buffer.getSize());(Ba||t.displayedIndexRange)&&n.push(t)}else m(0===wa),t.vbo.dispose(),delete ka.origin2data[jb],0===Object.keys(ka.origin2data).length&&(sa.push(Va),delete r[Va],x&&Ub(ka,"merged"))}}var ab=Sb(k,q,!0),I,Ja;for(Ja in ab){var bb=ab[Ja],Za;for(Za in bb){var y=bb[Za];if(0===y.optimalCount)I=u[Ja],I.origin2data[Za].vbo.dispose(),delete I.origin2data[Za],0===Object.keys(I.origin2data).length&&
(sa.push(Ja),delete u[Ja],x&&Ub(I,"instanced"));else{var na=y.material;I=u[Ja];if(void 0===I){var tb=na.getRenderPriority();I={material:f.aquire(na),materialDepthShadowMap:f.aquireDepthShadowMap(na),materialNormal:f.aquireNormal(na),materialDepth:f.aquireDepth(na),origin2data:{}};u[Ja]=I;x&&Tb(I,tb,"instanced")}var cb=na.getVertexBufferLayout(),lb=I.material.instanced?na.getInstanceBufferLayout():null,ub=lb&&lb.hasAttribute("instanceColor"),R=cb.getStride(),p=I.origin2data[Za];void 0===p&&(p={instances:{},
vbo:new sb(void 0,cb,a),buffer:new Pb(y.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:y.origin},I.origin2data[Za]=p);var oa=p.buffer.getSize(),wb=p.buffer.getArray(),Cb=y.optimalCount<y.sparseCount/2,Cb=Cb|p.buffer.resize(Cb?y.optimalCount:y.sparseCount),L,$a,ya,za,z,J,Db,C,v;for(z in y.perGeometryDelta)if((v=p.perGeometryDataInfo[z])&&v.instanceBufferData){var eb=y.perGeometryDelta[z].removeCount;0<eb&&v.instanceBufferData.prepareFree(eb)}var Eb=y.toRemove;if(Cb){L=0;for($a=Eb.length;L<
$a;++L)C=Eb[L],delete p.instances[C.uniqueName],z=C.data.id,J=v=p.perGeometryDataInfo[z],0===--J.refCount&&void 0===y.dataId2refCount[z]?(p.optimalCount-=(J.to-J.from)*R,delete p.perGeometryDataInfo[z]):v.instanceBufferData&&v.instanceBufferData.free(C.idx);var oa=0,xb=p.buffer.getArray(),Fb={},fb;for(fb in p.perGeometryDataInfo)J=p.perGeometryDataInfo[fb],m(void 0===Fb[J.from]),Fb[J.from]=J;for(Db in Fb)J=Fb[Db],ya=J.from*R,za=J.to*R,xb.set(wb.subarray(ya,za),oa),J.from=oa/R,oa+=za-ya,J.to=oa/R;
for(Db in p.instances){var M=p.instances[Db];M.from=p.perGeometryDataInfo[M.dataId].from;M.to=p.perGeometryDataInfo[M.dataId].to;M.displayedIndexRange&&(M.displayedIndexRange=Gb.offsetIntervals(M.renderGeometry.displayedIndexRange,M.from))}}else for(L=0,$a=Eb.length;L<$a;++L)C=Eb[L],delete p.instances[C.uniqueName],z=C.data.id,v=p.perGeometryDataInfo[z],0===--v.refCount&&void 0===y.dataId2refCount[z]?(ya=v.from*R,za=v.to*R,p.buffer.erase(ya,za),p.optimalCount-=za-ya,delete p.perGeometryDataInfo[z]):
v.instanceBufferData&&v.instanceBufferData.free(C.idx);vb(va,-y.origin[0],-y.origin[1],-y.origin[2]);for(z in y.perGeometryDelta)if((v=p.perGeometryDataInfo[z])&&v.instanceBufferData){var gb=y.perGeometryDelta[z].addCount;0<gb&&v.instanceBufferData.prepareAllocate(gb)}var hb=y.toAdd;L=0;for($a=hb.length;L<$a;++L){C=hb[L];var Lb=C.data;z=Lb.id;v=p.perGeometryDataInfo[z];if(void 0===v){na.fillInterleaved(Lb,void 0,void 0,void 0,p.buffer.getArray(),oa);var ob=na.getOutputAmount(Aa(Lb.faces.indices).length);
ya=oa/R;oa+=ob;za=oa/R;p.optimalCount+=ob;v={refCount:1,from:ya,to:za,instanceBuffer:null,instanceBufferData:null};lb&&(v.instanceBuffer=new sb(void 0,lb,a),v.instanceBufferData=new $b(lb.getStride(),y.perGeometryDelta[z].addCount));p.perGeometryDataInfo[z]=v}else++v.refCount;m(v.from*R<=p.buffer.getSize()&&v.to*R<=p.buffer.getSize());var pb=w.create();w.multiply(va,C.transformation,pb);var M=new Qb(C.name,v.from,v.to,C.displayedIndexRange,pb,C.instanceParameters,C.idx,z),mb=v.instanceBufferData;
if(mb){var Mb=mb.allocate(C.idx);mb.fill(Mb,0,M.transformation);mb.fill(Mb,16,M.transformationNormal);ub&&mb.fill(Mb,32,C.instanceParameters.color)}p.instances[C.uniqueName]=M}m(p.optimalCount===y.optimalCount);p.vbo.setData(p.buffer.getArray(),p.buffer.getSize());for(z in p.perGeometryDataInfo){var Nb=p.perGeometryDataInfo[z];if(Nb.instanceBuffer){var qb=y.perGeometryDelta[z];if(0<qb.addCount+qb.removeCount){var Vb=Nb.instanceBufferData.compact();Nb.instanceBuffer.setData(Vb,Vb.length)}}}}}}for(var Ob=
0;Ob<n.length;Ob++){var Ka=n[Ob];Ka.displayedIndexRange=[];var Wb=Ka.instances,Xb=!0,Yb;for(Yb in Wb){var nb=Wb[Yb];nb.displayedIndexRange?(Ka.displayedIndexRange.push.apply(Ka.displayedIndexRange,Gb.offsetIntervals(nb.displayedIndexRange,nb.from)),Xb=!1):Ka.displayedIndexRange.push([nb.from,nb.to])}Ka.displayedIndexRange=Xb?null:Gb.mergeIntervals(Ka.displayedIndexRange)}Ib(sa);for(var Hb in h)f.updateMaterialParameters(Hb);U=!0};var ob=1535;this.setThreshold=function(a){ob=a;this.dispose();a=Array(Object.keys(E).length);
var b=0,e;for(e in E)a[b++]=E[e];E=void 0;this.setContent(a)};var Jb=function(a){var b=!1,e=Aa(a.data.faces.indices).length,b=b|!1===a.material.canBeMerged,b=b|a.material.instanced,b=b|a.isBackdrop;return a.singleUse?b:b|=e>ob},Rb=function(a,d,e){for(var b=0;b<a.length;++b)1>Aa(a[b].data.faces.indices).length||(Jb(a[b])?e.push(a[b]):d.push(a[b]))},va=w.identity(),Sa=w.create(),Ta=w.create(),Sb=function(a,d,e){var b={};pb(a,!0,e,b);pb(d,!1,e,b);return b},pb=function(a,d,e,c){for(var b=0,h=a.length;b<
h;++b){var g=a[b],f=g.origin,n=g.material,l=n.getId(),m=e?u[l]:r[l];void 0!==m&&(m=m.origin2data[f.id]);var q=c[l];void 0===q&&(q={},c[l]=q);l=q[f.id];if(void 0===l){l={optimalCount:void 0===m?0:m.optimalCount,sparseCount:void 0===m?0:m.buffer.getSize(),material:n,toAdd:[],toRemove:[],perGeometryDelta:null,origin:f.vec3};if(e){var w={};if(void 0!==m)for(var x in m.perGeometryDataInfo)w[x]=m.perGeometryDataInfo[x].refCount;l.dataId2refCount=w;l.perGeometryDelta={}}q[f.id]=l}f=n.getOutputAmount(Aa(g.data.faces.indices).length);
e?(n=g.data.id,m=l.perGeometryDelta[n],m||(m={addCount:0,removeCount:0},l.perGeometryDelta[n]=m),d?(m.addCount++,void 0===l.dataId2refCount[n]&&(l.dataId2refCount[n]=0),1===++l.dataId2refCount[n]&&(l.optimalCount+=f,l.sparseCount+=f),l.toAdd.push(g)):(m.removeCount++,0===--l.dataId2refCount[n]&&(delete l.dataId2refCount[n],l.optimalCount-=f),l.toRemove.push(g))):d?(l.optimalCount+=f,l.sparseCount+=f,l.toAdd.push(g)):(l.optimalCount-=f,l.toRemove.push(g))}},Tb=function(a,d,e){for(var b,c=a.material.getMaterialId(),
f=A.length,g=0;g<f&&A[g][0]>=d;){b=A[g][1];if(b.id===c){m(!b[e],"matData for type already exists");b[e]=a;return}g++}b={id:c,instanced:null,merged:null};b[e]=a;A.splice(g,0,[d,b])},Ub=function(a,d){var b=a.material.getMaterialId();for(a=0;A[a][1].id!==b;)a++;b=A[a][1];b[d]=null;b.instanced||b.merged||A.splice(a,1)},qb=function(a,d){for(var b=d.length,c=0,f;c<b&&d[c][1].id!==a;)c++;if(c<b&&(a=d[c][1],a=(a.merged||a.instanced).material.getRenderPriority(),f=d[c][0],a!==d[c][0])){d[c][0]=a;for(var k=
a>f?-1:1,c=c+k;-1<c&&c<b&&k*d[c][0]>k*a;)f=d[c],d[c]=d[c-k],d[c-k]=f,c+=k}};this.updateRenderOrder=qb;this.modifyRenderOrder=function(a){if(x){for(var b in a)qb(b,A);U=!0}};var Ib=function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)f.release(a[b]),f.releaseDepth(a[b]),f.releaseNormal(a[b]);else f.release(a),f.releaseDepth(a),f.releaseNormal(a)},xb=function(a){for(var b=new bc,c=0;2>c;++c){var f=0===c?r:u,m;for(m in f){var k=f[m].origin2data,g;for(g in k){var n=k[g].instances,q;for(q in n){var l=
n[q];void 0!==a[l.name]&&b.set(l.idx)}}}}return b},ea=new ac(a.RGB,a.UNSIGNED_BYTE,!0,a.NEAREST,a),fb=[1,1,1,.5],Qa=new ab(n,ea.getTexture(),fb,!0,a.ALWAYS),Q=w.identity();c=db.create();var Y={proj:Q,view:Q,nearFar:[-1,1],origin:c};c=new Float32Array(20);c[0]=-1;c[1]=-1;c[2]=0;c[3]=0;c[4]=0;c[5]=1;c[6]=-1;c[7]=0;c[8]=1;c[9]=0;c[10]=-1;c[11]=1;c[12]=0;c[13]=0;c[14]=1;c[15]=1;c[16]=1;c[17]=0;c[18]=1;c[19]=1;var V=new sb(c,Hb.Defaults.PosTex,a)}});