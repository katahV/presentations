// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/arrayUtils ../../../core/Handles ../../../core/Logger ../../../core/now ../../../core/scheduling ./MemoryController ./StreamDataLoader ./StreamDataSupplier ../webgl-engine/lib/Util".split(" "),function(v,w,h,k,l,m,n,p,q,r,g){function t(){var b={},c;for(c in e.ClientType)b[e.ClientType[c]]=0;b[e.ClientType.TERRAIN]=15;b[e.ClientType.SCENE]=20;b[e.ClientType.SYMBOLOGY]=5;return new q(b)}var u=l.getLogger("esri.views.support.ResourceController"),e=function(){function b(c,
a,f){void 0===a&&(a=n);void 0===f&&(f=m);var d=this;this._view=c;this._memoryController=this._budget=null;this._streamDataLoader=t();this._frameWorkers=[];this._nextFrameWorker=0;this._idleWorkers=[];this._nextIdleWorker=0;this._idleUpdatesStartFired=!1;this._lastTargetChangeTime=0;this._handles=new k;this._frameTask=null;this.idleTimeout=300;this.idleBudget=100;this._budget=new b.Budget(f);this._lastTargetChangeTime=f();this._memoryController=new p(this._view);this._handles.add(this._view.watch("state.camera",
function(){return d._cameraChangedHandler()},!0));this._frameTask=a.addFrameTask({update:function(a){return d._frameUpdate(a)}})}b.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._handles.remove();this._streamDataLoader&&(this._streamDataLoader.destroy(),this._streamDataLoader=null)};Object.defineProperty(b.prototype,"enableBudget",{set:function(c){this._budget.enabled=c},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",
{get:function(){return this._memoryController.updating},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"maxGpuMemory",{set:function(c){this._memoryController.setMaxGpuMemory(c)},enumerable:!0,configurable:!0});b.prototype.setMemoryDirty=function(){this._memoryController.setDirty()};Object.defineProperty(b.prototype,"memoryFactor",{get:function(){return this._memoryController.getMemoryFactor()},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"usedMemory",{get:function(){return this._memoryController.getUsedMemory()},
enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"memoryEvents",{get:function(){return this._memoryController.events},enumerable:!0,configurable:!0});b.prototype.getStreamDataSupplier=function(c,a){return new r(c,this._streamDataLoader,a)};b.prototype.registerIdleFrameWorker=function(c,a){var b=this._idleWorkers.some(function(a){return a.client===c});g.assert(!b,"Can only register idle frame workers once per client/layer");g.assert(!a.idleFrame||a.needsUpdate,"needsUpdate has to be specified if idleFrame is specified");
this._idleWorkers.push({client:c,callbacks:a});this._isIdle()&&this._idleUpdatesStartFired&&a.idleBegin&&a.idleBegin.call(c)};b.prototype.deregisterIdleFrameWorker=function(c){for(var a=this._idleWorkers,b=0;b<a.length;b++){var d=a[b];if(d.client===c){this._idleUpdatesStartFired&&d.callbacks.idleEnd&&d.callbacks.idleEnd.call(c);a[b]=a[a.length-1];a.pop();this._nextIdleWorker>=a.length&&(this._nextIdleWorker=0);break}}};b.prototype.registerFrameWorker=function(c){-1===this._frameWorkers.indexOf(c)&&
this._frameWorkers.push(c)};b.prototype.deregisterFrameWorker=function(c){h.removeUnordered(this._frameWorkers,c)?this._nextFrameWorker>=this._frameWorkers.length&&(this._nextFrameWorker=0):u.warn("Can't deregister unknown frame handler")};b.prototype._cameraChangedHandler=function(){this._lastTargetChangeTime=this._budget.now();this.setMemoryDirty();this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._callIdleWorkers("idleEnd"))};b.prototype._frameUpdate=function(c){var a=Math.max(c.frameDuration-
c.elapsedFrameTime-5,10),b=this.idleBudget-c.elapsedFrameTime;this._view._stage&&!this._view._stage.getRenderParams().idleSuspend&&(b=a);a=this._isIdle()?b:a;this._budget.reset(a);this._view.stateManager&&this._view.stateManager.step(c.deltaTime/1E3);this._memoryController.update();for(c=0;c<this._frameWorkers.length;++c)if(a=(this._nextFrameWorker+c)%this._frameWorkers.length,this._frameWorkers[a](this._budget),3>this._budget.remaining()){this._nextFrameWorker=(a+1)%this._frameWorkers.length;break}this._isIdle()&&
(this._idleUpdatesStartFired||(this._callIdleWorkers("idleBegin"),this._idleUpdatesStartFired=!0),this._budget.reset(this.idleBudget-this._budget.elapsed()),this._callIdleFrameWorkers())};b.prototype._isIdle=function(){return this._budget.now()-this._lastTargetChangeTime>this.idleTimeout};b.prototype._callIdleWorkers=function(b){for(var a=this._idleWorkers,c=0;c<a.length;c++){var d=a[c];d.callbacks[b]&&d.callbacks[b].call(d.client)}};b.prototype._callIdleFrameWorkers=function(){for(var b=0;b<this._idleWorkers.length;++b){var a=
(this._nextIdleWorker+b)%this._idleWorkers.length;if(this._budget.done()){this._nextIdleWorker=a;break}a=this._idleWorkers[a];a.callbacks.needsUpdate&&a.callbacks.needsUpdate.call(a.client)&&a.callbacks.idleFrame.call(a.client,this._budget)}};return b}();(function(b){(function(a){a.TERRAIN="terrain";a.SCENE="scene";a.SYMBOLOGY="symbology"})(b.ClientType||(b.ClientType={}));var c=function(){function a(a){this._nowFunc=a;this.enabled=!0;this.budget=this.begin=0}a.prototype.now=function(){return this._nowFunc()};
a.prototype.reset=function(a){this.begin=this.now();this.budget=this.enabled?a:Number.MAX_VALUE};a.prototype.done=function(){return this.enabled&&this.elapsed()>=this.budget};a.prototype.remaining=function(){return this.enabled?Math.max(this.budget-this.elapsed(),0):Number.POSITIVE_INFINITY};a.prototype.elapsed=function(){return this.now()-this.begin};return a}();b.Budget=c})(e||(e={}));return e});