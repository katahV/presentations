// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/tsSupport/decorateHelper ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/tsSupport/generatorHelper ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/QueueProcessor ../../../../core/throttle ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../../../tasks/support/QuantizationParameters".split(" "),
function(u,m,z,e,A,B,C,D,E,F,G,H,I,J,h,k,K,L){Object.defineProperty(m,"__esModule",{value:!0});var w=F.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");u=function(l){function b(a){a=l.call(this,a)||this;a.displayLimitExceeded=!1;a.displayLimitExceededThrottle=1E3;a.handles=new E;a.idToFeatureTile=new Map;a.displayingFeatureReferences=new Map;a.suspended=!0;return a}z(b,l);Object.defineProperty(b.prototype,"displayFeatureLimit",{set:function(a){var d=this._get("displayFeatureLimit");
a===d||a&&d&&a.min===d.min&&a.max===d.max&&a.perTile===d.perTile||(this._set("displayFeatureLimit",A({},a)),this.update())},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this.fetchQueue.length},enumerable:!0,configurable:!0});Object.defineProperty(b.prototype,"filterExtent",{set:function(a){if(a&&this.tilingScheme&&!a.spatialReference.equals(this.tilingScheme.spatialReference))w.error("#filterExtent\x3d","extent needs to be in the same spatial reference as the tiling scheme");
else{var d=this._get("filterExtent");d===a||d&&a&&d.equals(a)||(a=a?a.clone():null,this._set("filterExtent",a),this.reclip(a,d))}},enumerable:!0,configurable:!0});b.prototype.initialize=function(){var a=this;this.updateDisplayLimitExceededThrottled=I.throttle(this.updateDisplayLimitExceeded,this.displayLimitExceededThrottle,this);this.capabilities=this.calculateCapabilities();this.fetchQueue=this.createFetchQueue();this.handles.add(J.on(this,"tileDescriptors","change",function(){return a.update()},
function(){return a.update()}));this.update()};b.prototype.destroy=function(){var a=this;this.handles&&(this.handles.destroy(),this.handles=null);this.updateDisplayLimitExceededThrottled.remove();this.forEachFeatureTile(function(d){return a.cancelFetchTile(d)});this.fetchQueue.clear()};b.prototype.filtersChanged=function(){var a=this;this.fetchQueue.clear();this.forEachFeatureTile(function(d){a.resetFetchTile(d);a.queueFetchTile(d)});this.update()};b.prototype.suspend=function(){this.suspended||(this.suspended=
!0,this.fetchQueue.pause(),this.fetchQueue.reset())};b.prototype.resume=function(){this.suspended&&(this.suspended=!1,this.update(),this.fetchQueue.resume())};b.prototype.getFeatureTileById=function(a){return this.idToFeatureTile.get(a)||null};b.prototype.forEachFeatureTile=function(a){this.idToFeatureTile.forEach(a)};b.prototype.calculateCapabilities=function(){var a=this.layer,d=!!(a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsPagination),a=!!(a.capabilities&&a.capabilities.query&&
a.capabilities.query.supportsResultType);return{supportsMultipleResolutions:this.calculateSupportsMultipleResolutions(),supportsPagination:d,supportsResultType:a}};b.prototype.calculateSupportsMultipleResolutions=function(){var a=this.layer,d=a.geometryType;return"polyline"===d?!0:"polygon"===d?a.capabilities&&a.capabilities.query&&a.capabilities.query.supportsQuantization:!1};b.prototype.createFetchQueue=function(){var a=this;return new H({concurrency:6,ordered:!0,peeker:function(d){return a.highestPriorityTile(d)},
process:function(d){return a.fetchTile(d)}})};b.prototype.highestPriorityTile=function(a){return a.reduce(function(a,c){return a&&a.descriptor.loadPriority<=c.descriptor.loadPriority?a:c},null)};b.prototype.update=function(){if(!this.suspended&&this.constructed){var a=this.getListOfTiles();this.markTilesNotAlive(a);this.addTiles(a);a=this.sortTiles(a);this.removeTiles(a);this.displayTiles(a);this.queueFetchTiles(a);this.updated()}};b.prototype.markTilesNotAlive=function(a){for(var d=0;d<a.length;d++)a[d].alive=
!1};b.prototype.addTiles=function(a){var d=this;this.tileDescriptors.forEach(function(c){var b=d.getFeatureTileById(c.id);b?b.alive=!0:a.push(d.addTile(c))})};b.prototype.removeTiles=function(a){for(var d=0;d<a.length;d++){var c=a[d];c.alive&&!c.intersects(this.filterExtent)&&this.clearTile(c)}for(var d=!1,b=a.length-1;0<=b;b--)c=a[b],c.displayingFeatures&&0<c.displayingFeatures.length&&this.displayFeatureLimit&&this.displayingFeatureReferences.size<=this.displayFeatureLimit.min?c.alive=!0:c.alive||
(this.removeTile(c),b!==a.length-1&&(d=!0),a[b]=a[a.length-1],a.pop());d&&this.sortTiles(a)};b.prototype.sortTiles=function(a){a.sort(function(a,c){return a.descriptor.loadPriority-c.descriptor.loadPriority});return a};b.prototype.displayTiles=function(a){for(var d=0,c=a.length-1,b=null;d<=c;)if(!b&&this.isDisplayingFeaturesAtMaximumLimit()){var g=a[c--],v=this.featureCountDifferenceWhenHidingTile(g);this.displayFeatureLimit&&this.displayingFeatureReferences.size-v>=this.displayFeatureLimit.max?this.hideTile(g):
b=g}else g=a[d++],v=this.featureCountDifferenceWhenShowingTile(g),0<v&&b&&(this.hideTile(b),b=null),this.showTile(g)};b.prototype.queueFetchTiles=function(a){var d=a.length-1;if(this.isDisplayingFeaturesAtMaximumLimit())for(var c=a.length-1;0<=c;c--){var b=a[c];b.displayingFeatures&&0<b.displayingFeatures.length&&(d=c)}for(c=0;c<=d;c++)this.queueFetchTile(a[c])};b.prototype.reclip=function(a,d){var b=this;if(this.constructed){var f=[];this.forEachFeatureTile(function(c){c.displayingFeatures&&(c.intersection(d,
p),c.intersection(a,x),k.equals(p,x)||(f.push(c),b.hideTile(c)))});for(var g=0;g<f.length;g++)this.showTile(f[g]);this.updated()}};b.prototype.updated=function(){this.notifyChange("updating");this.debugger&&this.debugger.update();this.updateDisplayLimitExceededThrottled()};b.prototype.updateDisplayLimitExceeded=function(){var a=!1;this.forEachFeatureTile(function(d){if(d.perTileDisplayLimitExceeded||!d.displayingFeatures&&!d.isFetchFetching)a=!0});a?this._set("displayLimitExceeded",!0):this.updating||
this._set("displayLimitExceeded",!1)};b.prototype.addTile=function(a){a=new y(a);this.idToFeatureTile.set(a.id,a);this.resetFetchTile(a);this.referenceDisplayingFeaturesFromRelatedTiles(a);return a};b.prototype.referenceDisplayingFeaturesFromRelatedTiles=function(a){var d=this;this.forEachFeatureTile(function(c){if(c.displayingFeatures&&d.tilesAreRelated(a,c)){a.displayingFeatures||(a.displayingFeatures=[]);var b=0;for(c=c.displayingFeatures;b<c.length;b++){var g=c[b];a.displayingFeatures.push(g);
d.getDisplayingFeatureReference(g).ref()}}})};b.prototype.tilesAreRelated=function(a,d){a=a.descriptor.lij;var b=d.descriptor.lij;if(!a||!b)return!1;var f=a[0]<b[0];d=f?a:b;a=f?b:a;b=a[0]-d[0];if(0===b)return!1;b=1<<b;return Math.floor(a[1]/b)===d[1]&&Math.floor(a[2]/b)===d[2]};b.prototype.removeTile=function(a){this.clearTile(a);this.idToFeatureTile.delete(a.id)};b.prototype.resetFetchTile=function(a){a.intersects(this.filterExtent)?a.fetchStatus=0:0===a.fetchStatus&&(a.fetchStatus=2)};b.prototype.cancelFetchTile=
function(a){var b=a.fetchRequest;b&&(a.fetchRequest=null,a.fetchStatus=0,b.cancel())};b.prototype.fetchTile=function(a){var b=this,c,f=function(a){return c=a};return G.create(function(d,c){b.fetchTileAll(a,f).then(d,c)},function(a){return c&&c.cancel(a)})};b.prototype.setPagingParameters=function(a,b,c){if(!this.capabilities.supportsPagination)return!1;var d=this.capabilities.supportsResultType&&this.layer.tileMaxRecordCount||this.layer.maxRecordCount||M;a.start=b;0<c&&this.capabilities.supportsResultType?
(a.maxRecordCountFactor=Math.ceil(c/d),a.num=c):a.num=Math.min(d,c);return!0};b.prototype.fetchTileAll=function(a,b){return B(this,void 0,void 0,function(){var d,f,g,l,n,h,e,k,m;return C(this,function(c){switch(c.label){case 0:d=0,f=[],g=this.displayFeatureLimit&&this.displayFeatureLimit.perTile,a.perTileDisplayLimitExceeded=!1,c.label=1;case 1:return n=this.createQuery(a),h=this.setPagingParameters(n,d,g),e=void 0,this.layer.queryFeaturesJSON?[4,b(this.layer.queryFeaturesJSON(n))]:[3,3];case 2:return k=
c.sent(),e=K.fromFeatureSetJSON(k),l=k.exceededTransferLimit,[3,5];case 3:return[4,b(this.layer.queryFeatures(n))];case 4:m=c.sent(),e=m.features,l=m.exceededTransferLimit,c.label=5;case 5:f=0===f.length?e:f.concat(e);if(!h||!l||0<g&&f.length>=g)return[3,6];a.features=a.needsDisplayUpdate?a.features.concat(e):a.displayingFeatures?a.displayingFeatures.concat(e):e;this.update();d+=n.num;return[3,1];case 6:b(null);if(g&&f.length>g)return a.perTileDisplayLimitExceeded=!0,[2,f.slice(0,g)];l&&(a.perTileDisplayLimitExceeded=
!0);return[2,f]}})})};b.prototype.createQuery=function(a){var b=this.tilingScheme.spatialReference,c=a.descriptor.extent,f=this.layer.createQuery();c&&(f.geometry=k.toExtent(c,b));f.outSpatialReference=b;this.setResolutionParams(f,a);this.capabilities.supportsResultType&&(f.resultType="tile");return f};b.prototype.setResolutionParams=function(a,b){if(this.capabilities.supportsMultipleResolutions){var d=this.layer,f=d.geometryType;b=b.descriptor.resolution;null!=b&&("polyline"===f?a.maxAllowableOffset=
b:"polygon"===f&&(a.quantizationParameters=new L.default({mode:"view",originPosition:"upper-left",tolerance:b,extent:d.fullExtent})))}};b.prototype.queueFetchTile=function(a){var b=this;if(a.isFetchPending){var c=!1,f=this.fetchQueue.push(a).then(function(b){a.fetchRequest=null;a.fetchStatus=2;a.features=b}).catch(function(b){a.fetchRequest===f&&(a.fetchRequest=null,a.fetchStatus=2);b&&"cancel"===b.dojoType?c=!0:(a.features=[],w.error("#fetchTile()",b&&b.message?b.message:b))}).then(function(){c||
b.update()});f.isFulfilled()?a.fetchStatus=2:(a.fetchRequest=f,a.fetchStatus=1)}};b.prototype.getFeatureId=function(a){return a.attributes[this.layer.objectIdField]};b.prototype.getDisplayingFeatureReference=function(a){return this.displayingFeatureReferences.get(this.getFeatureId(a))};b.prototype.serializeFeature=function(a){var b=JSON.stringify(a.attributes);return JSON.stringify(a.geometry)+b};b.prototype.displayingFeatureNeedsReplacement=function(a,b,c){if(this.capabilities.supportsMultipleResolutions&&
c.descriptor.resolution>a.resolution)return!0;a=this.serializeFeature(a.feature);b=this.serializeFeature(b);return a!==b};b.prototype.showTile=function(a){if(!a.displayingFeatures||a.needsDisplayUpdate)if(a.features){for(var b=a.descriptor.resolution,c=0,f=a.features;c<f.length;c++){var g=f[c],l=this.getFeatureId(g),e=this.displayingFeatureReferences.get(l);if(e)if(e.ref(),this.displayingFeatureNeedsReplacement(e,g,a))q.push(e.feature),e.feature=g,e.resolution=a.descriptor.resolution;else continue;
else this.displayingFeatureReferences.set(l,new N(g,b));r.push(g)}this.hideTileFeatures(a);0<q.length&&this.features.removeMany(q);0<r.length&&this.features.addMany(r);q.length=0;r.length=0;a.displayingFeatures=a.features}else a.displayingFeatures=[]};b.prototype.featureCountDifferenceWhenShowingTile=function(a){if(!a.needsDisplayUpdate)return 0;for(var b=-this.featureCountDifferenceWhenHidingTile(a,!0),c=0,f=a.features;c<f.length;c++){var g=this.getDisplayingFeatureReference(f[c]);(!g||g.isSingle&&
g.markedTile===a)&&b++}return b};b.prototype.featureCountDifferenceWhenHidingTile=function(a,b){void 0===b&&(b=!1);if(!a.displayingFeatures)return 0;for(var c=0,d=0,g=a.displayingFeatures;d<g.length;d++){var e=this.getDisplayingFeatureReference(g[d]);e&&e.isSingle&&(b&&(e.markedTile=a),c++)}return c};b.prototype.hideTile=function(a){this.cancelFetchTile(a);this.hideTileFeatures(a)};b.prototype.hideTileFeatures=function(a){if(a.displayingFeatures){for(var b=0,c=a.displayingFeatures;b<c.length;b++){var f=
this.getFeatureId(c[b]),g=this.displayingFeatureReferences.get(f);g&&!g.unref()&&(this.displayingFeatureReferences.delete(f),t.push(g.feature))}0<t.length&&this.features.removeMany(t);t.length=0}a.displayingFeatures=null};b.prototype.clearTile=function(a){this.hideTile(a);a.features=null};b.prototype.isDisplayingFeaturesAtMaximumLimit=function(){return this.displayFeatureLimit&&this.displayingFeatureReferences.size>=this.displayFeatureLimit.max};b.prototype.getListOfTiles=function(){var a=Array(this.idToFeatureTile.size),
b=0;this.forEachFeatureTile(function(c){return a[b++]=c});return a};e([h.property({constructOnly:!0})],b.prototype,"features",void 0);e([h.property()],b.prototype,"tileDescriptors",void 0);e([h.property({constructOnly:!0})],b.prototype,"tilingScheme",void 0);e([h.property()],b.prototype,"displayFeatureLimit",null);e([h.property({constructOnly:!0})],b.prototype,"layer",void 0);e([h.property({readOnly:!0})],b.prototype,"updating",null);e([h.property({readOnly:!0})],b.prototype,"displayLimitExceeded",
void 0);e([h.property({constructOnly:!0})],b.prototype,"displayLimitExceededThrottle",void 0);e([h.property()],b.prototype,"filterExtent",null);return b=e([h.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],b)}(h.declared(D));m.FeatureTileFetcher3D=u;var y=function(){function e(b){this.descriptor=b;this.fetchRequest=null;this.fetchStatus=0;this.displayingFeatures=this.features=null;this.perTileDisplayLimitExceeded=!1;this.alive=!0}Object.defineProperty(e.prototype,"id",{get:function(){return this.descriptor.id},
enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"isFetchFetching",{get:function(){return 1===this.fetchStatus},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"isFetchPending",{get:function(){return 0===this.fetchStatus},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"isFetchDone",{get:function(){return 2===this.fetchStatus},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"needsDisplayUpdate",{get:function(){return this.features&&
this.displayingFeatures!==this.features},enumerable:!0,configurable:!0});e.prototype.intersects=function(b){if(!b||!this.descriptor.extent)return!0;k.fromExtent(b,p);return k.intersects(this.descriptor.extent,p)};e.prototype.intersection=function(b,a){void 0===a&&(a=k.create());if(!b&&!this.descriptor.extent)return a;b?(k.fromExtent(b,a),this.descriptor.extent&&k.intersection(a,this.descriptor.extent,a)):k.set(a,this.descriptor.extent);return a};return e}();m.FeatureTile=y;var N=function(){function e(b,
a){this.feature=b;this.resolution=a;this.refCount=1}Object.defineProperty(e.prototype,"isReferenced",{get:function(){return 0!==this.refCount},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"isSingle",{get:function(){return 1===this.refCount},enumerable:!0,configurable:!0});e.prototype.ref=function(){this.refCount+=1};e.prototype.unref=function(){return 0<this.refCount?(--this.refCount,this.isReferenced):!0};return e}(),M=2E3,p=k.create(),x=k.create(),r=[],q=[],t=[];m.default=u});