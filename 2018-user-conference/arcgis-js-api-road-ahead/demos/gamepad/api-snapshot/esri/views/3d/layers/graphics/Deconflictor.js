// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../core/Handles ../../../../core/Logger ../../../../core/PooledArray ../../../../core/watchUtils ../../../../geometry/support/aaBoundingRect ./deconflictorDebug ../../lib/glMatrix ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial ../../webgl-engine/materials/internal/MaterialUtil".split(" "),function(C,V,W,K,y,z,L,q,v,n,M,D,N,w){function A(a){return!!a&&"selection"===
a.type}C=n.vec2d;n=n.vec4d;var E=D.VertexAttrConstants,O=y.getLogger("esri.views.3d.graphics.Deconflictor"),F=n.create(),x=n.create(),G=n.create(),P=n.create(),Q=q.create(),R=q.create(),S=new Set,H=D.lerp,p=new z(100),r=new z(100),T=function(){function a(b,c){this.creator=b;this.disposer=c;this.list=[];this.currentIndex=0}a.prototype.alloc=function(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];this.currentIndex>=this.list.length&&this.list.push(new this.creator(b));return this.list[this.currentIndex++]};
a.prototype.freeAll=function(){for(var b=this.currentIndex,c=this.disposer,l=this.list;0<=--b;)c(l[b]);this.currentIndex=0};return a}(),I=function(){function a(){this.graphics3DGraphic=null;this.posView=this.yMax=this.yMin=this.xMax=this.xMin=0;this.graphicsOwner=null;this.id=0}a.release=function(b){b.graphics3DGraphic=null;b.graphicsOwner=null};return a}();y=function(){function a(b){var c=this;this.graphicsOwners=[];this.deconflictTimeoutId=0;this.handles=new K;this.graphicInfoPool=new T(I,I.release);
this.nextGraphicInfoId=0;this.accBinsNumX=15;this.accBinsNumY=20;this.accBinsSizeY=this.accBinsSizeX=0;this.accBins=null;this.accNumTests=0;this.iconMarginFactor=-.1;this.view=b;this.handles.add([b.watch("state.camera",function(){return c.scheduleRun()}),L.whenNot(b,"ready",function(){return c.clearDeconflictTimeout()})])}a.prototype.destroy=function(){this.handles.destroy();this.handles=null;this.clearDeconflictTimeout();this.graphicInfoPool.freeAll();this.view=this.graphicInfoPool=null};a.prototype.clearDeconflictTimeout=
function(){this.deconflictTimeoutId&&(clearTimeout(this.deconflictTimeoutId),this.deconflictTimeoutId=0)};a.prototype.addGraphicsOwner=function(b){var c=this;this.graphicsOwners.push(b);this.setDirty();b.layer&&"function"===typeof b.layer.watch&&b.layer.watch("featureReduction",function(l,a){A(l)?c.setDirty():A(a)&&(c._removeIconVisibilityFlags(b),c.setDirty())})};a.prototype.removeGraphicsOwner=function(b){b=this.graphicsOwners.indexOf(b);0<=b&&this.graphicsOwners.splice(b,1);this.setDirty()};a.prototype.setDirty=
function(){this.scheduleRun(10)};a.prototype.initializeLabelVisibility=function(b){b.setVisibilityFlag(2,!1,1)};a.prototype.doesIntersectExistingPoly=function(b){var c=b.graphics3DGraphic.graphic.uid;S.clear();for(var l=Math.floor(b.xMin/this.accBinsSizeX);l<=Math.floor(b.xMax/this.accBinsSizeX);l++)if(!(0>l||l>=this.accBinsNumX))for(var a=Math.floor(b.yMin/this.accBinsSizeY);a<=Math.floor(b.yMax/this.accBinsSizeY);a++)if(!(0>a||a>=this.accBinsNumY))for(var d=this.accBins[l][a],h=0;h<d.length;h++){var g=
d.data[h];if(g.graphics3DGraphic.graphic.uid!==c&&(this.accNumTests++,!(g.xMin>b.xMax||g.xMax<b.xMin||g.yMin>b.yMax||g.yMax<b.yMin)))return!0}return!1};a.prototype.initBins=function(b,c){if(null==this.accBins){this.accBins=[];for(var a=0;a<this.accBinsNumX;a++){this.accBins.push([]);for(var m=this.accBins[this.accBins.length-1],d=0;d<this.accBinsNumY;d++)m.push(new z(10))}}for(a=0;a<this.accBinsNumX;a++)for(d=0;d<this.accBinsNumY;d++)this.accBins[a][d].clear();this.accBinsSizeX=b/this.accBinsNumX;
this.accBinsSizeY=c/this.accBinsNumY;this.accNumTests=0};a.prototype.addToBins=function(b){for(var c=Math.floor(b.xMin/this.accBinsSizeX);c<=Math.floor(b.xMax/this.accBinsSizeX);c++)if(!(0>c||c>=this.accBinsNumX))for(var a=Math.floor(b.yMin/this.accBinsSizeY);a<=Math.floor(b.yMax/this.accBinsSizeY);a++)0>a||a>=this.accBinsNumY||this.accBins[c][a].push(b)};a.prototype.scheduleRun=function(b){var c=this;void 0===b&&(b=200);0===this.deconflictTimeoutId&&(this.deconflictTimeoutId=setTimeout(function(){return c.run()},
b))};a.prototype.run=function(){this.clearDeconflictTimeout();this.view.ready?(this.graphicInfoPool.freeAll(),this.nextGraphicInfoId=0,v.prepare(this.view),this._collectVisibleObjects()&&(this._deconflictVisibleObjects(p,!1),r.length&&this._deconflictVisibleObjects(r,!0),v.drawAccelerationStruct(this,p),v.drawAccelerationStruct(this,r))):this.setDirty()};a.prototype._collectVisibleObjects=function(){var b=this.view.state.camera,c=b.fullWidth,a=b.fullHeight;p.clear();r.clear();for(var m=!1,d=0;d<this.graphicsOwners.length;d++){var h=
this.graphicsOwners[d],g=h.labelsEnabled,J=A(h.layer?h.layer.featureReduction:null);if(g||J){var q=h.graphics3DGraphics;if(q){var e=h.graphics3DGraphicsKeys;if(e){m||(this.initBins(c,a),m=!0);for(var n=0;n<e.length;n++){var f=q[e[n]];f.areVisibilityFlagsSet(void 0,2)&&(J&&this._collectGraphics(f,f._graphics,0,h,b,p,this.iconMarginFactor),g&&this._collectGraphics(f,f._labelGraphics,1,h,b,r))}}}}}p.sort(function(b,a){return a.posView-b.posView});r.sort(function(b,a){return a.posView-b.posView});return m};
a.prototype._collectGraphics=function(b,a,l,n,d,h,g){void 0===g&&(g=0);if(a.length){for(var c=q.empty(Q),m,e,r=0;r<a.length;r++){var f=a[r];if(f&&"object3d"===f.type){var t=f.stageObject,p=t?t.getNumGeometryRecords():0;if(!(1>p)){var u=t.getGeometryRecord(0),k=u.materials[0];if(k instanceof N)if(1<p)O.warn("Graphic objects with more than 1 geometry record are not supported");else{p=u.geometry.getData().getVertexAttr();if(!e){e=t.getCenter();u=u.origin.vec3;w.transformToWorld(e,u,F);w.transformToView(F,
u,d.viewMatrix,x);k.applyVerticalOffsetTransformation(x,p[E.NORMAL].data,t.objectTransformation,d,B);t=p[E.AUXPOS1].data;u="screen"!==k.getParams().centerOffsetUnits;w.transformToProjection(x,d.projectionMatrix,u?t:[0,0,0],G);e=w.transformToNDC(G,P);u||(e[0]+=t[0]/d.fullWidth*2,e[1]+=t[1]/d.fullHeight*2);if(-1>e[0]||-1>e[1]||-1>e[2]||1<=e[0]||1<=e[1])break;m=x[2];b.areVisibilityFlagsSet(2,void 0,l)&&(m*=.7)}f=f.getScreenSize(U);M.applyPrecomputedScaleFactorVec2(f,B.factor,f);k=q.offset(k.calculateRelativeScreenBounds(f,
B.scaleAlignment,R),H(0,d.fullWidth,.5+.5*e[0]),H(0,d.fullHeight,.5+.5*e[1]));0!==g&&(f=g*Math.min(q.width(k),q.height(k)),k[0]-=f,k[1]-=f,k[2]+=f,k[3]+=f);q.expand(c,k)}}}}null!=m&&(a=this.graphicInfoPool.alloc(),a.id=this.nextGraphicInfoId++,a.xMin=c[0],a.yMin=c[1],a.xMax=c[2],a.yMax=c[3],a.graphics3DGraphic=b,a.posView=m,a.graphicsOwner=n,h.push(a))}};a.prototype._deconflictVisibleObjects=function(b,a){for(var c=a?1:0,m=0;m<b.length;m++){var d=b.data[m],h=d.graphics3DGraphic,g=!(a&&!1===h.areVisibilityFlagsSet(2))&&
!this.doesIntersectExistingPoly(d);g&&this.addToBins(d);h.setVisibilityFlag(2,g,c);v.drawPoly(d,g?"green":"red")}};a.prototype._removeIconVisibilityFlags=function(b){var a=b.graphics3DGraphics;b=b.graphics3DGraphicsKeys;if(null!=a&&null!=b)for(var l=0;l<b.length;l++)a[b[l]].setVisibilityFlag(2,void 0)};return a}();var B={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},U=C.create();return y});