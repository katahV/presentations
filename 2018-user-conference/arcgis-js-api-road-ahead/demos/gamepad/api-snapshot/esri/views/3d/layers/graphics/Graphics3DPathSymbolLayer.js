// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper ../../../../geometry/Point ../../../../layers/graphics/dehydratedFeatures ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolCommonCode ./Graphics3DSymbolLayer ./graphicUtils ../../../../views/3d/lib/glMatrix ../../support/projectionUtils ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Util ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(A,Y,L,M,N,O,n,P,Q,B,R,C,S,D,T,E,U){function V(F,f,b,a){for(var e=F.getGeometryRecords(),G=e.length,H="absolute-height"!==f.mode,l=0,g=0;g<G;g++){var I=e[g].geometry,p=[e[g].transformation[12],e[g].transformation[13],e[g].transformation[14]],k=I.getData().getVertexAttr(),q=k[W.POSITION].data,y=k.zOffset.data,k=k.mapPos.data,v=k.length/3;X(q.length/3===v*z+2,"unexpected tube geometry");var m=0,w=0;r.spatialReference=b.spatialReference;for(var u=0,c=0;c<v;c++){r.x=k[3*c];r.y=k[3*c+1];r.z=k[3*
c+2];var h=n.computeElevation(b,r,f,a,H?J:null);H&&(u+=J.terrainElevation);var t=z;0!==c&&c!==v-1||t++;for(var x=0;x<t;x++)d[0]=q[m]+p[0],d[1]=q[m+1]+p[1],d[2]=q[m+2]+p[2],a.setAltitude(h+y[w],d),q[m]=d[0]-p[0],q[m+1]=d[1]-p[1],q[m+2]=d[2]-p[2],m+=3,w+=1;I.invalidateBoundingInfo()}F.geometryVertexAttrsUpdated(g);l+=u/v}return l/G}var x=B.vec3d,K=B.mat4d,X=E.assert;A=function(d){function f(){return null!==d&&d.apply(this,arguments)||this}L(f,d);f.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var b=
Q.validateSymbolLayerSize(this._getSymbolSize());if(b){this._logWarning(b);this.reject();return}}var b=this._getStageIdHint(),a=this._getMaterialOpacityAndColor(),e=x.create(a),a=a[3],e={diffuse:e,ambient:e,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};this._material=new U(e,b+"_3dlinemat");this._context.stage.add(C.ModelContentType.MATERIAL,this._material);this.resolve()};f.prototype.destroy=function(){d.prototype.destroy.call(this);
this.isFulfilled()||this.reject();this._material&&(this._context.stage.remove(C.ModelContentType.MATERIAL,this._material.id),this._material=null)};f.prototype.createGraphics3DGraphic=function(b){var a=b.graphic;if("polyline"!==a.geometry.type)return this._logWarning("unsupported geometry type for path symbol: "+a.geometry.type),null;if(!this._validateGeometry(a.geometry))return null;var e="graphic"+a.uid,f=this.getGraphicElevationContext(a);return this._createAs3DShape(a,b.renderingInfo,f,e,a.uid)};
f.prototype.layerPropertyChanged=function(b,a,e){if("opacity"===b)return a=this._getMaterialOpacity(),e=1>a||this._isPropertyDriven("opacity"),this._material.setParameterValues({opacity:a,transparent:e}),!0;if("elevationInfo"===b){this._updateElevationContext();for(var f in a){var d=a[f];if(b=e(d))d=this.getGraphicElevationContext(d.graphic),b.needsElevationUpdates=n.needsElevationUpdates3D(d.mode),b.elevationContext.set(d)}return!0}return!1};f.prototype._getPathSize=function(b){b=b.size&&this._isPropertyDriven("size")?
n.getSingleSizeDriver(b.size):this._getSymbolSize();return b/=this._context.renderCoordsHelper.unitInMeters};f.prototype._getSymbolSize=function(){return this.symbol.size||1};f.prototype._createAs3DShape=function(b,a,e,d,f){var l=b.geometry,g=l.paths;b=[];var r=[],p=[],k=x.create(),q=this._context.renderSpatialReference===R.SphericalECEFSpatialReference,y=Array(6),v=this._getPathSize(a),l=n.getGeometryVertexData3D(g,N.hasZ(l),l.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,
this._context.renderCoordsHelper,e);this._logGeometryCreationWarnings(l,g,"paths","PathSymbol3DLayer");if(0<g.length){for(var g=l.geometryData.outlines,m=l.eleVertexData,w=l.vertexData,u=0;u<g.length;++u){var c=g[u];if(!(1>=c.count)){var h=c.index,t=c.count;if(this._context.clippingExtent&&(n.computeBoundingBox(m,h,t,y),n.boundingBoxClipped(y,this._context.clippingExtent)))continue;n.chooseOrigin(w,h,t,k);n.subtractCoordinates(w,h,t,k);c=new Float64Array(m.buffer,3*h*m.BYTES_PER_ELEMENT,3*t);h=n.flatArrayToArrayOfArrays(w,
h,t);h=D.createTubeGeometry(h,.5*v,z,q,k);h.getVertexAttr().mapPos={size:3,data:c,offsetIdx:0,strideIdx:3};this._material.getParams().vertexColors&&(c=this._getVertexOpacityAndColor(a),h=D.addVertexColors(h,c));c=new S(h,d+"path"+u);c.singleUse=!0;b.push(c);r.push([this._material]);c=K.identity();K.translate(c,k,c);p.push(c)}}if(0<b.length)return a=new T({geometries:b,materials:r,transformations:p,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicId:f},idHint:d}),a=new O(this,a,b,null,
null,V,e),a.alignedTerrainElevation=l.terrainElevation,a.needsElevationUpdates=n.needsElevationUpdates3D(e.mode),a}return null};return f}(P);var W=E.VertexAttrConstants,d=x.create(),r=new M,J={verticalDistanceToGround:0,terrainElevation:0},z=10;return A});