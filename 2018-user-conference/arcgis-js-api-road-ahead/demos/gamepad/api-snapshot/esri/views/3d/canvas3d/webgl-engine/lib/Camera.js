// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["./Util","./gl-matrix"],function(h,n){function m(a){var b="_"+a;return function(){return this[b]}}function p(a){var b="_"+a;return function(a){l(this[b],a)||(e.set(a,this[b]),this._frustumPlanesDirty=this._viewDirty=!0)}}function t(a){var b="_"+a;return function(a){this[b]!==a&&(this[b]=a,this._frustumPlanesDirty=this._projectionDirty=!0)}}var e=n.vec3d,k=n.vec4d,f=n.mat4d,l=h.arraysEqual,u=h.clamp,q=e.create(),d=k.create(),r=f.create(),g=function(a,b,c){this._eye=e.create(a);this._center=
e.create(b);this._fov=55/180*Math.PI;this._viewport=k.create();this._near=1;this._far=1E3;this._up=void 0!==c?e.create(c):e.create([0,1,0]);this._viewDirty=!0;this._viewMatrix=f.create();this._projectionDirty=!0;this._projectionMatrix=f.create();this._viewInverseTransposeMatrixDirty=!0;this._viewInverseTransposeMatrix=null;this._frustumPlanesDirty=!0;this._frustumPlanes=Array(6);for(a=0;6>a;++a)this._frustumPlanes[a]=k.create();this._padding=k.create();this._fullViewport=null};Object.defineProperties(g.prototype,
{eye:{get:m("eye"),set:p("eye")},center:{get:m("center"),set:p("center")},up:{get:m("up"),set:p("up")},viewMatrix:{get:function(){this._viewDirty&&(f.lookAt(this._eye,this._center,this._up,this._viewMatrix),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0);return this._viewMatrix},set:function(a){f.set(a,this._viewMatrix);this._viewDirty=!1;this._frustumPlanesDirty=this._viewInverseTransposeMatrixDirty=!0}},near:{get:m("near"),set:t("near")},far:{get:m("far"),set:t("far")},viewport:{get:m("viewport"),
set:function(a){this.x=a[0];this.y=a[1];this.width=a[2];this.height=a[3]}},x:{get:function(){return this._viewport[0]},set:function(a){a+=this._padding[3];this._viewport[0]!==a&&(this._viewport[0]=a,this._frustumPlanesDirty=this._projectionDirty=!0)}},y:{get:function(){return this._viewport[1]},set:function(a){a+=this._padding[2];this._viewport[1]!==a&&(this._viewport[1]=a,this._frustumPlanesDirty=this._projectionDirty=!0)}},width:{get:function(){return this._viewport[2]},set:function(a){a-=this._padding[1]+
this._padding[3];this._viewport[2]!==a&&(this._viewport[2]=a,this._frustumPlanesDirty=this._projectionDirty=!0)}},height:{get:function(){return this._viewport[3]},set:function(a){a-=this._padding[0]+this._padding[2];this._viewport[3]!==a&&(this._viewport[3]=a,this._frustumPlanesDirty=this._projectionDirty=!0)}},fullWidth:{get:function(){return this._viewport[2]+this._padding[1]+this._padding[3]}},fullHeight:{get:function(){return this._viewport[3]+this._padding[0]+this._padding[2]}},fullViewport:{get:function(){this._fullViewport||
(this._fullViewport=k.create());this._fullViewport[0]=this._viewport[0]-this._padding[3];this._fullViewport[1]=this._viewport[1]-this._padding[2];this._fullViewport[2]=this.fullWidth;this._fullViewport[3]=this.fullHeight;return this._fullViewport}},aspect:{get:function(){return this.width/this.height}},padding:{get:function(){return this._padding},set:function(a){l(this._padding,a)||(this._viewport[0]+=a[3]-this._padding[3],this._viewport[1]+=a[2]-this._padding[2],this._viewport[2]-=a[1]+a[3]-(this._padding[1]+
this._padding[3]),this._viewport[3]-=a[0]+a[2]-(this._padding[0]+this._padding[2]),k.set(a,this._padding),this._frustumPlanesDirty=this._projectionDirty=!0)}},projectionMatrix:{get:function(){if(this._projectionDirty){var a=this.width,b=this.height,c=this.near*Math.tan(this.fovY/2),d=c*this.aspect;f.frustum(-d*(1+2*this._padding[3]/a),d*(1+2*this._padding[1]/a),-c*(1+2*this._padding[2]/b),c*(1+2*this._padding[0]/b),this.near,this.far,this._projectionMatrix);this._projectionDirty=!1}return this._projectionMatrix},
set:function(a){f.set(a,this._projectionMatrix);this._projectionDirty=!1;this._frustumPlanesDirty=!0}},fov:{get:function(){return this._fov},set:function(a){this._fov=a;this._frustumPlanesDirty=this._projectionDirty=!0}},fovX:{get:function(){return h.fovd2fovx(this._fov,this.width,this.height)},set:function(a){this._fov=h.fovx2fovd(a,this.width,this.height);this._frustumPlanesDirty=this._projectionDirty=!0}},fovY:{get:function(){return h.fovd2fovy(this._fov,this.width,this.height)},set:function(a){this._fov=
h.fovy2fovd(a,this.width,this.height);this._frustumPlanesDirty=this._projectionDirty=!0}},distance:{get:function(){return e.dist(this._center,this._eye)}},angleOfElevation:{get:function(){e.subtract(this._center,this._eye,q);e.normalize(q);var a=e.dot(this._center,q)/e.length(this._center);return Math.acos(u(a,-1,1))-.5*Math.PI}},frustumPoints:{get:function(){return this.computeFrustumPoints()}},frustumPlanes:{get:function(){this._frustumPlanesDirty&&(this._frustumPlanes=this.computeFrustumPlanes(this._frustumPlanes),
this._frustumPlanesDirty=!1);return this._frustumPlanes}},viewInverseTransposeMatrix:{get:function(){if(this._viewInverseTransposeMatrixDirty||this._viewDirty)this._viewInverseTransposeMatrix||(this._viewInverseTransposeMatrix=f.create()),f.inverse(this.viewMatrix,this._viewInverseTransposeMatrix),f.transpose(this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1;return this._viewInverseTransposeMatrix}},perPixelRatio:{get:function(){return Math.tan(this.fovX/2)/this.width}}});
g.prototype.copyFrom=function(a){e.set(a._eye,this._eye);e.set(a._center,this._center);e.set(a._up,this._up);k.set(a._viewport,this._viewport);k.set(a._padding,this._padding);this._near=a._near;this._far=a._far;this._fov=a._fov;a._viewDirty?this._frustumPlanesDirty=this._viewDirty=!0:(f.set(a._viewMatrix,this._viewMatrix),this._viewDirty=!1);a._projectionDirty?this._frustumPlanesDirty=this._projectionDirty=!0:(f.set(a._projectionMatrix,this._projectionMatrix),this._projectionDirty=!1);return this};
g.prototype.copy=function(){var a=new g;a.copyFrom(this);return a};g.prototype.equals=function(a){return l(this._eye,a._eye)&&l(this._center,a._center)&&l(this._up,a._up)&&l(this._viewport,a._viewport)&&l(this._padding,a._padding)&&this._near===a._near&&this._far===a._far&&this._fov===a._fov};g.prototype.markViewDirty=function(){this._frustumPlanesDirty=this._viewDirty=!0};g.prototype.computeDirection=function(a){a||(a=e.create());return e.normalize(e.subtract(this._center,this._eye,a))};g.prototype.computePixelSizeAt=
function(a){return 2*e.dist(a,this._eye)*Math.tan(this.fovX/2)/this.width};g.prototype.computePixelSizeAtDist=function(a){return 2*a*Math.tan(this.fovX/2)/this.width};g.prototype.computeFrustumPlanes=function(a){if(!a){a=Array(6);for(var b=0;6>b;++b)a[b]=k.create()}h.matrix2frustumPlanes(this.viewMatrix,this.projectionMatrix,a);return a};g.prototype.computeFrustumPoints=function(a){if(!a){a=Array(8);for(var b=0;8>b;++b)a[b]=e.create()}h.matrix2frustum(this.viewMatrix,this.projectionMatrix,a);return a};
g.frameCenterRadiusWithPadding=function(a,b,c){b=Math.max(1E-6,b);c=Math.max(2,(c||0)+2);return{center:a,radius:b*c}};g.prototype.setGLViewport=function(a){var b=this.viewport,c=this.padding;a.viewport(b[0]-c[3],b[1]-c[2],b[2]+c[1]+c[3],b[3]+c[0]+c[2])};g.prototype.projectPoint=function(a,b,c){k.set4(a[0],a[1],a[2],1,d);f.multiplyVec4(this.viewMatrix,d);c&&(b[2]=-d[2]);f.multiplyVec4(this.projectionMatrix,d);e.scale(d,1/Math.abs(d[3]));a=this.viewport;b[0]=h.lerp(0,a[0]+a[2],.5+.5*d[0]);b[1]=h.lerp(0,
a[1]+a[3],.5+.5*d[1]);c||(b[2]=.5*(d[2]+1));return b};g.prototype.unprojectPoint=function(a,b,c){if(c)return console.error("Camera.unprojectPoint() not yet implemented for linear Z"),null;f.multiply(this.projectionMatrix,this.viewMatrix,r);if(!f.inverse(r))return null;c=this.viewport;d[0]=2*(a[0]-c[0])/c[2]-1;d[1]=2*(a[1]-c[1])/c[3]-1;d[2]=2*a[2]-1;d[3]=1;f.multiplyVec4(r,d);if(0===d[3])return null;b[0]=d[0]/d[3];b[1]=d[1]/d[3];b[2]=d[2]/d[3];return b};return g});