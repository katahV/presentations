// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("./GLVBO ./GLSLProgram ./VertexBufferLayout ./GLUtil ./Camera ./Util ./gl-matrix".split(" "),function(ra,fa,sa,ta,ua,k,v){var b=v.vec2d,K=v.vec3d,aa=v.vec4d,va=v.mat3d,D=v.mat4d,H=v.mat4;return function(v,c){function w(a,c){K.set3(a[c],a[c+3],a[c+6],ga);return ga}var p,L=4096,E,V,M=1,ba=2,N=[0,0,0,0,0],e=function(){this.camera=new ua;this.lightMat=D.create()},P=[],n,l,x;for(n=0;4>n;++n)P[n]=new e;this.getIsSupported=function(){return c.getExtension("OES_standard_derivatives")};this.setTextureResolution=
function(a){L=a};this.getTextureResolution=function(){return L};this.setMaxNumCascades=function(a){ba=k.clamp(Math.floor(a),1,4)};this.getMaxNumCascades=function(){return ba};this.setEnableState=function(a){k.assert(a!==this.getEnableState());a?this.enable():this.disable()};this.getEnableState=function(){return void 0!==p};this.enable=function(){k.assert(!this.getEnableState());k.assert(this.getIsSupported(),"Shadow maps not supported");p=c.createTexture();c.bindTexture(c.TEXTURE_2D,p);c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MIN_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,L,L,0,c.RGBA,c.UNSIGNED_BYTE,null);E=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,E);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,L,L);V=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,V);c.framebufferTexture2D(c.FRAMEBUFFER,
c.COLOR_ATTACHMENT0,c.TEXTURE_2D,p,0);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,E);ta.checkFramebufferStatus(c.FRAMEBUFFER,c);c.bindRenderbuffer(c.RENDERBUFFER,null);c.bindFramebuffer(c.FRAMEBUFFER,null)};this.disable=function(){k.assert(this.getEnableState());c.deleteFramebuffer(V);c.deleteRenderbuffer(E);c.deleteTexture(p);p=E=V=void 0};var ha=D.create(),ia=D.create(),ja=aa.create(),y=Array(8);for(n=0;8>n;++n)y[n]=aa.create();var I=K.create(),J=K.create(),ka=b.create(),
la=b.create(),wa=b.create(),ma=b.create(),na=b.create(),oa=D.create(),pa=K.create();this.prepare=function(z,R,S,e,t){k.assert(this.getEnableState());D.multiply(z.projectionMatrix,z.viewMatrix,ha);var d=t[0],q=t[1];2>d&&(d=2);2>q&&(q=2);d>=q&&(d=2,q=4);M=Math.min(1+Math.floor(k.logWithBase(q/d,4)),ba);S=Math.pow(q/d,1/M);for(t=0;t<M+1;++t)N[t]=d*Math.pow(S,t);D.inverse(ha,ia);D.lookAt([0,0,0],[-R[0],-R[1],-R[2]],[0,1,0],oa);S=z.viewMatrix;z=z.projectionMatrix;for(t=0;t<M;++t){e=P[t];d=-N[t];q=-N[t+
1];d=(z[10]*d+z[14])/Math.abs(z[11]*d+z[15]);q=(z[10]*q+z[14])/Math.abs(z[11]*q+z[15]);k.assert(d<q);for(l=0;8>l;++l)for(aa.set4(0===l%4||3==l%4?-1:1,0===l%4||1==l%4?-1:1,4>l?d:q,1,ja),D.multiplyVec4(ia,ja,y[l]),x=0;3>x;++x)y[l][x]/=y[l][3];K.negate(y[0],pa);D.translate(oa,pa,e.camera.viewMatrix);for(l=0;8>l;++l)D.multiplyVec3(e.camera.viewMatrix,y[l]);K.set(y[0],I);K.set(y[0],J);for(l=1;8>l;++l)for(x=0;3>x;++x)I[x]=Math.min(I[x],y[l][x]),J[x]=Math.max(J[x],y[l][x]);I[2]-=200;J[2]+=200;e.camera.near=
-J[2];e.camera.far=-I[2];d=1/y[0][3];q=1/y[4][3];k.assert(d<q);var h=d+Math.sqrt(d*q),m=Math.sin(Math.acos(S[2]*R[0]+S[6]*R[1]+S[10]*R[2])),h=h/m,d=y,v=h,p=m,m=ka,A=la,g=wa,F=ma,h=na;b.set2(0,0,C);for(var f=void 0,f=0;4>f;++f)b.add(C,d[f],C);b.scale(C,.25);b.set2(0,0,W);for(f=4;8>f;++f)b.add(W,d[f],W);b.scale(W,.25);b.lerp(d[4],d[5],.5,Q[0]);b.lerp(d[5],d[6],.5,Q[1]);b.lerp(d[6],d[7],.5,Q[2]);b.lerp(d[7],d[4],.5,Q[3]);for(var n=0,G=b.dist2(Q[0],C),f=1;4>f;++f){var u=b.dist2(Q[f],C);u<G&&(G=u,n=f)}b.subtract(Q[n],
d[n+4],r);f=r[0];r[0]=-r[1];r[1]=f;b.subtract(W,C,qa);b.lerp(r,qa,p);b.normalize(r);n=p=void 0;p=n=b.dot(b.subtract(d[0],C,O),r);for(f=1;8>f;++f)G=b.dot(b.subtract(d[f],C,O),r),G<p?p=G:G>n&&(n=G);b.set(C,m);b.scale(r,p-v,O);b.add(m,O,m);for(var u=-1,H=1,f=v=G=0;8>f;++f){b.subtract(d[f],m,Y);b.normalize(Y);var E=r[0]*Y[1]-r[1]*Y[0];0<E?E>u&&(u=E,G=f):E<H&&(H=E,v=f)}k.verify(0<u,"leftArea");k.verify(0>H,"rightArea");b.scale(r,p,T);b.add(T,C,T);b.scale(r,n,U);b.add(U,C,U);Z[0]=-r[1];Z[1]=r[0];A=k.rayRay2D(m,
d[v],U,b.add(U,Z,O),1,A);g=k.rayRay2D(m,d[G],U,O,1,g);F=k.rayRay2D(m,d[G],T,b.add(T,Z,O),1,F);d=k.rayRay2D(m,d[v],T,O,1,h);k.verify(A,"rayRay");k.verify(g,"rayRay");k.verify(F,"rayRay");k.verify(d,"rayRay");g=ka;d=la;m=ma;F=na;h=e.camera.projectionMatrix;b.scale(b.subtract(m,F,B),.5);a[0]=B[0];a[1]=B[1];a[2]=0;a[3]=B[1];a[4]=-B[0];a[5]=0;a[6]=B[0]*B[0]+B[1]*B[1];a[7]=B[0]*B[1]-B[1]*B[0];a[8]=1;a[6]=-b.dot(w(a,0),g);a[7]=-b.dot(w(a,1),g);g=b.dot(w(a,0),m)+a[6];A=b.dot(w(a,1),m)+a[7];f=b.dot(w(a,0),
F)+a[6];F=b.dot(w(a,1),F)+a[7];g=-(g+f)/(A+F);a[0]+=a[1]*g;a[3]+=a[4]*g;a[6]+=a[7]*g;g=1/(b.dot(w(a,0),m)+a[6]);A=1/(b.dot(w(a,1),m)+a[7]);a[0]*=g;a[3]*=g;a[6]*=g;a[1]*=A;a[4]*=A;a[7]*=A;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;g=b.dot(w(a,1),d)+a[7];A=b.dot(w(a,2),d)+a[8];f=b.dot(w(a,1),m)+a[7];F=b.dot(w(a,2),m)+a[8];g=-.5*(g/A+f/F);a[1]+=a[2]*g;a[4]+=a[5]*g;a[7]+=a[8]*g;g=b.dot(w(a,1),d)+a[7];A=b.dot(w(a,2),d)+a[8];f=-A/g;a[1]*=f;a[4]*=f;a[7]*=f;h[0]=a[0];h[1]=a[1];h[2]=0;h[3]=a[2];h[4]=a[3];h[5]=
a[4];h[6]=0;h[7]=a[5];h[8]=0;h[9]=0;h[10]=1;h[11]=0;h[12]=a[6];h[13]=a[7];h[14]=0;h[15]=a[8];e.camera.projectionMatrix[10]=2/(I[2]-J[2]);e.camera.projectionMatrix[14]=-(I[2]+J[2])/(I[2]-J[2]);D.multiply(e.camera.projectionMatrix,e.camera.viewMatrix,e.lightMat);d=L/2;e.camera.viewport[0]=0===t%2?0:d;e.camera.viewport[1]=0===Math.floor(t/2)?0:d;e.camera.viewport[2]=d;e.camera.viewport[3]=d}N[M]=100*q;c.bindFramebuffer(c.FRAMEBUFFER,V);c.clearColor(1,1,1,1);c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT)};
var ca=[];this.getCascades=function(){for(var a=0;a<M;++a)ca[a]=P[a];ca.length=M;return ca};this.finish=function(a){k.assert(this.getEnableState());fa.unuse(c);c.bindFramebuffer(c.FRAMEBUFFER,a)};this.bind=function(a){var b=this.getEnableState();c.activeTexture(c.TEXTURE7);c.bindTexture(c.TEXTURE_2D,b?p:null);c.activeTexture(c.TEXTURE0);a.use();a.uniform1i("depthTex",7);a.uniform1f("depthHalfPixelSz",b?.5/L:-1);a.uniform1i("shadowMapNum",M);a.uniform4f("shadowMapDistance",N[0],N[1],N[2],N[3])};this.bindAll=
function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var c=0;c<a.length;c++)this.bind(a[c])};var u=H.create(),X=new Float32Array(64);this.bindView=function(a,c){if(this.getEnableState()){var b;H.translate(P[0].lightMat,c,u);for(b=0;16>b;++b)X[b]=u[b];H.translate(P[1].lightMat,c,u);for(b=0;16>b;++b)X[16+b]=u[b];H.translate(P[2].lightMat,c,u);for(b=0;16>b;++b)X[32+b]=u[b];H.translate(P[3].lightMat,c,u);for(b=0;16>b;++b)X[48+b]=u[b];a.uniformMatrix4fv("shadowMapMatrix",X)}};e=new Float32Array(16);
e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=256;e[5]=0;e[6]=1;e[7]=0;e[8]=0;e[9]=256;e[10]=0;e[11]=1;e[12]=256;e[13]=256;e[14]=1;e[15]=1;var da=sa.Defaults.Pos2Tex,ea=new ra(e,da,c);this.drawDebugQuad=function(a){k.assert(this.getEnableState());var b=v.get("showDepth");c.disable(c.DEPTH_TEST);b.use();b.uniformMatrix4fv("proj",a);b.uniform1i("depthTex",0);c.bindTexture(c.TEXTURE_2D,p);da.enableVertexAttribArrays(c,b);ea.bind();ea.setPointers(b);c.drawArrays(c.TRIANGLE_STRIP,0,ea.getNum());c.bindBuffer(c.ARRAY_BUFFER,
null);da.disableVertexAttribArrays(c,b);fa.unuse(c);c.enable(c.DEPTH_TEST)};var C=b.create(),W=b.create(),Q=[b.create(),b.create(),b.create(),b.create()],r=b.create(),qa=b.create(),O=b.create(),Y=b.create(),T=b.create(),U=b.create(),Z=b.create(),ga=K.create(),B=b.create(),a=va.create()}});