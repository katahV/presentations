// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["./ModelContentType","./ModelDirtyTypes","./Util"],function(D,d,x){return function(z){function e(a,b,c,d,v,h,m,l,e){c=c||a.getParentLayer().getId();var g=a.getId();a=b.getId();c=A(k,c,g);(g=c[a])?(b=g[1],b&v?delete c[a]:b&h?(g[1]=d,g[2]=e):b&m?g[2]|=e:b&l||B("ModelDirtySet.objGeometryAdded: inconsistent state")):c[a]=[b,d,e]}function A(a,b,c){a[b]||(a[b]={});a[b][c]||(a[b][c]={});return a[b][c]}var E=x.objectEmpty,B=x.assert,r={},k={},p={};this._getResidentGeometryRecords=function(){return r};
this._getDirtyGeometryRecords=function(){return k};this.getDirtyMaterials=function(){return E(p)?null:p};this.clearDirtyMaterials=function(){p={}};this.hasDirtyGeometryRecords=function(){for(var a in k)for(var b in k[a]){var c=k[a][b];if(c&&!E(c))return!0}return!1};this.getDirtyLayers=function(){var a={},b;for(b in k)for(var c in k[b]){var d=k[b][c];if(d&&0<d.length){a[b]=z.get(D.LAYER,b);break}}return a};this.handleUpdate=function(a,b,c){B(this[b],"ModelDirtySet doesn't know how to process "+b);
return this[b](a,c)};this.getAddRemoveUpdateList=function(a){return this.getAddRemoveUpdateListFilteredByLayers(Object.keys(k),a)};this.getAddRemoveUpdateListFilteredByLayers=function(a,b){for(var c=[],g=[],v=[],h=0;h<a.length;h++){var m=a[h];if(m in k)for(var l in k[m]){var e=k[m][l];if(e){var p=A(r,m,l),w;for(w in e){var t=e[w],C=t[0],n=t[1],t=t[2],u=n&d.GeomDirtyType.UPDATE&&t&d.UpdateTypes.REINSERT,f,y;if(n&d.GeomDirtyType.REMOVE||u)(f=p[w])?g.push.apply(g,f[1]):n===d.GeomDirtyType.REMOVE&&B(!1,
"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove"),b&&f&&delete p[w];if(n&d.GeomDirtyType.ADD||u)f=[C,[]],y=z.get(D.OBJECT,l),z.getGeometryRenderGeometries(y,C,f[1]),c.push.apply(c,f[1]),b&&(p[w]=f);if(n&d.GeomDirtyType.UPDATE&&!u)if(f=p[w],y=z.get(D.OBJECT,l),f){var n=f[1],u=n.length,q;if(t&d.UpdateTypes.FACERANGE){var x=y.getVisibleIndexRanges(C);for(f=0;f<u;f++)q=n[f],q.displayedIndexRange=x?x[q.componentIdx]:void 0}if(t&d.UpdateTypes.TRANSFORMATION)for(f=0;f<u;f++)q=n[f],y.getCombinedTransformation(C,
q.transformation),q.updateTransformation(q.transformation);for(f=0;f<u;f++)q=n[f],v.push({renderGeometry:q,updateType:t})}else B(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}}}b&&delete k[m]}return[c,g,v]};this.getResidentRenderGeometries=function(){return this.getResidentRenderGeometriesFilteredByLayers(Object.keys(r))};this.getResidentRenderGeometriesFilteredByLayers=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];if(d in r)for(var v in r[d]){var h=r[d][v];if(h)for(var e in h)b.push.apply(b,
h[e][1])}}return b};this.hideFaceRange=function(a,b,c){c=c||a.getParentLayer().getId();e(a,b,c,d.GeomDirtyType.UPDATE,0,0,d.GeomDirtyType.UPDATE,d.GeomDirtyType.ADD|d.GeomDirtyType.REMOVE,d.UpdateTypes.FACERANGE)};this.unhideAllFaceRange=function(a,b){for(var c=0;c<a.getGeometryRecords().length;c++)e(a,a.getGeometryRecords()[c],b,d.GeomDirtyType.UPDATE,0,0,d.GeomDirtyType.UPDATE,d.GeomDirtyType.ADD|d.GeomDirtyType.REMOVE,d.UpdateTypes.FACERANGE)};this.vertexAttrsUpdated=function(a,b,c){e(a,b,c,d.GeomDirtyType.UPDATE,
0,0,d.GeomDirtyType.UPDATE,d.GeomDirtyType.ADD|d.GeomDirtyType.REMOVE,d.UpdateTypes.VERTEXATTRS)};this.colorAttrsUpdated=function(a,b,c){e(a,b,c,d.GeomDirtyType.UPDATE,0,0,d.GeomDirtyType.UPDATE,d.GeomDirtyType.ADD|d.GeomDirtyType.REMOVE,d.UpdateTypes.COLORATTRS)};this.matChanged=function(a){p[a.getId()]=!0};this.layerAdded=function(a){for(var b=a.getObjects(),c=0;c<b.length;c++)this.layObjectAdded(a,b[c])};this.layerRemoved=function(a){for(var b=a.getObjects(),c=0;c<b.length;c++)this.layObjectRemoved(a,
b[c])};this.layObjectAdded=function(a,b){a=a.getId();for(var c=b.getGeometryRecords(),d=0;d<c.length;d++)this.objGeometryAdded(b,c[d],a)};this.layObjectRemoved=function(a,b){a=a.getId();for(var c=b.getGeometryRecords(),d=0;d<c.length;d++)this.objGeometryRemoved(b,c[d],a)};this.layObjectReplaced=function(a,b){this.layObjectRemoved(a,b[0]);this.layObjectAdded(a,b[1])};this.objDirty=function(a,b){b=b||a.getParentLayer().getId();var c=a.getId(),c=A(r,b,c),g;for(g in c)e(a,c[g][0],b,d.GeomDirtyType.UPDATE,
0,d.GeomDirtyType.UPDATE,0,d.GeomDirtyType.ADD|d.GeomDirtyType.REMOVE,d.UpdateTypes.REINSERT)};this.objTransformation=function(a,b){b=b||a.getParentLayer().getId();var c=a.getId(),c=A(r,b,c),g;for(g in c)e(a,c[g][0],b,d.GeomDirtyType.UPDATE,0,0,d.GeomDirtyType.UPDATE,d.GeomDirtyType.ADD|d.GeomDirtyType.REMOVE,d.UpdateTypes.TRANSFORMATION)};this.objGeometryAdded=function(a,b,c){e(a,b,c,d.GeomDirtyType.ADD,d.GeomDirtyType.REMOVE,0,0,0)};this.objGeometryRemoved=function(a,b,c){e(a,b,c,d.GeomDirtyType.REMOVE,
d.GeomDirtyType.ADD,d.GeomDirtyType.UPDATE,0,0)};this.objGeometryReplaced=function(a,b){this.objGeometryRemoved(a,b[0]);this.objGeometryAdded(a,b[1])};this.objGeometryTransformation=function(a,b){this.objGeometryReplaced(a,b)};this.formatDebugInfo=function(a){var b=["ADD","UPD",void 0,"REM"];if(a)return"";a="";for(var c in k)for(var d in k[c]){var e=k[c][d];if(e){0<a.length&&(a+="\n");a+=c+"."+d;var h=[],m;for(m in e){var l=e[m][1];h[l]||(h[l]=[]);h[l].push(e[m][0].geometry.getId())}for(e=0;e<h.length;e++)if(h[e])for(a+=
" "+b[e-1]+": ",l=0;l<h[e].length;l++)a+=h[e][l]+", "}}return a}}});