// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["./Util","./gl-matrix"],function(N,t){function O(){for(var w=0,m=0,n=0,u=0,g=0,z=0,a=0,e=0,h=0,r=0,f=0,q=0,v=0,J=0,F=0,b=0,p=0,B=0,A=0,E=0,K,D,t=new P,d=Array(6),L=0;6>L;++L)d[L]=H.create();var C=Q.create();this.init=function(k,c,l){k.computeFrustumPlanes(d);k=k.viewMatrix;w=d[0][0];m=d[0][1];n=d[0][2];u=d[0][3];g=d[1][0];z=d[1][1];a=d[1][2];e=d[1][3];h=d[2][0];r=d[2][1];f=d[2][2];q=d[2][3];v=d[3][0];J=d[3][1];F=d[3][2];b=d[3][3];p=k[2];B=k[6];A=k[10];E=k[14];K=c;D=l;t.init(l)};this.includeNearBoundingInfoRec=
function(k,c){var l=k.getBSRadius(),y=k.getCenter();I.multiplyVec3(c,y,C);var y=C[0],d=C[1],x=C[2],l=l*Math.sqrt(Math.max(Math.max(c[0]*c[0]+c[4]*c[4]+c[8]*c[8],c[1]*c[1]+c[5]*c[5]+c[9]*c[9]),c[2]*c[2]+c[6]*c[6]+c[10]*c[10]));if(!(w*y+m*d+n*x+u>l||g*y+z*d+a*x+e>l||h*y+r*d+f*x+q>l||v*y+J*d+F*x+b>l||(y=p*y+B*d+A*x+E,d=y+l,2>-(y-l)||-d>=D.bestNear)))if(-d>D.bestNear2)D.bestNear=-d;else{if(100<l&&(l=k.getChildren(),void 0!==l)){for(k=0;8>k;++k)void 0!==l[k]&&this.includeNearBoundingInfoRec(l[k],c);return}t.intersectFrustumAABB(K,
c,k.getBBMin(),k.getBBMax())}};this.includeFarBoundingInfoRec=function(k,c){var l=k.getBSRadius(),d=k.getCenter();I.multiplyVec3(c,d,C);var d=C[0],G=C[1],x=C[2],l=l*Math.sqrt(Math.max(Math.max(c[0]*c[0]+c[4]*c[4]+c[8]*c[8],c[1]*c[1]+c[5]*c[5]+c[9]*c[9]),c[2]*c[2]+c[6]*c[6]+c[10]*c[10]));if(!(w*d+m*G+n*x+u>l||g*d+z*G+a*x+e>l||h*d+r*G+f*x+q>l||v*d+J*G+F*x+b>l||(d=p*d+B*G+A*x+E-l,-d<=D.bestFar)))if(-d<D.bestFar2)D.bestFar=-d;else{if(100<l&&(l=k.getChildren(),void 0!==l)){for(k=0;8>k;++k)void 0!==l[k]&&
this.includeFarBoundingInfoRec(l[k],c);return}t.intersectFrustumAABB(K,c,k.getBBMin(),k.getBBMax())}}}function P(){for(var w=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],m,n=Array(8),u=0;8>u;++u)n[u]=H.create();var g=I.create();this.init=function(a){m=a};this.intersectFrustumAABB=function(a,e,h,r){I.multiply(a,e,g);for(a=0;8>a;++a){e=n[a];var f=0===a||3===a||4===a||7===a?h[0]:r[0],q=0===a||1===a||4===a||5===a?h[1]:r[1],v=4>a?h[2]:r[2];e[0]=g[0]*
f+g[4]*q+g[8]*v+g[12];e[1]=g[1]*f+g[5]*q+g[9]*v+g[13];e[2]=g[2]*f+g[6]*q+g[10]*v+g[14];e[3]=g[3]*f+g[7]*q+g[11]*v+g[15]}for(a=0;12>a;++a){e=z(n[w[a][0]],n[w[a][1]],n[w[a][2]]);f=!0;for(h=0;h<e.length;++h)if(r=e[h][3],2<=r){f=!1;break}if(!f)for(h=0;h<e.length;++h)r=e[h][3],r<m.bestNear&&(m.bestNear=r),r>m.bestFar&&(m.bestFar=r)}};var z=function(a,e,h){var g=function(a,b){if(0===b)return a[0]>=-a[3];if(1===b)return a[1]>=-a[3];if(2===b)return a[0]<=a[3];if(3===b)return a[1]<=a[3];N.assert(!1)},f=function(a,
b,e){var f=0;0===e?f=(-a[3]-a[0])/(b[0]-a[0]+b[3]-a[3]):1===e?f=(-a[3]-a[1])/(b[1]-a[1]+b[3]-a[3]):2===e?f=(a[3]-a[0])/(b[0]-a[0]-b[3]+a[3]):3===e&&(f=(a[3]-a[1])/(b[1]-a[1]-b[3]+a[3]));return H.lerp(a,b,f,H.create())};a=[a,e,h];for(e=0;4>e;++e){h=a;a=[];for(var q=0;q<h.length;++q){var m=h[q],n=h[(q+1)%h.length];g(n,e)?(g(m,e)||a.push(f(m,n,e)),a.push(n)):g(m,e)&&a.push(f(m,n,e))}}return a}}var Q=t.vec3,H=t.vec4d,I=t.mat4,M=t.mat4d;return function(){var w=[],m=[],n=[],u=[],g=[],z=new O,a=M.create();
this.calculateSceneNearFar=function(e,h,r){M.multiply(e.projectionMatrix,e.viewMatrix,a);var f=e.viewMatrix,q=f[2],v=f[6],t=f[10],F=f[14],f=0,b,p;for(b in h)if(p=h[b],p.castShadow&&r.get(p.idx)){var B=p.bsRadius,A=p.center,E=q*A[0]+v*A[1]+t*A[2]+F,A=E-B,B=E+B;w[f]=p;m[f]=-B;n[f]=-A;++f}p=Number.MAX_VALUE;q=-Number.MAX_VALUE;if(0===f)return[p,q];for(b=0;b<f;++b)m[b]>q&&(q=m[b]),2<m[b]&&n[b]<p&&(p=n[b]);v=Math.max(.5*p,2);t=2*q;for(b=r=h=0;b<f;++b)m[b]<p&&(m[b]>=v?p=m[b]:u[h++]=b),n[b]>q&&(n[b]<=t?
q=n[b]:g[r++]=b);if(0===h&&0===r)return[p,q];u.length=h;g.length=r;u.sort(function(a,b){return m[a]<m[b]?-1:m[a]>m[b]?1:0});g.sort(function(a,b){return n[a]<n[b]?1:n[a]>n[b]?-1:0});f={bestNear:p,bestFar:q,bestNear2:v,bestFar2:t};z.init(e,a,f);for(b=0;b<h;++b)m[u[b]]<f.bestNear&&(p=w[u[b]],e=p.boundingInfo,z.includeNearBoundingInfoRec(e,p.transformation));for(b=0;b<r;++b)n[g[b]]>f.bestFar&&(p=w[g[b]],e=p.boundingInfo,z.includeFarBoundingInfoRec(e,p.transformation));return[f.bestNear,f.bestFar]}}});