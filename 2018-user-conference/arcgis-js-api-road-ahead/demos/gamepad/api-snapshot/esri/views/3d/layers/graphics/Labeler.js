// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/declareExtendsHelper ../../../../core/tsSupport/decorateHelper dojo/promise/all ../../../../Color ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/LabelClass ../../../../symbols/callouts/calloutUtils ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DWebStyleSymbol ./labelPlacement ../../support/debugFlags ../../webgl-engine/Stage ../../webgl-engine/lib/Layer ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextTexture ../../webgl-engine/lib/TextTextureAtlas".split(" "),
function(l,n,z,q,A,r,B,C,D,t,m,u,E,F,G,H,I,v,J,w,K,L){Object.defineProperty(n,"__esModule",{value:!0});l=function(l){function e(a){var b=l.call(this)||this;b.labelStageLayer=null;b.scheduledRunTimeoutId=0;b.labelingContexts=[];b.view=a;b.idHint="__labeler";return b}z(e,l);h=e;e.prototype.setup=function(){var a=this;this.handles||(this.handles=new D,this.handles.add([this.view.watch("state.camera",function(){return a.scheduleRun()})]));this.labelStageLayer||(this.labelStageLayer=new J(this.idHint,
{isPickable:!1},this.idHint+"_labels"),this.view._stage.add(v.ModelContentType.LAYER,this.labelStageLayer),this.view._stage.addToViewContent([this.labelStageLayer.id]),this.textTextureAtlas=new L(this.idHint+"_atlas",this.view),this.hudMaterialCollection=new w(this.view._stage),this.calloutMaterialCollection=new w(this.view._stage))};e.prototype.dispose=function(){this.cancelScheduledRun();this.handles&&(this.handles.destroy(),this.handles=null);this.labelStageLayer&&(this.view._stage.removeFromViewContent([this.labelStageLayer.id]),
this.view._stage.remove(v.ModelContentType.LAYER,this.labelStageLayer.id),this.labelStageLayer=null,this.textTextureAtlas.dispose(),this.textTextureAtlas=null,this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null,this.calloutMaterialCollection.dispose(),this.calloutMaterialCollection=null)};e.prototype.scheduleRun=function(a){var b=this;void 0===a&&(a=200);0===this.scheduledRunTimeoutId&&(this.scheduledRunTimeoutId=setTimeout(function(){return b.run()},a))};e.prototype.cancelScheduledRun=
function(){this.scheduledRunTimeoutId&&(clearTimeout(this.scheduledRunTimeoutId),this.scheduledRunTimeoutId=0)};e.prototype.run=function(){this.cancelScheduledRun();if(this.view.ready){for(var a=!1,b=0,d=this.labelingContexts;b<d.length;b++){var c=d[b];if(!this.labelsEnabled(c))this.clearLabels(c)&&(a=!0);else if(null!==c.labelClassContexts)if(c.labelClassContexts.length||c.labelClassPromise||this.createLabelClassContexts(c),c.labelClassPromise&&!c.labelClassPromise.isResolved())this.setDirty();else{for(var g in c.uninitializedLabels){var f=
c.uninitializedLabels[g];f.graphics3DGraphic.isVisible(0)&&(this.createLabelGraphics3DResources(f,c)?c.initializedLabels[g]=c.uninitializedLabels[g]:c.invalidLabels[g]=c.uninitializedLabels[g],delete c.uninitializedLabels[g],a=!0)}for(g in c.initializedLabels)if(f=c.initializedLabels[g],f.graphics3DGraphic.setVisibilityFlag(0,!0,1),f.graphics3DGraphic.isVisible(1)){if(f.textTextures.length||this.createLabelTextures(f,c),!c.visibleLabels[g]){c.visibleLabels[g]=f;for(var e=0;e<f.graphics3DGraphic._labelGraphics.length;e++)f.textTextures[e]&&
this.textTextureAtlas.addTextTexture(f.textTextures[e],f.graphics3DGraphic._labelGraphics[e].stageObject);c.invisibleLabels[g]&&(a=!0,delete c.invisibleLabels[g])}}else c.visibleLabels[g]&&(delete c.visibleLabels[g],c.invisibleLabels[g]=f,this.removeLabelTextures(f))}}a&&(this.view.deconflictor.setDirty(),this.setDirty())}else this.setDirty()};e.prototype.createLabelClassContexts=function(a){a.labelClassPromise=a.layer.when(function(){a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();
var b=a.graphics3DCore,d=b.layer.labelingInfo&&b.layer.labelingInfo.filter(function(a){return!!a.symbol});if(!d||0===d.length)return null;var c=Array(d.length),d=d.map(function(a,d){var f=a.symbol,g;g=b.getOrCreateGraphics3DSymbol(f);g=g instanceof G?g.graphics3DSymbol:g;var e=null;E.isCalloutSupport(f)&&f.hasVisibleCallout()&&(e=F.make(f,b.symbolCreationContext));c[d]={labelClass:a,graphics3DSymbol:g,graphics3DCalloutSymbolLayer:e,options:a.getOptions()};return g});return A(d).then(function(){return c})}).then(function(b){b&&
(a.labelClassContexts=b)}).catch(function(){a.labelClassContexts=null});return a.labelClassPromise};e.prototype.createLabelText=function(a,b,d,c){if(!u.evaluateWhere(b.where,a.attributes))return null;b=b.getLabelExpression();return b.expression?u.buildLabelText(b.expression,a,c.fields,d):null};e.prototype.createLabelGraphic=function(a,b,d,c,g){a={text:a,centerOffset:d.centerOffset,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,anchor:d.anchor,needsOffsetAdjustment:d.needsOffsetAdjustment,
centerOffsetUnits:d.centerOffsetUnits,verticalOffset:d.verticalOffset,debugDrawBorder:I.LABELS_SHOW_BORDER};h.tmpGraphicCreationContext.graphic=b;h.tmpGraphicCreationContext.renderingInfo=null;h.tmpGraphicCreationContext.layer=c;return g.createGraphics3DGraphic(h.tmpGraphicCreationContext,a,this.hudMaterialCollection,this.textTextureAtlas)};e.prototype.createLabelCalloutGraphic=function(a,b,d,c,g){h.tmpGraphicCreationContext.graphic=a;h.tmpGraphicCreationContext.renderingInfo={symbol:b,needsOffsetAdjustment:c.needsOffsetAdjustment,
translation:c.translation,elevationOffset:c.elevationOffset,screenOffset:c.screenOffset,centerOffset:c.centerOffset,centerOffsetUnits:c.centerOffsetUnits,materialCollection:this.calloutMaterialCollection};h.tmpGraphicCreationContext.layer=g;return d.createGraphics3DGraphic(h.tmpGraphicCreationContext)};e.prototype.createLabelGraphics3DResources=function(a,b){var d=!1;a=a.graphics3DGraphic;var c=a.graphic,g=b.labelClassContexts,f=b.layer,e=this.labelsEnabled(b);if(g&&0!==g.length&&a._graphics[0]){for(var h=
0;h<g.length;h++){var k=g[h],x=k.labelClass,l=this.createLabelText(c,x,k.options,f);if(l){var m=null;k.graphics3DSymbol&&k.graphics3DSymbol.symbol&&"label-3d"===k.graphics3DSymbol.symbol.type&&(m=k.graphics3DSymbol.symbol);var n=k.graphics3DSymbol.childGraphics3DSymbols[0],p=H.get({graphics3DGraphic:a,labelSymbol:m,labelClass:k.labelClass});if(n&&p.isValid){if(d=this.createLabelGraphic(l,c,p,f,n)){if(d._labelClass=x,a.addLabelGraphic(d,this.labelStageLayer,this.view._stage),b.spatialIndex&&b.spatialIndex.add(a),
a.setVisibilityFlag(0,e,1),a.setVisibilityFlag(1,void 0,1),this.view.deconflictor.initializeLabelVisibility(a),d=!0,k.graphics3DCalloutSymbolLayer&&p.hasLabelVerticalOffset&&(c=this.createLabelCalloutGraphic(c,m,k.graphics3DCalloutSymbolLayer,p,f)))a.addLabelGraphic(c,this.labelStageLayer,this.view._stage),k.calloutSymbolLayerIndex=a._labelGraphics.length}else return!1;break}}}b.scaleVisibility&&d&&b.scaleVisibility.updateGraphicLabelScaleVisibility(a);return!0}};e.prototype.createLabelTextures=function(a,
b){var d=a.graphics3DGraphic,c=b.labelClassContexts;b=b.layer;var g=d.graphic;if(c&&0!==c.length&&d._graphics[0])for(d=0;d<c.length;d++){var f=c[d],e=this.createLabelText(g,f.labelClass,f.options,b)||g.symbol&&g.symbol.text;if(e&&!(1>e.length)){var f=f.graphics3DSymbol.childGraphics3DSymbols[0].symbol,h=f.material?r.toUnitRGBA(f.material.color):y,k=f.halo&&f.halo.color&&0<f.halo.size,l=k?r.toUnitRGBA(f.halo.color):y,k=k?t.pt2px(f.halo.size):0,m=t.pt2px(f.size)||12,e=new K(e,{size:m,color:h,font:{family:f.font&&
f.font.family?f.font.family:"Arial",weight:f.font&&f.font.weight?f.font.weight:"normal",style:f.font&&f.font.style?f.font.style:"normal"},halo:{size:k,color:l}},b.id+"_label_"+g.uid);a.textTextures.push(e)}}};e.prototype.addGraphic=function(a,b){var d={graphics3DGraphic:b,textTextures:[]};a.labelGraphicContexts.push(d);a.uninitializedLabels[b.graphic.uid]=d;this.setDirty()};e.prototype.removeGraphic=function(a,b){b=b.graphic.uid;var d=a.initializedLabels[b]||a.uninitializedLabels[b];C.removeUnordered(a.labelGraphicContexts,
d);delete a.initializedLabels[b];delete a.uninitializedLabels[b];delete a.invalidLabels[b];delete a.visibleLabels[b];this.removeLabelTextures(d);this.setDirty()};e.prototype.labelsEnabled=function(a){return!0===a.layer.labelsVisible};e.prototype.getLabelingContext=function(a){var b=this.labelingContexts.filter(function(b){return b.graphics3DCore===a});return b.length?b[0]:null};e.prototype.elevationInfoChange=function(a){for(var b=function(b){b.graphics3DSymbol.layerPropertyChanged("elevationInfo",
{});if(b.graphics3DCalloutSymbolLayer){for(var c={},d=0,e=a.labelGraphicContexts;d<e.length;d++){var g=e[d].graphics3DGraphic;c[g.graphic.uid]=g}b.graphics3DCalloutSymbolLayer.layerPropertyChanged("elevationInfo",c,function(a){return a._labelGraphics[b.calloutSymbolLayerIndex]})}},d=0,c=a.labelClassContexts;d<c.length;d++)b(c[d])};e.prototype.clearLabels=function(a){var b=a.visibleLabels,d=!1,c;for(c in b)d=b[c],this.removeLabelTextures(d),b[c].graphics3DGraphic.setVisibilityFlag(0,!1,1),a.invisibleLabels[c]=
d,d=!0;a.visibleLabels={};this.labelStageLayer.invalidateSpatialQueryAccelerator();return d};e.prototype.resetLabels=function(a){for(var b=0,d=a.labelGraphicContexts;b<d.length;b++){var c=d[b];this.removeLabelTextures(c);c.textTextures=[];c.graphics3DGraphic.clearLabelGraphics();a.uninitializedLabels[c.graphics3DGraphic.graphic.uid]=c}a.initializedLabels={};a.invalidLabels={};a.invisibleLabels={};a.visibleLabels={};a.labelClassPromise=null;this.setDirty()};e.prototype.removeLabelTextures=function(a){for(var b=
0;b<a.graphics3DGraphic._labelGraphics.length;b++)a.textTextures[b]&&this.textTextureAtlas.removeTextTexture(a.textTextures[b],a.graphics3DGraphic._labelGraphics[b].stageObject)};e.prototype.addGraphicsOwner=function(a,b,d){var c=this;if(!this.getLabelingContext(a)){var e={graphics3DCore:a,layer:a.layer,scaleVisibility:b,spatialIndex:d,labelClassPromise:null,labelClassContexts:[],labelGraphicContexts:[],uninitializedLabels:{},initializedLabels:{},invalidLabels:{},visibleLabels:{},invisibleLabels:{}};
this.labelingContexts.push(e);this.setDirty();return{addGraphic:function(a){return c.addGraphic(e,a)},removeGraphic:function(a){return c.removeGraphic(e,a)},updateLabelingInfo:function(){if(c.labelsEnabled(e))return c.resetLabels(e),c.createLabelClassContexts(e)},layerLabelsEnabled:function(){return c.labelsEnabled(e)},elevationInfoChange:function(){c.elevationInfoChange(e)},clear:function(){return c.clearLabels(e)}}}};e.prototype.removeGraphicsOwner=function(a){if(a=this.getLabelingContext(a)){var b=
this.labelingContexts.indexOf(a);this.labelingContexts.splice(b,1);b=0;for(a=a.labelGraphicContexts;b<a.length;b++)this.removeLabelTextures(a[b]);this.setDirty()}};Object.defineProperty(e.prototype,"labelStageLayerId",{get:function(){return this.labelStageLayer.id},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"isDirty",{get:function(){return!!this.scheduledRunTimeoutId||this.textTextureAtlas&&this.textTextureAtlas.isDirty},enumerable:!0,configurable:!0});e.prototype.setDirty=
function(){this.scheduleRun()};Object.defineProperty(e.prototype,"updating",{get:function(){return this.labelingContexts.some(function(a){return null!==a.labelClassPromise})},enumerable:!0,configurable:!0});e.tmpGraphicCreationContext={graphic:null,renderingInfo:null,layer:null};q([m.property({type:Boolean,readOnly:!0})],e.prototype,"updating",null);return e=h=q([m.subclass()],e);var h}(m.declared(B));n.Labeler=l;var y=[0,0,0,1]});