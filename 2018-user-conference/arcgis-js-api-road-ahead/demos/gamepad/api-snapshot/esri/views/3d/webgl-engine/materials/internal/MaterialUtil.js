// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../geometry/support/aaBoundingBox ../../lib/ComponentUtils ../../lib/gl-matrix ../../lib/screenSizePerspectiveUtils ../../lib/Util ../../../../webgl/Util".split(" "),function(da,g,C,L,p,M,I,Z){function z(a,b,d,c,e,f){if(void 0===e||3!==f)for(e=0;e<f;++e)d[c+e]=a[b+e];else{var E=a[b],l=a[b+1];a=a[b+2];d[c]=e[0]*E+e[4]*l+e[8]*a+e[12];d[c+1]=e[1]*E+e[5]*l+e[9]*a+e[13];d[c+2]=e[2]*E+e[6]*l+e[10]*a+e[14]}return f}function N(a,b,d,c,e,f){for(var E=a.length,l=0;l<E;++l){for(var q=
d*a[l],g=0;g<d;++g)c[e+g]=b[q+g];e+=f}}function O(a,b,d,c,e,f){c=new Uint8Array(c);e*=4;f*=4;var g=a.length;if(4===d)for(d=0;d<g;++d){var l=4*a[d];c[e]=b[l];c[e+1]=b[l+1];c[e+2]=b[l+2];c[e+3]=b[l+3];e+=f}else if(3===d)for(d=0;d<g;++d)l=3*a[d],c[e]=b[l],c[e+1]=b[l+1],c[e+2]=b[l+2],c[e+3]=255,e+=f}function P(a,b,d,c,e){var f=Q(b,d,R);C.setMin(A,a.getBBMin());C.setMax(A,a.getBBMax());if(H(A,b,f,c)){var f=a.getPrimitiveIndices(),g=a.getIndices(),l=a.getPosition(),q=f?f.length:g.length/3;if(1E4<q&&(a=
a.getChildren(),void 0!==a)){for(f=0;8>f;++f)void 0!==a[f]&&P(a[f],b,d,c,e);return}K(b,d,0,q,g,l,f,e)}}function K(a,b,d,c,e,f,g,l){var q=f.data,E=f.offsetIdx;f=f.strideIdx;var m=a[0],k=a[1];a=a[2];var h=b[0]-m,p=b[1]-k;for(b=b[2]-a;d<c;d++){var n=g?g[d]:d,t=E+f*e[3*n],w=E+f*e[3*n+1],r=E+f*e[3*n+2],u=q[t],v=q[t+1],x=q[t+2],t=q[w]-u,z=q[w+1]-v,w=q[w+2]-x,A=q[r]-u,C=q[r+1]-v,r=q[r+2]-x,B=p*r-C*b,F=b*A-r*h,H=h*C-A*p,D=t*B+z*F+w*H,u=m-u,G=k-v,J=a-x,v=G*w-z*J,x=J*t-w*u,I=u*z-t*G;if(D>S){B=u*B+G*F+J*H;if(0>
B||B>D)continue;F=h*v+p*x+b*I;if(0>F||B+F>D)continue}else if(D<-S){B=u*B+G*F+J*H;if(0<B||B<D)continue;F=h*v+p*x+b*I;if(0<F||B+F<D)continue}else continue;D=(A*v+C*x+r*I)/D;0<=D&&(t=T(t,z,w,A,C,r,aa),l(D,t,n))}}function T(a,b,d,c,e,f,g){p.vec3d.set3(a,b,d,U);p.vec3d.set3(c,e,f,V);return p.vec3d.normalize(p.vec3d.cross(U,V,g))}function Q(a,b,d){return p.vec3d.set3(1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]),d)}function H(a,b,d,c){var e=(a[0]-c-b[0])*d[0],f=(a[3]+c-b[0])*d[0],g=Math.min(e,f),e=Math.max(e,
f),f=(a[1]-c-b[1])*d[1],l=(a[4]+c-b[1])*d[1],g=Math.max(g,Math.min(f,l)),e=Math.min(e,Math.max(f,l));if(g>e)return!1;f=(a[2]-c-b[2])*d[2];a=(a[5]+c-b[2])*d[2];g=Math.max(g,Math.min(f,a));e=Math.min(e,Math.max(f,a));return g<=e}function W(a,b){b=b?W(b):{};for(var d in a){var c=a[d];c&&c.forEach&&(c=ba(c));null==c&&d in b||(b[d]=c)}return b}function ba(a){var b=[];a.forEach(function(a){return b.push(a)});return b}Object.defineProperty(g,"__esModule",{value:!0});var X=p.mat4d.create(),A=C.create(),G=
I.VertexAttrConstants;g.IDENTITY=p.mat4d.identity();g.fill=z;g.fillColor=function(a,b,d,c,e){for(var f=0;f<e;++f)d[c+f]=a[b+f];return e};g.fillInterleaved=function(a,b,d,c,e,f,g,l){for(var q=Z.getStride(e)/4,p=0;p<e.length;p++){var m=e[p],k=g+m.offset/4,m=m.name,h=a.vertexAttr[m];if(null!=h&&(null==l||null!=l[m]))switch(m){case "uv0":N(a.indices[m],h.data,h.size,f,k,q);break;case "region":for(var m=a.indices[m],y=h.data,n=h.size,h=q,t=new Uint16Array(f.buffer),k=2*k,h=2*h,w=m.length,r=0;r<w;++r){for(var u=
n*m[r],v=0;v<n;++v)t[k+v]=y[u+v];k+=h}break;case "color":if(c&&c.color)if(m=a.indices[m],y=h.data,n=c.color,r=h.size,h=q,t=new Uint8Array(f.buffer),k*=4,h*=4,w=m.length,4===r)for(r=0;r<w;++r)u=4*m[r],t[k]=y[u]*n[0],t[k+1]=y[u+1]*n[1],t[k+2]=y[u+2]*n[2],t[k+3]=y[u+3]*n[3],k+=h;else{if(3===r)for(v=255*n[3],r=0;r<w;++r)u=3*m[r],t[k]=y[u]*n[0],t[k+1]=y[u+1]*n[1],t[k+2]=y[u+2]*n[2],t[k+3]=v,k+=h}else O(a.indices[m],h.data,h.size,f.buffer,k,q);break;case "symbolColor":O(a.indices[m],h.data,h.size,f.buffer,
k,q);break;default:if(n=m===G.POSITION?b:m===G.NORMAL?d:void 0,void 0!==n&&3===h.size)for(m=a.indices[m],y=h.data,h=f,t=q,w=m.length,r=0;r<w;++r){var x=3*m[r],u=y[x],v=y[x+1],x=y[x+2];h[k]=n[0]*u+n[4]*v+n[8]*x+n[12];h[k+1]=n[1]*u+n[5]*v+n[9]*x+n[13];h[k+2]=n[2]*u+n[6]*v+n[10]*x+n[14];k+=t}else N(a.indices[m],h.data,h.size,f,k,q)}}};g.triangleVertexArrayToWireframeLines=function(a,b,d,c){for(d=Math.floor(d/3)-1;0<=d;d--){var e=b+3*d*c,f=b+6*d*c+5*c;z(a,e,a,f,null,c);f-=c;z(a,e+c,a,f,null,c);f-=c;z(a,
e+c,a,f,null,c);f-=c;z(a,e+2*c,a,f,null,c);f-=c;z(a,e+2*c,a,f,null,c);f-=c;z(a,e,a,f,null,c)}};g.intersectTriangleGeometry=function(a,b,d,c,e,f,g){I.assert("triangle"===a.data.primitiveType);b=b.componentVisibilities;c=c.tolerance;if(1<a.getComponentCount()){d=Q(e,f,R);var l=a.getBoundingInfo();C.setMin(A,l.getBBMin());C.setMax(A,l.getBBMax());if(H(A,e,d,c))for(var q=a.data,l=a.getComponentCount(),p=q.getIndices(G.POSITION),m=q.getAttribute(G.POSITION),q=q.componentOffsets,k=0;k<l;k++)if(L.getVisibility(b,
k)){var h=a.getComponentAABB(k,A);H(h,e,d,c)&&K(e,f,q[k]/3,q[k+1]/3,p,m,void 0,g)}}else L.getVisibility(b,0)&&P(a.getBoundingInfo(),e,f,c,g)};var R=p.vec3d.create(),S=Math.pow(2,-52),aa=p.vec3d.create();g.intersectTriangles=K;var U=p.vec3d.create(),V=p.vec3d.create();g.computeNormal=T;g.intersectAabbInvDir=H;g.transformToWorld=function(a,b,d){return p.vec4d.set4(a[0]-b[0],a[1]-b[1],a[2]-b[2],1,d)};g.transformToView=function(a,b,d,c){p.mat4d.translate(d,b,X);d=X;return p.mat4d.multiplyVec4(d,a,c)};
g.transformToProjection=function(a,b,d,c){c[0]=a[0]+d[0];c[1]=a[1]+d[1];c[2]=a[2]+d[2];c[3]=a[3];return p.mat4d.multiplyVec4(b,c)};g.transformToNDC=function(a,b){return p.vec4d.scale(a,1/Math.abs(a[3]),b)};g.applyScreenSizePerspectiveScale=function(a,b,d,c,e){return M.scale(a,c,d,e)};g.verticalOffsetAtDistance=function(a,b,d,c,e){var f=d.screenLength||0;e&&(f=M.scale(f,c,b,e));return I.clamp(f*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,d.minWorldLength||0,null!=d.maxWorldLength?d.maxWorldLength:Infinity)};
g.aquireIfNotUndefined=function(a,b,d){if(void 0!==a)return b.aquire(a,d)};g.releaseIfNotUndefined=function(a,b){void 0!==a&&b.release(a)};var Y=p.mat4.create();g.bindView=function(a,b,d){p.mat4d.translate(b,a,Y);d.setUniform3fv("localOrigin",a);d.setUniformMatrix4fv("view",Y)};g.bindCamPos=function(a,b,d){d.setUniform3f("camPos",b[3]-a[0],b[7]-a[1],b[11]-a[2])};g.bindVerticalOffset=function(a,b,d){if(a){var c=b.fovY;b=b.viewport[3];var e=void 0;void 0===e&&(e=ca);e.screenLength=a.screenLength;e.perDistance=
Math.tan(.5*c)/(.5*b);e.minWorldLength=a.minWorldLength;e.maxWorldLength=a.maxWorldLength;a=e;d.setUniform4f("verticalOffset",a.screenLength,a.perDistance,a.minWorldLength,a.maxWorldLength)}};g.bindScreenSizePerspective=function(a,b,d){void 0===d&&(d="screenSizePerspectiveAlignment");if(a){var c=a.parameters;b.setUniform4f(d,c.divisor,c.offset,c.minPixelSize,a.paddingPixelsOverride)}};g.copyParameters=W;g.updateParameters=function(a,b){var d=!1,c;for(c in b){var e=b[c];void 0!==e&&(d=!0,Array.isArray(e)?
a[c]=e.slice():a[c]=e)}return d};g.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ca={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});