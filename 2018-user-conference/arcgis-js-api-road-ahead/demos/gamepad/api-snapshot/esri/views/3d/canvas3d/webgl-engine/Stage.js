// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("./parts/Model ./parts/View ./lib/Selector ./lib/Camera ./lib/gl-matrix ./lib/Util".split(" "),function(u,D,y,B,p,q){var v=q.assert,E=p.vec2d,F=p.vec2,m=p.vec3d,k=function(p,G){var w=!0;this.needsRender=function(){return w};this.setNeedsRender=function(){w=!0};this.resetNeedsRender=function(){w=!1};this.dispose=function(){e.dispose();f=e=null};this.setSelectionObject=function(a,b,c){f.setSelection(a,c);e.setSelectionObject(void 0!==a?a.getId():void 0,c);if(!b)this.onSelectionChange(a,c)};this.getSelectionObject=
function(){return f.getSelection()};this.setHighlightObjects=function(a,b){e.setHighlightObjects(a,b);this.highlightedObjectIds=b&&-1===b.holdTime?a:void 0};this.frame=function(a,b){a=B.frameCenterRadiusWithPadding(a.getCenter(),a.getBSRadiusApprox(),b);b=this.getCamera();var c=b.computeDirection();m.scale(c,-(1.5*a.radius/Math.tan(b.fov)));m.set(a.center,b.center);m.add(a.center,c,b.eye);b=new B(b.eye,b.center,b.up);this.setCamera(b)};this.beginMod=function(){k.DebugSettings.fineGrainedContentValidation&&
f.validateContent()};this.add=function(a,b){f.add(a,b);"function"==typeof b.addParentStage&&b.addParentStage(this)};this.remove=function(a,b){a=f.remove(a,b);"function"==typeof a.removeParentStage&&a.removeParentStage(this);return a};this.endMod=function(a){k.DebugSettings.fineGrainedContentValidation&&!a&&f.validateContent()};this.notifyDirty=function(a,b,c,d){f.notifyDirty(a,b,c,d)};this.processDirty=function(){var a=f.getDirtySet(),b=a.getDirtyMaterials();if(a.hasDirtyGeometryRecords()||b){k.DebugSettings.endFrameContentValidation&&
f.validateContent();k.DebugSettings.logDirtySet&&console.log("Dirty set: "+f.getDirtySet().formatDebugInfo(!1));for(var c=0;c<g.length;c++){var d=a.getAddRemoveUpdateListFilteredByLayers(g[c],!1);(0<d[0].length+d[1].length+d[2].length||b)&&e.modify(d[0],d[1],d[2],b,c);k.DebugSettings.logDirtySet&&0===c&&(console.log("RGs add: "+d[0].map(function(a){return a.uniqueName})),console.log("RGs remove: "+d[1].map(function(a){return a.uniqueName})))}this._updateViewExtent();a.getAddRemoveUpdateList(!0);a.clearDirtyMaterials();
w=!0}};this.processDirtyLayer=function(a){v(0===g[1].length,"Method not implemented for multiple visualizers");var b=f.getDirtySet(),c=b.getDirtyMaterials();a=b.getAddRemoveUpdateListFilteredByLayers([a],!0);(0<a[0].length+a[1].length+a[2].length||c)&&e.modify(a[0],a[1],a[2],c,0);b.clearDirtyMaterials()};this.get=function(a,b){return f.get(a,b)};this.getAll=function(a){return f.getAll(a)};this.addTextureListener=function(a){e.addTextureListener(a)};this.removeTextureListener=function(a){e.removeTextureListener(a)};
this.getContainer=function(){return C};this.getCamera=function(){return e.getCamera()};this.setCamera=function(a){e.setCamera(a)};this.getViewParams=function(a){return e.getViewParams(a)};this.setViewParams=function(a){e.setViewParams(a);void 0!==a.fovX&&this._updateViewExtent();void 0!==a.viewMode&&(e.setLights(f.getAmbientLight(),f.getDirectionalLight()),g=[[],[]])};this.getLayers=function(){return f.getAll(k.ModelContentType.LAYER)};this.getAmbientLight=function(){return f.getAmbientLight()};this.getDirectionalLight=
function(){return f.getDirectionalLight()};this.setAmbientLight=function(a){f.setAmbientLight(a);e.setLights(f.getAmbientLight(),f.getDirectionalLight())};this.setDirectionalLight=function(a){f.setDirectionalLight(a);e.setLights(f.getAmbientLight(),f.getDirectionalLight())};this.getCanvas=function(){return e.getCanvas()};this.setRenderParams=function(a){e.setRenderParams(a)};this.getRenderParams=function(){return e.getRenderParams()};this.has=function(a){return e.has(a)};this.getViewContent=function(a){return g[a||
0].slice(0)};this.setViewContent=function(a,b){b||(b=0);v(0<=b&&b<g.length,"Stage.setViewContent: invalid index");var c=q.array2object(g[b]),d=q.array2object(a),l=q.subtractObjects(d,c),c=q.subtractObjects(c,d);this.processDirty();d=f.getDirtySet();l=d.getResidentRenderGeometriesFilteredByLayers(q.object2array(l));c=d.getResidentRenderGeometriesFilteredByLayers(q.object2array(c));e.modify(l,c,{},b);g[b]=a.slice(0)};this.addToViewContent=function(a,b){b||(b=0);v(0<=b&&b<g.length,"Stage.addToViewContent: invalid index");
for(var c=[],d=0;d<a.length;d++)-1===g[b].indexOf(a[d])&&c.push(a[d]);0<a.length&&(this.processDirty(),a=f.getDirtySet().getResidentRenderGeometriesFilteredByLayers(c),e.modify(a,[],{},b),g[b].push.apply(g[b],c))};this.removeFromViewContent=function(a,b){b||(b=0);v(0<=b&&b<g.length,"Stage.RemoveFromViewContent: invalid index");this.processDirty();for(var c=f.getDirtySet(),d=g[b],l=[],x=0;x<a.length;x++){var k=d.indexOf(a[x]);-1<k&&(d[k]=d[d.length-1],d.pop(),l.push(a[x]))}a=c.getResidentRenderGeometriesFilteredByLayers(l);
e.modify([],a,{},b)};this.getViewFrustumObjects=function(){return e.getFrustumObjects()};this.getLocalOrigin=function(a,b,c){return f.getOrigin(a,b,c)};this.resize=function(){return e.resize()};this.onReady=function(){};this.onRender=function(){};this.onSelectionChange=function(){};this.onGeometryPicked=function(){};this.onViewExtentUpdated=function(){};this.addModelListener=function(a){return f.addModelListener(a)};this.removeModelListener=function(a){f.removeModelListener(a)};this.addFPSListener=
function(a){e.addFPSListener(a)};this.removeFPSListener=function(a){e.removeFPSListener(a)};this.renderScreenshots=function(a,b,c){return e.renderScreenshots(a,b,c)};this.getFrameTask=function(){return e.getFrameTask()};this.requestScreenCapture=function(a,b){e.requestScreenCapture(a,b)};this.getAllTexturesLoaded=function(){return e.getAllTexturesLoaded()};this.getTextureLoaded=function(a){return e.getTextureLoaded(a)};this.addExternalRenderer=function(a,b){"function"===typeof b.intersect&&n.push(b);
return e.addExternalRenderer(a,b)};this.removeExternalRenderer=function(a,b){var c=n.indexOf(b);-1<c&&(n[c]=n[n.length-1],n.pop());return e.removeExternalRenderer(a,b)};this.getContentDebugStrings=function(a){return f.formatDebugInfo(a)};this.getRenderStats=function(){return e.getCombinedStats()};this.getRenderStatString=function(a){var b=this.getRenderStats(),c="";if(a){var c=c+"\x3ctable\x3e",d;for(d in b)c+="\x3ctr\x3e\x3ctd\x3e"+d+'\x3c/td\x3e\x3ctd style\x3d"text-align: right"\x3e'+Math.round(b[d])+
"\x3c/td\x3e\x3c/tr\x3e";c+="\x3c/table\x3e"}else for(d in b)c+=d+": "+b[d]+"\n";return c};this._pick=function(a,b,c,d,f){var l=m.create(),g=m.create();e.getPickRay(a,l,g);return this.pickRay(l,g,a,a,b,c,d,f)}.bind(this);this.pickRayWithBeginPoint=function(a,b,c,d,f){e.pickRayWithBeginPoint(a,b,c,d,f)};var H=E.create(),t=F.create(),z=m.create(),A=new y;this.pickRay=function(a,b,c,d,l,g,k,r){var h;h=d?e.getSideIndexForPoint(d):0;var m=e.getCamera();c||(c=H,m.projectPoint(b,c));if(l)for(d=Array(l.length),
h=0;h<d.length;h++)d[h]=f.get(u.ContentType.LAYER,l[h]);else{d=[];l=this.getViewContent(h);var q=f.getAll(u.ContentType.LAYER);for(h=0;h<l.length;h++){var p=q[l[h]];p&&"VISIBLE"===p.getState()&&d.push(p)}}r?r.init(d,g,a,b,c,m,k):r=new y(d,g,a,b,c,m,k);for(h=0;h<n.length;h++)n[h].intersect(r,a,b,c);if(r.getHudResults().length){b=r.getHudResults();b.sort(function(a,b){return b.dist-a.dist});b=b[b.length-1];m.projectPoint(b.center,t);t[0]=Math.round(t[0]);t[1]=Math.round(t[1]);e.getPickRay(t,a,z);A.init(d,
g,a,z,t,m,!1);for(h=0;h<n.length;h++)n[h].intersect(A,a,z,t);b.dist<=A.getMinResult().dist&&(r.getMinResult().set(b.object,b.name,b.dist,b.normal,b.priority),r.getMinResult().setIntersector("stage"))}return r}.bind(this);var I=new y;this._select=function(a){var b=this._pick(a,this.highlightedObjectIds,null,!0,I).getMinResult(),c=b.object;this.onGeometryPicked(c,a,b);if(c&&(a=c.getParentLayer(),c===f.getSelection()||a&&"PICKABLE"!==a.getInteraction())){var d=c.getFaceRangeFromTriangleNr(b.triangleNr);
if(null==d||null!=f.getSelectionFaceRange()&&JSON.stringify(d)===JSON.stringify(f.getSelectionFaceRange()))c=void 0}this.selectionState&&this.setSelectionObject(c,!1,d)};this.getViewExtent=function(){var a=Number.MAX_VALUE,a={min:m.create([a,a,a]),max:m.create([-a,-a,-a])},b=f.getAll(k.ModelContentType.LAYER),c;for(c in b)if(0<b[c].getObjects().length){var d=b[c].getFullExtent();if(void 0!==d)for(var e=0;3>e;++e)a.min[e]=Math.min(a.min[e],d[0][e]),a.max[e]=Math.max(a.max[e],d[1][e])}return a};this._updateViewExtent=
function(){var a=null;this.onViewExtentUpdated(function(){null===a&&(a=this.getViewExtent());return a}.bind(this))};this.getTextureGraphicsRenderer=function(){return e.getTextureGraphicsRenderer()};this._getModule=function(a){switch(a){case "model":return f;case "view":return e;default:return e._getModule(a)}};var C=p,f=new u,e=new D(C,this,f.getDirtySet(),G),g=[[],[]],n=[];e.setLights(f.getAmbientLight(),f.getDirectionalLight());this._debugHideFaceRange=function(a,b){a=this.getAll("objects")[a];
a.hideFaceRange(a.getGeometryRecords()[0],0,[a.getMetadata().faceRanges[b]])};this._debugHideAllFaceRange=function(a){a=this.getAll("objects")[a];for(var b in a.getMetadata().faceRanges)a.hideFaceRange(a.getGeometryRecords()[0],0,[a.getMetadata().faceRanges[b]])};this._debugUnhideFaceRange=function(a,b){this.getAll("objects")[a].unhideAllFaceRange()}};k.DebugSettings={fineGrainedContentValidation:!1,endFrameContentValidation:!1,logDirtySet:!1};k.ModelContentType=u.ContentType;return k});