// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/arrayUtils ../../../geometry/support/aaBoundingRect ../lib/glMatrix ../support/mathUtils ./ElevationData ./ElevationTileAgent ./MapTileAgent ./TerrainConst ./terrainUtils ./TileAgent ./TilePerLayerInfo ./tileUtils".split(" "),function(J,K,B,v,f,q,C,w,x,h,D,G,E,y){function z(d){d instanceof w?w.Pool.release(d):d instanceof x&&x.Pool.release(d)}var F=D.weakAssert,u=f.vec3d.create(),g=f.vec4d.create(),r=f.vec4d.create(),H=f.vec3d.create(),m=G.AGENT_DONE,t=h.LayerClass.LAYER_CLASS_COUNT,
A=h.LayerClass.MAP,n=h.LayerClass.ELEVATION,p=h.TileUpdateTypes;return function(){function d(a){this.lij=[0,0,0];this.extent=v.create();this.elevationBounds=f.vec2d.create();this.children=[null,null,null,null];this.layerInfo=Array(t);this.extentWGS84Rad=v.create();this.centerAtSeaLevel=f.vec3d.create();this.center=f.vec3d.create();this.tileUp=H;this.intersectsClippingArea=this.isWithinClippingArea=!0;this.clippingArea=null;this.radius=this.edgeLen=this.renderOrder=this.screenDepth=this._maxTesselation=
0;this.numSubdivisionsAtLevel=a}d.prototype.init=function(a,b,c,e){this.lij[0]=a[0];this.lij[1]=a[1];this.lij[2]=a[2];e.getExtent(a[0],a[1],a[2],this.extent,this.extentWGS84Rad);this.intersectsClippingArea=this.isWithinClippingArea=!0;this.clippingArea=null;this.radius=this.edgeLen=0;this.vlevel=a?a[0]:0;b&&b.elevationBounds?f.vec2d.set(b.elevationBounds,this.elevationBounds):f.vec2d.set2(0,0,this.elevationBounds);this.parent=b;for(a=0;4>a;a++)this.children[a]=null;this.pendingUpdates=0;this.renderData=
null;this.screenDepth=0;this.visible=!1;this.parentSurface=c;for(a=0;a<t;a++)if(c){b=c.numLayers(a);var k=void 0;this.layerInfo[a]?(k=this.layerInfo[a],k.length=b):(k=Array(b),this.layerInfo[a]=k);for(var d=0;d<b;d++)k[d]=E.makeEmptyLayerInfo(a,k[d]),a===n&&this.findElevationBoundsForLayer(d,-1)}else this.layerInfo[a]=null;this.computeElevationBounds();this._maxTesselation=Math.min(e.pixelSize[0],h.MAX_TILE_TESSELATION)};d.prototype.dispose=function(){for(var a=0;a<t;a++)for(var b=this.layerInfo[a],
c=0;c<b.length;c++)b[c].dispose()};d.prototype.isVisible=function(a,b){return!0};d.prototype.createGeometry=function(a,b,c,e){};d.prototype.updateScreenDepth=function(a){f.vec3d.set(this.center,r);r[3]=1;f.mat4d.multiplyVec4(a,r,r);this.screenDepth=r[2]/r[3]};d.prototype.shouldSplit=function(a,b){var c=this.lij[0];f.vec3d.subtract(this.center,b,u);var e=f.vec3d.length(u),k=this.edgeLen/(a[0]*e*2),d=this.edgeLen/(a[2]*e*2),l=a[1],I=a[3],h=a[4];a=a[5];return e<this.edgeLen&&c<h?p.SPLIT:k<l?this.vlevel!==
this.lij[0]?(this.vlevel=this.lij[0],p.VSPLITMERGE):p.NONE:c>=h?(d=c+Math.ceil(-q.log2(l/k)),d!==this.vlevel?(this.vlevel=d,p.VSPLITMERGE):p.NONE):6<c&&(f.vec3d.scale(this.tileUp,f.vec3d.dot(this.tileUp,u),g),f.vec3d.subtract(g,u),f.vec3d.length2(g)>this.radius*this.radius&&(f.vec3d.scale(g,this.radius/f.vec3d.length(g)),f.vec3d.add(g,this.center),f.vec3d.subtract(b,g,g),b=this.elevationBounds[1]-this.elevationBounds[0],Math.min(1,(Math.abs(f.vec3d.dot(g,this.tileUp))+.5*b+this.curvatureHeight)/f.vec3d.length(g))*
d<.1/a*I))?p.NONE:p.SPLIT};d.prototype.decodeElevationData=function(a){var b;if(a instanceof ArrayBuffer)try{b=C.createFromLERC(this.lij,this.extent,a,h.noDataValueOpt)}catch(c){console.warn("Error decoding raw data: %s",c.message)}else b=C.createFromFetchTileResult(this.lij,this.extent,a);return b};d.prototype.getWGS84Extent=function(){var a=this.extentWGS84Rad;return v.fromValues(q.rad2deg(a[0]),q.rad2deg(a[1]),q.rad2deg(a[2]),q.rad2deg(a[3]))};d.prototype.load=function(a){for(var b=0;b<t;b++)this.layerInfo[b]&&
this._createOrUpdateAgents(0,b);a.loadTile(this)};d.prototype.unload=function(a){this.renderData&&a.unloadTile(this);for(a=0;a<t;a++)for(var b=this.layerInfo[a],c=0;c<b.length;c++){var e=b[c];e.loadingAgent&&e.loadingAgent!==m&&(e.loadingAgent.dispose(),z(e.loadingAgent),e.loadingAgent=null);e.pendingUpdates=0}this.pendingUpdates&=~h.TileUpdateTypes.UPDATE_GEOMETRY;this.pendingUpdates&=~h.TileUpdateTypes.UPDATE_TEXTURE};d.prototype.updateClippingStatus=function(a){if(B.equals(a,this.clippingArea))return!1;
var b=this.intersectsClippingArea,c=this.isWithinClippingArea;a?(this.intersectsClippingArea=this.intersectsExtent(a),this.isWithinClippingArea=this.isWithinExtent(a)):this.isWithinClippingArea=this.intersectsClippingArea=!0;this.clippingArea=a;a=c&&this.isWithinClippingArea;b=!c&&!b&&!this.isWithinClippingArea&&!this.intersectsClippingArea;!this.renderData||a||b||this.updateGeometry();return!0};d.prototype.updateVisibility=function(a,b,c){a=(c||this.isVisible(a,b))&&this.intersectsClippingArea;if(a!==
this.visible)for(this.visible=a,b=this.layerInfo[0],c=0;c<b.length;c++){var e=b[c];e.loadingAgent&&e.loadingAgent!==m&&e.loadingAgent.setSuspension(!a)}return a};d.prototype.getLayerInfo=function(a,b){return this.layerInfo[b][a]};d.prototype.hasLayerData=function(a,b){return(a=this.layerInfo[b][a])&&a.data&&!a.dataInvalidated};d.prototype.tileDataAvailable=function(a,b,c){return(b=this.layerInfo[c][b].tilemap)?"unavailable"!==b.getAvailability(a.lij[1],a.lij[2]):!0};d.prototype.requestLayerData=function(a,
b,c){h.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),b,a,c.tile.lij.toString());var e=this.layerInfo[b][a];if(-1<e.waitingAgents.indexOf(c))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),!0;if(e.data&&!e.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),
b,a),e.waitingAgents.push(c),setTimeout(c.dataArrived.bind(c,this),0),!0;if(e.pendingUpdates&p.DECODE_ELEVATION)return e.waitingAgents.push(c),!0;e.waitingAgents.push(c);if(!e.requestPromise){var k=this.parentSurface.requestTileData(this,a,b);if(k.isFulfilled())return!1;a=function(){e.requestPromise===k&&(e.requestPromise=null)};e.requestPromise=k;k.then(a,a);return!!k}return!0};d.prototype.descendants=function(a){a||(a=[]);for(var b=0;4>b;b++){var c=this.children[b];c&&(c.descendants(a),a.unshift(this.children[b]))}return a};
d.prototype.isLij=function(a){return this.lij[0]===a[0]&&this.lij[1]===a[1]&&this.lij[2]===a[2]};d.prototype.findByLij=function(a){if(this.isLij(a))return this;for(var b=0;4>b;b++){var c=this.children[b];if(c&&(c=c.findByLij(a)))return c}return null};d.prototype.unrequestLayerData=function(a,b,c){h.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),b,a,c.tile.lij.toString());var e=this.layerInfo[b][a],k=e.waitingAgents;c=k.indexOf(c);F(-1<c,"agent has not requested this piece of map data");
k[c]=k[k.length-1];k.length--;1>k.length&&(k=e.requestPromise,c=!1,b===A&&(c=this.parentSurface.layerViewByIndex(a,A),c=D.isVectorTileLayerView(c)),c||F(k||e.rawData,"no pending operations on layerInfo that agents were waiting for"),k&&!k.isFulfilled()&&(k.cancel(),e.requestPromise=null),h.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),b,a))};d.prototype.dataArrived=function(a,b,c){a=this.layerInfo[b][a];a.data=c;a.dataInvalidated=!1;for(c=0;c<
a.waitingAgents.length;c++)a.waitingAgents[c].dataArrived(this);a.waitingAgents.length=0};d.prototype.dataMissing=function(a,b,c){c.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),b,a);a=this.layerInfo[b][a];a.dataMissing=!0;for(b=0;b<a.waitingAgents.length;b++)a.waitingAgents[b].dataMissing(this);a.waitingAgents.length=0};d.prototype.updateTexture=function(a){this.renderData&&(a?this.parentSurface.renderer.updateTileTexture(this):(this.pendingUpdates|=h.TileUpdateTypes.UPDATE_TEXTURE,
this.parentSurface.setPendingUpdates()))};d.prototype.invalidateLayerData=function(a,b){this.layerInfo[b][a].invalidateSourceData();this.restartAgents(b)};d.prototype.computeElevationBounds=function(){f.vec2d.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var a=this.layerInfo[n],b=!1,c=0;c<a.length;c++){var e=a[c];e.elevationBounds&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],e.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],e.elevationBounds[1]),
b=!0)}b||f.vec2d.set2(0,0,this.elevationBounds);this.updateRadiusAndCenter()};d.prototype.updateRadiusAndCenter=function(){f.vec3d.scale(this.tileUp,.5*(this.elevationBounds[0]+this.elevationBounds[1]),g);f.vec3d.add(this.centerAtSeaLevel,g,this.center)};d.prototype.findElevationBoundsForLayer=function(a,b){var c=this.layerInfo[n][a];if(!c.elevationBounds||c.elevationBounds[2]<b)if(b=this.parentSurface.layerViewByIndex(a,n),y.fallsWithinLayer(this,b.layer,!1)){b=!1;if(c.data){var e=c.data;f.vec2d.set(e.bounds,
g);g[2]=this.lij[0];b=!0}else{for(var k=this.parent,d=0,l=null,e=c.data;k&&(!e||d<h.ELEVATION_DESIRED_RESOLUTION_LEVEL);){d=this.vlevel-k.lij[0];l=e||l;e=k.layerInfo[n][a].data;if(!e&&l&&d>=h.ELEVATION_DESIRED_RESOLUTION_LEVEL)break;k=k.parent}if(e=e||l)e.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],g),Infinity!==g[0]&&(g[2]=e.level,b=!0)}b&&(c.elevationBounds?f.vec3d.set(g,c.elevationBounds):c.elevationBounds=[g[0],g[1],g[2]])}};d.prototype.updateGeometry=function(){this.pendingUpdates|=
h.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface.setPendingUpdates()};d.prototype.modifyLayers=function(a,b,c){for(var e=b.length,d=this.layerInfo[c],f=Array(e),l=0;l<d.length;l++){var h=d[l];h.loadingAgent&&h.loadingAgent!==m&&(h.loadingAgent.dispose(),z(h.loadingAgent),h.loadingAgent=null);h.waitingAgents.length=0}if(c===A)for(l=0;l<d.length;l++)void 0===a[l]&&d[l].dispose();for(l=0;l<e;l++)a=b[l],f[l]=-1<a?d[a]:E.makeEmptyLayerInfo(c);this.layerInfo[c]=f};d.prototype.restartAgents=function(a){if(this.renderData)if(this._createOrUpdateAgents(0,
a),a===n){this.updateGeometry();a=this.layerInfo[a];for(var b=0;b<a.length;b++)a[b].pendingUpdates|=h.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface.setPendingUpdates()}else this.updateTexture(!0)};d.prototype.updateAgents=function(a){if(this.renderData){for(var b=this.layerInfo[a],c=0;c<b.length;c++){var e=b[c];e.loadingAgent===m&&(e.loadingAgent=null)}this._createOrUpdateAgents(0,a)}};d.prototype.removeLayerAgent=function(a,b){a=this.layerInfo[b][a];a.loadingAgent&&a.loadingAgent!==m&&a.loadingAgent.dispose();
a.loadingAgent=null};d.prototype.agentDone=function(a,b){var c=this.layerInfo[b],e=c[a];e.loadingAgent=m;e.data||e.upsampleFromTile||a<c.length-1&&this._createOrUpdateAgents(a+1,b)};d.prototype._createOrUpdateAgents=function(a,b){var c;c=b===n?!1:!this.visible;for(var e=this.layerInfo[b];a<e.length;){var d=e[a],f=!1,l=this.parentSurface.layerViewByIndex(a,b);if(null!==d.loadingAgent&&d.loadingAgent!==m)f=d.loadingAgent.update();else if(d.loadingAgent!==m&&y.fallsWithinLayer(this,l.layer,!1)){var g;
g=b===h.LayerClass.ELEVATION?w.Pool.acquire():x.Pool.acquire();(f=g.init(this,a,b,c))?d.loadingAgent=g:(g.dispose(),z(g),d.loadingAgent=m)}if(f&&!l.isTransparent)break;a++}};d.prototype.geometryState=function(a){var b,c=this._getElevationInfo(a?a.samplerData:null),e=this.lij[0],d=!1;c.samplerData?(b=this.vlevel-e,b=Math.max(e-c.maxTileLevel,h.ELEVATION_DESIRED_RESOLUTION_LEVEL-b),e=this._maxTesselation,b=q.clamp((e>>b)+1,2,e+1)):b=8>e?this.numSubdivisionsAtLevel[e]+1:2;e=this.clippingArea;if(!this.intersectsClippingArea||
this.isWithinClippingArea)e=null;a?(a.numVertsPerRow!==b&&(a.numVertsPerRow=b,d=!0),c.changed&&(a.samplerData=c.samplerData,d=!0),B.equals(a.clippingArea,e)||(a.clippingArea=e,d=!0),a.needsUpdate=d):a={numVertsPerRow:b,samplerData:c.samplerData,needsUpdate:!0,clippingArea:e};return a};d.prototype._getElevationInfo=function(a){for(var b=this.layerInfo[n],c=b.length,e=Array(c),d=0,f=0,l=!1,h=0;h<c;h++){var g=b[h];if(g.upsampleFromTile){var g=g.upsampleFromTile.tile,m=g.layerInfo[n][h].data;a&&a[d]===
m.samplerData||(l=!0);e[d++]=m.samplerData;f=Math.max(f,g.lij[0])}else g.data&&(m=this.parentSurface.layerViewByIndex(h,n),y.fallsWithinLayer(this,m.layer,!1)&&(m=g.data,a&&a[d]===m.samplerData||(l=!0),e[d++]=m.samplerData,f=this.lij[0]))}a&&a.length!==d&&(l=!0);0<d?e.length=d:e=null;return{changed:l,samplerData:e,maxTileLevel:f}};d.prototype.isWithinExtent=function(a){var b=this.extent;return b[0]>=a[0]&&a[2]>=b[2]&&b[1]>=a[1]&&a[3]>=b[3]};d.prototype.intersectsExtent=function(a){var b=this.extent;
return b[2]>=a[0]&&a[2]>=b[0]&&b[3]>=a[1]&&a[3]>=b[1]};return d}()});