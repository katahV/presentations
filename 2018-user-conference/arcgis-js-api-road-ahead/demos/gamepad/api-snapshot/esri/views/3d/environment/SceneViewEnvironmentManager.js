// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../core/Accessor ../../../core/Evented ../../../core/Handles ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../geometry/Point ../../../geometry/SpatialReference ../../../geometry/support/webMercatorUtils ./EnvironmentRenderer ./SceneViewBackgroundPlain ../lib/glMatrix ../support/earthUtils ../support/sunUtils ../webgl-engine/lighting/Lightsources".split(" "),
function(f,l,w,h,x,y,z,p,k,g,q,r,A,B,C,e,t,m,n){Object.defineProperty(l,"__esModule",{value:!0});var u=[.5773502691896258,-.5773502691896258,.5773502691896258];f=function(f){function c(a){a=f.call(this)||this;a.referencePointUpdateDelay=200;a.referencePointUpdateInterval=3E3;a.referencePointUpdateDistThreshold=1E6;a._referencePosUpdateQuery=null;a._referencePosMapCoordsRequested=null;a._viewHandles=new z;a._preserveAbsoluteDateTime=!1;a._trackingEnabled=!1;a._viewConnected=!1;a._referencePosResetPreserveAbsoluteTime=
!1;a._referencePosUpdateTimer=null;a._referencePosWGS84=null;a._referencePosMapCoords=null;a._mainLight=new n.MainLight;a._ambientLight=new n.AmbientLight;a._moonLight=new n.FillLight;a._environmentRenderer=null;a._resetReferencePosition();return a}w(c,f);c.prototype.destroy=function(){this._viewHandles.destroy();this.disposeRendering()};Object.defineProperty(c.prototype,"updating",{get:function(){return!this.noReferencePositionQueries&&(!!this._referencePosUpdateQuery||!!this._referencePosMapCoordsRequested)},
enumerable:!0,configurable:!0});c.prototype.updateReadyChange=function(a){a&&!this._viewConnected?(this._viewConnected=!0,this.connectView(this.view)):!a&&this._viewConnected&&(this._viewConnected=!1,this.disconnectView(this.view))};c.prototype.disposeRendering=function(){this._environmentRenderer&&(this._environmentRenderer.destroy(),this._environmentRenderer=null);this._resetReferencePosition(!0)};c.prototype.connectView=function(a){this._environmentRenderer=new B({view:a});this._viewHandles.add([k.on(this.view,
"environment.lighting","date-will-change",this._lightingDateHandler.bind(this)),this.view.watch("interacting,stationary",this._interactingStationaryHandler.bind(this)),this.view.watch(["environment.lighting.directShadowsEnabled","environment.lighting.ambientOcclusionEnabled","environment.background.color"],this._updateRenderParamsHandler.bind(this)),this.view.watch("spatialReference",this._spatialReferenceHandler.bind(this)),k.init(this.view,"viewingMode",this._viewingModeHandler.bind(this)),k.init(this.view,
"environment.lighting.cameraTrackingEnabled",this._updateCameraTracking.bind(this),!0),this.watch("noReferencePositionQueries",this._cameraHandler.bind(this,null))]);this._updateRenderParamsHandler();this._updateLightParams();this._cameraHandler()};c.prototype._updateCameraTracking=function(a){if(this._trackingEnabled=a)a=k.init(this,"view.state.camera",this._cameraHandler.bind(this,null),!0),this._viewHandles.add(a,"camera");else{if(a=this.get("view.environment.lighting"))a.positionTimezoneInfo.autoUpdated=
!1;this._viewHandles.remove("camera")}};c.prototype.disconnectView=function(a){this.disposeRendering();this._viewHandles.removeAll()};c.prototype._lightingDateHandler=function(a){if(a=a.date){var d=this.view.environment.lighting;if(!d.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;var b=this.view.spatialReference;if(!(b.isWGS84||b.isWebMercator||(b=this.view.camera.position,this._referencePosMapCoords&&this._referencePosMapCoords.equals(b)))){this._requestReferencePositionUpdate(b);
return}this._preupdateTracking(a);this._referencePosWGS84&&(b=t.positionToTimezone(this._referencePosWGS84,v),d.autoUpdate(null,b),this._trackingEnabled&&(d.positionTimezoneInfo.autoUpdated=!0))}this._updateLightParams(a)}};c.prototype._preupdateTracking=function(a){!this._trackingEnabled&&this.get("view.environment.lighting.cameraTrackingEnabled")&&this._cameraHandler(a)};c.prototype._cameraHandler=function(a){void 0===a&&(a=null);if(this.view.ready){var d=this.view.camera;if(d){var b=this.view.spatialReference;
b.isWGS84||b.isWebMercator?this._cameraHandlerGlobal(d,a):this._cameraHandlerLocal(d,a)}}};c.prototype._cameraHandlerGlobal=function(a,d){a=a.position;this._referencePosWGS84||(this._referencePosWGS84=new q({spatialReference:r.WGS84}));a.spatialReference.isWebMercator?A.webMercatorToGeographic(a,!1,this._referencePosWGS84):(this._referencePosWGS84.x=a.x,this._referencePosWGS84.y=a.y);this._referencePosWGS84.z=a.z;this._autoUpdateTimezone(a,d)||this._updateLightParams(d)};c.prototype._cameraHandlerLocal=
function(a,d){a=a.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(a))&&this._requestReferencePositionUpdate(a,!0);this.view.mapCoordsHelper&&this._referencePosWGS84&&(this._referencePosWGS84.z=a.z*this.view.mapCoordsHelper.unitInMeters,this._referencePosChanged())};c.prototype._interactingStationaryHandler=function(){!this.view.interacting&&this.view.stationary&&this._executePendingReferencePositionUpdate()};c.prototype._updateLightParams=
function(a){void 0===a&&(a=null);var d=this.view.environment.lighting;a=a||d.date;var d=this.view._stage,b;this._referencePosWGS84?(b=m.computeColorAndIntensity(a,this._referencePosWGS84),m.computeDirection(a,this._referencePosWGS84,this.view.viewingMode,b.diffuse.direction)):b={diffuse:{color:[1,1,1],intensity:.55,direction:u},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0};e.vec3d.scale(b.diffuse.color,b.diffuse.intensity*Math.PI,this._mainLight.intensity);e.vec3d.negate(b.diffuse.direction,
this._mainLight.direction);e.vec3d.scale(b.ambient.color,b.ambient.intensity,this._ambientLight.intensity);e.vec3d.lerp(D,E,b.globalFactor,this._moonLight.intensity);e.vec3d.scale(this._moonLight.intensity,(1-.5*b.globalFactor)*(1-.4*b.noonFactor*(1-b.globalFactor)));e.vec3d.set(b.diffuse.direction,this._moonLight.direction);d.setLighting({lights:[this._mainLight,this._ambientLight,this._moonLight],globalFactor:b.globalFactor,groundLightingFactor:1-b.noonFactor});this._updateRenderParamsHandler()};
c.prototype._autoUpdateTimezone=function(a,d){void 0===d&&(d=null);if(!this.view.get("environment.lighting.cameraTrackingEnabled"))return!1;var b=F;b.setTime((d||this.view.environment.lighting.date).getTime());a=t.positionToTimezone(a,v);var c=this.view.environment.lighting.positionTimezoneInfo;if(!c.autoUpdated)c=a;else if(c.hours===a.hours&&c.minutes===a.minutes&&c.seconds===a.seconds)return!1;var e=b.getUTCHours()-(a.hours-c.hours),f=b.getUTCMinutes()-(a.minutes-c.minutes),c=b.getUTCSeconds()-
(a.seconds-c.seconds);b.setUTCHours(e);b.setUTCMinutes(f);b.setUTCSeconds(c);return d?!1:this.view.environment.lighting.autoUpdate(b,a)};c.prototype._updateRenderParamsHandler=function(){var a=this.view._stage,c=!0;this._referencePosWGS84&&(c=m.computeShadowsEnabled(this._referencePosWGS84,this.view.viewingMode));var b=this.view.environment.background;b&&b instanceof C?(b=b.color,b={type:"plain",color:[b.r/255,b.g/255,b.b/255,b.a]}):b={type:"plain",color:[0,0,0,1]};a&&a.setRenderParams({shadowMap:this.view.environment.lighting.directShadowsEnabled&&
c,ssao:this.view.environment.lighting.ambientOcclusionEnabled,background:b})};c.prototype._spatialReferenceHandler=function(){this._resetReferencePosition()};c.prototype._viewingModeHandler=function(){this._resetReferencePosition()};c.prototype._resetReferencePosition=function(a){void 0===a&&(a=!1);this._cancelReferencePosUpdates();this._referencePosWGS84=this._referencePosResetPreserveAbsoluteTime=this._referencePosMapCoordsRequested=this._referencePosMapCoords=null;a||this.notifyChange("updating")};
c.prototype._requestReferencePositionUpdate=function(a,c){var b=this;void 0===c&&(c=!1);if(this.view.mapCoordsHelper.canProject()&&!this.noReferencePositionQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(a):this._referencePosMapCoordsRequested=a.clone(),this._referencePosResetPreserveAbsoluteTime=!!c,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&!this.view.interacting&&this.view.stationary)){var d=this._referencePosUpdateQuery=p.after(this.referencePointUpdateDelay).then(function(){if(b._referencePosUpdateQuery===
d)return b._doReferencePositionUpdateQuery(function(){return b._referencePosUpdateQuery!==d})}).always(function(){b._referencePosUpdateQuery===d&&(b._referencePosUpdateQuery=null,b._referencePosUpdateTimer||b._executePendingReferencePositionUpdate(),b.notifyChange("updating"))}),e=this._referencePosUpdateTimer=p.after(this.referencePointUpdateInterval).then(function(){b._referencePosUpdateTimer===e&&(b._referencePosUpdateTimer=null,b._referencePosUpdateQuery||b._executePendingReferencePositionUpdate())});
this.notifyChange("updating")}};c.prototype._doReferencePositionUpdateQuery=function(a){var c=this;this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1);this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone();this._referencePosMapCoordsRequested=this._referencePosResetPreserveAbsoluteTime=null;return this.view.mapCoordsHelper.toGeographic(this._referencePosMapCoords).then(function(b){if(!a()&&
!isNaN(b[0])&&!isNaN(b[1])){var d=c._referencePosMapCoords.z*c.view.mapCoordsHelper.unitInMeters;c._referencePosWGS84?(c._referencePosWGS84.x=b[0],c._referencePosWGS84.y=b[1],c._referencePosWGS84.z=d):c._referencePosWGS84=new q({x:b[0],y:b[1],z:d,spatialReference:r.WGS84});c._referencePosChanged()}})};c.prototype._executePendingReferencePositionUpdate=function(){var a=this._referencePosMapCoordsRequested;a&&this._requestReferencePositionUpdate(a,this._referencePosResetPreserveAbsoluteTime)};c.prototype._referencePosChanged=
function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84)||this._updateLightParams()};c.prototype._exceedsReferencePosDistThreshold=function(a){return this._referencePosMapCoords?(a=this._referencePosMapCoords.distance(a),this.view.mapCoordsHelper&&(a*=this.view.mapCoordsHelper.unitInMeters),a>this.referencePointUpdateDistThreshold):!0};c.prototype._cancelReferencePosUpdates=function(){this._referencePosUpdateTimer=this._referencePosUpdateQuery=
null};c.FIXED_LIGHT_DIRECTION=u;h([g.property({type:Boolean,dependsOn:["noReferencePositionQueries"],readOnly:!0})],c.prototype,"updating",null);h([g.property()],c.prototype,"noReferencePositionQueries",void 0);h([g.property({constructOnly:!0})],c.prototype,"view",void 0);h([g.property()],c.prototype,"_environmentRenderer",void 0);return c=h([g.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],c)}(g.declared(x,y));l.SceneViewEnvironmentManager=f;var F=new Date,v={hours:0,minutes:0,
seconds:0},D=e.vec3d.createFrom(.22,.22,.33),E=e.vec3d.createFrom(.22,.22,.22);l.default=f});