// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["./Texture","./Util"],function(u,p){var m=p.nextHighestPowerOfTwo,d,q=function(){void 0===d&&(d=document.createElement("canvas"),d.setAttribute("id","canvas2d"),d.setAttribute("width",1024),d.setAttribute("height",1024),d.setAttribute("style","display:none"))},v=function(d){return"rgb("+d.map(function(d){return Math.floor(255*d)}).toString()+")"},l=function r(l,b,w){b=b||{};b.size=b.size||18;b.font=b.font||{family:"Arial"};b.font.family=b.font.family||"Arial";b.font.weight=b.font.weight||
"normal";b.font.style=b.font.style||"normal";var x=v(b.color),t=this;this._id=null;this.getId=function(){null==this._id&&(this._id=u.__idGen.gen(w));return this._id};var n,k=l.split(/\r?\n/);this.getParams=function(){return b};this.getString=function(){return l};this.renderGl=function(c,b){this._createTextTexture(k,c,b);b._isTracingEnabled&&(c._debugTracingType="TextTexture")};this.getTextWidth=function(){q();var c=d.getContext("2d");this.setTextProperties(c,b.size);var h=0,a;for(a in k){var e=c.measureText(k[a]).width;
e>h&&(h=e)}if("italic"==b.font.style||"oblique"==b.font.style||"bold"==b.font.weight||"bolder"==b.font.weight||600<b.font.weight)h+=.3*c.measureText("A").width;return h};this.setTextProperties=function(c,d){c.fillStyle=x;c.font=b.font.style+" "+b.font.weight+" "+d+"px "+b.font.family;c.textAlign="left";c.textBaseline="top";b.canvasStyle&&p.mergeObjects(c,b.canvasStyle,c)};this.getTextHeight=function(){return this.getLineHeight()*k.length};this.getTexcoordScale=function(){if(b.enableMipmapping){var c=
this.getTextHeight(),d=this.getTextWidth();return[d/m(d),c/m(c)]}return[1,1]};this.getLineHeight=function(){return Math.floor(1.2*b.size)};this._createTextTexture=function(c,h,a,e){q();e=d.getContext("2d");e.save();var f=this.getTextWidth(),g=this.getTextHeight();b.enableMipmapping&&(f=m(f),g=m(g));a.bindTexture(a.TEXTURE_2D,h);d.setAttribute("width",f);d.setAttribute("height",g);this.renderText(1,f,g,e,c);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d);c=a.LINEAR;b.enableMipmapping&&
(a.generateMipmap(a.TEXTURE_2D),r.MIPMAP_CREATE?(r.MIPMAP_CREATE(d,a),c=a.LINEAR_MIPMAP_LINEAR):(y(a),c=a.LINEAR_MIPMAP_NEAREST));a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,c);a.bindTexture(a.TEXTURE_2D,null);e.restore()};this.setUnloadFunc=function(c){n=c};this.unload=function(){void 0!==n&&(n(this._id),n=
void 0)};this.renderText=function(c,d,a,e,f,g){a=t.getLineHeight()*c;t.setTextProperties(e,b.size*c);c="center"===e.textAlign?.5*d:"right"===e.textAlign?d:0;c+=f||0;f=0+(g||0);for(var h in k)e.fillText(k[h],c,f),f+=a};var y=function(c){var b=d.getContext("2d"),a=d.getAttribute("width")/2,e=d.getAttribute("height")/2,f=.5,g=1;do d.setAttribute("width",a),d.setAttribute("height",e),this.renderText(b,f,a,e,b,k),c.texSubImage2D(c.TEXTURE_2D,g,0,0,c.RGBA,c.UNSIGNED_BYTE,d),f*=.5,a*=.5,e*=.5,g++;while(1<
a&&1<e)}.bind(this)};l.MIPMAP_CREATE=void 0;return l});