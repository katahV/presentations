// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/views/3d/canvas3d/webgl-engine/materials/internal/util.xml":'\x3c?xml version\x3d"1.0" encoding\x3d"UTF-8"?\x3e\r\n\r\n\x3csnippets\x3e\r\n\r\n\x3csnippet name\x3d"float2rgba"\x3e\x3c![CDATA[\r\n\tvec4 float2rgba(const in float v) { \r\n\t\tvec4 enc \x3d vec4(1.0, 255.0, 65025.0, 160581375.0) * v; \r\n\t\tenc \x3d fract(enc); \r\n\t\tenc -\x3d enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0); \r\n\t\treturn enc; \r\n\t}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"rgba2float"\x3e\x3c![CDATA[\r\n\tfloat rgba2float(vec4 rgba) { \r\n\t\treturn dot(rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0)); \r\n\t}\r\n]]\x3e\x3c/snippet\x3e\t\r\n\r\n\x3csnippet name\x3d"calcFragDepth"\x3e\x3c![CDATA[\r\n\t#extension GL_OES_standard_derivatives : enable \r\n\r\n\tfloat calcFragDepth(const in float depth) {\r\n\t\t//calc polygon offset\r\n\t\tconst float SLOPE_SCALE \x3d 2.0; \r\n\t\tconst float BIAS \x3d 2.0 * .000015259;\t\t// 1 / (2^16 - 1) \r\n\t\tfloat m \x3d max(abs(dFdx(depth)), abs(dFdy(depth))); \r\n\t\tfloat result \x3d depth + SLOPE_SCALE * m + BIAS; \r\n\t\treturn clamp(result, .0, .999999); \r\n\t}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"evalShadow"\x3e\x3c![CDATA[\r\n\t$rgba2float\r\n\r\n\t// "matrix" parameter used to have const qualifier as well, but IE11 couldn\'t deal with it at time of writing.\r\n\t// once IE11 is fine with it, const should probably be re-introduced\r\n\tfloat evalShadow(const in vec3 vpos, const in float depth, const in sampler2D depthTex, const int num, const in vec4 distance, in mat4 matrix[4], const in float halfPxSz) {\r\n\t\tif (halfPxSz \x3c .0) return .0;\r\n\t\t\r\n\t\t//choose correct cascade\r\n\t\tint i \x3d depth \x3c distance[1] ? 0 : depth \x3c distance[2] ? 1 : depth \x3c distance[3] ? 2 : 3;\t\t\r\n\r\n\t\tif (i \x3e\x3d num) return .0;\r\n\t\t\r\n\t\tmat4 mat \x3d i \x3d\x3d 0 ? matrix[0] : i \x3d\x3d 1 ? matrix[1] : i \x3d\x3d 2 ? matrix[2] : matrix[3];\r\n\t\t\r\n\t\tvec4 lv \x3d mat * vec4(vpos, 1.0);\r\n\t\tlv.xy /\x3d lv.w;\r\n\t\t\r\n\t\t//vertex completely outside? -\x3e no shadow\r\n\t\tvec3 lvpos \x3d .5 * lv.xyz + vec3(.5);\t\t\r\n\t\tif (lvpos.z \x3e\x3d 1.0) return .0;\t\t\r\n\t\tif (lvpos.x \x3c .0 || lvpos.x \x3e 1.0 || lvpos.y \x3c .0 || lvpos.y \x3e 1.0) return .0;\r\n\t\t\r\n\t\t//calc coord in cascade texture\r\n\t\tvec2 uv \x3d vec2(float(i - 2 * (i / 2)) *.5, float(i / 2) * .5) + .5 * lvpos.xy;\r\n\t\t\r\n\t\tfloat texSize \x3d .5 / halfPxSz; \r\n\r\n\t\t//filter, offset by half pixels\r\n\t\tvec2 st \x3d fract((vec2(halfPxSz) + uv) * texSize);\r\n\t\t\r\n\t\tfloat s00 \x3d rgba2float(texture2D(depthTex, uv + vec2(-halfPxSz, -halfPxSz))) \x3c lvpos.z ? 1.0 : .0; \r\n\t\tfloat s10 \x3d rgba2float(texture2D(depthTex, uv + vec2(halfPxSz, -halfPxSz))) \x3c lvpos.z ? 1.0 : .0; \r\n\t\tfloat s11 \x3d rgba2float(texture2D(depthTex, uv + vec2(halfPxSz, halfPxSz))) \x3c lvpos.z ? 1.0 : .0; \r\n\t\tfloat s01 \x3d rgba2float(texture2D(depthTex, uv + vec2(-halfPxSz, halfPxSz))) \x3c lvpos.z ? 1.0 : .0; \r\n\r\n\t\treturn mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y); \r\n\t}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"normal2envTC"\x3e\x3c![CDATA[\r\n\tvec2 normal2envTC(vec3 normal) { \r\n\t\tfloat v \x3d .5 + .5 * asin(normal.y) * 0.63661977; \r\n\t\tfloat u \x3d .5 - .5 * atan(normal.z, normal.x) * 0.31830988; \r\n\t\treturn vec2(u, v);\r\n\t}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"vertexShaderShowDepth"\x3e\x3c![CDATA[\r\n\tuniform mat4 proj;\r\n\tattribute vec2 $position;\r\n\tattribute vec2 $uv0;\r\n\tvarying vec2 vtc;\r\n\r\n\tvoid main(void) {\r\n\t\tgl_Position \x3d proj * vec4($position.x, $position.y, .0, 1.0);\r\n\t\tvtc \x3d $uv0;\r\n\t}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\t\x3csnippet name\x3d"fragmentShaderShowDepth"\x3e\x3c![CDATA[\r\n\tprecision mediump float;\r\n\r\n\tuniform sampler2D depthTex;\r\n\tvarying vec2 vtc;\r\n\t$rgba2float\r\n\tvoid main() {\r\n\t//\tgl_FragColor \x3d vec4(vec3(texture2D(depthTex, vtc).a), 1.0);\r\n\t\tgl_FragColor \x3d vec4(rgba2float(texture2D(depthTex, vtc)));\r\n\t//\tgl_FragColor \x3d texture2D(depthTex, vtc);\r\n\t}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"vsUVQuad"\x3e\x3c![CDATA[\r\n\tattribute vec2 $position; \r\n\tvarying vec2 uv; \r\n\r\n\tvoid main(void) { \r\n\t\tgl_Position \x3d vec4($position.x, $position.y, .0, 1.0); \r\n\t\tuv \x3d $position * .5 + vec2(.5); \r\n\t}\r\n]]\x3e\x3c/snippet\x3e\t\r\n\r\n\x3csnippet name\x3d"toScreenCoords"\x3e\x3c![CDATA[\r\n\tvec4 toScreenCoords(vec3 vertex) {\r\n\t\tvec4 vClipSpace \x3d proj * view * vec4((model * vec4(vertex, 1.0)).xyz, 1.0);\r\n\t\tvClipSpace.xy *\x3d screenSize;\r\n\t\treturn vClipSpace/abs(vClipSpace.w);\r\n\t}\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3c/snippets\x3e\r\n\t'}});
define("dojo/text!../materials/internal/util.xml ../lib/GLTextureRep ../lib/GLSLProgramRep ../lib/GLMaterialRep ../lib/ShaderSnippets ../lib/GLVBO ../lib/GLFBO ../lib/TextureRenderer ../lib/Util ../lib/gl-matrix ../lib/webgl-utils ../lib/GLDefaultState ../materials/AtmosphereMaterial ../materials/BillboardMaterial ../materials/HUDMaterial ../materials/LeafCardMaterial ../materials/Material ../materials/RibbonLineMaterial ../materials/WaterMaterial ../materials/internal/SimpleGLMaterial ../materials/internal/TexOnlyGLMaterial ../materials/internal/BlendLayers ../materials/ColorMaterial ../lib/SSAOHelperObscurance ./Model ./Viewport".split(" "),
function(O,P,Q,R,S,T,U,V,t,x,W,X,Y,Z,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,J){var y=x.vec3d,r=x.vec4d;return function(z,A,x,n){var h=document.createElement("canvas");h.setAttribute("style","width: 100%; height:100%; display:block;");var B=[1,1,1,1],q={alpha:n.alpha||!1};null!=n.antialias&&(q.antialias=n.antialias);n=W.setupWebGL(h,q);var b=n[0];n=void 0;t.assert(b);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.web3DDefaultState=new X(b);var D=new t.FPSCounter,K,e,k;(function(){var a=new S;a._parse(O);e=new Q;
k={shaders:{},add:function(a,b){t.assert(void 0===this.shaders[a]);this.shaders[a]=b},get:function(a){t.assert(void 0!==this.shaders[a]);return this.shaders[a]}};fa.loadShaders(a,k,e,b);ga.loadShaders(a,k,e,b);ca.loadShaders(a,k,e,b);ja.loadShaders(a,k,e,b);Y.loadShaders(a,k,e,b);Z.loadShaders(a,k,e,b);aa.loadShaders(a,k,e,b);ba.loadShaders(a,k,e,b);da.loadShaders(a,k,e,b);ea.loadShaders(a,k,e,b);ha.loadShaders(a,k,e,b);ia.loadShaders(a,k,e,b);K=a;return e})();var L=new T.GLVBORep,p=new P(A.getAll(ka.ContentType.TEXTURE),
e,function(){return d.getCamera().viewport},b),E=new R(p,e),F=y.createFrom(0,1,0),d=new J(e,L,E,p,b);n=z.getBoundingClientRect();q=d.getCamera();q.viewport[2]=n.width;q.viewport[3]=n.height;d.setCamera(q);var G=new V(b,h,e,E,p,x),v=[],u=!0,H=!0;z.appendChild(h);this.dispose=function(){d.dispose();d=null;G.dispose();G=null;e.dispose();e=null;z.contains(h)&&z.removeChild(h);b=h=null};this.getCombinedStats=function(){return d.getCombinedStats()};var M=function(){u=!1;A.resetNeedsRender();d.resetNeedsRender();
p.resetNeedsRender()};this.resetNeedsRender=M;var N=function(){return A.needsRender()||u||!H||d.needsRender()||p.needsRender()};this.needsRender=function(){return N()};var I=!1,la={preRender:function(){A.processDirty();N()?(I=!0,d.getCamera().setGLViewport(b),b.clearColor.apply(b,B),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT)):I=!1},render:function(){I&&(b.web3DDefaultState.apply(),d.render(F,null))},postRender:function(){},update:function(){if(0!==v.length){for(var a=0;a<v.length;a++){var c=v[a],
d=0,e=0,g=h.width,m=h.height,f=h.width,l=h.height;if(f=c.settings.area)d=f.x,e=f.y,g=f.width,m=f.height;void 0!==c.settings.width&&void 0!==c.settings.height?(f=c.settings.width/c.settings.height,m*f<g?(f*=m,d+=Math.floor((g-f)/2),g=Math.floor(f)):(f=g/f,e+=Math.floor((m-f)/2),m=Math.floor(f)),f=c.settings.width,l=c.settings.height):(f=g,l=m);var k=h;if(0!==d||0!==e||g!==h.width||m!==h.height||f!==h.width||l!==h.height){C.width=f;C.height=l;var p=C.getContext("2d"),k=new Uint8Array(g*m*4);b.readPixels(d,
h.height-(e+m),g,m,b.RGBA,b.UNSIGNED_BYTE,k);d=p.getImageData(0,0,f,l);t.resampleHermite(k,g,m,d.data,f,l,!0);p.putImageData(d,0,0);k=C;p=null}g={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"}[c.settings.format?c.settings.format.toLowerCase():"png"];m=1;void 0!==c.settings.quality&&(m=c.settings.quality/100);g=k.toDataURL(g,m);c.callback({dataURL:g,x:0,y:0,width:f,height:l})}v=[]}M();a=t.performance.now();D.step(a)}};this.getFrameTask=function(){return la};var w={ambient:r.create(),diffuse:r.create(),
specular:r.create(),direction:y.create()};this.setLights=function(a,c){y.set(c.direction,F);r.set4(a.color[0],a.color[1],a.color[2],a.intensity,w.ambient);r.set4(c.color[0],c.color[1],c.color[2],c.intensity,w.diffuse);r.set4(c.color[0],c.color[1],c.color[2],Math.min(c.intensity+a.intensity,1),w.specular);y.set(c.direction,w.direction);d.setLightingData(w);u=!0};this.getViewParams=function(a){var c=d.getViewParams(a);if(!a||a.backgroundColor)c.backgroundColor=B;return c};this.setViewParams=function(a){u=
!0;a.backgroundColor&&(B=a.backgroundColor);d.setViewParams(a)};this.setRenderParams=function(a){u=!0;"anisotropicFiltering"in a&&p.setMaxAnisotropy(a.anisotropicFiltering);"backfaceCulling"in a&&(b.web3DDefaultState.cullFace=a.backfaceCulling);void 0!==a.idleSuspend&&(H=!!a.idleSuspend);d.setRenderParams(a)};this.getRenderParams=function(){var a=d.getRenderParams();a.anisotropicFiltering=p.getMaxAnisotropy();a.backfaceCulling=b.web3DDefaultState.cullFace;a.idleSuspend=H;return a};this.has=function(a){return"s3tc"===
a?!!b.getExtension("WEBGL_compressed_texture_s3tc"):!1};this.getFrustumObjects=function(){return d.getFrustumObjects()};this.modify=function(a,c,b,e,g){d.modify(a,c,b,e,g)};this.setSelectionObject=function(a,c){d.setSelectionObject(a,c)};this.setHighlightObjects=function(a,c){d.setHighlightObjects(a,c)};this.frame=function(a,c){d.frame(a,c)};this.setCamera=function(a){d.setCamera(a)};this.getCamera=function(){return d.getCamera()};this.addFPSListener=function(a){D.addListener(a)};this.removeFPSListener=
function(a){D.removeListener(a)};this.getPickRay=function(a,c,b){d.getPickRay(a,c,b)};this.pickRayWithBeginPoint=function(a,b,e,h,g){d.pickRayWithBeginPoint(a,b,e,h,g)};this.getSideIndexForPoint=function(a){return d.getSideIndexForPoint(a)};this.getCanvas=function(){return h};this.getTextureGraphicsRenderer=function(){return G};this.renderScreenshots=function(a){var c=new J(e,L,E,p,b),k=d.getViewParams({frustumCullingEnabled:!0,maxFarNearRatio:!0});c.setLightingData(d.getLightingData());c.setRenderParams(d.getRenderParams());
c.modify(t.object2array(d.getContent()),[]);for(var n=d.getExternalRenderers(),g=0;g<n.length;g++)for(var m=0;m<n[g].length;m++)c.addExternalRenderer(g,n[g][m]);for(var n=Array(a.length),f,g=0,m=a.length;g<m;++g){f=a[g];var l=f.camera;k.pixelRatio=.5*(l.width/h.width+l.height/h.height);c.setViewParams(k);f=new U(b.RGBA,b.UNSIGNED_BYTE,!0,b.NEAREST,b);f.setSize(l.width,l.height);f.bind();var r=l.width*l.height*4;c.setCamera(l);b.clearColor.apply(b,B);b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);
c.step(0);c.render(F,f.getGLName());var q=new Uint8Array(r);b.readPixels(0,0,l.width,l.height,b.RGBA,b.UNSIGNED_BYTE,q);for(l=3;l<r;l+=4)q[l]=255;n[g]=q}b.bindFramebuffer(b.FRAMEBUFFER,null);f.dispose();b.viewport(0,0,h.width,h.height);c.dispose();return n};this.requestScreenCapture=function(a,b){v.push({settings:a||{},callback:b});u=!0};this.getAllTexturesLoaded=function(){return 0===p.getLoadingCount()};this.getTextureLoaded=function(a){return p.getIsLoaded(a)};this.addTextureListener=function(a){p.addTextureListener(a)};
this.removeTextureListener=function(a){p.removeTextureListener(a)};this.addExternalRenderer=function(a,b){return d.addExternalRenderer(a,b)?(b.loadShaders(K,k,e),!0):!1};this.removeExternalRenderer=function(a,b){return d.removeExternalRenderer(a,b)};this._getModule=function(a){return"viewport"===a?d:d._getModule(a)};var C=document.createElement("canvas")}});