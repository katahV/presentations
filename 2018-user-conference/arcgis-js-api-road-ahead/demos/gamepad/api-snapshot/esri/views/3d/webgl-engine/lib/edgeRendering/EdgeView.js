// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/tsSupport/assignHelper ../../../../../core/tsSupport/awaiterHelper ../../../../../core/tsSupport/generatorHelper ../../../../../core/arrayUtils ../../../../../core/requireUtils ../../../../../core/workers ../../../lib/glMatrix ../../../support/buffer/BufferView ../localOriginHelper ../LocalOriginManager ../PreinterleavedGeometryData ../RegularGridLocalOriginFactory ../Util ../TextureBackedBuffer/BufferManager ./bufferLayouts ./edgeBufferWriters ./EdgeProcessingWorker ./EdgeRenderer ./strokes ./util ../../../../webgl/BufferObject ../../../../webgl/VertexArrayObject module".split(" "),
function(N,F,I,p,B,O,P,Q,A,R,S,T,J,U,K,V,z,L,W,r,X,t,E,M,Y){Object.defineProperty(F,"__esModule",{value:!0});var ba=function(){function d(a,c,b){this.rctx=a;this.programRepository=c;this.callbacks=b;this.profilingCallback=null;this.perObjectData=new Map;this.renderers=new Map;this.localOrigins=new T.LocalOriginManager(new U(1E4));this.gpuMemoryUsage=this.numberOfRenderedEdges=0;this.worker=new W;this.workerThread=null;this.destroyed=!1;this.tmpModelPosition=A.vec3d.create();this.tmpCameraPosition=
A.vec3d.create();this.componentColorManager=new V.BufferManager(this.rctx,2)}d.isSupported=function(a){return!!a.capabilities.instancing};d.loadShaders=function(a,c,b){r.EdgeRenderer.loadShaders(a,c,b)};d.prototype.initialize=function(){var a=this;Q.open(P.getAbsMid("./EdgeProcessingWorker",N,Y),{client:this}).then(function(b){a.destroyed?b.close():a.workerThread=b});for(var c=z.VertexLayout.createBuffer(4),b=0;4>b;b++)c.sideness.set(b,0,0===b||3===b?0:1),c.sideness.set(b,1,0===b||1===b?0:1);this.verticesBufferObject=
E.createVertex(this.rctx,35044,c.buffer)};d.prototype.destroy=function(){this.destroyed||(this.workerThread&&(this.workerThread.close(),this.workerThread=null),this.verticesBufferObject&&(this.verticesBufferObject.dispose(),this.verticesBufferObject=null),this.destroyed=!0)};d.prototype.getGpuMemoryUsage=function(){return this.gpuMemoryUsage/1048576};Object.defineProperty(d.prototype,"numberOfRenderedPrimitives",{get:function(){return this.numberOfRenderedEdges},enumerable:!0,configurable:!0});d.prototype.shouldRender=
function(){return 0<this.renderers.size};d.prototype.addObject=function(a,c,b){return p(this,void 0,void 0,function(){var e,f,m,k,g,h,d;return B(this,function(q){switch(q.label){case 0:if(this.hasObject(a))return[2];e=[];m={loaded:new Promise(function(a){return f=a}),renderables:[]};this.perObjectData.set(a,m);if(b&&b.mergeGeometries&&1<a.geometries.length&&this.canMergeGeometries(a))e.push(this.addObjectMergedGeometries(a,m,c));else for(k=0;k<a.geometries.length;k++)g=a.geometries[k],h=a.geometryRecords[k],
d=h.materials[0],d.supportsEdges&&(g.data instanceof J?e.push(this.addGeometryPreinterleaved(a,m,g,g.data,h,c)):e.push(this.addGeometryNonPreinterleaved(a,m,g,g.data,h,c[0])));return[4,Promise.all(e)];case 1:return q.sent(),this.callbacks.setNeedsRender(),f(),[2]}})})};d.prototype.hasObject=function(a){return this.perObjectData.has(a)};d.prototype.updateAllComponentOpacities=function(a,c){return p(this,void 0,void 0,function(){var b,e;return B(this,function(f){switch(f.label){case 0:return(b=this.perObjectData.get(a))?
[4,b.loaded]:[2];case 1:return f.sent(),e=c instanceof Array?function(a){return c[a]}:function(a){return c},b.renderables.forEach(function(a){for(var b=a.components.meta.length,c=0;c<b;c++){var f=e(c),m=a.components.meta[c],d=m.index;m.material.opacity=f;a.components.buffer.textureBuffer.setDataElement(d,1,3,255*f)}a.allTransparent=t.determineAllTransparent(a.components.meta)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateAllComponentMaterials=function(a,c){return p(this,void 0,void 0,
function(){var b=this,e;return B(this,function(f){switch(f.label){case 0:return(e=this.perObjectData.get(a))?[4,e.loaded]:[2];case 1:return f.sent(),e.renderables.forEach(function(a){var e=t.determineRequiresUberRenderer(c),f=r.EdgeRenderer.getKey(e,c[0].type);if(f!==a.rendererKey){var d=b.renderers.get(a.rendererKey),e=b.aquireRenderer(e,c[0].type);d.removeRenderable(a);d.refCount.decrement();a.rendererKey=f;e.addRenderable(a)}for(f=0;f<c.length;f++)a.components.meta[f].material=c[f];b.updateComponentBuffer(a.components);
a.allTransparent=t.determineAllTransparent(a.components.meta)}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.updateObjectVisibility=function(a,c){return p(this,void 0,void 0,function(){var b;return B(this,function(e){switch(e.label){case 0:return(b=this.perObjectData.get(a))?[4,b.loaded]:[2];case 1:return e.sent(),b.renderables.forEach(function(a){a.visible=c}),this.callbacks.setNeedsRender(),[2]}})})};d.prototype.removeObject=function(a){var c=this,b=this.perObjectData.get(a);b&&(this.perObjectData.delete(a),
b.loaded.then(function(){b.renderables.forEach(function(a){c.removeRenderable(a)});c.callbacks.setNeedsRender()}))};d.prototype.removeAll=function(){var a=this;this.perObjectData.forEach(function(c,b){a.removeObject(b)})};d.prototype.createSolidEdgeMaterial=function(a){return I({},Z,a,{type:"solid"})};d.prototype.createSketchEdgeMaterial=function(a){return I({},aa,a,{type:"sketch"})};d.prototype.render=function(a){var c=this;this.localOrigins.updateViewMatrices(a.view);this.renderers.forEach(function(a){0===
a.refCount.value&&(c.renderers.delete(a.key),a.dispose())});this.componentColorManager.garbageCollect();this.componentColorManager.updateTextures();var b=a.view,e=0,f=0;this.renderers.forEach(function(a){a.forEachRenderable(function(a){e+=a.statistics.averageEdgeLength;f++})});var d={distanceFalloffFactor:e/f*40,minimumEdgeLength:t.estimateLengthAtDistance(a.viewport[3],a.fovY,1,3.5)},k=this.rctx.capabilities.blendMinMax;k?(this.rctx.setDepthWriteEnabled(!1),this.rctx.setBlendingEnabled(!0),this.rctx.setBlendEquationSeparate(32774,
k.MAX),this.rctx.setBlendFunctionSeparate(1,0,1,1)):(this.rctx.setDepthWriteEnabled(!0),this.rctx.setBlendingEnabled(!1));this.rctx.setDepthTestEnabled(!0);this.rctx.setDepthFunction(515);this.updateObjectCameraDistances(a);this.numberOfRenderedEdges=0;this.renderers.forEach(function(b){c.renderRegularEdges(b,a,d);c.renderSilhouetteEdges(b,a,d)});this.rctx.setDepthWriteEnabled(!0);this.rctx.setDepthFunction(513);this.rctx.setBlendEquationSeparate(32774,32774);this.rctx.setBlendFunctionSeparate(1,
0,1,1);a.view=b};d.prototype.computeModelTransformWithLocalOrigin=function(a,c,b){a.getCombinedStaticTransformation(c,b);c.origin?this.localOrigins.register(c.origin):(a=A.vec3d.set3(b[12],b[13],b[14],this.tmpModelPosition),c.origin=this.localOrigins.aquire(a));S.applyToModelMatrix(c.origin.vec3,b);return b};d.prototype.updateComponentBuffer=function(a){var c=a.meta;a=a.buffer;for(var b=0;b<c.length;b++){var e=c[b].material,f=c[b].index,d=K.clamp(Math.round(e.size*r.LINE_WIDTH_FRACTION_FACTOR),0,
255),k=K.clamp(e.extensionLength,-r.EXTENSION_LENGTH_OFFSET,255-r.EXTENSION_LENGTH_OFFSET)+r.EXTENSION_LENGTH_OFFSET,g="solid"===e.type?0:1,h=255*e.opacity,e=e.color;a.textureBuffer.setData(f,0,255*e[0],255*e[1],255*e[2],255*e[3]);a.textureBuffer.setData(f,1,d,k,g,h)}};d.prototype.createComponentBuffers=function(a){for(var c=[],b=this.componentColorManager.getBuffer(a.length),e=0;e<a.length;e++){var f=a[e],d=b.aquireIndex();c.push({index:d,material:f})}a={meta:c,buffer:b};this.updateComponentBuffer(a);
return a};d.prototype.extractEdges=function(a,c,b){return this.worker.process({data:c,originalIndices:b,writerSettings:a},this.workerThread)};d.prototype.createEdgeResources=function(a){var c={};if(0<a.regular.lodInfo.lengths.length){var b=new M(this.rctx,z.EdgeShaderAttributeLocations,{vertices:z.glVertexLayout,instances:L.RegularEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:E.createVertex(this.rctx,35044,a.regular.instancesData.buffer)});c.regular={vao:b,lod:a.regular.lodInfo}}0<
a.silhouette.lodInfo.lengths.length&&(b=new M(this.rctx,z.EdgeShaderAttributeLocations,{vertices:z.glVertexLayout,instances:L.SilhouetteEdgeBufferWriter.glLayout},{vertices:this.verticesBufferObject,instances:E.createVertex(this.rctx,35044,a.silhouette.instancesData.buffer)}),c.silhouette={vao:b,lod:a.silhouette.lodInfo});return c};d.prototype.disposeEdgeResources=function(a){a.regular&&(a.regular.vao.vertexBuffers.instances.dispose(),a.regular.vao.dispose(!1),a.regular.vao=null);a.silhouette&&(a.silhouette.vao.vertexBuffers.instances.dispose(),
a.silhouette.vao.dispose(!1),a.silhouette.vao=null)};d.prototype.addGeometryNonPreinterleaved=function(a,c,b,e,f,d){return p(this,void 0,void 0,function(){var b,g,h,m;return B(this,function(k){switch(k.label){case 0:return b=e.getAttribute("position"),g=this.computeModelTransformWithLocalOrigin(a,f,A.mat4d.create()),h=f.origin,m={position:b,indices:t.cloneIndices(e.getIndices("position")),modelTransform:g,origin:h},[4,this.addNonPreinterleaved(a,c,m,d)];case 1:return k.sent(),[2]}})})};d.prototype.addNonPreinterleaved=
function(a,c,b,e){return p(this,void 0,void 0,function(){var a,d,k,g,h,H,q,l,C,u,x,v,n,y,w;return B(this,function(f){switch(f.label){case 0:a=this.aquireRenderer(!1,e.type);d=b.modelTransform;k=b.origin;g=b.indices;h=b.position;H=h.data.length/h.strideIdx;q=z.EdgeInputBufferLayout.createBuffer(H);for(l=0;l<H;l++)q.position.set(l,0,h.data[h.offsetIdx+l*h.strideIdx+0]),q.position.set(l,1,h.data[h.offsetIdx+l*h.strideIdx+1]),q.position.set(l,2,h.data[h.offsetIdx+l*h.strideIdx+2]);C=this.createComponentBuffers([e]);
t.fillComponenBufferIndices(C.meta,[0,q.componentIndex.count],q.componentIndex);return[4,this.extractEdges(a.writerSettings,q,g)];case 1:return u=f.sent(),x=this.createEdgeResources(u),v=x.regular,n=x.silhouette,y=(v?v.vao.size:0)+(n?n.vao.size:0),w={regular:v,silhouette:n,transform:{modelMatrix:d,origin:k},statistics:{gpuMemoryUsage:y,averageEdgeLength:u.averageEdgeLength},components:C,visible:!0,allTransparent:t.determineAllTransparent(C.meta),distanceToCamera:0,rendererKey:a.key},c.renderables.push(w),
a.addRenderable(w),this.gpuMemoryUsage+=y,[2]}})})};d.prototype.addGeometryPreinterleaved=function(a,c,b,e,f,d){return p(this,void 0,void 0,function(){var b,g,h,m,q,l,C,u,x,v,n,y,w,G,p,r,D;return B(this,function(k){switch(k.label){case 0:b=e.getAttribute("position");if(!(b&&b.data instanceof Float32Array))return console.warn("Geometry has no float32 `position` attribute, skipping it."),[2];g=d[0];h=t.determineRequiresUberRenderer(d);m=this.aquireRenderer(h,g.type);q=this.computeModelTransformWithLocalOrigin(a,
f,A.mat4d.create());l=f.origin;C=t.cloneIndices(e.getIndices("position"));u=new R.BufferViewVec3f(b.data.buffer,4*b.offsetIdx,4*b.strideIdx);x=z.EdgeInputBufferLayout.createBuffer(u.count);for(v=0;v<u.count;v++)x.position.set(v,0,u.get(v,0)),x.position.set(v,1,u.get(v,1)),x.position.set(v,2,u.get(v,2));n=this.createComponentBuffers(d);t.fillComponenBufferIndices(n.meta,e.componentOffsets,x.componentIndex,C);return[4,this.extractEdges(m.writerSettings,x,C)];case 1:return y=k.sent(),w=this.createEdgeResources(y),
G=w.regular,p=w.silhouette,r=(G?G.vao.size:0)+(p?p.vao.size:0),D={regular:G,silhouette:p,transform:{modelMatrix:q,origin:l},statistics:{gpuMemoryUsage:r,averageEdgeLength:y.averageEdgeLength},components:n,visible:!a.isHidden(f),allTransparent:t.determineAllTransparent(n.meta),distanceToCamera:0,rendererKey:m.key},c.renderables.push(D),m.addRenderable(D),this.gpuMemoryUsage+=r,[2]}})})};d.prototype.canMergeGeometries=function(a){for(var c=null,b=null,e=0;e<a.geometries.length;e++){var f=a.geometryRecords[e];
if(f.materials[0].supportsEdges){if(a.geometries[e].data instanceof J)return!1;if(!c)c=f.transformation;else if(!O.equals(c,f.transformation))return!1;if(!b&&f.origin)b=f;else if(b&&f.origin&&b.origin.id!==f.origin.id)return!1}}return!0};d.prototype.addObjectMergedGeometries=function(a,c,b){return p(this,void 0,void 0,function(){var e,f,d,k,g,h,p,q,l,t,u,x,v,n,y,w,r,z,E,D,F;return B(this,function(m){switch(m.label){case 0:e=new Map;f=0;k=d=null;for(g=0;g<a.geometries.length;g++)if(h=a.geometries[g],
p=a.geometryRecords[g],q=p.materials[0],q.supportsEdges&&(!k&&p.origin&&(k=p),l=h.data.getIndices("position"),f+=l?l.length:0,l&&null==d||d===Uint16Array))d=l instanceof Uint16Array?Uint16Array:Uint32Array;t=f?new d(f):null;u=[];for(g=x=0;g<a.geometries.length;g++)if(h=a.geometries[g],v=a.geometryRecords[g],q=v.materials[0],q.supportsEdges){n=h.data.getAttribute("position");l=h.data.getIndices("position");y=e.get(n.data);if(null==y){y=u.length/3;for(w=n.offsetIdx;w<n.data.length;w+=n.strideIdx)u.push(n.data[w+
0]),u.push(n.data[w+1]),u.push(n.data[w+2]);e.set(n.data,y)}if(l)for(r=0;r<l.length;r++)t[x++]=y+l[r]}z=k||a.geometryRecords[0];E=this.computeModelTransformWithLocalOrigin(a,z,A.mat4d.create());D=z.origin;for(g=0;g<a.geometryRecords.length;g++)a.geometryRecords[g].origin=D;F={position:{data:u,offsetIdx:0,strideIdx:3},indices:t,modelTransform:E,origin:D};return[4,this.addNonPreinterleaved(a,c,F,b[0])];case 1:return m.sent(),[2]}})})};d.prototype.aquireRenderer=function(a,c){var b=r.EdgeRenderer.getKey(a,
c),e=this.renderers.get(b);this.strokesTexture||(this.strokesTexture=X.generateStrokesTexture(this.rctx));e||(e=new r.EdgeRenderer(this.rctx,this.programRepository,{type:c,strokesTexture:this.strokesTexture,uber:a}),this.renderers.set(b,e));e.refCount.increment();return e};d.prototype.removeRenderable=function(a){var c=this.renderers.get(a.rendererKey);c.removeRenderable(a);c.refCount.decrement();this.disposeEdgeResources(a);this.localOrigins.release(a.transform.origin);this.gpuMemoryUsage-=a.statistics.gpuMemoryUsage;
for(var c=0,b=a.components.meta;c<b.length;c++)a.components.buffer.releaseIndex(b[c].index)};d.prototype.updateObjectCameraDistances=function(a){var c=this;a=a.viewInvTransp;A.vec3d.set3(a[3],a[7],a[11],this.tmpCameraPosition);this.perObjectData.forEach(function(a,e){var b=A.vec3d.dist(e.getCenter(),c.tmpCameraPosition);a.renderables.forEach(function(a){return a.distanceToCamera=b})})};d.prototype.renderRegularEdges=function(a,c,b){var e=this;a.bindRegularEdges(c,b);a.forEachRenderable(function(f){if(f.visible&&
f.regular&&!f.allTransparent){var d=t.computeEdgeCount(f.regular.lod.lengths,f.distanceToCamera,b);c.view=e.localOrigins.getViewMatrix(f.transform.origin);a.renderRegularEdges(f,c,d);e.numberOfRenderedEdges+=d}})};d.prototype.renderSilhouetteEdges=function(a,c,b){var e=this;a.bindSilhouetteEdges(c,b);a.forEachRenderable(function(d){if(d.visible&&d.silhouette&&!d.allTransparent){var f=t.computeEdgeCount(d.silhouette.lod.lengths,d.distanceToCamera,b);c.view=e.localOrigins.getViewMatrix(d.transform.origin);
a.renderSilhouetteEdges(d,c,f);e.numberOfRenderedEdges+=f}})};return d}();F.EdgeView=ba;var Z={color:A.vec4d.createFrom(0,0,0,.2),size:1,extensionLength:0,opacity:1},aa={color:A.vec4d.createFrom(0,0,0,.2),size:1,extensionLength:0,opacity:1}});