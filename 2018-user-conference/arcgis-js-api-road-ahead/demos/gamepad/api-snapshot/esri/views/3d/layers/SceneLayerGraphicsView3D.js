// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper ../../../Graphic ../../../core/Handles ../../../core/Logger ../../../core/PooledArray ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/rbush/PooledRBush ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/contains ../../../layers/graphics/dehydratedFeatures ../../../renderers/support/renderingInfoUtils ./LayerView3D ./graphics/Graphics3DFeatureLikeLayerView ./i3s/I3SQueryEngine ./i3s/I3SUtil ./i3s/MemCache ./support/layerViewUpdatingProperties ../lib/glMatrix ../support/EventedArray ../support/orientedBoundingBox ../support/projectionUtils".split(" "),
function(u,ba,H,f,I,J,K,L,r,M,g,N,t,G,O,B,P,Q,R,S,x,T,U,V,W,X,C){var D=K.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D");u=function(u){function b(a){a=u.call(this)||this;a.overlayUpdating=!1;a.supportsDraping=!0;a._queryEngine=null;a._memCache=new T(50);a.supportsHeightUnitConversion=!0;a._isUpdating=!1;a._coordinatesOutsideExtentErrors=0;a._maxCoordinatesOutsideExtentErrors=20;a._definitionExpressionErrors=0;a._maxDefinitionExpressionErrors=20;a._nodesAddedToStage={};a.loadedGraphics=
new W;a._controllerCreated=!1;a._handles=new J;return a}H(b,u);b.prototype.initialize=function(){var a=this;x.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode);this._handles.add([M.init(this.layer,"rangeInfos",function(c){return a._rangeInfosChanged(c)}),this.layer.watch("renderer",function(c,e){return a._rendererChange(c,e)}),this.layer.watch("objectIdFilter",function(){return a._objectIdFilterChange()}),this.watch("_controller.parsedDefinitionExpression",function(){return a._definitionExpressionChange()})]);
this.graphics3d=new R({owner:this,layer:this.layer,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,verticalScaleEnabled:this.supportsHeightUnitConversion,suspendResumeExtentMode:"data",dataExtent:this.layer.fullExtent,updateClippingExtent:function(c){return a._updateClippingExtent(c)},queryGraphicUIDsInExtent:function(c,e,d){return a._queryGraphicUIDsInExtent(c,e,d)}});this.addResolvingPromise(this.graphics3d.setup());this.drawingOrder=this.view.getDrawingOrder(this.layer.uid);
this._createController()};b.prototype.destroy=function(){this.graphics3d&&(this.graphics3d.destroy(),this.graphics3d=null);this._controller&&(this._controller.destroy(),this._controller=null);this._nodesAddedToStage=this._elevationUpdateNodes=null;this._handles&&(this._handles.destroy(),this._handles=null)};b.prototype.whenGraphicAttributes=function(a,c){var e=this;return x.whenGraphicAttributes(this.layer,[a],this._getObjectIdField(),c,function(){var c=e._findGraphicNodeAndIndex(a);return{node:c.node,
indices:[c.index]}},{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(a){return a[0]})};b.prototype.getGraphicsFromStageObject=function(a,c){if(!this.loadedGraphics)return r.reject();var e=a.getMetadata().graphicId;a=B.hydrateGraphic(this.loadedGraphics.find(function(a){return a.uid===e}),this.layer);c=this._getObjectIdField();if(!a||!a.attributes||!a.attributes[c])return r.reject();a.layer=this.layer;a.sourceLayer=this.layer;return r.resolve(a)};b.prototype.whenGraphicBounds=function(a,
c){return this.graphics3d.graphicsCore.whenGraphicBounds(a,c)};b.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.isUpdating=function(){return this._isUpdating||!this._controllerCreated?!0:!(!this._controller||!this._controller.updating)};b.prototype.getRenderingInfo=function(a){if((a=P.getRenderingInfo(a,{renderer:this.layer.renderer}))&&a.color){var c=a.color;c[0]/=255;c[1]/=255;c[2]/=255}return a};Object.defineProperty(b.prototype,
"symbolUpdateType",{get:function(){return this.graphics3d.graphicsCore.symbolUpdateType},enumerable:!0,configurable:!0});b.prototype._findGraphicNodeAndIndex=function(a){a=a.attributes[this.layer.objectIdField];for(var c=0,e=Object.keys(this._nodesAddedToStage);c<e.length;c++){var d=e[c],b=this._findGraphicIndex(this._nodesAddedToStage[d].bundle,a);if(0<=b)return{node:this._controller.nodeIndex[d],index:b}}return null};b.prototype._forAllFeatures=function(a,c){for(var e=0,d=Object.keys(this._nodesAddedToStage);e<
d.length;e++){for(var b=d[e],k=this._nodesAddedToStage[b].bundle,h=0;h<k.length;h++)for(var p=k[h].graphics,m=0;m<p.length;m++){var l=p[m],g=k[h].featureIds[m];l.visible&&a(g,h,l)}null!=c&&c({nodeId:b})}};b.prototype._getGraphicIndices=function(a,c){a=this._nodesAddedToStage[a];for(var e=this._getObjectIdField(),d=[],b=0;b<c.length;b++){var k=this._findGraphicIndex(a.bundle,c[b].attributes[e]);0<=k&&d.push(k)}return d};b.prototype._findGraphicIndex=function(a,c){for(var e=0;e<a.length;e++)for(var d=
0,b=a[e].featureIds;d<b.length;d++)if(b[d]===c)return e;return-1};b.prototype._queryGraphicUIDsInExtent=function(a,c,e){if(this._controller){var d=this._controller.crsIndex;C.boundingRectToBoundingRect(a,c,v,d);var b=Y;t.fromRect(b,v);b[2]=-Infinity;b[5]=Infinity;null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new L(10));var k=this._elevationUpdateNodes;k.clear();this._controller.updateElevationChanged(b,d,k);for(d=0;d<k.length;d++){var h=this._nodesAddedToStage[k.data[d].id];if(null!=
h){if(!h.spatialIndex&&h.bundle.length>=Z){for(var p=new N.PooledRBush(9,[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),m=A.length=0,l=h.bundle;m<l.length;m++){for(var b=l[m],g=G.empty(),f=0,r=b.graphics;f<r.length;f++)B.expandAABR(r[f].geometry,g);b.extent=g;A.push(b)}p.load(A);h.spatialIndex=p}if(h.spatialIndex)b=v,C.boundingRectToBoundingRect(a,c,v,this.view.spatialReference),w.minX=b[0],w.minY=b[1],w.maxX=b[2],w.maxY=b[3],h.spatialIndex.search(w,function(a){var c=0;for(a=a.graphics;c<
a.length;c++)e(a[c].uid)});else for(p=0,h=h.bundle;p<h.length;p++)for(b=h[p],m=0,b=b.graphics;m<b.length;m++)e(b[m].uid)}}}};b.prototype.updatingChanged=function(){var a=!1;this.graphics3d.destroyed||(a=!this._controllerCreated||this.overlayUpdating||this.graphics3d.updating);this._isUpdating!==a&&(this._isUpdating=a,this.notifyChange("updating"))};b.prototype.highlight=function(a,c){return this.graphics3d.highlight(a,c,this.layer.objectIdField)};b.prototype._createController=function(){var a=this;
this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:{addNodeData:function(c,b){return a._addNodeData(c,b)},isNodeLoaded:function(c){return a._isNodeLoaded(c)},getMemoryUsage:function(){return a.view.resourceController.usedMemory},removeNodeData:function(c){return a._removeNodeData(c)},getLoadedNodeIDs:function(){return a._getLoadedNodeIDs()}},layerViewOptionalFunctions:{getLoadedAttributes:function(c){return a._getLoadedAttributes(c)},getAttributeData:function(c){return a._getAttributeData(c)},
setAttributeData:function(c,b,d){return a._setAttributeData(c,b,d)},loadCachedNodeData:function(c,b){return a._loadCachedNodeData(c,b)},addCachedNodeData:function(c,b,d){return a._addCachedNodeData(c,b,d)}}}).then(function(c){a._controller=c;c.watch("rootNodeVisible",function(){a.notifyChange("suspended")})}).always(function(){a._controllerCreated=!0;a.updatingChanged()})};b.prototype._addNodeData=function(a,c){var b=c.allGeometryData,d=c.attributeDataInfo,n=this._controller.crsIndex;c=this.view.spatialReference;
var k=[0,0,0],h=this._getObjectIdField();a.memory=4096;null==this._nodesAddedToStage[a.id]&&(this._nodesAddedToStage[a.id]={bundle:[],attributeData:d?d.attributeData:null,loadedAttributes:d?d.loadedAttributes:null});var p=[];this._nodesAddedToStage[a.id].bundle=p;if(d=this.layer.fullExtent)d=this.layer.fullExtent.clone(),d.xmin-=.5,d.ymin-=.5,d.xmax+=.5,d.ymax+=.5,d.hasZ&&(d.zmin-=.5,d.zmax+=.5),d.hasM&&(d.mmin-=.5,d.mmax+=.5);for(var m=d,d=[],l=[],g=0;g<b.length;g++){var f=b[g],u=f.featureDataPosition,
t=u.length,w=f.geometries||[aa[t]],x=f.featureIds;m&&!O.extentContainsCoords3D(m,u)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&D.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&D.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++);for(var E=0;E<w.length;E++){var y=w[E];if("points"===y.params.type){var v=[],z=x[E<
x.length?E:0],A={};null!=z&&(A[h]=z);z=void 0;"Embedded"===y.type&&(z=y.params.vertexAttributes.position);for(y=0;y<z.length;y+=t){for(var q=0;q<t;q++)k[q]=u[q]+z[y+q];C.bufferToBuffer(k,n,0,F,c,0,1);q=B.makeDehydratedPoint(F[0],F[1],F[2],c);3>t&&(q.z=void 0);v.push({uid:I.generateUID(),geometry:q,attributes:A,visible:!0});a.obb||l.push(q.x,q.y,q.z?q.z:0)}a.memory+=16*z.length;d.push.apply(d,v);p.push({featureIds:f.featureIds,graphics:v})}}}a.numFeatures=d.length;a.memory/=1048576;b=this._nodesAddedToStage[a.id];
this._setBundleAttributes(b.bundle,b.loadedAttributes,b.attributeData);0<l.length&&(n=this.view.renderSpatialReference,k=this._controller.crsVertex,C.bufferToBuffer(l,c,0,l,n,0,l.length/3),a.obb=X.compute({data:l,size:3,offsetIdx:0,strideIdx:3}),C.vectorToVector(a.obb.center,n,a.obb.center,k));if(!this._controller.isGeometryVisible(a))return this._memCache.put(a.id,this._nodesAddedToStage[a.id],a.memory),delete this._nodesAddedToStage[a.id],r.resolve();this.loadedGraphics.addMany(d);this._filterNode(b);
return r.resolve()};b.prototype._isNodeLoaded=function(a){return null!=this._nodesAddedToStage[a.id]&&null!=this._nodesAddedToStage[a.id].bundle};b.prototype._removeNodeData=function(a){var b=this,e=[];a.forEach(function(a){var c=b._removeNodeStageData(a.id,e);c&&b._memCache.put(a.id,c,a.memory)});this.loadedGraphics.removeUnorderedMany(e)};b.prototype._removeAllNodeData=function(){var a=this,b=[];Object.keys(this._nodesAddedToStage).forEach(function(c){var d=a._removeNodeStageData(c,b);d&&a._memCache.put(c,
d,a._controller.nodeIndex[c].memory)});this.loadedGraphics.removeUnorderedMany(b)};b.prototype._removeNodeStageData=function(a,b){var c=this._nodesAddedToStage[a];if(null==c)return null;for(var d=0,n=c.bundle;d<n.length;d++)b.push.apply(b,n[d].graphics);delete this._nodesAddedToStage[a];return c};b.prototype._loadCachedNodeData=function(a,b){return r.resolve(this._memCache.get(a.id))};b.prototype._addCachedNodeData=function(a,b,e){e=[];for(var c=0,n=b.bundle;c<n.length;c++)e.push.apply(e,n[c].graphics);
this._nodesAddedToStage[a.id]=b;this.loadedGraphics.addMany(e);this._filterNode(b);return r.resolve()};b.prototype._getLoadedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)};b.prototype._getLoadedAttributes=function(a){if(a=this._nodesAddedToStage[a.id])return a.loadedAttributes};b.prototype._getAttributeData=function(a){if(a=this._nodesAddedToStage[a.id])return a.attributeData};b.prototype._setAttributeData=function(a,b,e){if(a=this._nodesAddedToStage[a.id])a.loadedAttributes=b,a.attributeData=
e,this._setBundleAttributes(a.bundle,b,e),this._filterNode(a),this.graphics3d.graphicsCore.labelsEnabled&&this.graphics3d.graphicsCore.updateLabelingInfo()};b.prototype._setBundleAttributes=function(a,b,e){for(var c=0;c<a.length;c++)for(var n=0,k=a[c].graphics;n<k.length;n++){var h=k[n];h.attributes||(h.attributes={});if(b)for(var g=0,f=b;g<f.length;g++){var l=f[g].name;e[l]&&(h.attributes[l]=x.getCachedAttributeValue(e[l],c))}}};b.prototype._updateClippingExtent=function(a){this._controller&&this._controller.updateClippingArea(a);
return!1};b.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"};b.prototype._rendererChange=function(a,b){var c=a?a.requiredFields:[],d=b?b.requiredFields:[];c.length===d.length&&c.every(function(a,b){return c[b]===d[b]})||this._reloadAllNodes()};b.prototype._rangeInfosChanged=function(a){null!=a&&0<a.length&&D.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};b.prototype._objectIdFilterChange=
function(){var a=this;Object.keys(this._nodesAddedToStage).forEach(function(b){return a._filterNode(a._nodesAddedToStage[b])})};b.prototype._reloadAllNodes=function(){this._removeAllNodeData();this._controller&&this._controller.restartNodeLoading()};b.prototype._definitionExpressionChange=function(){this._definitionExpressionErrors=0};b.prototype._evaluateClause=function(a,b){try{return!!a.calculateValue(b)}catch(e){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&D.error("Error while evaluating definitionExpression: "+
e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&D.error("Further errors are ignored"),!1}};b.prototype._filterNode=function(a){var b=this._getObjectIdField(),e=null;if(this.layer.objectIdFilter)var d=this.layer.objectIdFilter.ids,g="include"===this.layer.objectIdFilter.method,e=function(a){return 0<=d.indexOf(a)===g};var k=this._controller.parsedDefinitionExpression,h=0;for(a=a.bundle;h<a.length;h++)for(var f=0,m=a[h].graphics;f<m.length;f++){var l=
m[f];e&&!e(l.attributes[b])?l.visible=!1:l.visible=k?this._evaluateClause(k,l):!0}};b.prototype.queryExtent=function(a){return this._ensureQueryEngine().queryExtent(a)};b.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().queryFeatureCount(a)};b.prototype.queryFeatures=function(a){return this._ensureQueryEngine().queryFeatures(a)};b.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().queryObjectIds(a)};b.prototype._ensureQueryEngine=function(){this._queryEngine||
(this._queryEngine=this._createQueryEngine());return this._queryEngine};b.prototype._createQueryEngine=function(){var a=this,b={id:0,index:0,graphic:null},e=this;return new S(this.layer,{forAll:function(c,e){a._forAllFeatures(function(a,d,e){b.id=a;b.index=d;b.graphic=e;c(b)},e)},createGraphic:function(a){return B.hydrateGraphic(a.graphic,e.layer)},requestFields:function(b,c,e){return x.whenGraphicAttributes(a.layer,c,a._getObjectIdField(),e,function(){var d=a._getGraphicIndices(b.nodeId,c);return{node:a._controller.nodeIndex[b.nodeId],
indices:d}},{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var b=t.empty(),c=a.layer.spatialReference;return{add:function(a){return B.expandAABB(a.graphic.geometry,b)},getExtent:function(){return t.toExtent(b,c)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})};b.prototype.getUsedMemory=function(){var a=this,b=0,e=Object.keys(this._nodesAddedToStage);e.forEach(function(c){b+=a._controller.nodeIndex[c].memory});this._controller&&(b+=512*(Object.keys(this._controller.nodeIndex).length-
e.length)/1048576);return b};b.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0};b.prototype.getCachedMemory=function(){return this._memCache.getSize()};b.prototype.removeCachedData=function(){0<this._memCache.getSize()||this.suspended&&this._removeAllNodeData();this._memCache.clear()};b.prototype.getStats=function(){var a=this.inherited(arguments)||{};a.index=this._controller?Object.keys(this._controller.nodeIndex).length:0;a.nodes=Object.keys(this._nodesAddedToStage).length;
0<this._controller.getNumUnloadedNodes()&&(a.nodes+=" + "+this._controller.getNumUnloadedNodes());a.features=this.loadedGraphics.length;a.cache=this._memCache.getSize().toFixed(2)+"MB, "+Math.round(100*this._memCache.getHitRate())+"% hit";a.detail=this._controller.getFeatureDetail();return a};f([g.property()],b.prototype,"graphics3d",void 0);f([g.property()],b.prototype,"drawingOrder",void 0);f([g.property({aliasOf:"graphics3d.graphicsCore.hasDraped"})],b.prototype,"hasDraped",void 0);f([g.property({type:Boolean})],
b.prototype,"overlayUpdating",void 0);f([g.property({type:Boolean})],b.prototype,"supportsDraping",void 0);f([g.property()],b.prototype,"loadedGraphics",void 0);f([g.property()],b.prototype,"layer",void 0);f([g.property()],b.prototype,"_controller",void 0);f([g.property({dependsOn:["_controller.updating","graphics3d.updating","overlayUpdating"]})],b.prototype,"updating",void 0);f([g.property(U.updatingPercentage)],b.prototype,"updatingPercentage",void 0);f([g.property({aliasOf:"_controller.updatingPercentage"})],
b.prototype,"updatingPercentageValue",void 0);return b=f([g.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],b)}(g.declared(Q));var aa={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},Z=100,v=G.create(),Y=t.create(t.POSITIVE_INFINITY),w={minX:0,minY:0,maxX:0,maxY:0},F=V.vec3d.create(),A=[];return u});