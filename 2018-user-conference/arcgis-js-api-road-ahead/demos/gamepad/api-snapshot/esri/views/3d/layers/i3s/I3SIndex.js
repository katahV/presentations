// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/urlUtils","./I3SUtil","../../support/orientedBoundingBox"],function(x,y,r,n,u){var v="version level sharedResource attributeData geometryData textureData lodSelection".split(" ");return function(){function a(c,d,h,b,l,m,a,n,g,f,w){var e=this;this.rootId=h;this.progressiveLoadPenalty=b;this.nodeIndex=l;this.streamDataSupplier=m;this.viewportQueries=a;this.logger=n;this._isLoaded=g;this._needsLoading=f;this._needsUpdate=w;this._prefetching=this._loading=
this._dirty=!0;this.cancelled=!1;this._loadingNodes=new Set;this._indexMissing=1;this._nodesMissing=0;this._nodeTraversalState={};this._numFeatures=this._version=0;this._featureEstimate=null;this._unloadedMemoryEstimate=0;this._missing=new Map;this._prefetch=new Map;this._updates={update:[],add:new Map,cancel:[]};this._maxLodLevel=this.viewportQueries.maxLodLevel;this.rootUrl=r.makeAbsolute(d,c);this.traverseVisible(function(c,b){return e.nodeTraversalState(b)})}a.prototype.requestReload=function(){this._prefetching=
this._loading=this._dirty=!0;++this._version};a.prototype.update=function(c,d,h){var b=this;if(this.cancelled||!this._dirty)return!1;c=Math.max(c,0);d=Math.max(d,0);this._nodesMissing=this._indexMissing=0;this._missing.clear();this._prefetch.clear();this._updates.add.clear();this._updates.update=[];this._updates.cancel=h;this._prefetching=this._loading=0<this._loadingNodes.size;var l=c,a=Number.NEGATIVE_INFINITY,t=!0,r=function(){return function(){this.unremoved=this.missingNodes=this.knownNodes=
this.missing=this.known=0}}(),g=new r,f=new r;this.traverseVisible(function(m,e,p){if(e){if(e.children){p=0;for(var k=e.children;p<k.length;p++){var q=k[p];b.nodeIndex[q.id]||b._loadingNodes.has(q.id)||(++b._indexMissing,b._prefetching=!0,0<l&&n.buildTopNodeMap(b._prefetch,l,{id:q.id,href:q.href,baseUrl:e.baseUrl},b.entryPriority(q)))}}if(!e.failed&&e.featureData&&0!==e.featureData.length)if(b._isLoaded(e))g.known+=e.memory,++g.knownNodes,++f.knownNodes,b._needsLoading(e)?(f.known+=e.numFeatures,
e.children&&(t=!1)):(g.unremoved+=e.memory,f.unremoved+=e.numFeatures,t=!1),b._needsUpdate(e)&&b._updates.update.push({prio:b.entryPriority(e),id:e.id});else if(e.memory&&(g.known+=e.memory,++g.knownNodes),b._needsLoading(e))if(++b._nodesMissing,t=!1,e.memory?g.missing+=e.memory:++g.missingNodes,e.numFeatures?(f.known+=e.numFeatures,++f.knownNodes):++f.missingNodes,0<=h.indexOf(e.id))b._updates.cancel=b._updates.cancel.filter(function(c){return c!==e.id});else if(0<d){p=b.progressiveLoadPenalty;for(k=
e;k;k=k.parentNode?b.nodeIndex[k.parentNode.id]:null)if(b._isLoaded(k)){p=0;break}k=b.entryPriority(m)+p;n.buildTopNodeMap(b._updates.add,d,e.id,k)}}else++b._indexMissing,b._loading=!0,k=b.entryPriority(m),a=Math.max(a,k),q=m.id,0<c&&!b._loadingNodes.has(q)&&(n.buildTopNodeMap(b._missing,c,{id:q,href:m.href,baseUrl:p},k),l=c-b._missing.size)});n.buildTopNodeMap(this._prefetch,l);this._unloadedMemoryEstimate=g.missing-g.unremoved;3<g.knownNodes&&(this._unloadedMemoryEstimate+=g.missingNodes*g.known/
g.knownNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate=0<f.knownNodes?{estimate:Math.max(0,f.known+f.missing-f.unremoved+(f.known+f.missing+f.unremoved)/f.knownNodes*f.missingNodes),leafsReached:t}:{estimate:0,leafsReached:!1};this._updates.add.forEach(function(c,d){c<a&&b._updates.add.delete(d)});this._updates.update.sort(function(c,b){return b.prio-c.prio});return this._dirty=this._prefetching||0<this._indexMissing||0<this._nodesMissing||0<this._updates.update.length||
0<this._updates.cancel.length};a.prototype.load=function(){var c=this;this._missing.forEach(function(d,h){return c._loadNode(h)});this._missing.clear();return this._loading};a.prototype.prefetch=function(c){var d=this;n.buildTopNodeMap(this._prefetch,c);this._prefetch.forEach(function(c,b){return d._loadNode(b)});this._prefetch.clear()};a.prototype.cancel=function(){this.cancelled=!0};a.prototype.isLoading=function(){return this._loading};a.prototype.isPrefetching=function(){return this._prefetching};
a.prototype.getNumLoading=function(){return this._loadingNodes.size};a.prototype.getNumPending=function(){return this._indexMissing};a.prototype.getNumFeatures=function(){return this._numFeatures};a.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate};a.prototype.getNumUnloadedNodes=function(){return this._nodesMissing};a.prototype.getUpdates=function(c){n.buildTopNodeMap(this._updates.add,c);return this._updates};a.prototype.getFeatureEstimate=function(){return this._featureEstimate};
a.prototype.nodeTraversalState=function(c){if(!c)return null;var d=this._nodeTraversalState[c.id];if(d&&d.version===this._version)return d;var a=0;if(c.parentNode){var b=this.nodeIndex[c.parentNode.id];if(null==b)return null;if(b=this._nodeTraversalState[b.id])a=b.lodLevel}var b=this.viewportQueries.hasLOD(c),l=this.viewportQueries.getLodLevel(c),a=!b||l>a;if(d)return d.lodLevel=l,d.isChosen=a,d.version=this._version,d;this._nodeTraversalState[c.id]={nodeHasLOD:b,lodLevel:l,isChosen:a,version:this._version};
return this._nodeTraversalState[c.id]};a.prototype._loadNode=function(c){var d=this;this._loadingNodes.add(c.id);var a=r.makeAbsolute(c.href,c.baseUrl);this.streamDataSupplier.request(a,"json").then(function(c,a){var b={id:a.id,mbs:a.mbs,parentNode:a.parentNode,children:a.children,featureData:a.featureData};v.forEach(function(c){b[c]=a.hasOwnProperty(c)?a[c]:null});a.hasOwnProperty("obb")&&(b.obb=u.clone(a.obb),b.hasServiceOBB=!0);d.nodeIndex[b.id]=b;b.baseUrl=c;b.featureData&&1===b.featureData.length&&
b.featureData[0].featureRange&&(b.numFeatures=b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]);d.nodeTraversalState(b);d._loadingNodes.delete(b.id)},function(b){d.loadErrorCallback(a);d._loadingNodes.delete(c.id)})};a.prototype.entryPriority=function(c){if(c.id===this.rootId)return 0;var a=0,h=this.nodeIndex[c.id];null!=h&&null!=h.parentNode&&(h=this._nodeTraversalState[h.parentNode.id],null!=h&&(a=h.lodLevel));c=this.viewportQueries.distToPOI(c);return-c-a*(c+this.progressiveLoadPenalty)};
a.prototype.traverseVisible=function(c){var a=this.nodeIndex[this.rootId];this._numFeatures=0;a?this._traverse({id:this.rootId,mbs:a.mbs,href:this.rootUrl},a,c,""):c({id:this.rootId,mbs:null,href:this.rootUrl},null,"")};a.prototype._traverse=function(c,a,h,b){if(!a.children||0===a.children.length)this.viewportQueries.isGeometryVisible(a)&&(h(c,a,b),this._numFeatures+=a.numFeatures);else if(this.viewportQueries.isNodeVisible(a)&&(h(c,a,b),this._numFeatures+=a.numFeatures,c=this.nodeTraversalState(a),
!c.nodeHasLOD||c.lodLevel!==this._maxLodLevel))for(c=0,b=a.children;c<b.length;c++){var d=b[c],m=this.nodeIndex[d.id];m?this._traverse(d,m,h,a.baseUrl):this.viewportQueries.isNodeVisible(d)&&h(d,null,a.baseUrl)}};a.prototype.loadErrorCallback=function(a){this.logger.warn("Error loading node: "+a)};return a}()});