// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Logger ./Camera ./DefaultVertexAttributeLocations ./DefaultVertexBufferLayouts ./gl-matrix ./glUtil3D ./Util ../../../webgl/BufferObject ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),function(Q,D,fa,ga,ha,ia,b,ja,m,ka,la,ma,R,na){function p(a,g){b.vec3d.set3(a[g],a[g+3],a[g+6],S);return S}var oa=fa.getLogger("esri.views.3d.webgl-engine.lib.ShadowMap"),pa=function(){return function(){this.camera=
new ga;this.lightMat=b.mat4d.create()}}();Q=function(){function d(a,b){this.doShadowMapMipmapsWork=!1;this.textureRes=4096;this.numCascades=1;this.maxNumCascades=2;this.cascadeDistances=[0,0,0,0,0];this.cascades=[];this.programRep=a;this.rctx=b;this.emptyTexture=ja.createEmptyTexture(b);for(a=0;4>a;++a)this.cascades.push(new pa)}d.prototype.dispose=function(){this.emptyTexture.dispose();this.emptyTexture=null};d.prototype.getIsSupported=function(){return this.rctx.capabilities.standardDerivatives};
d.prototype.setTextureResolution=function(a){this.textureRes=a};d.prototype.getTextureResolution=function(){return this.textureRes};d.prototype.setMaxNumCascades=function(a){this.maxNumCascades=m.clamp(Math.floor(a),1,4)};d.prototype.getMaxNumCascades=function(){return this.maxNumCascades};d.prototype.setEnableState=function(a){a?this.enable():this.disable()};d.prototype.getEnableState=function(){return!!this.depthTexture};d.prototype.getDepthTexture=function(){return this.depthTexture};d.prototype.getCascades=
function(){for(var a=0;a<this.numCascades;++a)P[a]=this.cascades[a];P.length=this.numCascades;return P};d.prototype.prepare=function(g,t,G,l){m.assert(this.getEnableState());b.mat4d.multiply(g.projectionMatrix,g.viewMatrix,T);var c=l[0],d=l[1];2>c&&(c=2);2>d&&(d=2);c>=d&&(c=2,d=4);this.numCascades=Math.min(1+Math.floor(m.logWithBase(d/c,4)),this.maxNumCascades);G=Math.pow(d/c,1/this.numCascades);for(l=0;l<this.numCascades+1;++l)this.cascadeDistances[l]=c*Math.pow(G,l);b.mat4d.inverse(T,U);b.mat4d.lookAt([0,
0,0],[-t[0],-t[1],-t[2]],[0,1,0],V);G=g.viewMatrix;g=g.projectionMatrix;for(l=0;l<this.numCascades;++l){var q=this.cascades[l],d=-this.cascadeDistances[l],c=-this.cascadeDistances[l+1],d=(g[10]*d+g[14])/Math.abs(g[11]*d+g[15]),c=(g[10]*c+g[14])/Math.abs(g[11]*c+g[15]);m.assert(d<c);for(var e=0;8>e;++e){b.vec4d.set4(0===e%4||3===e%4?-1:1,0===e%4||1===e%4?-1:1,4>e?d:c,1,W);b.mat4d.multiplyVec4(U,W,r[e]);for(var f=0;3>f;++f)r[e][f]/=r[e][3]}b.vec3d.negate(r[0],X);b.mat4d.translate(V,X,q.camera.viewMatrix);
for(e=0;8>e;++e)b.mat4d.multiplyVec3(q.camera.viewMatrix,r[e]);b.vec3d.set(r[0],z);b.vec3d.set(r[0],A);for(e=1;8>e;++e)for(f=0;3>f;++f)z[f]=Math.min(z[f],r[e][f]),A[f]=Math.max(A[f],r[e][f]);z[2]-=200;A[2]+=200;q.camera.near=-A[2];q.camera.far=-z[2];c=1/r[0][3];d=1/r[4][3];m.assert(c<d);var f=c+Math.sqrt(c*d),e=Math.sin(Math.acos(G[2]*t[0]+G[6]*t[1]+G[10]*t[2])),f=f/e,c=r,K=f,E=e,e=Y,u=Z,k=qa,x=aa,f=ba;b.vec2d.set2(0,0,w);for(var h=0;4>h;++h)b.vec2d.add(w,c[h],w);b.vec2d.scale(w,.25);b.vec2d.set2(0,
0,L);for(h=4;8>h;++h)b.vec2d.add(L,c[h],L);b.vec2d.scale(L,.25);b.vec2d.lerp(c[4],c[5],.5,F[0]);b.vec2d.lerp(c[5],c[6],.5,F[1]);b.vec2d.lerp(c[6],c[7],.5,F[2]);b.vec2d.lerp(c[7],c[4],.5,F[3]);for(var B=0,y=b.vec2d.dist2(F[0],w),h=1;4>h;++h){var H=b.vec2d.dist2(F[h],w);H<y&&(y=H,B=h)}b.vec2d.subtract(F[B],c[B+4],n);h=n[0];n[0]=-n[1];n[1]=h;b.vec2d.subtract(L,w,ca);b.vec2d.lerp(n,ca,E);b.vec2d.normalize(n);B=E=void 0;E=B=b.vec2d.dot(b.vec2d.subtract(c[0],w,C),n);for(h=1;8>h;++h)y=b.vec2d.dot(b.vec2d.subtract(c[h],
w,C),n),y<E?E=y:y>B&&(B=y);b.vec2d.set(w,e);b.vec2d.scale(n,E-K,C);b.vec2d.add(e,C,e);for(var H=-1,D=1,h=K=y=0;8>h;++h){b.vec2d.subtract(c[h],e,N);b.vec2d.normalize(N);var M=n[0]*N[1]-n[1]*N[0];0<M?M>H&&(H=M,y=h):M<D&&(D=M,K=h)}m.verify(0<H,"leftArea");m.verify(0>D,"rightArea");b.vec2d.scale(n,E,I);b.vec2d.add(I,w,I);b.vec2d.scale(n,B,J);b.vec2d.add(J,w,J);O[0]=-n[1];O[1]=n[0];u=m.rayRay2D(e,c[K],J,b.vec2d.add(J,O,C),1,u);k=m.rayRay2D(e,c[y],J,C,1,k);x=m.rayRay2D(e,c[y],I,b.vec2d.add(I,O,C),1,x);
c=m.rayRay2D(e,c[K],I,C,1,f);m.verify(u,"rayRay");m.verify(k,"rayRay");m.verify(x,"rayRay");m.verify(c,"rayRay");k=Y;c=Z;e=aa;x=ba;f=q.camera.projectionMatrix;b.vec2d.scale(b.vec2d.subtract(e,x,v),.5);a[0]=v[0];a[1]=v[1];a[2]=0;a[3]=v[1];a[4]=-v[0];a[5]=0;a[6]=v[0]*v[0]+v[1]*v[1];a[7]=v[0]*v[1]-v[1]*v[0];a[8]=1;a[6]=-b.vec2d.dot(p(a,0),k);a[7]=-b.vec2d.dot(p(a,1),k);k=b.vec2d.dot(p(a,0),e)+a[6];u=b.vec2d.dot(p(a,1),e)+a[7];h=b.vec2d.dot(p(a,0),x)+a[6];x=b.vec2d.dot(p(a,1),x)+a[7];k=-(k+h)/(u+x);a[0]+=
a[1]*k;a[3]+=a[4]*k;a[6]+=a[7]*k;k=1/(b.vec2d.dot(p(a,0),e)+a[6]);u=1/(b.vec2d.dot(p(a,1),e)+a[7]);a[0]*=k;a[3]*=k;a[6]*=k;a[1]*=u;a[4]*=u;a[7]*=u;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;k=b.vec2d.dot(p(a,1),c)+a[7];u=b.vec2d.dot(p(a,2),c)+a[8];h=b.vec2d.dot(p(a,1),e)+a[7];x=b.vec2d.dot(p(a,2),e)+a[8];k=-.5*(k/u+h/x);a[1]+=a[2]*k;a[4]+=a[5]*k;a[7]+=a[8]*k;k=b.vec2d.dot(p(a,1),c)+a[7];u=b.vec2d.dot(p(a,2),c)+a[8];h=-u/k;a[1]*=h;a[4]*=h;a[7]*=h;f[0]=a[0];f[1]=a[1];f[2]=0;f[3]=a[2];f[4]=a[3];f[5]=a[4];
f[6]=0;f[7]=a[5];f[8]=0;f[9]=0;f[10]=1;f[11]=0;f[12]=a[6];f[13]=a[7];f[14]=0;f[15]=a[8];q.camera.projectionMatrix[10]=2/(z[2]-A[2]);q.camera.projectionMatrix[14]=-(z[2]+A[2])/(z[2]-A[2]);b.mat4d.multiply(q.camera.projectionMatrix,q.camera.viewMatrix,q.lightMat);c=this.textureRes/2;q.camera.viewport[0]=0===l%2?0:c;q.camera.viewport[1]=0===Math.floor(l/2)?0:c;q.camera.viewport[2]=c;q.camera.viewport[3]=c}this.lastOrigin=null;this.cascadeDistances[this.numCascades]=100*d;t=this.rctx;l=t.gl;t.bindFramebuffer(this.fbo);
t.bindTexture(null,7);t.setClearColor(1,1,1,1);t.clear(l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT);t.setBlendingEnabled(!1)};d.prototype.finish=function(a){m.assert(this.getEnableState());this.rctx.bindFramebuffer(a);this.doShadowMapMipmapsWork&&this.depthTexture.generateMipmap()};d.prototype.bind=function(a){var b=this.rctx,d=this.getEnableState();b.bindTexture(d?this.depthTexture:this.emptyTexture,7);b.bindProgram(a);a.setUniform1i("depthTex",7);a.setUniform1f("depthHalfPixelSz",d?.5/this.textureRes:
-1);a.setUniform1i("shadowMapNum",this.numCascades);a.setUniform4f("shadowMapDistance",this.cascadeDistances[0],this.cascadeDistances[1],this.cascadeDistances[2],this.cascadeDistances[3])};d.prototype.bindAll=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var b=0;b<a.length;b++)this.bind(a[b])};d.prototype.bindView=function(a,d){if(this.getEnableState()){var g=this.lastOrigin;if(!g||g[0]!==d[0]||g[1]!==d[1]||g[2]!==d[2])for(this.lastOrigin=this.lastOrigin||b.vec3d.create(),b.vec3d.set(d,
this.lastOrigin),g=0;g<this.numCascades;++g){b.mat4d.translate(this.cascades[g].lightMat,d,da);for(var l=0;16>l;++l)ea[16*g+l]=da[l]}a.setUniformMatrix4fv("shadowMapMatrix",ea)}};d.prototype.drawDebugQuad=function(a){m.assert(this.getEnableState());var b=this.rctx,d=b.gl;if(!this.debugQuadVAO){var g=new Float32Array([0,0,0,0,256,0,1,0,0,256,0,1,256,256,1,1]);this.debugQuadVAO=new na(b,ha.Default3D,{geometry:ia.Pos2Tex},{geometry:ka.createVertex(b,d.STATIC_DRAW,g)})}var g=this.programRep.get("showDepth"),
c=this.debugQuadVAO;b.setDepthTestEnabled(!1);b.bindProgram(g);g.setUniformMatrix4fv("proj",a);g.setUniform1i("depthTex",0);b.bindTexture(this.depthTexture,0);b.bindVAO(c);R.assertCompatibleVertexAttributeLocations(c,g);b.drawArrays(d.TRIANGLE_STRIP,0,R.vertexCount(c,"geometry"));b.setDepthTestEnabled(!0)};d.prototype.enable=function(){if(!this.getEnableState())if(this.getIsSupported()){var a=this.rctx.gl;this.depthTexture=new ma(this.rctx,{target:a.TEXTURE_2D,pixelFormat:a.RGBA,dataType:a.UNSIGNED_BYTE,
wrapMode:a.CLAMP_TO_EDGE,samplingMode:a.NEAREST,flipped:!0,width:this.textureRes,height:this.textureRes});this.fbo=la.createWithAttachments(this.rctx,this.depthTexture,{colorTarget:0,depthStencilTarget:1,width:this.textureRes,height:this.textureRes})}else oa.warn("Shadow maps are not supported for this browser or hardware")};d.prototype.disable=function(){this.getEnableState()&&this.fbo&&(this.fbo.dispose(),this.depthTexture=this.fbo=null)};return d}();var T=b.mat4d.create(),U=b.mat4d.create(),W=
b.vec4d.create(),r=[];for(D=0;8>D;++D)r.push(b.vec4d.create());var z=b.vec3d.create(),A=b.vec3d.create(),Y=b.vec2d.create(),Z=b.vec2d.create(),qa=b.vec2d.create(),aa=b.vec2d.create(),ba=b.vec2d.create(),V=b.mat4d.create(),X=b.vec3d.create(),P=[],da=b.mat4d.create(),ea=new Float32Array(64),w=b.vec2d.create(),L=b.vec2d.create(),F=[b.vec2d.create(),b.vec2d.create(),b.vec2d.create(),b.vec2d.create()],n=b.vec2d.create(),ca=b.vec2d.create(),C=b.vec2d.create(),N=b.vec2d.create(),I=b.vec2d.create(),J=b.vec2d.create(),
O=b.vec2d.create(),S=b.vec3d.create(),v=b.vec2d.create(),a=b.mat3d.create();return Q});