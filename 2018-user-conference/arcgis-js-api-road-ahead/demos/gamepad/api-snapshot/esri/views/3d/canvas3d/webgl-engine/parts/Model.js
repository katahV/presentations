// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("dojo/string ../lib/Light ../lib/ModelContentType ../lib/ModelDirtySet ../lib/RenderGeometry ../lib/Util ../lib/gl-matrix".split(" "),function(D,t,e,E,F,g,m){var f=g.assert,G=g.verify,p=m.vec3,H=m.mat4d,I=g.logWithBase;g=function(){function g(a,b){var c=Array.prototype.slice.call(arguments);c.shift();k.forEach(function(b){void 0!==b[a]&&b[a].apply(this,c)})}var n=new E(this),q=function(){var a={},b;for(b in e)a[e[b]]={};return a}(),m=new t.AmbientLight([1,1,1],.3,!0,.5,5,3,16),u=new t.DirectionalLight([1,
1,1],.7,p.normalize([1,1,1]),.5,!0),v,r,k=[];this.getAll=function(a){a=q[a];f(void 0!==a);return a};this.get=function(a,b){return this.getAll(a)[b]};this.add=function(a,b){var c=q[a];f(void 0!==c);var d=b.getId();f(void 0===c[d],"Model/Stage already contains object to be added");c[d]=b;a===e.LAYER&&this.notifyDirty(a,b,"layerAdded");g("contentAdded",a,b)};this.remove=function(a,b){var c=q[a];f(void 0!==c);var d=c[b];f(void 0!==d,"Model/Stage doesn't contain object to be removed");delete c[b];a===
e.TEXTURE&&d.unload();a===e.LAYER&&this.notifyDirty(a,d,"layerRemoved");g("contentRemoved",a,d);return d};this.getDirtySet=function(){return n};this.notifyDirty=function(a,b,c,d){n.handleUpdate(b,c,d)};this.getAmbientLight=function(){return m};this.setAmbientLight=function(a){m.set(a)};this.getDirectionalLight=function(){return u};this.setDirectionalLight=function(a){u.set(a)};this.getSelection=function(){return v};this.setSelection=function(a,b){v=a;r=b};this.getSelectionFaceRange=function(){return r};
var A={},J=0,w={},B=function(a,b,c){var d=0;b=b*(c||10)/1E4;1<b&&(d=Math.ceil(I(b,2)));b=1E4*Math.pow(2,d);c=Math.round(a[0]/b);var e=Math.round(a[1]/b);a=Math.round(a[2]/b);var d=d+"_"+c+"_"+e+"_"+a,f=w[d];void 0===f&&(f={vec3:p.createFrom(c*b,e*b,a*b),id:d},w[d]=f);return f};this.getOrigin=B;this.getGeometryRenderGeometries=function(a,b,c,d){d=a.getId();for(var e="Panorama"===d||"panorama"===d||"Atmosphere"===d,f=b.geometry,g=f.getData(),m=!!f.singleUse,k=g.getFaces(),n=g.getVertexAttr(),g=g.getId(),
q=b.materials,t=b.instanceParameters,p=a.getCombinedTransformation(b),u=H.maxScale(p),v=b.origin,r=a.getVisibleIndexRanges(b),h=0,w=f.getNumGroups();h<w;++h){var l=f.getBoundingInfo(h),y=b.getId()+"#"+h,x=A[y];void 0===x&&(x=J++,A[y]=x);var C={},z;for(z in k[h].indices)C[z]=n[z];l=new F({faces:k[h],vertexAttr:C,id:g+"#"+h},l,q[h],p,u,a.getCastShadow(),e,m,d,y,x,h);l.origin=v||B(l.center,l.radius);l.displayedIndexRange=r?r[h]:null;l.instanceParameters=t?b.instanceParameters[h]:null;c.push(l)}};this.formatDebugInfo=
function(a){var b=[],c;if(a){b[0]="\x3ctable\x3e";for(c in e)a=e[c],b[0]+="\x3ctr\x3e\x3ctd\x3e"+a+'\x3c/td\x3e\x3ctd style\x3d"text-align: right"\x3e'+Object.keys(this.getAll(a)).length+"\x3c/td\x3e\x3c/tr\x3e";b[0]+="\x3c/table\x3e";b[1]=n.formatDebugInfo(!0)}else{b[0]="";for(c in e)a=e[c],b[0]+=D.pad(String(Object.keys(this.getAll(a)).length),6," ")+" "+a+", ";b[1]=n.formatDebugInfo(!1)}return b};this.validateContent=function(){var a=this.getAll(e.OBJECT),b;for(b in a)this.validateObject(a[b]);
a=this.getAll(e.LAYER);for(b in a)this.validateLayer(a[b]);a=this.getAll(e.MATERIAL);for(b in a)this.validateMaterial(a[b])};this.validateObject=function(a){a=a.getGeometryRecords();for(var b=0;b<a.length;++b){var c=a[b];f(null!=this.get(e.GEOMETRY,c.geometry.getId()));var d=c.geometry.getNumGroups();f(d<=c.materials.length,"object materials do not match geometry groups");G(d==c.materials.length,"object materials do not match geometry groups");for(var g=0;g<d;++g)f(null!=this.get(e.MATERIAL,c.materials[g].getId()))}};
this.validateLayer=function(a){a=a.getObjects();for(var b=0;b<a.length;++b){var c=this.get(e.OBJECT,a[b].getId());f(null!=c)}};this.validateMaterial=function(a){a=a.getAllTextureIds();for(var b=0;b<a.length;++b){var c=this.get(e.TEXTURE,a[b]);f(null!=c)}};this.addModelListener=function(a){f(-1===k.indexOf(a));k.push(a)};this.removeModelListener=function(a){a=k.indexOf(a);f(-1!==a);k.splice(a,a)}};g.ContentType=e;return g});