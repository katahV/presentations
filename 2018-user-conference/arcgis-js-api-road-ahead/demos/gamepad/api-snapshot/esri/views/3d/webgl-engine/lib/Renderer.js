// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ./ComponentUtils ./DefaultVertexAttributeLocations ./ExternalRendererContainer ./Float32ArrayList ./FxaaRenderPass ./gl-matrix ./HighlightTextureHelper ./InstanceBufferData ./IntervalUtilities ./LinearDepthTextureHelper ./NormalTextureHelper ./RenderContext ./RenderPass ./RenderSlot ./SmaaRenderPass ./StencilRenderingHelper ./Util ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/HUDMaterial ../../../webgl/BufferObject ../../../webgl/Profiling ../../../webgl/Texture ../../../webgl/Util ../../../webgl/VertexArrayObject".split(" "),
function(X,qa,Y,S,ea,Z,fa,T,ga,ha,aa,ia,ja,ka,E,m,la,ma,C,ba,na,oa,O,ca,da,H,P){function U(e){return e.instanceParameters.hidden?[]:Y.generateVisibleIndexRanges(e.instanceParameters.componentVisibilities,e.componentOffsets)}function V(e,a,b){var d=e.origin.vec3;C.setMatrixTranslation3(K,-d[0],-d[1],-d[2]);F.multiply(K,e.transformation,a);F.inverse(a,b);F.transpose(b)}function I(e,a,b){for(var d in e){var c=e[d];a(d,c);for(var f in c.origin2data)b(f,c.origin2data[f])}}function M(e){return!1===e.preinterleaved?
C.getFirstObjectValue(e.indices).length:e.indexCount}X=T.vec2d;var F=T.mat4d,N=F.identity();T=function(){function e(a,b,d,c,f){this._lighting=new na.SceneLighting;this._mat2DataMerged={};this._mat2DataInstanced={};this._mat2DataPreinterleaved={};this._renderOrder=[];this._externalRenderers=new ea;this._renderContext=new ka;this._isRendering=!1;this._highlights=[];this._pixelRatio=1;this._threshold=1535;this._needsRender=!0;this._fallbackDepthStencilTexture=null;this._stats=new pa;this._edgeView=null;
this.ssaoEnabled=this._edgeViewLoaded=!1;this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1};this._programRep=a;this._materialRep=b;this._orderedRendering=f;this._rctx=c;this._fxaaPass=new fa(c);this._smaaPass=new la(c);this._renderContext.rctx=c;this._renderContext.lightingData=this._lighting.getOld();c.setDepthTestEnabled(!0);c.setFaceCullingEnabled(!0);c.setBlendingEnabled(!1);c.setBlendFunctionSeparate(770,771,1,771);this._bindParameters={view:null,proj:null,viewInvTransp:null,
fovY:0,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null};this._linearDepthTextureHelper=new ia(c);this._normalTextureHelper=new ja(c);this._highlightTextureHelper=new ga(c);this._stencilRenderingHelper=new ma(c);this._initializeFramebufferTexture()}e.prototype._initializeFramebufferTexture=function(){var a=this._rctx.gl,a=this._rctx.contextAttributes.alpha?a.RGBA:a.RGB,b=new da(this._rctx,{target:3553,pixelFormat:a,
dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:a,texture:b}};e.prototype.dispose=function(){var a=this,b=function(b){a._releaseMaterials(b)},d=function(a,b){if(b.type===y.Preinterleaved)for(var c in b.instances)b.instances[c].vao.dispose(!0);else b.vao.dispose(!0)};I(this._mat2DataMerged,b,d);I(this._mat2DataInstanced,b,d);I(this._mat2DataPreinterleaved,b,d);this._mat2DataPreinterleaved=this._mat2DataInstanced=this._mat2DataMerged=null;this._framebuffer.texture.dispose();
this._framebuffer.texture=null;this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable();this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable();this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1);this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1);this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=
null)};Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0});Object.defineProperty(e.prototype,"edgeView",{get:function(){var a=this;this._edgeViewLoaded||(this._edgeViewLoaded=!0,ba.EdgeView.isSupported(this._rctx)&&(this._edgeView=new ba.EdgeView(this._rctx,this._programRep,{setNeedsRender:function(){a._needsRender=!0}}),this._edgeView.initialize()));return this._edgeView},
enumerable:!0,configurable:!0});e.prototype.setLighting=function(a){this._lighting.set(a)};e.prototype.setPixelRatio=function(a){this._pixelRatio=a;this._needsRender=!0};e.prototype.getPixelRatio=function(){return this._pixelRatio};e.prototype.addExternalRenderer=function(a,b){this._externalRenderers.addRenderer(a,b);return!0};e.prototype.removeExternalRenderer=function(a){this._externalRenderers.removeRenderer(a);return!0};e.prototype.getExternalRenderers=function(){return this._externalRenderers};
e.prototype.resetNeedsRender=function(){this._needsRender=!1;this._externalRenderers.resetNeedsRender()};e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()};e.prototype.getCombinedStats=function(){var a=this;this._stats.VBOallocatedSize=0;this._stats.VBOoptimalSize=0;this._stats.VBOusedSize=0;var b=function(){},d=function(b,d){if(d.type===y.Preinterleaved)for(var c in d.instances)b=d.instances[c].vao.size,a._stats.VBOallocatedSize+=b/4,a._stats.VBOusedSize+=
b/4,a._stats.VBOoptimalSize+=b/4;else a._stats.VBOallocatedSize+=d.buffer.getArray().length,a._stats.VBOusedSize+=d.buffer.getSize(),a._stats.VBOoptimalSize+=d.optimalCount};I(this._mat2DataMerged,b,d);I(this._mat2DataInstanced,b,d);I(this._mat2DataPreinterleaved,b,d);this._stats.VBOallocatedSize*=.00390625;this._stats.VBOusedSize*=.00390625;this._stats.VBOoptimalSize*=.00390625;return this._stats};e.prototype._addHighlight=function(a){var b=this._getInstance(a);if(null===b)console.error("No instance found for RenderGeometry {name: '"+
a.name+"', uniqueName: '"+a.uniqueName+"'}");else if(this._highlights.push(b),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights)};e.prototype._removeHighlight=function(a){var b=this._highlights.length;this._highlights=this._highlights.filter(function(b){return b.uniqueName!==a.uniqueName});if(b!==this._highlights.length){if(this.onHasHighlightsChanged)this.onHasHighlightsChanged(this.hasHighlights);
this._needsRender=!0}};Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return 0<this._highlights.length},enumerable:!0,configurable:!0});e.prototype._renderHUDVisibility=function(a){var b=this,d=oa.shouldRenderVisibilityDuringRenderPass(a.pass),c=a.offscreenRenderingHelper&&a.offscreenRenderingHelper.getEnableState();d&&c&&a.offscreenRenderingHelper.renderHUDVisibility(function(){b._renderInternalSlot(m.OCCLUSION_PIXELS,a)})};e.prototype.renderGeometrySlotsPt1=function(a){this._externalRenderers.render(m.INTERNAL_MATERIAL,
a);this._renderInternalSlot(m.STENCIL_MATERIAL,a);this._externalRenderers.render(m.OPAQUE_TERRAIN,a);this._renderInternalSlot(m.OPAQUE_MATERIAL,a);this._externalRenderers.render(m.OPAQUE_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep);this._externalRenderers.render(m.POSTPROCESSING_ATMOSPHERE_OPAQUE,this._renderContext);this._renderInternalSlot(m.TRANSPARENT_MATERIAL,a);this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(a),this._renderInternalSlot(m.LINE_CALLOUTS,
this._renderContext));this._externalRenderers.render(m.TRANSPARENT_EXTERNAL,a);a.ssaoHelper&&a.ssaoHelper.bindAll(this._programRep)};e.prototype.renderGeometrySlotsPt2=function(a){this._externalRenderers.render(m.TRANSPARENT_TERRAIN,a)};e.prototype.renderGeometrySlots=function(a){this.renderGeometrySlotsPt1(a);this.renderGeometrySlotsPt2(a)};e.prototype._renderHighlights=function(a,b,d){var c=!!d&&d.getEnableState()&&(this.hasHighlights||this._externalRenderers.needsHighlight());this._highlightTextureHelper.setEnableState(c);
if(c){c=null;d.profilingCallback&&(c=ca.startMeasurement(this._renderContext.rctx));this._highlightTextureHelper.setupFBOs(a);this._highlightTextureHelper.prepareHighlightPass();this.renderGeometryPass(E.MATERIAL_HIGHLIGHT,a,null,null);this._rctx.clear(this._rctx.gl.DEPTH_BUFFER_BIT);this._renderInternalSlot(m.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(m.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(m.HUDMATERIAL2,this._renderContext);this._highlightTextureHelper.finish(b);
var f=this._highlightTextureHelper.getHighlightFBO();d.render(a,b,f);null!==c&&d.profilingCallback&&c.stop(function(a){d.profilingCallback&&d.profilingCallback(a)})}};e.prototype._needsRenderOccluded=function(a){for(var b in this._mat2DataInstanced){var d=this._mat2DataInstanced[b][0];if(d&&d.renderOccluded&&d.beginSlot(a)&&d.isVisible())return!0}return!1};e.prototype._renderOccluded=function(a,b,d){if(b&&d&&d.getEnableState()){var c=this._needsRenderOccluded(m.OPAQUE_MATERIAL)||this._needsRenderOccluded(m.TRANSPARENT_MATERIAL);
c!==b.getEnableState()&&b.setEnableState(c);c&&(c=this._renderContext,b.setupFBOs(a),b.prepareColorPass(),c.pass=E.MATERIAL,c.renderOccludedOnly=!0,this._renderInternalSlot(m.OPAQUE_MATERIAL,c),this._renderInternalSlot(m.TRANSPARENT_MATERIAL,c),c.renderOccludedOnly=!1,b.finish(d.getFramebuffer()),b.apply())}};e.prototype._renderUnordered=function(a,b,d,c){var f=this,e=this._rctx;this._isRendering=!0;this._stats.reset();this._updateGlobalUniforms(a.projectionMatrix);this._renderContext.pass=E.MATERIAL;
this._renderContext.camera=a;this._renderContext.pixelRatio=this._pixelRatio;this._renderContext.shadowMap=b;this._renderContext.ssaoHelper=c.ssao;this._renderContext.offscreenRenderingHelper=c.offscreenRendering;this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper;this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO();
this._renderContext.options=this.renderOptions;c.offscreenRendering.setEnableState(!0);c.offscreenRendering.initializeFrame(a);this._externalRenderers.render(m.BACKGROUND,this._renderContext);this.renderGeometrySlotsPt1(this._renderContext);this._edgeView&&this.edgeView.shouldRender()&&(b=null,this._edgeView.profilingCallback&&(b=ca.startMeasurement(this._renderContext.rctx)),c.offscreenRendering.renderSeparateAndComposite(function(){f._edgeView.render(f._bindParameters)},void 0,"alpha"),b&&b.stop(function(a){f._edgeView&&
f._edgeView.profilingCallback&&f._edgeView.profilingCallback(a)}));this.renderGeometrySlotsPt2(this._renderContext);this._externalRenderers.render(m.POSTPROCESSING_ATMOSPHERE_TRANSPARENT,this._renderContext);this._externalRenderers.render(m.POSTPROCESSING_EXTERNAL,this._renderContext);this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(m.LINE_CALLOUTS,this._renderContext));this._renderOccluded(a,c.renderOccluded,c.offscreenRendering);
b=this.renderOptions.antialiasing;"smaa"===b&&this._smaaPass.loadResources(function(){f._needsRender=!0});"smaa"===b&&this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:c.offscreenRendering.getColorTexture()},null)):"fxaa"===b&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:c.offscreenRendering.getColorTexture()},null)):(c.offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable());e.bindFramebuffer(null);
this._renderContext.framebufferTex=c.offscreenRendering.getColorTexture();this._renderInternalSlot(m.LINE_CALLOUTS_HUD_DEPTH,this._renderContext);this._renderInternalSlot(m.HUDMATERIAL1,this._renderContext);this._renderInternalSlot(m.HUDMATERIAL2,this._renderContext);this._renderHighlights(a,d,c.highlight);this._isRendering=!1};e.prototype._renderGeometryPassOrderedHighlight=function(a){this._renderInternalHighlights(this._highlights)};e.prototype._renderGeometryPassOrderedMaterial=function(a){for(var b=
null,d=0;d<this._renderOrder.length;d++){var c=this._renderOrder[d][1];if(c.instanced){var f=c.instanced||c.merged,e=f[a.pass];e&&e.isVisible()&&(this._renderInternalInstanced(f,e,this._bindParameters,Infinity),b=null)}c.merged&&(f=c.merged,(e=f[a.pass])&&e.isVisible()&&(c=e.getProgram(),c!==b&&(c.setUniformMatrix4fv("model",N),c.hasUniform("modelNormal")&&c.setUniformMatrix4fv("modelNormal",N)),b=c,this._renderInternalMerged(f,e,this._bindParameters,Infinity)))}};e.prototype._renderGeometryPassOrdered=
function(a){var b=a.camera;this._bindParameters.view=b.viewMatrix;this._bindParameters.proj=b.projectionMatrix;this._bindParameters.viewInvTransp=b.viewInverseTransposeMatrix;L[0]=b.near;L[1]=b.far;this._bindParameters.nearFar=L;this._bindParameters.lightingData=a.lightingData;this._bindParameters.viewport=b.fullViewport;this._bindParameters.framebufferTex=this._framebuffer.texture;this._bindParameters.pixelRatio=a.pixelRatio;a.isHighlightPass?this._renderGeometryPassOrderedHighlight(a):this._renderGeometryPassOrderedMaterial(a)};
e.prototype._renderOrdered=function(a,b){this._stats.reset();this.renderGeometryPass(a,b)};e.prototype.render=function(a,b,d){this._orderedRendering?this._renderOrdered(E.MATERIAL,a):this._renderUnordered(a,d.shadowMap,b,d)};e.prototype.renderAuxiliaryBuffers=function(a,b,d){var c=d.ssao;d=d.shadowMap;var f=this.ssaoEnabled||this._externalRenderers.needsLinearDepth();this._linearDepthTextureHelper.setEnableState(f);f&&(this._linearDepthTextureHelper.setupFBOs(a),this._linearDepthTextureHelper.prepareDepthPass(),
this.renderGeometryPass(E.MATERIAL_DEPTH,a,d,c),this._linearDepthTextureHelper.finish(b));this._normalTextureHelper.setEnableState(this.ssaoEnabled);this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(a),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(E.MATERIAL_NORMAL,a,d,c),this._normalTextureHelper.finish(b));this.ssaoEnabled&&c.computeSSAO(a,b,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO());c.bindAll(this._programRep)};e.prototype.renderGeometryPass=
function(a,b,d,c){this._isRendering=!0;this._updateGlobalUniforms(b.projectionMatrix);this._renderContext.pass=a;this._renderContext.camera=b;this._renderContext.pixelRatio=this._pixelRatio;this._renderContext.shadowMap=d;this._renderContext.ssaoHelper=c;this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO();this._renderContext.normals=this._normalTextureHelper.getNormalFBO();this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext);
this._isRendering=!1};e.prototype._renderGeometryPassUnordered=function(a){this.renderGeometrySlots(a)};e.prototype._renderInternalHighlights=function(a,b){void 0===b&&(b=null);for(var d=0;d<a.length;++d){var c=a[d],f=c.matData[E.MATERIAL_HIGHLIGHT];f&&(null===b||f.beginSlot(b))&&f.isVisible()&&this._renderInternalHighlight(c,this._bindParameters,E.MATERIAL_HIGHLIGHT)}};e.prototype._renderInternalSlotOccluded=function(a,b){for(var d in this._mat2DataInstanced){var c=this._mat2DataInstanced[d],f=c[b.pass];
f&&f.renderOccluded&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalInstanced(c,f,this._bindParameters,a)}};e.prototype._renderInternalSlotMaterial=function(a,b){for(var d in this._mat2DataInstanced){var c=this._mat2DataInstanced[d],f=c[b.pass];f&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalInstanced(c,f,this._bindParameters,a)}for(var c=this._programRep.getProgramsUsingUniform("model"),f=this._programRep.getProgramsUsingUniform("modelNormal"),e=0;e<c.length;e++){var h=c[e];h.setUniformMatrix4fv("model",
N);-1<f.indexOf(h)&&h.setUniformMatrix4fv("modelNormal",N)}for(d in this._mat2DataMerged)c=this._mat2DataMerged[d],(f=c[b.pass])&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalMerged(c,f,this._bindParameters,a);for(d in this._mat2DataPreinterleaved)c=this._mat2DataPreinterleaved[d],(f=c[b.pass])&&f.beginSlot(a)&&f.isVisible()&&this._renderInternalPreinterleaved(c,f,this._bindParameters,a);a===m.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()};e.prototype._renderInternalSlotHighlights=
function(a,b){this._renderInternalHighlights(this._highlights,a)};e.prototype._renderInternalSlot=function(a,b){this._bindParameters.view=b.camera.viewMatrix;this._bindParameters.proj=b.camera.projectionMatrix;this._bindParameters.viewInvTransp=b.camera.viewInverseTransposeMatrix;this._bindParameters.cameraAboveGround=b.camera.aboveGround;this._bindParameters.fovY=b.camera.fovY;L[0]=b.camera.near;L[1]=b.camera.far;var d=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=L;this._bindParameters.lightingData=
b.lightingData;this._bindParameters.viewport=b.camera.fullViewport;this._bindParameters.framebufferTex=d?d.getColorTexture():null;this._bindParameters.shadowMap=b.shadowMap;this._bindParameters.shadowMappingEnabled=!!b.shadowMap&&b.shadowMap.getEnableState();this._bindParameters.ssaoEnabled=!!b.ssaoHelper&&b.ssaoHelper.getEnableState();this._bindParameters.pixelRatio=b.pixelRatio;this._bindParameters.hudVisibilityTexture=d?d.getHUDVisibilityTexture():null;b.isHighlightPass?this._renderInternalSlotHighlights(a,
b):b.renderOccludedOnly?this._renderInternalSlotOccluded(a,b):this._renderInternalSlotMaterial(a,b)};e.prototype._renderInternalInstanced=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,n=b.getDrawMode(f),g=f.capabilities.instancing,l;for(l in a.origin2data){var p=a.origin2data[l];d.origin=p.origin;c===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());var k=!1;if(b.instanced)for(var q in p.perGeometryDataInfo){var u=p.perGeometryDataInfo[q];
h||(b.bind(f,d),h=!0);f.bindVAO(u.vao);var r=b.getProgram();H.assertCompatibleVertexAttributeLocations(u.vao,r);k||(b.bindView(f,d),k=!0);var r=u.to-u.from,t=u.refCount;n===e.TRIANGLES&&(this._stats.trianglesRendered+=t*r/3);g.drawArraysInstanced(n,u.from,r,t);this._stats.drawCallsAngleInstanced++;this._stats.instancesDrawnAngle+=t}else{var u=p.instances,y;for(y in u)r=u[y],t=r.displayedIndexRange,t&&0===t.length||(h||(b.bind(f,d),h=!0),k||(f.bindVAO(p.vao),b.bindView(f,d),k=!0),b.bindInstance(f,
r),this._stats.drawCallsInstanced++,n===e.TRIANGLES&&(this._stats.trianglesRendered+=(r.to-r.from)/3),t?this._drawArraysFaceRange(t,r.from,n):f.drawArrays(n,r.from,r.to-r.from))}}f.bindVAO(null);h&&b.release(f,d)};e.prototype._renderInternalHighlight=function(a,b,d){var c=this._rctx,f=c.gl;d=a.matData[d];var e=d.getDrawMode(c),h=a.instance,n=h.highlightedIndexRange,g=this._renderContext.offscreenRenderingHelper,g=(g?g.getDepthTexture():null)||this._getFallbackDepthTexture(),l=d.getProgram(),p=c.capabilities.instancing;
b.origin=a.originData.origin;if(d.instanced&&a.type===y.Instanced)for(a=a.instancedVAO,d.bind(c,b),c.bindVAO(a),H.assertCompatibleVertexAttributeLocations(a,l),d.bindView(c,b),a=0;a<n.length;a++){var k=n[a],q=k.range?k.range[0]+h.from:h.from,k=k.range?k.range[1]-k.range[0]+1:h.to-h.from;c.bindTexture(g,5);l.setUniform1i("depthTex",5);l.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);p.drawArraysInstanced(e,q,k,1);e===f.TRIANGLES&&
(this._stats.trianglesRendered+=1*k/3);this._stats.drawCallsHighlight++}else if(a.type===y.Instanced&&d.instanced)console.error("_renderInternalHighlight: incompatible instance type");else{d.bind(c,b);d.bindView(c,b);p=null;switch(a.type){case y.Merged:q=a.originData;c.bindVAO(q.vao);l.setUniformMatrix4fv("model",N);break;case y.Instanced:q=a.originData;c.bindVAO(q.vao);d.bindInstance(c,h);break;case y.Preinterleaved:q=a.originData,a=q.instances[a.uniqueName].vao,c.bindVAO(a),d.bindInstance(c,h),
p=a.indexBuffer&&a.indexBuffer.indexType}for(a=0;a<n.length;a++){k=n[a];q=k.range?k.range[0]+h.from:h.from;k=k.range?k.range[1]-k.range[0]+1:h.to-h.from;c.bindTexture(g,5);d.getProgram().setUniform1i("depthTex",5);l.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]);if(p){var u=H.getBytesPerElement(p);c.drawElements(e,k,p,q*u)}else c.drawArrays(e,q,k);e===f.TRIANGLES&&(this._stats.trianglesRendered+=k/3);this._stats.drawCallsHighlight++}}c.bindVAO(null);
d.release(c,b)};e.prototype._drawArraysFaceRange=function(a,b,d){for(var c=this._rctx,f=0;f<a.length;f++){var e=a[f];c.drawArrays(d,e[0]+b,e[1]-e[0]+1)}this._stats.drawCallsFragmented+=a.length-1};e.prototype._drawElementsFaceRange=function(a,b,d,c){for(var f=this._rctx,e=H.getBytesPerElement(c),h=0;h<a.length;h++){var n=a[h];f.drawElements(d,n[1]-n[0]+1,c,(n[0]+b)*e)}this._stats.drawCallsFragmented+=a.length-1};e.prototype._renderInternalMerged=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,n;for(n in a.origin2data){var g=
a.origin2data[n];d.origin=g.origin;c===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());if(!g.displayedIndexRange||0!==g.displayedIndexRange.length){h||(b.bind(f,d),h=!0);var l=b.getProgram();f.bindVAO(g.vao);H.assertCompatibleVertexAttributeLocations(g.vao,l);b.bindView(f,d);this._stats.drawCallsMerged++;l=b.getDrawMode(f);l===e.TRIANGLES&&(this._stats.trianglesRendered+=g.vao.vertexBuffers.geometry.size/3);g.displayedIndexRange?
this._drawArraysFaceRange(g.displayedIndexRange,0,l):f.drawArrays(l,0,H.vertexCount(g.vao,"geometry"))}}h&&b.release(f,d)};e.prototype._renderInternalPreinterleaved=function(a,b,d,c){var f=this._rctx,e=f.gl,h=!1,n=b.getDrawMode(f),g;for(g in a.origin2data){var l=a.origin2data[g];d.origin=l.origin;var p=!1;c===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());for(var k in l.instances){var q=l.instances[k],u=q.instance,r=q.vao,
q=u.displayedIndexRange;if(!q||0!==q.length){h||(b.bind(f,d),h=!0);var t=b.getProgram();H.assertCompatibleVertexAttributeLocations(r,t);f.bindVAO(r);p||(b.bindView(f,d),p=!0);b.bindInstance(f,u);this._stats.drawCallsPreinterleaved++;n===e.TRIANGLES&&(this._stats.trianglesRendered+=(u.to-u.from)/3);r=r.indexBuffer&&r.indexBuffer.indexType;q?r?this._drawElementsFaceRange(q,u.from,n,r):this._drawArraysFaceRange(q,u.from,n):r?(q=H.getBytesPerElement(r),f.drawElements(n,u.to-u.from,r,u.from*q)):f.drawArrays(n,
u.from,u.to-u.from)}}}f.bindVAO(null);h&&b.release(f,d)};e.prototype._updateGlobalUniforms=function(a){for(var b=this._programRep.getProgramsUsingUniform("proj"),d=0;d<b.length;d++)b[d].setUniformMatrix4fv("proj",a);if(this._lighting){b=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d]);b=this._programRep.getProgramsUsingUniform("lightDirection");for(d=0;d<b.length;d++)this._lighting.setUniforms(b[d])}};e.prototype.print=function(){var a=
Object.keys(this._mat2DataMerged).length,b=Object.keys(this._mat2DataInstanced).length,d=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+a+"/"+b+"/"+d);var c=0;I(this._mat2DataMerged,function(){},function(a,b){c+=Object.keys(b.instances).length});var f=0;I(this._mat2DataInstanced,function(){},function(a,b){f+=Object.keys(b.instances).length});var e=0;I(this._mat2DataPreinterleaved,function(){},function(a,b){e+=Object.keys(b.instances).length});
console.log("number of instances (merged/instanced/preinterleaved): "+c+"/"+f+"/"+e)};e.prototype.isEmpty=function(){for(var a in this._mat2DataInstanced){var b=this._mat2DataInstanced[a],d;for(d in b.origin2data)if(!C.objectEmpty(b.origin2data[d].instances))return!1}for(a in this._mat2DataMerged)for(d in b=this._mat2DataMerged[a],b.origin2data)if(!C.objectEmpty(b.origin2data[d].instances))return!1;for(a in this._mat2DataPreinterleaved)for(d in b=this._mat2DataPreinterleaved[a],b.origin2data)if(!C.objectEmpty(b.origin2data[d].instances))return!1;
return!0};e.prototype.modify=function(a,b,d,c){this._isRendering&&console.warn("Renderer.modify called while rendering");var f=[],e=[],h=[];this._classifyRenderGeometry(a,f,e,h);a=[];var n=[],g=[];this._classifyRenderGeometry(b,a,n,g);var l={};d&&this._performUpdates(d,l);d=[];this._modifyMerged(f,a,d,l);this._modifyInstanced(e,n,d);this._modifyPreinterleaved(h,g,d);this._updateMergedFaceranges(l);this._releaseMaterials(d);f=this._highlights.length;if(b&&0<b.length&&0<f&&(this._highlights=this._highlights.filter(function(a){return!b.some(function(b){return b.uniqueName===
a.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged))this.onHasHighlightsChanged(this.hasHighlights);this._updateHighlightVAOs();c&&this._modifyMaterials(c);this._needsRender=!0};e.prototype._classifyRenderGeometry=function(a,b,d,c){for(var f=0;f<a.length;f++){var e=a[f];if(1<=M(e.data))switch(this._getType(e)){case y.Merged:b.push(e);break;case y.Instanced:d.push(e);break;case y.Preinterleaved:c.push(e)}}};e.prototype._performUpdates=function(a,b){for(var d=0;d<a.length;d++){var c=
a[d],f=c.updateType,c=c.renderGeometry,e=this._getType(c)===y.Merged;if(1<=M(c.data)){f&2&&this._updateFaceranges(c,b);if(f&32){var h=this._getInstance(c);h&&this._updateHighlightFaceranges(c,h.instance)}f&4||e&&f&16?this._updateVertexAttributes(c,!e):!e&&f&16&&this._updateInstanceTransformation(c)}}};e.prototype._updateFaceranges=function(a,b){var d=a.material.id,c=a.origin.id,f=this._getType(a),e;if(f===y.Preinterleaved){var h=this._getOriginData(f,d,c);e=h.instances[a.uniqueName].instance}else h=
this._getOriginData(f,d,c),(e=h.instances[a.uniqueName])&&f===y.Merged&&(b[this._modifiedMergedFacerangesKey(d,c)]=h);e&&(e.displayedIndexRange=U(a),this._updateHighlightFaceranges(a,e))};e.prototype._updateHighlightFaceranges=function(a,b){if(b){var d=b.highlightedIndexRange,c;c=a.instanceParameters.hidden?[]:Y.generateHighlightedIndexRanges(a.instanceParameters.componentVisibilities,a.instanceParameters.componentHighlights,a.componentOffsets);(b.highlightedIndexRange=c)&&!d?this._addHighlight(a):
!c&&d&&this._removeHighlight(a)}};e.prototype._updateMergedFaceranges=function(a){for(var b in a){var d=a[b];d.displayedIndexRange=[];var c=d.instances,e=!0,G;for(G in c){var h=c[G];h.displayedIndexRange?(d.displayedIndexRange.push.apply(d.displayedIndexRange,aa.offsetIntervals(h.displayedIndexRange,h.from)),e=!1):d.displayedIndexRange.push([h.from,h.to-1])}d.displayedIndexRange=e?null:aa.mergeIntervals(d.displayedIndexRange)}};e.prototype._updateVertexAttributes=function(a,b){var d=a.material,c=
d.id,e=a.origin.id,G=H.getStride(d.getVertexBufferLayout())/4,h=this._getType(a);if(h===y.Preinterleaved)console.error("Updating Preinterleaved geometry not supported");else{var h=this._getOriginData(h,c,e),c=h.instances[a.uniqueName],e=h.buffer.getArray(),h=h.vao,n,g;b||(V(a,Q,R),n=Q,g=R);d.fillInterleaved(a.data,n,g,a.instanceParameters,e,c.from*G);C.assert(c.from+d.getOutputAmount(M(a.data))/G===c.to,"material VBO layout has changed");h.vertexBuffers.geometry.setSubData(e,c.from*G*4,c.from*G*4,
c.to*G*4)}};e.prototype._updateInstanceTransformation=function(a){var b=this._getType(a),d=a.material.id,c=a.origin.id;b===y.Preinterleaved?(b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName].instance,V(a,c.transformation,c.transformationNormal)):(b=this._getOriginData(b,d,c),c=b.instances[a.uniqueName],b=b.perGeometryDataInfo[a.data.id],d=b.instanceBufferData,V(a,c.transformation,c.transformationNormal),d&&(a=d.getSlot(a.idx),d.fill(a,0,c.transformation),d.fill(a,16,c.transformationNormal),
a=4*d.getOffset(a),c=H.getStride(b.vao.layout.instance),b.vao.vertexBuffers.instance.setSubData(d.getArray(),a,a,a+c)))};e.prototype._modifyMerged=function(a,b,d,c){var e=this._rctx,G=y.Merged;a=this._compMatToDelta(a,b,G);b=this._mat2DataMerged;for(var h in a){var n=a[h],g;for(g in n){var l=n[g],p=l.optimalCount,k=l.material,q=k.getVertexBufferLayout(),u=H.getStride(q)/4,r=b[h];if(null==r){C.assert(0<p);var t=k.renderPriority,r=this._initializeMatData(k);b[h]=r;this._orderedRendering&&this._insertIntoRenderOrder(r,
t,"merged")}t=r.origin2data[g];null==t&&(C.assert(0<p),t={type:G,instances:{},vao:new P(e,S.Default3D,{geometry:q},{geometry:O.createVertex(e,35044)}),buffer:new Z(p),optimalCount:0,origin:l.origin},r.origin2data[g]=t);if(0<p){var q=t.buffer.getSize(),m=t.buffer.getArray(),r=p<l.sparseCount/2,A=t.buffer.resize(r?p:l.sparseCount),x=l.toRemove;if(r||A){for(var q=0,z=t.buffer.getArray(),r=0;r<x.length;++r)A=t.instances[x[r].uniqueName],t.optimalCount-=(A.to-A.from)*u,delete t.instances[x[r].uniqueName];
var r={},B;for(B in t.instances)A=t.instances[B],C.assert(null==r[A.from]),r[A.from]=A;for(var v in r){var A=r[v],w=A.from*u,D=A.to*u;z.set(m.subarray(w,D),q);A.from=q/u;q+=D-w;A.to=q/u}C.assert(q===t.optimalCount)}else for(r=0;r<x.length;++r)A=x[r].uniqueName,C.assert(void 0!==t.instances[A]),w=t.instances[A].from*u,D=t.instances[A].to*u,t.buffer.erase(w,D),delete t.instances[A],t.optimalCount-=D-w;C.setMatrixTranslation3(K,-l.origin[0],-l.origin[1],-l.origin[2]);m=l.toAdd;l=!1;for(r=0;r<m.length;++r)x=
m[r],w=x.data,F.multiply(K,x.transformation,Q),F.inverse(Q,R),F.transpose(R),A=q,k.fillInterleaved(w,Q,R,x.instanceParameters,t.buffer.getArray(),q),w=k.getOutputAmount(M(w)),z=A+w,C.assert(null==t.instances[x.uniqueName]),D=U(x),A=new W(x.name,A/u,z/u,D,void 0,void 0,x.idx),t.instances[x.uniqueName]=A,this._updateHighlightFaceranges(x,A),D&&(l=!0),t.optimalCount+=w,q+=w;C.assert(t.optimalCount===p);p=new Float32Array(t.buffer.getArray().buffer,0,t.buffer.getSize());t.vao.vertexBuffers.geometry.setData(p);
if(l||t.displayedIndexRange)c[this._modifiedMergedFacerangesKey(h,g)]=t}else C.assert(0===p),t.vao.dispose(!0),t.vao=null,delete r.origin2data[g],0===Object.keys(r.origin2data).length&&(d.push(h),delete b[h],this._orderedRendering&&this._removeFromRenderOrder(r,"merged"))}}};e.prototype._modifyInstanced=function(a,b,d){var c=this._rctx,e=y.Instanced;a=this._compMatToDelta(a,b,e);b=this._mat2DataInstanced;for(var G in a){var h=a[G],n;for(n in h){var g=h[n];if(0===g.optimalCount)g=b[G],g.origin2data[n].vao.dispose(!0),
delete g.origin2data[n],0===Object.keys(g.origin2data).length&&(d.push(G),delete b[G],this._orderedRendering&&this._removeFromRenderOrder(g,"instanced"));else{var l=g.material,p=b[G];if(null==p){var k=l.renderPriority,p=this._initializeMatData(l);b[G]=p;this._orderedRendering&&this._insertIntoRenderOrder(p,k,"instanced")}var q=l.getVertexBufferLayout(),u=p[E.MATERIAL].instanced?l.getInstanceBufferLayout():void 0,r=u&&H.findAttribute(u,"instanceColor"),t=u&&H.findAttribute(u,"instanceFeatureAttribute"),
m=H.getStride(q)/4,k=p.origin2data[n];null==k&&(k={type:e,instances:{},vao:new P(c,S.Default3D,{geometry:q},{geometry:O.createVertex(c,35044)}),buffer:new Z(g.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:g.origin},p.origin2data[n]=k);var p=k.buffer.getSize(),A=k.buffer.getArray(),x=g.optimalCount<g.sparseCount/2,z=k.buffer.resize(x?g.optimalCount:g.sparseCount),B;for(B in g.perGeometryDelta){var v=k.perGeometryDataInfo[B];if(v&&v.instanceBufferData){var w=g.perGeometryDelta[B].removeCount;
0<w&&v.instanceBufferData.prepareFree(w)}}var D=g.toRemove;if(x||z){for(x=0;x<D.length;++x){z=D[x];delete k.instances[z.uniqueName];B=z.data.id;var J=v=k.perGeometryDataInfo[B];0===--J.refCount&&null==g.dataId2refCount[B]?(k.optimalCount-=(J.to-J.from)*m,delete k.perGeometryDataInfo[B]):v.instanceBufferData&&v.instanceBufferData.free(z.idx)}var p=0,x=k.buffer.getArray(),z={},I;for(I in k.perGeometryDataInfo)J=k.perGeometryDataInfo[I],C.assert(null==z[J.from]),z[J.from]=J;for(var L in z)J=z[L],w=J.from*
m,v=J.to*m,x.set(A.subarray(w,v),p),J.from=p/m,p+=v-w,J.to=p/m;for(var N in k.instances)w=k.instances[N],w.from=k.perGeometryDataInfo[w.dataId].from,w.to=k.perGeometryDataInfo[w.dataId].to}else for(x=0;x<D.length;++x)z=D[x],delete k.instances[z.uniqueName],B=z.data.id,v=k.perGeometryDataInfo[B],0===--v.refCount&&null==g.dataId2refCount[B]?(w=v.from*m,v=v.to*m,k.buffer.erase(w,v),k.optimalCount-=v-w,delete k.perGeometryDataInfo[B]):v.instanceBufferData&&v.instanceBufferData.free(z.idx);C.setMatrixTranslation3(K,
-g.origin[0],-g.origin[1],-g.origin[2]);for(B in g.perGeometryDelta)(v=k.perGeometryDataInfo[B])&&v.instanceBufferData&&(x=g.perGeometryDelta[B].addCount,0<x&&v.instanceBufferData.prepareAllocate(x));A=g.toAdd;for(x=0;x<A.length;++x)if(z=A[x],w=z.data,B=w.id,v=k.perGeometryDataInfo[B],null==v?(l.fillInterleaved(w,void 0,void 0,void 0,k.buffer.getArray(),p),D=l.getOutputAmount(M(w)),w=p/m,p+=D,v=p/m,k.optimalCount+=D,v={refCount:1,from:w,to:v,vao:null,instanceBufferData:null},u&&(w=H.getStride(u)/
4,v.vao=new P(c,S.Default3D,{geometry:q,instance:u},{geometry:k.vao.vertexBuffers.geometry,instance:O.createVertex(c,35044)}),v.instanceBufferData=new ha(w,g.perGeometryDelta[B].addCount)),k.perGeometryDataInfo[B]=v):++v.refCount,C.assert(v.from*m<=k.buffer.getSize()&&v.to*m<=k.buffer.getSize()),w=F.create(),F.multiply(K,z.transformation,w),D=U(z),w=new W(z.name,v.from,v.to,D,w,z.instanceParameters,z.idx,B),k.instances[z.uniqueName]=w,this._updateHighlightFaceranges(z,w),v=v.instanceBufferData)D=
v.allocate(z.idx),v.fill(D,0,w.transformation),v.fill(D,16,w.transformationNormal),r&&v.fill(D,r.offset/4,z.instanceParameters.color),t&&v.fill(D,t.offset/4,z.instanceParameters.featureAttribute);C.assert(k.optimalCount===g.optimalCount);l=new Float32Array(k.buffer.getArray().buffer,0,k.buffer.getSize());k.vao.vertexBuffers.geometry.setData(l);for(B in k.perGeometryDataInfo)if(q=k.perGeometryDataInfo[B],q.vao&&(l=q.vao.vertexBuffers.instance))u=g.perGeometryDelta[B],0<u.addCount+u.removeCount&&(q=
q.instanceBufferData.compact(),l.setData(q))}}}};e.prototype._modifyPreinterleaved=function(a,b,d){for(var c=this._rctx,e=y.Preinterleaved,m=this._mat2DataPreinterleaved,h=0;h<a.length;h++){var n=a[h],g=n.material,l=g.id,p=n.origin.id,k=n.origin.vec3,q=m[l];null==q&&(q=this._initializeMatData(g),m[l]=q);l=q.origin2data[p];null==l&&(l={type:e,origin:k,count:0,instances:{}},q.origin2data[p]=l);C.setMatrixTranslation3(K,-k[0],-k[1],-k[2]);q=F.create();F.multiply(K,n.transformation,q);k=U(n);p=n.data;
p.preinterleaved?null==p.vertexData?C.assert(!1,"Trying to re-add preinterleaved geometry data which is no longer available."):(q=new W(n.name,0,p.indexCount,k,q,n.instanceParameters,n.idx,p.id),k=p.indexData?O.createIndex(c,35044,p.indexData):null,g=g.getVertexBufferLayout(),g=new P(c,S.Default3D,{geometry:g},{geometry:O.createVertex(c,35044)},k),g.vertexBuffers.geometry.setData(p.vertexData),p.vertexData=null,l.count+=1,l.instances[n.uniqueName]={instance:q,vao:g},this._updateHighlightFaceranges(n,
q)):C.assert(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(a=0;a<b.length;a++)n=b[a],k=n.origin,g=n.material,l=g.id,p=k.id,n=n.uniqueName,q=m[l],c=q.origin2data[p],c.instances[n].vao.dispose(),delete c.instances[n],--c.count,0===c.count&&delete q.origin2data[p],0===Object.keys(q.origin2data).length&&(d.push(l),delete m[l])};e.prototype._compMatToDelta=function(a,b,d){var c={};this._updateMatToDelta(a,!0,d,c);this._updateMatToDelta(b,!1,d,c);return c};e.prototype._updateMatToDelta=
function(a,b,d,c){d=d===y.Instanced;for(var e=0;e<a.length;e++){var m=a[e],h=m.origin,n=m.material,g=n.id,l=d?this._mat2DataInstanced[g]:this._mat2DataMerged[g],l=l&&l.origin2data[h.id],p=c[g];null==p&&(p={},c[g]=p);g=p[h.id];if(null==g){g={optimalCount:null==l?0:l.optimalCount,sparseCount:null==l?0:l.buffer.getSize(),material:n,toAdd:[],toRemove:[],perGeometryDelta:null,origin:h.vec3};if(d){var k={};if(void 0!==l)for(var q in l.perGeometryDataInfo)k[q]=l.perGeometryDataInfo[q].refCount;g.dataId2refCount=
k;g.perGeometryDelta={}}p[h.id]=g}h=n.getOutputAmount(M(m.data));d?(n=m.data.id,l=g.perGeometryDelta[n],l||(l={addCount:0,removeCount:0},g.perGeometryDelta[n]=l),b?(l.addCount++,null==g.dataId2refCount[n]&&(g.dataId2refCount[n]=0),1===++g.dataId2refCount[n]&&(g.optimalCount+=h,g.sparseCount+=h),g.toAdd.push(m)):(l.removeCount++,0===--g.dataId2refCount[n]&&(delete g.dataId2refCount[n],g.optimalCount-=h),g.toRemove.push(m))):b?(g.optimalCount+=h,g.sparseCount+=h,g.toAdd.push(m)):(g.optimalCount-=h,
g.toRemove.push(m))}};e.prototype._getType=function(a){if(a.data.preinterleaved)return y.Preinterleaved;var b=!1,d=M(a.data),b=(b=(b=b||!1===a.material.canBeMerged)||a.material.instanced)||!0===a.material.renderOccluded;a.singleUse||(b=b||d>this._threshold);return b?y.Instanced:y.Merged};e.prototype._getTargetMat2Data=function(a){switch(a){case y.Merged:return this._mat2DataMerged;case y.Instanced:return this._mat2DataInstanced;case y.Preinterleaved:return this._mat2DataPreinterleaved}};e.prototype._getOriginData=
function(a,b,d){return this._getTargetMat2Data(a)[b].origin2data[d]};e.prototype._modifiedMergedFacerangesKey=function(a,b){return a+"_"+b};e.prototype._insertIntoRenderOrder=function(a,b,d){for(var c=a[E.MATERIAL].materialId,e=this._renderOrder.length,m=0;m<e&&this._renderOrder[m][0]>=b;){var h=this._renderOrder[m][1];if(h.id===c){C.assert(!h[d],"matData for type already exists");h[d]=a;return}m++}c={id:c,instanced:null,merged:null};c[d]=a;this._renderOrder.splice(m,0,[b,c])};e.prototype._removeFromRenderOrder=
function(a,b){var d=a[E.MATERIAL].materialId;for(a=0;this._renderOrder[a][1].id!==d;)a++;d=this._renderOrder[a][1];d[b]=null;d.instanced||d.merged||this._renderOrder.splice(a,1)};e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(a,b){a=a.matData[E.MATERIAL].renderPriority;b=b.matData[E.MATERIAL].renderPriority;return a>b?-1:b>a?1:0})};e.prototype._updateRenderOrder=function(a,b){for(var d=b.length,c=0;c<d&&b[c][1].id!==a;)c++;if(c<d){a=b[c][1];a=(a.merged||a.instanced)[E.MATERIAL].renderPriority;
var e=b[c][0];if(a!==b[c][0])for(b[c][0]=a,e=a>e?-1:1,c+=e;-1<c&&c<d&&e*b[c][0]>e*a;){var m=b[c];b[c]=b[c-e];b[c-e]=m;c+=e}}};e.prototype._modifyMaterials=function(a){var b=this;a.forEach(function(a){b._materialRep.updateMaterialParameters(a)})};e.prototype.modifyRenderOrder=function(a){var b=this;this._orderedRendering&&(a.forEach(function(a){b._updateRenderOrder(a,b._renderOrder)}),this._sortHighlightsByRenderOrder(),this._needsRender=!0)};e.prototype._initializeMatData=function(a){var b={origin2data:{}};
b[E.MATERIAL]=this._materialRep.aquire(a);b[E.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(a);b[E.MATERIAL_NORMAL]=this._materialRep.aquireNormal(a);b[E.MATERIAL_DEPTH]=this._materialRep.aquireDepth(a);b[E.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(a);return b};e.prototype._releaseMaterials=function(a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this._materialRep.release(a[b]),this._materialRep.releaseDepthShadowMap(a[b]),this._materialRep.releaseNormal(a[b]),this._materialRep.releaseDepth(a[b]),
this._materialRep.releaseHighlight(a[b]);else this._materialRep.release(a),this._materialRep.releaseDepthShadowMap(a),this._materialRep.releaseNormal(a),this._materialRep.releaseDepth(a),this._materialRep.releaseHighlight(a)};e.prototype._getInstance=function(a){var b=a.uniqueName,d=a.material.id,c=this._getType(a),d=this._getTargetMat2Data(c)[d];if(!d)return null;a=d.origin2data[a.origin.id];if(!a)return null;var e;return(e=a.type===y.Preinterleaved?a.instances[b].instance:a.instances[b])?{type:c,
uniqueName:b,instance:e,matData:d,originData:a,instancedVAO:null,instancedVAOBaseInstance:null}:null};e.prototype._createBaseInstanceVAO=function(a){var b=this._rctx,d=a.instance,c=a.originData;if(a.type===y.Instanced&&c.perGeometryDataInfo){var c=c.perGeometryDataInfo[d.dataId],e=c.instanceBufferData;e&&(c=c.vao,d=e.getSlot(d.idx),a.instancedVAOBaseInstance!==d&&(e=H.setBaseInstanceOffset(c.layout,d),a.instancedVAO=new P(b,c.locations,e,c.vertexBuffers,c.indexBuffer),a.instancedVAOBaseInstance=d))}};
e.prototype._updateHighlightVAOs=function(){for(var a=0;a<this._highlights.length;++a)this._createBaseInstanceVAO(this._highlights[a])};e.prototype._getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new da(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255])));return this._fallbackDepthStencilTexture};return e}();var pa=function(){function e(){this.reset()}e.prototype.reset=
function(){this.VBOusedSize=this.VBOoptimalSize=this.VBOallocatedSize=this.instancesDrawnAngle=this.drawCallsHighlight=this.drawCallsFragmented=this.drawCallsPreinterleaved=this.drawCallsMerged=this.drawCallsAngleInstanced=this.drawCallsInstanced=this.trianglesRendered=0};return e}(),W=function(){return function(e,a,b,d,c,f,m,h){this.name=e;this.from=a;this.to=b;this.displayedIndexRange=d;this.transformation=c;this.instanceParameters=f;this.idx=m;this.dataId=h;null!=c&&(this.transformationNormal=
F.create(),F.set(c,this.transformationNormal),F.inverse(this.transformationNormal,this.transformationNormal),F.transpose(this.transformationNormal,this.transformationNormal))}}(),y;(function(e){e[e.Merged=0]="Merged";e[e.Instanced=1]="Instanced";e[e.Preinterleaved=2]="Preinterleaved"})(y||(y={}));var L=X.create(),K=F.identity(),Q=F.create(),R=F.create();return T});