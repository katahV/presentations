// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/extendsHelper dojo/Deferred dojo/sniff dojo/_base/lang dojo/errors/CancelError ../../../../request ../../../../core/Error ../../../../core/Logger ../../../../core/Version ../../../../geometry/support/aaBoundingBox ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),function(R,n,S,v,A,G,B,H,I,J,C,K,D,L,
M,N,O,P){function E(f){return new I("","Request for object resource failed: "+f)}function p(f,k){var a,b,q=[],h=[],y=[],w=[],F=[],r=C.Version.parse(f.version||"1.0","wosr");Q.validate(r);var r="meshsymbol_"+f.model.name,t=f.textureDefinitions,n={},u;for(u in t){var m=t[u];if(a=m.images[0].data){b=m.encoding+";base64,"+a;a="/textureDefinitions/"+u;var e={noUnpackFlip:!0,wrapClamp:!1};A("enable-feature:jkieboom/alpha-channel-usage")&&(e.wrapClamp=!0);b=new O(b,r,e);F.push(b);n[a]={engineTexObj:b,alphaChannelUsage:"rgba"===
m.channels?m.alphaChannelUsage||"transparency":"none"}}else g.warn("Externally referenced texture data is not yet supported")}u=f.model.geometries;t=f.materialDefinitions;for(m=0;m<u.length;m++){b=e=u[m];var d=b.params,l=d.topology;a=!0;d.vertexAttributes||(g.warn("Geometry must specify vertex attributes"),a=!1);switch(d.topology){case "PerAttributeArray":break;case "Indexed":case null:case void 0:l=d.faces;if(!l)g.warn("Indexed geometries must specify faces"),a=!1;else if(d.vertexAttributes){var c=
void 0;for(c in d.vertexAttributes)(d=l[c])&&d.values?(null!=d.valueType&&"UInt32"!==d.valueType&&(g.warn("Unsupported indexed geometry indices type '"+d.valueType+"', only UInt32 is currently supported"),a=!1),null!=d.valuesPerElement&&1!==d.valuesPerElement&&(g.warn("Unsupported indexed geometry values per element '"+d.valuesPerElement+"', only 1 is currently supported"),a=!1)):(g.warn("Indexed geometry does not specify face indices for '"+c+"' attribute"),a=!1)}break;default:g.warn("Unsupported topology '"+
l+"'"),a=!1}b.params.material||(g.warn("Geometry requires material"),a=!1);b=b.params.vertexAttributes;d=void 0;for(d in b)b[d].values||(g.warn("Geometries with externally defined attributes are not yet supported"),a=!1);if(a){b=e.params;a=b.material;b=b.texture;var l=e.params.vertexAttributes,d={},p;for(p in l)c=l[p],d[p]={data:c.values,size:c.valuesPerElement};y.push([]);l={};if("PerAttributeArray"===e.params.topology){for(var e=d.position.data.length/d.position.size,c=new Uint32Array(e),x=0;x<
e;x++)c[x]=x;var e=c,v;for(v in d)l[v]=e}else{var e=e.params.faces,z;for(z in e)l[z]=new Uint32Array(e[z].values)}e=b?n[b]:null;c=w[a]?w[a][b]:null;c||(c=a.substring(a.lastIndexOf("/")+1),c=t[c].params,1===c.transparency&&(c.transparency=0),c={ambient:c.diffuse,diffuse:c.diffuse,specular:[0,0,0],opacity:1-(c.transparency||0),transparent:0<c.transparency,textureId:e?e.engineTexObj.id:void 0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:c.externalColorMixMode||"tint"},A("enable-feature:jkieboom/alpha-channel-usage")&&
e&&("transparency"===e.alphaChannelUsage||"maskAndTransparency"===e.alphaChannelUsage)&&(c.transparent=!0),k&&k.materialParamsMixin&&G.mixin(c,k.materialParamsMixin),c=new P(c,r),w[a]||(w[a]={}),w[a][b]=c,h.push(c));y[m].push(c);a=new M(new N(d,l),r);q.push(a)}}return{stageResources:{textures:F,materials:h,geometries:q},materialsByComponent:y,pivotOffset:f.model.pivotOffset}}Object.defineProperty(n,"__esModule",{value:!0});var g=J.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),Q=new C.Version(1,
2,"wosr");n.fetch=function(f,k){k=k||{};var a=k.streamDataSupplier;if(a){var b=a.request(f,"json"),q=new v(function(){return a.cancelRequest(b)});b.then(function(a,b){try{var f=p(b,k);return q.resolve(f)}catch(t){return q.reject(t)}},function(a){q.reject(a instanceof B?a:E(a))});return q.promise}var h=H(f),g=new v(function(){return h.cancel()});h.then(function(a){try{var b=p(a.data,k);return g.resolve(b)}catch(r){return g.reject(r)}},function(a){g.reject(a instanceof B?a:E(f))});return g.promise};
n.computeBoundingBox=function(f){f=f.stageResources[L.ModelContentType.GEOMETRY];for(var k=K.empty(),a=[0,0,0],b=[0,0,0],g=0;g<f.length;g++){var h=f[g].getBoundingInfo();D.vec3d.set(h.getBBMin(),a);D.vec3d.set(h.getBBMax(),b);for(h=0;3>h;++h)k[h]=Math.min(k[h],a[h]),k[h+3]=Math.max(k[h+3],b[h])}return k};n.createStageResources=p});