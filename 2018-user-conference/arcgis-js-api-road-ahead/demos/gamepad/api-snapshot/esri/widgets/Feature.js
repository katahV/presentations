// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../core/tsSupport/declareExtendsHelper ../core/tsSupport/decorateHelper dojo/i18n!./Feature/nls/Feature dojo/keys ../core/promiseUtils ../core/watchUtils ../core/accessorSupport/decorators ./Widget ./Feature/FeatureViewModel ./Feature/support/attachmentUtils ./support/uriUtils ./support/widget".split(" "),function(x,D,y,l,p,r,z,A,m,B,t,u,C,d){function f(d,b){return void 0===b?"esri-feature__"+d:"esri-feature__"+d+"-"+b}return function(v){function b(a){a=v.call(this)||this;
a._chartMap=new Map;a._activeMediaMap=new Map;a._chartRequirePromise=null;a._refreshTimers=new Map;a._mediaInfo=new Map;a.contentEnabled=null;a.graphic=null;a.title=null;a.view=null;a.viewModel=new t;return a}y(b,v);b.prototype.postInitialize=function(){var a=this;this.own(A.init(this,"viewModel.content",function(){return a._setupMediaRefreshTimers()}))};b.prototype.destroy=function(){this._clearMediaRefreshTimers();this._activeMediaMap.clear();this._activeMediaMap=null;this._cancelChartModules();
this._destroyCharts()};b.prototype.render=function(){var a=d.tsx("div",{key:f("loading-container"),class:"esri-feature__loading-container"},d.tsx("span",{class:this.classes("esri-icon-loading-indicator esri-rotating","esri-feature__loading-spinner")})),a=this.viewModel.waitingForContent?a:this._renderContent();return d.tsx("div",{class:"esri-feature"},d.tsx("div",{class:"esri-feature__size-container"},d.tsx("div",{class:"esri-feature__main-container"},a)))};b.prototype.goToMedia=function(a,c){this._setContentElementMedia(a,
c)};b.prototype.nextMedia=function(a){this._pageContentElementMedia(a,"next")};b.prototype.previousMedia=function(a){this._pageContentElementMedia(a,"previous")};b.prototype._cancelChartModules=function(){this._chartRequirePromise&&this._chartRequirePromise.cancel()};b.prototype._destroyChart=function(a){var c=this._chartMap.get(a);c&&(c.chart.destroy(),c.tooltip.destroy());this._chartMap.delete(a)};b.prototype._destroyCharts=function(){this._chartMap.forEach(function(a){a.chart.destroy();a.tooltip.destroy()});
this._chartMap.clear()};b.prototype._renderContent=function(){this._destroyCharts();var a=this.viewModel.content;if("string"===typeof a)return d.tsx("div",{key:f("content-string"),innerHTML:a});if(d.isWidget(a))return d.tsx("div",{key:f("content-widget")},a.render());if(a instanceof HTMLElement)return d.tsx("div",{key:f("content-html-element"),bind:a,afterCreate:this._attachToNode});if(d.isWidgetBase(a))return d.tsx("div",{key:f("content-dijit"),bind:a.domNode,afterCreate:this._attachToNode});if(Array.isArray(a))return a.length?
d.tsx("div",{key:f("content-content-elements")},a.map(this._renderContentElement,this)):null};b.prototype._renderContentElement=function(a,c){switch(a.type){case "attachments":return this._renderAttachments(a,c);case "fields":return this._renderFields(a,c);case "media":return this._renderMedia(a,c);case "text":return this._renderText(a,c);default:return null}};b.prototype._renderAttachmentInfo=function(a){var c=a.attachmentInfo,h=a.supportsResizeAttachments,e=c.contentType;a=c.name;var b=c.url,g=
h&&u.isSupportedImage(e),f=-1===b.indexOf("?")?"?":"\x26",e=g?""+b+f+"w\x3d48":u.getIconPath(e),g=(n={},n["esri-feature__attachment-item-mask--icon"]=!g,n),n=(q={},q["esri-feature__attachments-image--resizable"]=h,q);return d.tsx("li",{class:"esri-feature__attachments-item",key:c},d.tsx("a",{class:"esri-feature__attachments-item-link",href:b,target:"_blank"},d.tsx("div",{class:this.classes(g,"esri-feature__attachment-item-mask")},d.tsx("img",{alt:a,class:this.classes(n,"esri-feature__attachments-image"),
title:a,src:e}),d.tsx("span",{class:"esri-feature__attachments-image-overlay"},d.tsx("span",{"aria-hidden":"true",class:"esri-feature__attachments-link-icon esri-icon-link-external"}))),d.tsx("span",{class:"esri-feature__attachments-filename"},a||p.noTitle)));var n,q};b.prototype._renderAttachments=function(a,c){var h=this,e=a.displayType,b=(c=a.attachmentInfos)&&c.length,g=this.get("graphic.layer.capabilities.operations.supportsResizeAttachments"),e=(k={},k["esri-feature__attachments--list"]="preview"!==
e,k["esri-feature__attachments--preview"]="preview"===e,k);return b?d.tsx("div",{key:f("attachments-element"),class:this.classes("esri-feature__attachments","esri-feature__content-element",e)},d.tsx("div",{class:"esri-feature__attachments-title"},p.attach),d.tsx("ul",{class:"esri-feature__attachments-items"},c.map(function(c,e){return h._renderAttachmentInfo({attachmentInfo:c,attachmentInfoIndex:e,supportsResizeAttachments:g,contentElement:a})}))):null;var k};b.prototype._forceLTR=function(a){return"\x26lrm;"+
a};b.prototype._renderFieldInfo=function(a,c){var h=this.viewModel.formattedAttributes,e=h?h.content[c]||h.global:null,b=a.fieldName,h=a.label||b,e=e?null==e[b]?"":e[b]:"";a=!(!a.format||!a.format.dateFormat);e="number"!==typeof e||a?C.autoLink(e):this._forceLTR(e);a=(g={},g["esri-feature__field-data--date"]=a,g);return d.tsx("tr",{key:f("fields-element-info-row",c)},d.tsx("th",{key:f("fields-element-info-row-header",c),class:"esri-feature__field-header",innerHTML:h}),d.tsx("td",{key:f("fields-element-info-row-data",
c),class:this.classes("esri-feature__field-data",a),innerHTML:e}));var g};b.prototype._renderFields=function(a,c){var h=this;return(a=a.fieldInfos)?d.tsx("div",{key:f("fields-element",c),class:this.classes("esri-feature__fields","esri-feature__content-element")},d.tsx("table",{class:"esri-table",summary:p.fieldsSummary,key:f("fields-element-table",c)},d.tsx("tbody",{key:f("fields-element-table-body",c)},a.map(function(a){return h._renderFieldInfo(a,c)})))):null};b.prototype._shouldOpenInNewTab=function(a){void 0===
a&&(a="");return!/^(?:mailto:|tel:)/.test(a.trim().toLowerCase())};b.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach(function(a){return clearTimeout(a)});this._refreshTimers.clear()};b.prototype._clearMediaRefreshTimer=function(a){var c=this._refreshTimers.get(a);c&&(clearTimeout(c),this._refreshTimers.delete(a))};b.prototype._getImageSource=function(a,c){var h=-1!==a.indexOf("?")?"\x26":"?";a=a.split("#");var b=a[1],b=void 0===b?"":b;return""+a[0]+h+"timestamp\x3d"+c+(b?
"#":"")+b};b.prototype._setupMediaRefreshTimer=function(a){var c=this.get("viewModel.content");if(Array.isArray(c)&&(c=c[a])&&"media"===c.type){var h=this._activeMediaMap.get(a);isNaN(h)&&(h=0);(c=c.mediaInfos[h])&&"image"===c.type&&c.refreshInterval&&this._setRefreshTimeout(a,c)}};b.prototype._setupMediaRefreshTimers=function(){var a=this;this._clearMediaRefreshTimers();var c=this.get("viewModel.content");Array.isArray(c)&&c.forEach(function(c,b){return a._setupMediaRefreshTimer(b)})};b.prototype._updateMediaInfoTimestamp=
function(a,c){var b=Date.now();this._mediaInfo.set(c,{timestamp:b,sourceURL:this._getImageSource(a,b)});this.scheduleRender()};b.prototype._setRefreshTimeout=function(a,c){var b=this,d=c.refreshInterval,f=c.value;d&&(c=6E4*d,this._updateMediaInfoTimestamp(f.sourceURL,a),c=setInterval(function(){b._updateMediaInfoTimestamp(f.sourceURL,a)},c),this._refreshTimers.set(a,c))};b.prototype._renderMediaInfoType=function(a,c){var b=a.value,e=a.title,e=void 0===e?"":e,w=a.type,g=a.refreshInterval,k=b.sourceURL,
b=b.linkURL;if("image"===w)return a=this._shouldOpenInNewTab(b)?"_self":"_blank",k=(g=g?this._mediaInfo.get(c):null)?g.sourceURL:k,c=d.tsx("img",{alt:e,key:f("media-image-"+(g?g.timestamp:0),c),src:k}),(e=b?d.tsx("a",{title:e,href:b,target:a},c):null)?e:c;if(-1!==w.indexOf("chart"))return d.tsx("div",{key:f("chart",c),bind:this,"data-media-info":a,"data-content-element-index":c,class:"esri-feature__media-chart",afterCreate:this._getChartDependencies,afterUpdate:this._getChartDependencies})};b.prototype._getChartDependencies=
function(a){var c=this,b=a["data-media-info"],d=a["data-content-element-index"],f=b.value,g=f.theme||"Claro",k=b.type,n=g;"string"===typeof g&&(n=g.replace(/\./g,"/"));this._cancelChartModules();this._chartRequirePromise=z.create(function(a){return x(["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip","dojox/charting/themes/"+n],function(){for(var c=[],b=0;b<arguments.length;b++)c[b]=arguments[b];return a(c)})}).then(function(b){c._renderChart(a,d,k,f,b[0],b[1],b[2]);c._chartRequirePromise=
null})};b.prototype._renderChart=function(a,c,b,d,f,g,k){a=new f(a,{margins:{l:4,t:4,r:4,b:4}});k&&a.setTheme(k);switch(b){case "pie-chart":a.addPlot("default",{type:"Pie",labels:!1});a.addSeries("Series A",d.chartOptions);break;case "line-chart":a.addPlot("default",{type:"Markers"});a.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1});a.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});d.chartOptions.forEach(function(a,c){a.x=c+1});a.addSeries("Series A",d.chartOptions);
break;case "column-chart":a.addPlot("default",{type:"Columns",gap:3});a.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});a.addSeries("Series A",d.chartOptions);break;case "bar-chart":a.addPlot("default",{type:"Bars",gap:3}),a.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),a.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),a.addSeries("Series A",d.chartOptions)}b=new g(a);a.render();this._chartMap.set(c,{chart:a,tooltip:b})};b.prototype._renderMediaInfo=
function(a,c){this._destroyChart(c);var b=this._renderMediaInfoType(a,c),e=a.title?d.tsx("div",{key:f("media-title",c),class:"esri-feature__media-item-title",innerHTML:a.title}):null;a=a.caption?d.tsx("div",{key:f("media-caption",c),class:"esri-feature__media-item-caption",innerHTML:a.caption}):null;return d.tsx("div",{key:f("media-container",c),class:"esri-feature__media-item-container"},d.tsx("div",{key:f("media-item-container",c),class:"esri-feature__media-item"},b),e,a)};b.prototype._renderMediaStatsItem=
function(a,c,b){b="chart"===b?this.classes("esri-feature__media-chart-icon","esri-icon-chart"):this.classes("esri-feature__media-image-icon","esri-icon-media");return d.tsx("li",{class:"esri-feature__media-image-summary"},d.tsx("span",{"aria-hidden":"true",class:b}),d.tsx("span",{class:"esri-feature__media-count","aria-label":a},"("+c+")"))};b.prototype._renderMediaPageButton=function(a,c){var b=(a="previous"===a)?p.previous:p.next,e=a?this.classes("esri-feature__button","esri-feature__media-previous"):
this.classes("esri-feature__button","esri-feature__media-next"),l=a?this.classes("esri-feature__icon","esri-feature__media-previous-icon","esri-icon-left-triangle-arrow"):this.classes("esri-feature__icon","esri-feature__media-next-icon","esri-icon-right-triangle-arrow"),g=a?this.classes("esri-feature__icon","esri-feature__media-previous-icon--rtl","esri-icon-right-triangle-arrow"):this.classes("esri-feature__icon","esri-feature__media-next-icon--rtl","esri-icon-left-triangle-arrow"),k=a?this._previousClick:
this._nextClick;return d.tsx("div",{key:f(a?"previous":"next",c),title:b,tabIndex:0,role:"button",class:e,"data-content-element-index":c,bind:this,onkeydown:k,onclick:k},d.tsx("span",{"aria-hidden":"true",class:l}),d.tsx("span",{"aria-hidden":"true",class:g}),d.tsx("span",{class:"esri-icon-font-fallback-text"},b))};b.prototype._handleMediaKeyup=function(a){var c=a.currentTarget["data-content-element-index"],b=a.keyCode;b===r.LEFT_ARROW&&(a.stopPropagation(),this.previousMedia(c));b===r.RIGHT_ARROW&&
(a.stopPropagation(),this.nextMedia(c))};b.prototype._renderMedia=function(a,c){a=a.mediaInfos;var b=this._getMediaStats(a),e=b.total,l=(g={},g["esri-feature--media-pagination-visible"]=1<b.total,g),g=this._renderMediaStatsItem(p.numImages,b.images,"image"),b=this._renderMediaStatsItem(p.numCharts,b.charts,"chart"),k=this._renderMediaPageButton("previous",c),n=this._renderMediaPageButton("next",c),m=this._activeMediaMap.get(c);isNaN(m)&&(this._activeMediaMap.set(c,0),m=0);return e?d.tsx("div",{key:f("media-element",
c),"data-content-element-index":c,bind:this,onkeyup:this._handleMediaKeyup,class:this.classes("esri-feature__media","esri-feature__content-element",l)},d.tsx("ul",{class:"esri-feature__media-summary"},g,b),d.tsx("div",{key:f("media-element-container",c),class:"esri-feature__media-container"},k,this._renderMediaInfo(a[m],c),n)):null;var g};b.prototype._renderText=function(a,b){return a.text?d.tsx("div",{key:f("text-element",b),innerHTML:a.text,class:this.classes("esri-feature__text","esri-feature__content-element")}):
null};b.prototype._attachToNode=function(a){a.appendChild(this)};b.prototype._getMediaStats=function(a){var b=0,d=0;a.forEach(function(a){a=a.type;"image"===a?b++:-1!==a.indexOf("chart")&&d++});return{total:d+b,images:b,charts:d}};b.prototype._setContentElementMedia=function(a,b){this._clearMediaRefreshTimer(a);var c=this.viewModel.content;(c=(c=c&&c[a])&&c.mediaInfos)&&c.length&&(this._activeMediaMap.set(a,(b+c.length)%c.length),this._setupMediaRefreshTimer(a),this.scheduleRender())};b.prototype._pageContentElementMedia=
function(a,b){b="previous"===b?-1:1;b=this._activeMediaMap.get(a)+b;this._setContentElementMedia(a,b)};b.prototype._previousClick=function(a){this.previousMedia(a.currentTarget["data-content-element-index"])};b.prototype._nextClick=function(a){this.nextMedia(a.currentTarget["data-content-element-index"])};l([m.aliasOf("viewModel.contentEnabled")],b.prototype,"contentEnabled",void 0);l([m.aliasOf("viewModel.graphic")],b.prototype,"graphic",void 0);l([m.aliasOf("viewModel.title")],b.prototype,"title",
void 0);l([m.aliasOf("viewModel.view")],b.prototype,"view",void 0);l([m.property({type:t}),d.renderable(["viewModel.waitingForContent","viewModel.content"])],b.prototype,"viewModel",void 0);l([d.accessibleHandler()],b.prototype,"_previousClick",null);l([d.accessibleHandler()],b.prototype,"_nextClick",null);return b=l([m.subclass("esri.widgets.Feature")],b)}(m.declared(B))});