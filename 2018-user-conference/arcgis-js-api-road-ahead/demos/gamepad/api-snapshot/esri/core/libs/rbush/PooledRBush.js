// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../PooledArray","../quickselect/quickselect"],function(z,A,v,I){function n(b,a){t(b,0,b.children.length,a,b)}function t(b,a,c,d,e){e||(e=q(null,!0));e.minX=Infinity;e.minY=Infinity;e.maxX=-Infinity;e.maxY=-Infinity;for(var f=void 0;a<c;a++)f=b.children[a],u(e,b.leaf?d(f):f);return e}function u(b,a){b.minX=Math.min(b.minX,a.minX);b.minY=Math.min(b.minY,a.minY);b.maxX=Math.max(b.maxX,a.maxX);b.maxY=Math.max(b.maxY,a.maxY);return b}function F(b,a){return b.minX-a.minX}
function G(b,a){return b.minY-a.minY}function B(b){return(b.maxX-b.minX)*(b.maxY-b.minY)}function w(b){return b.maxX-b.minX+(b.maxY-b.minY)}function C(b,a){return b.minX<=a.minX&&b.minY<=a.minY&&a.maxX<=b.maxX&&a.maxY<=b.maxY}function x(b,a){return a.minX<=b.maxX&&a.minY<=b.maxY&&a.maxX>=b.minX&&a.maxY>=b.minY}function q(b,a){return{children:b,height:1,leaf:a,minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity}}function H(b,a,c,d,e){for(var f=[a,c];f.length;)if(c=f.pop(),a=f.pop(),!(c-a<=d)){var l=
a+Math.ceil((c-a)/d/2)*d;I(b,l,a,c,e);f.push(a,l,l,c)}}Object.defineProperty(A,"__esModule",{value:!0});z=function(){function b(a,c){void 0===a&&(a=9);this.compareMinX=F;this.compareMinY=G;this.toBBox=function(a){return a};this._maxEntries=Math.max(4,a||9);this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries));c&&this._initFormat(c);this.clear()}b.prototype.all=function(a){this._all(this.data,a)};b.prototype.search=function(a,c){var d=this.data,b=this.toBBox;if(x(a,d))for(r.clear();d;){for(var f=
0,l=d.children.length;f<l;f++){var g=d.children[f],h=d.leaf?b(g):g;x(a,h)&&(d.leaf?c(g):C(a,h)?this._all(g,c):r.push(g))}d=r.pop()}};b.prototype.collides=function(a){var c=this.data,d=this.toBBox;if(!x(a,c))return!1;for(r.clear();c;){for(var b=0,f=c.children.length;b<f;b++){var l=c.children[b],g=c.leaf?d(l):l;if(x(a,g)){if(c.leaf||C(a,g))return!0;r.push(l)}}c=r.pop()}return!1};b.prototype.load=function(a){if(!a||!a.length)return this;if(a.length<this._minEntries){for(var c=0,d=a.length;c<d;c++)this.insert(a[c]);
return this}a=this._build(a.slice(),0,a.length-1,0);this.data.children.length?this.data.height===a.height?this._splitRoot(this.data,a):(this.data.height<a.height&&(c=this.data,this.data=a,a=c),this._insert(a,this.data.height-a.height-1,!0)):this.data=a;return this};b.prototype.insert=function(a){a&&this._insert(a,this.data.height-1);return this};b.prototype.clear=function(){this.data=q([],!0);return this};b.prototype.remove=function(a,c){if(!a)return this;var d=this.data,b,f,l,g,h=this.toBBox(a);
k.clear();for(D.clear();d||k.length;){d||(d=k.pop(),b=k.data[k.length-1],f=D.pop(),l=!0);if(d.leaf){a:{g=a;var m=d.children,p=c;if(p){for(var y=0;y<m.length;y++)if(p(g,m[y])){g=y;break a}g=-1}else g=m.indexOf(g)}if(-1!==g){d.children.splice(g,1);k.push(d);this._condense(k);break}}l||d.leaf||!C(d,h)?b?(f++,d=b.children[f],l=!1):d=null:(k.push(d),D.push(f),f=0,b=d,d=d.children[0])}return this};b.prototype.toJSON=function(){return this.data};b.prototype.fromJSON=function(a){this.data=a;return this};
b.prototype._all=function(a,c){for(E.clear();a;){if(!0===a.leaf){var d=0;for(a=a.children;d<a.length;d++)c(a[d])}else E.pushArray(a.children);a=E.pop()}};b.prototype._build=function(a,c,d,b){var f=d-c+1,e=this._maxEntries,g;if(f<=e)return g=q(a.slice(c,d+1),!0),n(g,this.toBBox),g;b||(b=Math.ceil(Math.log(f)/Math.log(e)),e=Math.ceil(f/Math.pow(e,b-1)));g=q([],!1);g.height=b;f=Math.ceil(f/e);e=f*Math.ceil(Math.sqrt(e));for(H(a,c,d,e,this.compareMinX);c<=d;c+=e){var h=Math.min(c+e-1,d);H(a,c,h,f,this.compareMinY);
for(var m=c;m<=h;m+=f)g.children.push(this._build(a,m,Math.min(m+f-1,h),b-1))}n(g,this.toBBox);return g};b.prototype._chooseSubtree=function(a,c,b,e){for(;;){e.push(c);if(!0===c.leaf||e.length-1===b)break;for(var d=Infinity,l=Infinity,g=void 0,h=0,m=c.children.length;h<m;h++){var p=c.children[h],k=B(p),n=(Math.max(p.maxX,a.maxX)-Math.min(p.minX,a.minX))*(Math.max(p.maxY,a.maxY)-Math.min(p.minY,a.minY))-k;n<l?(l=n,d=k<d?k:d,g=p):n===l&&k<d&&(d=k,g=p)}c=g||c.children[0]}return c};b.prototype._insert=
function(a,c,b){var d=this.toBBox;b=b?a:d(a);k.clear();d=this._chooseSubtree(b,this.data,c,k);d.children.push(a);for(u(d,b);0<=c;)if(k.data[c].children.length>this._maxEntries)this._split(k,c),c--;else break;this._adjustParentBBoxes(b,k,c)};b.prototype._split=function(a,b){var c=a.data[b],e=c.children.length,f=this._minEntries;this._chooseSplitAxis(c,f,e);e=this._chooseSplitIndex(c,f,e);e=q(c.children.splice(e,c.children.length-e),c.leaf);e.height=c.height;n(c,this.toBBox);n(e,this.toBBox);b?a.data[b-
1].children.push(e):this._splitRoot(c,e)};b.prototype._splitRoot=function(a,b){this.data=q([a,b],!1);this.data.height=a.height+1;n(this.data,this.toBBox)};b.prototype._chooseSplitIndex=function(a,b,d){var c,f,l;c=f=Infinity;for(var g=b;g<=d-b;g++){var h=t(a,0,g,this.toBBox),m=t(a,g,d,this.toBBox),k;k=Math.max(0,Math.min(h.maxX,m.maxX)-Math.max(h.minX,m.minX))*Math.max(0,Math.min(h.maxY,m.maxY)-Math.max(h.minY,m.minY));h=B(h)+B(m);k<c?(c=k,l=g,f=h<f?h:f):k===c&&h<f&&(f=h,l=g)}return l};b.prototype._chooseSplitAxis=
function(a,b,d){var c=a.leaf?this.compareMinX:F,f=a.leaf?this.compareMinY:G,l=this._allDistMargin(a,b,d,c);b=this._allDistMargin(a,b,d,f);l<b&&a.children.sort(c)};b.prototype._allDistMargin=function(a,b,d,e){a.children.sort(e);e=this.toBBox;for(var c=t(a,0,b,e),l=t(a,d-b,d,e),g=w(c)+w(l),h=b;h<d-b;h++){var k=a.children[h];u(c,a.leaf?e(k):k);g+=w(c)}for(h=d-b-1;h>=b;h--)k=a.children[h],u(l,a.leaf?e(k):k),g+=w(l);return g};b.prototype._adjustParentBBoxes=function(a,b,d){for(;0<=d;d--)u(b.data[d],a)};
b.prototype._condense=function(a){for(var b=a.length-1,d=void 0;0<=b;b--)0===a.data[b].children.length?0<b?(d=a.data[b-1].children,d.splice(d.indexOf(a.data[b]),1)):this.clear():n(a.data[b],this.toBBox)};b.prototype._initFormat=function(a){var b=["return a"," - b",";"];this.compareMinX=new Function("a","b",b.join(a[0]));this.compareMinY=new Function("a","b",b.join(a[1]));this.toBBox=new Function("a","return {minX: a"+a[0]+", minY: a"+a[1]+", maxX: a"+a[2]+", maxY: a"+a[3]+"};")};return b}();A.PooledRBush=
z;var r=new v(50),E=new v(50),k=new v(10),D=new v(10);A.default=z});