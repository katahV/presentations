// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","dojo/Deferred","./Queue","./scheduling"],function(m,n,h,k,l){var f={};return function(){function b(a){this._apiPromises=new Map;this._processingItems=new Map;this._isPaused=!1;this._scheduledNextHandle=null;this.concurrency=1;this.ordered=!1;a.concurrency&&(this.concurrency=a.concurrency);this.ordered=!!a.ordered;this._queue=new k(a.peeker?{peeker:a.peeker}:void 0);this.process=a.process}Object.defineProperty(b.prototype,"length",{get:function(){return this._processingItems.size+
this._queue.length},enumerable:!0,configurable:!0});b.prototype.clear=function(){this._queue.clear();var a=[];this._processingItems.forEach(function(c){return a.push(c.resultPromise)});this._processingItems.clear();a.forEach(function(a){return a.cancel()});a.length=0;this._apiPromises.forEach(function(c){return a.push(c)});this._apiPromises.clear();a.forEach(function(a){return a.cancel()});this._cancelNext()};b.prototype.find=function(a,c){var b=this,e=void 0;this._apiPromises.forEach(function(d,
g){a.call(c,g)&&(e=b._apiPromises.get(g).promise)});return e};b.prototype.has=function(a){return this._apiPromises.has(a)};b.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())};b.prototype.push=function(a){var c=this;if(this._apiPromises.has(a))return this._apiPromises.get(a).promise;var b=new h(function(b){var d=c._processingItems.get(a);d?d.resultPromise.cancel(b):(c._remove(a),c._scheduleNext())});this._add(a,b);this._scheduleNext();return b.promise};b.prototype.reset=
function(){var a=[];this._processingItems.forEach(function(c){return a.push(c)});this._processingItems.clear();for(var c=0;c<a.length;c++){var b=a[c];b.resultPromise.isFulfilled()?this._processReset(b):b.resultPromise.cancel(f)}};b.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())};b.prototype._scheduleNext=function(){var a=this;this._isPaused||this._scheduledNextHandle||(this._scheduledNextHandle=l.schedule(function(){a._scheduledNextHandle=null;a._next()}))};b.prototype._next=
function(){for(;0<this._queue.length&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())};b.prototype._processResult=function(a,c){this._remove(a.item);this._scheduleNext();a.dfd.resolve(c)};b.prototype._processError=function(a,c){c===f?this._processReset(a):(this._remove(a.item),this._scheduleNext(),a.dfd.reject(c))};b.prototype._processReset=function(a){this._remove(a.item);this._add(a.item,a.dfd);this._scheduleNext()};b.prototype._processOrdered=function(a,c){var b=this,
e=!1;if(!1===c.ok&&c.error===f)this._processReset(a);else{a.result=c;this._itemsToProcess||(this._itemsToProcess=[]);this._processingItems.forEach(function(a){e||(a.result?b._itemsToProcess.push(a):e=!0)});a=0;for(c=this._itemsToProcess;a<c.length;a++){var d=c[a];!1===d.result.ok?this._processError(d,d.result.error):this._processResult(d,d.result.value)}this._itemsToProcess.length=0}};b.prototype._process=function(a){var c=this;if(null!=a){var b=this._apiPromises.get(a),e=this.process(a);if(e&&"function"===
typeof e.then){var d={item:a,resultPromise:e,result:null,dfd:b};this._processingItems.set(a,d);this.ordered?e.then(function(a){return c._processOrdered(d,{ok:!0,value:a})},function(a){return c._processOrdered(d,{ok:!1,error:a})}):e.then(function(a){return c._processResult(d,a)},function(a){return c._processError(d,a)})}else b.resolve(e),this._remove(a);this._scheduleNext()}};b.prototype._add=function(a,b){this._apiPromises.set(a,b);this._queue.push(a)};b.prototype._remove=function(a){this._queue.remove(a);
this._apiPromises.delete(a);this._processingItems.delete(a)};b.prototype._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)};return b}()});