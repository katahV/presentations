// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports @dojo/shim/array @dojo/shim/iterator @dojo/shim/Map @dojo/shim/Set ../../../geometry ../../../core/Error ../../../core/promiseUtils ../../../core/libs/rbush/rbush ../../../geometry/projection ../../../geometry/support/normalizeUtils ../../../geometry/support/scaleUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./FeatureSetReader ./FeatureStoreCapabilities ./FeatureStoreItem ./FeatureStoreResult ./projectionSupport ./SpatialQueryCache ./spatialQuerySupport ../../../tasks/support/Query".split(" "),
function(y,z,E,t,A,B,F,p,l,G,H,I,w,J,x,K,L,M,u,q,N,n,v){function C(d){return d?JSON.parse(JSON.stringify(d,["latestWkid","wkid","wkt"])):d}Object.defineProperty(z,"__esModule",{value:!0});var O=new B.default(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"]),r={},D=new F.SpatialReference({wkid:4326});y=function(){function d(a){var c=this;this._itemsMap=new A.default;this._itemsToIndex=new B.default;this._index=G(9,[".bounds[0]",".bounds[1]",
".bounds[2]",".bounds[3]"]);this.capabilities={query:L.queryCapabilities};this.fieldsMap=new A.default;this.geometryType=a.geometryType;this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.cacheSpatialQueries=a.cacheSpatialQueries||!1;this.gdbVersion=a.gdbVersion;this.historicMoment=a.historicMoment;this.cacheSpatialQueries&&(this._geometryQueryCache=new N.default);a.fields.forEach(function(a){c.fieldsMap.set(a.name.trim(),
a);c.fieldsMap.set(a.name.trim().toLowerCase(),a)})}d.prototype.destroy=function(){this.clear();this.fieldsMap.clear()};d.prototype.clear=function(){this._itemsMap.clear();this._itemsToIndex.clear();this._index.clear();this._geometryQueryCache&&this._geometryQueryCache.clear()};Object.defineProperty(d.prototype,"size",{get:function(){return this._itemsMap.size},enumerable:!0,configurable:!0});d.prototype.load=function(a,c){var b="getBounds"in a?a:K.createFeatureSetReader(a),f=this._itemsMap,h=this._itemsToIndex;
this._clearCache();t.forOf(b.oids(),function(a){var e;f.has(a)?(e=f.get(a),e.count++,c&&c.update(a)):(e=new M.default(b,a),f.set(a,e),h.add(a),c&&c.add(a))})};d.prototype.unload=function(a,c){var b=this._index,f=this._itemsMap,h=this._itemsToIndex;this._clearCache();t.forOf(a.oids(),function(a){var e;f.has(a)&&(e=f.get(a),e.count--,0===e.count&&(f.delete(a),e.bounds?(b.remove(e),e.bounds=null):h.delete(a),c&&c.remove(a)))})};d.prototype.keep=function(a,c){var b=this._index,f=this._itemsMap,h=this._itemsToIndex;
this._clearCache();t.forOf(f,function(e){var g=e[0];e=e[1];a.has(g)||(f.delete(g),e.bounds?(b.remove(e),e.bounds=null):h.delete(g),c&&c.remove(g))})};d.prototype.remove=function(a,c){var b=this._index,f=this._itemsMap,h=this._itemsToIndex;this._clearCache();for(var e=0;e<a.length;e++){var g=a[e];if(!f.has(g))break;var d=f.get(g);f.delete(g);d.bounds?(b.remove(d),d.bounds=null):h.delete(g);c&&c.remove(g)}};d.prototype.executeQuery=function(a){var c=this;void 0===a&&(a=new v);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).catch(function(a){if(a===
r)return new u.default([],c);throw a;}).then(function(a){return a.createQueryResponse(b)})};d.prototype.executeQueryForCount=function(a){var c=this;void 0===a&&(a=new v);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){return a.size}).catch(function(a){if(a===r)return 0;throw a;
})};d.prototype.executeQueryForExtent=function(a){var c=this;void 0===a&&(a=new v);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){var f=a.items.length;if(!f)return{count:f,extent:null};for(var e={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,
ymax:Number.NEGATIVE_INFINITY,spatialReference:C(c.spatialReference)},d=0,m=a.items;d<m.length;d++){var k=m[d].getBounds();k&&(e.xmin=Math.min(k[0],e.xmin),e.ymin=Math.min(k[1],e.ymin),e.xmax=Math.max(k[2],e.xmax),e.ymax=Math.max(k[3],e.ymax))}a=q.project(e,a.spatialReference,b.outSpatialReference);a.spatialReference=C(b.outSpatialReference&&b.outSpatialReference.toJSON()||c.spatialReference);0===a.xmax-a.xmin&&(e=w.getMetersPerUnitForSR(a.spatialReference),a.xmin-=e,a.xmax+=e);0===a.ymax-a.ymin&&
(e=w.getMetersPerUnitForSR(a.spatialReference),a.ymin-=e,a.ymax+=e);return{count:f,extent:a}}).catch(function(a){if(a===r)return{count:0,extent:null};throw a;})};d.prototype.executeQueryForIds=function(a){var c=this;void 0===a&&(a=new v);var b=a.clone();return this._normalizeQuery(b).then(function(a){return c._checkQuerySupport(a)}).then(function(a){return c._executeGeometryQuery(a)}).then(function(a){return a.executeObjectIdsQuery(b)}).then(function(a){return a.executeAttributesQuery(b)}).then(function(a){a=
a.items;for(var b=[],c=0;c<a.length;c++)b[c]=a[c].oid;return b}).catch(function(a){if(a===r)return[];throw a;})};d.prototype._clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._allItems=null};d.prototype._getAll=function(){this._allItems||(this._allItems=new u.default(E.from(this._itemsMap,function(a){return a[1]}),this));return this._allItems};d.prototype._normalizeQuery=function(a){var c=this,b=this.definitionExpression,f=a.where,d=a.geometry,e=a.outFields,g=
a.orderByFields,m=a.groupByFieldsForStatistics,k=a.outStatistics;a.where=f=f&&f.trim();if(!f||/^1 *= *1$/.test(f)||b&&b===f)a.where=null;if(e)for(b=0;b<e.length;b++)e[b]=e[b].trim();if(g)for(b=0;b<g.length;b++)g[b]=g[b].trim();if(m)for(b=0;b<m.length;b++)m[b]=m[b].trim();if(k)for(b=0;b<k.length;b++)k[b].onStatisticField=k[b].onStatisticField.trim();if(!d)return l.resolve(a);a.outSpatialReference||(a.outSpatialReference=d.spatialReference);return this._getInputGeometry(a).then(function(b){return a.geometry=
b}).then(function(b){return q.checkProjectionSupport(a,b.spatialReference,c.spatialReference)}).then(function(){return I.normalizeCentralMeridian(a.geometry)}).then(function(a){return q.project(a[0].toJSON(),a[0].spatialReference,c.spatialReference)}).then(function(b){if(!b)throw r;return a.read({geometry:b})})};d.prototype._executeGeometryQuery=function(a){var c=this,b=a.geometry,f=a.outSpatialReference,d=a.spatialRelationship,e=f&&!J.equals(this.spatialReference,f),g=e?JSON.stringify({geometry:b,
spatialRelationship:d,outSpatialReference:f}):JSON.stringify({geometry:b,spatialRelationship:d});if(this.cacheSpatialQueries&&this._geometryQueryCache.size&&this._geometryQueryCache.has(g))return l.resolve(this._geometryQueryCache.get(g));var m=null;if(b){this._updateSpatialIndex();var k=this._getQueryBBoxes(b).reduce(function(a,b){return a.concat(c._index.search({minX:b[0],minY:b[1],maxX:b[2],maxY:b[3]}))},[]),m="envelope-intersects"===a.spatialRelationship||"esriGeometryPoint"===this.geometryType&&
n.canQueryWithRBush(b)?l.resolve(new u.default(k,this)):n.getSpatialQueryOperator(d,b,this.geometryType).then(function(a){if(a){var b=k.filter(function(b){return a(b.getGeometry())});return new u.default(b,c)}})}else m=l.resolve(this._getAll());return m.then(function(b){if(e&&(a.returnGeometry||a.returnCentroid))return b.project(f).then(function(a){c.cacheSpatialQueries&&c._geometryQueryCache.set(g,a);return a});c.cacheSpatialQueries&&c._geometryQueryCache.set(g,b);return b})};d.prototype._getInputGeometry=
function(a){var c=a.geometry,b=a.distance,d=a.units;if(null==b)return l.resolve(c);var h=c.spatialReference,e=d||w.getUnitString(h),d=null,d=h&&(h.isGeographic||h.isWebMercator)?l.resolve(c):q.checkProjectionSupport(a,h,D).then(function(){return H.project(c,D)});return d.then(function(a){return n.getGeodesicBufferOperator().then(function(c){return c(a,b,e)})}).catch(function(a){return n.getBufferOperator().then(function(a){return a(c,b,e)})})};d.prototype._updateSpatialIndex=function(){var a=this;
if(this._itemsToIndex.size){var c=[];t.forOf(this._itemsToIndex,function(b){b=a._itemsMap.get(b);b.getBounds()&&c.push(b)});this._index.load(c);this._itemsToIndex.clear()}};d.prototype._getQueryBBoxes=function(a){if("point"===a.type)return[[a.x,a.y,a.x,a.y]];a=n.canQueryWithRBush(a)?a:a.extent;switch(a.type){case "extent":return[[a.xmin,a.ymin,a.xmax,a.ymax]];case "polygon":return a.rings.map(function(a){return[a[0][0],a[0][1],a[2][0],a[2][1]]})}};d.prototype._checkQuerySupport=function(a){return 0>
a.distance||null!=a.geometryPrecision||null!=a.maxAllowableOffset||a.multipatchOption||a.orderByFields&&a.orderByFields.length||a.pixelSize||a.relationParameter||a.text||a.timeExtent?l.reject(new p("feature-store:unsupported-query","Unsupported query options",{query:a})):l.all([this._checkAttributesQuerySupport(a),this._checkStatisticsQuerySupport(a),n.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),q.checkProjectionSupport(a,this.spatialReference,a.outSpatialReference)]).then(function(){return a})};
d.prototype._checkAttributesQuerySupport=function(a){var c=a.outFields;if(c&&0<c.length&&(c=x.getMissingFields(this.fieldsMap,c),c.length))throw new p("feature-store:unsupported-query","outFields contains missing fields",{missingFields:c,query:a});x.validateWhere(this.fieldsMap,a.where)};d.prototype._checkStatisticsQuerySupport=function(a){if(a.returnDistinctValues)return l.reject(new p("feature-store:unsupported-query","query with returnDistinctValues not supported",{query:a}));if(a.outStatistics&&
a.outStatistics.length){var c=a.outStatistics.map(function(a){return a.onStatisticField.trim()}),b=x.getMissingFields(this.fieldsMap,c);if(b.length)return l.reject(new p("feature-store:unsupported-query","outStatistics contains missing fields",{missingFields:b,query:a}));for(b=0;b<c.length;b++){var d=c[b],h=this.fieldsMap.get(d);if(!(a.groupByFieldsForStatistics&&a.groupByFieldsForStatistics.length||O.has(h.type)))return l.reject(new p("feature-store:unsupported-query","outStatistics contains non-numeric fields",
{fieldName:d,query:a}))}}};return d}();z.default=y});