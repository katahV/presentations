// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/tsSupport/declareExtendsHelper ../../../core/tsSupport/decorateHelper dojo/has dojo/errors/CancelError dojo/promise/all ../../../core/Accessor ../../../core/arrayUtils ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/PooledArray ../../../core/Promise ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/sql/WhereClause ../../../geometry/support/aaBoundingBox ../../../layers/IntegratedMeshLayer ../../../layers/SceneLayer ../../../views/3d/layers/SceneLayerView3D ../../../views/3d/layers/i3s/I3SIndex ../../../views/3d/layers/i3s/I3SLodHandling ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SViewportQueries ../../../views/3d/layers/i3s/IdleQueue ../../../views/3d/lib/glMatrix ../../../views/3d/support/projectionUtils ../../../views/3d/support/PromiseLightweight ../../../views/3d/support/ResourceController".split(" "),
function(l,T,C,e,t,u,D,E,x,F,G,H,I,J,y,v,d,K,L,z,p,A,M,N,q,m,O,P,g,Q,R,S){function B(d,c){return d.length===c.length&&d.every(function(a){return 0<=w(c,a.name)})}function w(d,c){c=c.toLowerCase();for(var a=0;a<d.length;a++)if(d[a].name.toLowerCase()===c)return a;return-1}var h=H.getLogger("esri.layers.graphics.controllers.I3SOnDemandController");l=function(l){function c(a){a=l.call(this)||this;a.nodeIndex={};a.screenSizeFactor=0;a.updating=!0;a.updatingPercentage=0;a._lodFactorProperty=null;a._lodTargetFactor=
1;a._isIdle=!1;a._cameraDirty=!0;a._hasFeatures=!1;a._alwaysLoadEverythingModeEnabled=!1;a._uncompressedTextureDownsamplingEnabled=!1;a._processLambda=null;a._featureTarget=5E4;a._featureMargin=1.5;a._loadingNodes=new Map;a._updatingNodes=new Map;a._progressMaxNumNodes=1;a._poi=null;a._requiredAttributesDirty=!0;a._updatesDisabled=!1;a.disableCache=!1;a._restartNodeLoading=!1;a._fields=null;a._attributeStorageInfo=null;a._handles=new G;a._idleQueue=new P.IdleQueue;a._errorCount=0;return a}C(c,l);
Object.defineProperty(c.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.getStreamDataSupplier(S.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"parsedDefinitionExpression",{get:function(){if(this.layer instanceof p&&
this.layer.definitionExpression)try{var a=K.create(this.layer.definitionExpression);if(!a.isStandardized())return h.error("definitionExpression is using non standard function"),null;var b=[],c=a.getFields();m.findFieldsCaseInsensitive(c,this.layer.fields,{missingFields:b});return 0<b.length?(h.error("definitionExpression references unknown fields: "+b.join(", ")),null):a}catch(f){return h.error("Failed to parse definitionExpression: "+f),null}else return null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"definitionExpressionFields",{get:function(){if(this.parsedDefinitionExpression){var a=this.parsedDefinitionExpression.getFields();return m.findFieldsCaseInsensitive(a,this._fields)}return null},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"crsVertex",{get:function(){return m.getVertexCrs(this.layer)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,"crsIndex",{get:function(){return m.getIndexCrs(this.layer)},enumerable:!0,configurable:!0});Object.defineProperty(c.prototype,
"rootNodeVisible",{get:function(){var a=this._rootNodeId&&this.nodeIndex[this._rootNodeId];return a&&this._viewportQueries?this._viewportQueries.isNodeVisible(a):!0},enumerable:!0,configurable:!0});c.prototype.initialize=function(){var a=this;this.updateEventListener={needsUpdate:function(){return a._needsAnimationFrameHandler()},idleFrame:function(b){return a._processLogError(b)},idleBegin:function(){a._updateIdleState(!0)},idleEnd:function(){a._updateIdleState(!1)}};this.updateEventListenerWhileSuspended=
{idleBegin:function(){return a._startNodeLoadingWhileSuspended()}};this._lodHandling=new N(this.layerViewRequiredFunctions,this.layerViewOptionalFunctions,function(){return a.updatingChanged()});this.layerView._controller=this;var b=this.layer;this._defaultGeometrySchema=b.store.defaultGeometrySchema;this._rootNodeUrl=b.store.rootNode;var c=this._rootNodeUrl.split("/");this._rootNodeId=c[c.length-1];this.disableCache=t("disable-feature:idb-cache");b instanceof p?("mesh"===b.geometryType?this._lodFactorProperty=
"qualitySettings.sceneService.3dObject.lodFactor":"point"===b.geometryType&&(this._lodFactorProperty="qualitySettings.sceneService.point.lodFactor"),this._fields=b.fields,this._attributeStorageInfo=b.attributeStorageInfo):b instanceof z&&(this._lodFactorProperty="qualitySettings.sceneService.integratedMesh.lodFactor");b=D([this.layer.when(),this.layerView.when()]).then(function(){if(!a.destroyed&&a.layerView&&!a.layerView.destroyed){var b=a.layerView.view;a.setClippingArea(b.clippingArea);a._centerOnSurface=
b.pointsOfInterest.centerOnSurfaceFrequent;a._handles.add(a._centerOnSurface.watch("renderLocation",function(){return a._pointOfInterestChanged()}));var c=a.layerView.view.resourceController;c.memoryEvents.on("quality-changed",function(){return a._setCameraDirty()});var k=!1;a._processLambda=a._frame.bind(a);a._handles.add(v.init(a.layerView,"suspended",function(b){k&&(c.deregisterIdleFrameWorker(a),a.restartNodeLoading());b?(c.registerIdleFrameWorker(a,a.updateEventListenerWhileSuspended),c.deregisterFrameWorker(a._processLambda)):
(c.registerIdleFrameWorker(a,a.updateEventListener),c.registerFrameWorker(a._processLambda));k=!0}),"layerview");a._handles.add(a.layer.watch("elevationInfo",function(b){return a._elevationInfoChanged(b)}),"layer");a.layerView instanceof A&&a._handles.add([v.init(a.layerView,"alwaysLoadEverythingModeEnabled",function(b){a._alwaysLoadEverythingModeEnabled=b;a.restartNodeLoading()}),v.init(a.layerView,"uncompressedTextureDownsamplingEnabled",function(b){a._uncompressedTextureDownsamplingEnabled=b;a.restartNodeLoading()})],
"layer");a._handles.add(b.state.watch("camera",function(){return a._setCameraDirty()}));a._lodFactorProperty&&a._handles.add(a.layerView.view.watch(a._lodFactorProperty,function(){return a._setCameraDirty()}),"quality")}});this.addResolvingPromise(b);this.when(function(){return a._startNodeLoading()})};c.prototype.destroy=function(){this.layerView.view.resourceController.deregisterIdleFrameWorker(this);this.layerView.view.resourceController.deregisterFrameWorker(this._processLambda);this._handles.destroy();
this._nodeLoader=null};c.prototype._getRequiredAttributes=function(){if(!(null!=this._attributeStorageInfo&&this.layer instanceof p&&this._fields))return[];var a=Object.create(null);this.layer.renderer&&this.layer.renderer.collectRequiredFields(a);this.layer.labelsVisible&&this.layer.labelingInfo&&this.layer.labelingInfo.forEach(function(b){b._collectRequiredFields(a)});if(null!=this.definitionExpressionFields)for(var b=0,c=this.definitionExpressionFields;b<c.length;b++)a[c[b]]=!0;var f=this._attributeStorageInfo,
d=this._fields,e=this.layer.objectIdField;return Object.keys(a).map(function(a){var b=w(f,a);a=w(d,a);return 0<=b&&0<=a?{index:b,name:d[a].name,field:d[a],attributeStorageInfo:f[b]}:null}).filter(function(a){return null!=a&&a.name!==e}).sort(function(a,b){return b.index-a.index}).filter(function(a,b,c){return 0===b||c[b-1].index!==a.index})};c.prototype._requiredFieldsChange=function(){this._requiredAttributesDirty=!0;this.restartNodeLoading()};c.prototype._labelingChanged=function(){var a=this._requiredAttributes,
b=this._getRequiredAttributes();B(a,b)||this._requiredFieldsChange()};c.prototype.setClippingArea=function(a){var b=L.create();Q.extentToBoundingBox(a,b,this.layerView.view.renderSpatialReference)?this._clippingArea=b:this._clippingArea=null};c.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.updatePointOfInterest(this._poi),this._index&&(this._index.progressiveLoadPenalty=n.distancePenalty*this._viewportQueries.distCameraToPOI(),
this._index.requestReload())))};c.prototype._calculatePointOfInterest=function(a){void 0===a&&(a=g.vec3d.create());var b=this._centerOnSurface.renderLocation,c=g.vec3d.create();g.vec3d.subtract(b,this.camPos,c);g.vec3d.normalize(c);var f=this.layerView.view.renderCoordsHelper,d=g.vec3d.create();f.worldUpAtPosition(b,d);c=Math.acos(g.vec3d.dot(d,c))-.5*Math.PI;g.vec3d.lerp(this.camPos,b,Math.max(0,Math.min(1,c/(.5*Math.PI))),a);return a};c.prototype.updateClippingArea=function(a){this.setClippingArea(a);
this._cameraDirty=!0;this._viewportQueries&&this._viewportQueries.updateExtent(this._clippingArea)};c.prototype._setCameraDirty=function(){this._cameraDirty=!0;this.updatingChanged()};c.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path};c.prototype.updateElevationChanged=function(a,b,c){m.findIntersectingNodes(a,b,this.nodeIndex.root,this.crsIndex,this.nodeIndex,function(a){c.push(a)});for(a=0;a<c.length;a++)b=c.data[a],this._viewportQueries.invalidateCache(b.id),b.id===this._rootNodeId&&
this.notifyChange("rootNodeVisible");c.length&&this.restartNodeLoading()};c.prototype._elevationInfoChanged=function(a){this._viewportQueries.invalidateCache();this._initViewData()};c.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0;this.updatingChanged()};c.prototype.schedule=function(a){return this._idleQueue.push(a)};c.prototype.getUnloadedMemoryEstimate=function(){return this._index?this._index.getUnloadedMemoryEstimate()*this._getLodDropFactor():0};c.prototype._needsAnimationFrameHandler=
function(){return!0};c.prototype._frame=function(a){null!==this._viewportQueries&&this._viewportQueries.setCameraIdle(!this._cameraDirty);this.layerView.visible&&this._processLogError(a,!1)};c.prototype._processLogError=function(a,b){void 0===b&&(b=!0);try{this._process(a,b)}catch(k){50>this._errorCount?h.error("Error during processing: "+k):50===this._errorCount&&h.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}};c.prototype._process=function(a,
b){this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading());if(null!=this._nodeLoader&&null!=this._index){this._updateViewData();this._processIndex()&&(b=!1);for(b=this._processNodes(a,b);0<this._idleQueue.length()&&(b||!a.done());)b=!1,this._idleQueue.process();b=this._index;(!b.isLoading()||b.getNumFeatures()>2*this._featureTarget)&&this._updateTargetLOD();a.done()||this._prefetchIndex();this.updatingChanged();this._lodHandling.lodGlobalHandling()}};c.prototype._processIndex=
function(){var a=Math.min(10-this._index.getNumLoading(),this._getAvailableLoadTokens(1)),b=Math.min(5-this._loadingNodes.size,this._getAvailableLoadTokens(2));this._index.update(a,b,x.keysOfMap(this._loadingNodes));return this._index.load()};c.prototype._prefetchIndex=function(){if(!(0<this._loadingNodes.size)){var a=Math.min(10-this._index.getNumLoading(),this._getAvailableLoadTokens(1));this._index.prefetch(a)}};c.prototype._updateTargetLOD=function(){var a=this._index.getFeatureEstimate();if(a.estimate){var b=
this._featureTarget*this._getLodFactor()*this._getLodMemoryFactor()/this._lodTargetFactor;if(b/a.estimate>this._featureMargin&&1E4>this._lodTargetFactor){if(a.leafsReached)return;var c=this._lodTargetFactor;this._lodTargetFactor*=1+.1*(b/a.estimate-1);this._viewportQueries.updateScreenSpaceErrorBias(this._getLodFactor()*this._getLodMemoryFactor());this._index.requestReload();this._index.update(0,0,x.keysOfMap(this._loadingNodes));a=this._index.getFeatureEstimate();a.estimate&&a.estimate/b>this._featureMargin&&
(this._lodTargetFactor=c)}else if(a.estimate/b>this._featureMargin&&1E-4<this._lodTargetFactor)this._lodTargetFactor/=1+.1*(a.estimate/b-1);else return;this._viewportQueries.updateScreenSpaceErrorBias(this._getLodFactor()*this._getLodMemoryFactor());this._index.requestReload()}};c.prototype._processNodes=function(a,b){var c=this,f=Math.min(5-this._loadingNodes.size,this._getAvailableLoadTokens(2)),f=this._index.getUpdates(f);f.cancel.forEach(this._cancelNodeIdLoading,this);f.update.forEach(function(k){if(b||
!a.done())b=!1,c._updateLoadedNode(k.id)});f.add.forEach(function(k,f){if(b||!a.done())b=!1,c._loadNode(c.nodeIndex[f])});return b};c.prototype._cancelNodeLoading=function(){var a=this;this._loadingNodes.forEach(function(b,c){return a._cancelNodeIdLoading(c)});this._loadingNodes.clear();this._updatingNodes.forEach(function(b,c){return a._updatingNodes.get(c).cancel()});this._updatingNodes.clear()};c.prototype._cancelNodeIdLoading=function(a){this._loadingNodes.get(a).cancel();this._loadingNodes.delete(a)};
c.prototype._getAvailableLoadTokens=function(a){return Math.floor((12-1*this._index.getNumLoading()-2*this._loadingNodes.size)/a)};c.prototype.updatingChanged=function(){var a=this._index?this._index.getNumPending():0,b=this._index?this._index.getNumUnloadedNodes():0,a=a+3*b+2*this._loadingNodes.size,b=!(!(0<a||0<this._updatingNodes.size||this._index&&this._index.isPrefetching()||this._restartNodeLoading||this._cameraDirty||0<this._idleQueue.length()||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&
this._isIdle);0===a&&(this._progressMaxNumNodes=1);this._progressMaxNumNodes=Math.max(a,this._progressMaxNumNodes);b!==this._get("updating")&&this._set("updating",b);a=100*a/this._progressMaxNumNodes;a!==this._get("updatingPercentage")&&this._set("updatingPercentage",a)};c.prototype._initViewData=function(){var a=this.layerView.view,b=a.state.camera,c=a.renderCoordsHelper;this.camPos=g.vec3d.create(a.pointsOfInterest.renderPointOfView);this.screenSizeFactor=1/b.perPixelRatio;this._poi=this._calculatePointOfInterest();
var f=(this._lodFactorProperty&&this.layerView.view.get(this._lodFactorProperty)||1)*this._getLodMemoryFactor();this._viewportQueries=new O(this.crsIndex,c,b,this._poi,this._clippingArea,a.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(this.layer,f),screenspaceErrorBias:f,angleDependentLoD:.5>f,disableLod:this._alwaysLoadEverythingModeEnabled});this._cameraDirty=!1;this.notifyChange("rootNodeVisible")};c.prototype._updateViewData=function(){if(this._cameraDirty&&
this._index){var a=this.layerView.view,b=a.state.camera;this.camPos=g.vec3d.create(a.pointsOfInterest.renderPointOfView);this.screenSizeFactor=1/b.perPixelRatio;this._poi=this._calculatePointOfInterest(this._poi);this._viewportQueries.updateCamera(b);this._viewportQueries.updatePointOfInterest(this._poi);a=this._getLodFactor()*this._getLodMemoryFactor();this._viewportQueries.updateScreenSpaceErrorBias(a);this._index.progressiveLoadPenalty=n.distancePenalty*this._viewportQueries.distCameraToPOI();
this._index.requestReload();this._alwaysLoadEverythingModeEnabled||this._removeInvisibleNodes();this._cameraDirty=!1;this.notifyChange("rootNodeVisible")}};c.prototype._getProgressiveLoadFactor=function(a,b){return a instanceof p&&"mesh"===a.geometryType?(a=1<=b&&t("enable-feature:progressive-3dobject"))?n.factor3dObject:1:a instanceof z?(a=1<=b&&!t("disable-feature:progressive-im"))?n.factorIM:1:1};c.prototype._getLodFactor=function(){return this._lodFactorProperty&&this.layerView.view.get(this._lodFactorProperty)||
1};c.prototype._getLodMemoryFactor=function(){return this.layerView.view.resourceController.memoryFactor*this._lodTargetFactor};c.prototype._getLodDropFactor=function(){return Math.min(this._getLodMemoryFactor(),.5)/.5};c.prototype.getFeatureDetail=function(){return this._lodTargetFactor};c.prototype.getNumUnloadedNodes=function(){return this._index?this._index.getNumUnloadedNodes():0};c.prototype._startNodeLoadingWhileSuspended=function(){this._initViewData();this._alwaysLoadEverythingModeEnabled&&
this.layerView.visible&&!this.layerView.get("parent.suspended")||this._removeInvisibleNodes()};c.prototype.isGeometryVisible=function(a){return this._viewportQueries.isGeometryVisible(a)};c.prototype._shouldLoadNode=function(a){if(!this._lodHandling.shouldLoadNode(a))return!1;var b=this._getLodDropFactor();return 0<b&&0<this._viewportQueries.maxDistance&&this._lodHandling.childrenEmpty(a)&&this._viewportQueries.distToPOI(a)>this._viewportQueries.maxDistance*b?!1:a.obb?this._viewportQueries.isGeometryVisible(a):
!0};c.prototype._startNodeLoading=function(){var a=this;this._restartNodeLoading=!1;if(!this._updatesDisabled&&null!=this.streamDataSupplier){this._initViewData();null!=this.layerViewOptionalFunctions.getLoadedAttributes&&this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1,this._handles.add([this.layer.watch("renderer",function(){return a._requiredFieldsChange()}),this.layer.watch("definitionExpression",function(){return a._requiredFieldsChange()}),
this.layer.watch("labelsVisible",function(){return a._labelingChanged()}),this.layer.watch("labelingInfo",function(){return a._labelingChanged()})],"requiredAttributes"));var b=this.layerViewOptionalFunctions.textureOptions,c=q.TextureFormat.Normal;b&&b.useCompressedTextures?c=q.TextureFormat.Compressed:this._uncompressedTextureDownsamplingEnabled&&(c=q.TextureFormat.Downsampled);b=this._defaultGeometrySchema;this._nodeLoader=new q(this.streamDataSupplier,h,b,this._requiredAttributes,{textureFormat:c,
loadTextureData:this.layerView instanceof A&&this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==b||null==b.ordering});c=n.distancePenalty*this._viewportQueries.distCameraToPOI();this._index=new M(this.getBaseUrl(),this._rootNodeUrl,this._rootNodeId,c,this.nodeIndex,this.streamDataSupplier,this._viewportQueries,h,function(b){return a.layerViewRequiredFunctions.isNodeLoaded(b)},function(b){return a._shouldLoadNode(b)},function(b){return a._needsUpdate(b)});this._alwaysLoadEverythingModeEnabled||
this._removeInvisibleNodes();this._lodHandling.startNodeLoading(function(b){return a._viewportQueries.isNodeVisible(b)},function(b){return a._viewportQueries.isGeometryVisible(b)},function(b){return a._index.nodeTraversalState(b)},this.nodeIndex,this._rootNodeId,{maxLodLevel:this._viewportQueries.maxLodLevel});this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler();this.updatingChanged()}};c.prototype.isNodeLoading=function(){return null!=
this._nodeLoader&&null!=this._index};c.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._index.cancel(),this._nodeLoader.cancel(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._cancelNodeLoading(),this._poi=this._index=this._nodeLoader=null,this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler(),this.updatingChanged())};c.prototype._removeInvisibleNodes=function(){var a=this.layerViewRequiredFunctions.getLoadedNodeIDs(),
b=this._getLodDropFactor(),c=this._viewportQueries.maxDistance*b,b=0<b&&0<c;r.clear();for(var d=0;d<a.length;d++){var e=this.nodeIndex[a[d]];if(!this._viewportQueries.isGeometryVisible(e)||b&&this._lodHandling.childrenEmpty(e)&&this._viewportQueries.distToPOI(e)>c)this._lodHandling.setLodGlobalDirty(),r.push(e)}this.layerViewRequiredFunctions.removeNodeData(r);r.clear()};c.prototype._needsUpdate=function(a){if(null==a.featureData||0===a.featureData.length||this._updatingNodes.has(a.id))return!1;var b=
this.layerViewOptionalFunctions.getLoadedAttributes;a=null!=b?b(a):void 0;return null!=a&&a!==this._requiredAttributes};c.prototype._updateLoadedNode=function(a){var b=this,c=this.nodeIndex[a],d=c.baseUrl,e=this.layerViewOptionalFunctions.getLoadedAttributes(c),d=B(e,this._requiredAttributes)?y.resolve(this.layerViewOptionalFunctions.getAttributeData(c)):this._nodeLoader.loadAttributes(c,d,this._requiredAttributes);this._updatingNodes.set(a,d);d.then(function(a){return b.schedule().then(function(){return b.layerViewOptionalFunctions.setAttributeData(c,
b._requiredAttributes,a)})}).catch(function(a){a instanceof u||b.layerViewOptionalFunctions.setAttributeData(c,b._requiredAttributes,{})}).always(function(){b._updatingNodes.delete(a);b.updatingChanged()});this.updatingChanged()};c.prototype._loadNode=function(a){var b=this,c=new R.Promise;this._loadingNodes.set(a.id,c);this.updatingChanged();this._loadAndAddBundle(a).always(function(){b._loadingNodes.delete(a.id);b._hasFeatures=b._hasFeatures||!!a.numFeatures;b.updatingChanged();c.done()});return c};
c.prototype._loadAndAddBundle=function(a){var b=this;1!==a.featureData.length&&h.warn("Node ${node.id} has ${node.featureData.length} bundles. Only the first bundle will be loaded.");return this._loadCached(a).then(function(c){if(!c)return b._loadUncached(a)}).catch(function(c){if(!(c instanceof u))return b._loadUncached(a)})};c.prototype._loadCached=function(a){var b=this,c=this.disableCache?null:this.layerViewOptionalFunctions.loadCachedNodeData,d=this.disableCache?null:this.layerViewOptionalFunctions.addCachedNodeData;
return c&&d?this.schedule().then(function(){return c(a,function(a,c){return b._nodeLoader.loadTextures(a,c)})}).then(function(c){if(null==c)return!1;var e=b._requiredAttributes;return b.schedule().then(function(){return b._nodeLoader.loadAttributes(a,a.baseUrl,e)}).then(function(a){return b.schedule({loadedAttributes:e,attributeData:a})}).then(function(b){return d(a,c,b)}).then(function(){b._lodHandling.lodSwapBundleLoaded(a);return!0})}):y.resolve(!1)};c.prototype._loadUncached=function(a){var b=
this;return this.schedule().then(function(){return b._nodeLoader.loadBundleData(a,0)}).then(function(a){return b.schedule(a)}).then(function(c){return b.layerViewRequiredFunctions.addNodeData(a,c)}).then(function(){return b._lodHandling.lodSwapBundleLoaded(a)}).catch(function(b){b instanceof u||(h.error("Failed to load node '"+a.id+"' bundle 0: "+b),a.failed=!0)})};c.prototype._updateIdleState=function(a){a!==this._isIdle&&(this._isIdle=a,this._viewportQueries&&this._viewportQueries.setCameraIdle(!0),
this.updatingChanged())};e([d.property({readOnly:!0})],c.prototype,"isMeshPyramid",null);e([d.property({readOnly:!0})],c.prototype,"streamDataSupplier",null);e([d.property({readOnly:!0,dependsOn:["layer.definitionExpression"]})],c.prototype,"parsedDefinitionExpression",null);e([d.property({readOnly:!0,dependsOn:["parsedDefinitionExpression"]})],c.prototype,"definitionExpressionFields",null);e([d.property({readOnly:!0})],c.prototype,"crsVertex",null);e([d.property({readOnly:!0})],c.prototype,"crsIndex",
null);e([d.property({readOnly:!0})],c.prototype,"nodeIndex",void 0);e([d.property()],c.prototype,"camPos",void 0);e([d.property()],c.prototype,"screenSizeFactor",void 0);e([d.property()],c.prototype,"layerView",void 0);e([d.property()],c.prototype,"layerViewRequiredFunctions",void 0);e([d.property()],c.prototype,"layerViewOptionalFunctions",void 0);e([d.property()],c.prototype,"layer",void 0);e([d.property({readOnly:!0})],c.prototype,"updating",void 0);e([d.property({readOnly:!0})],c.prototype,"updatingPercentage",
void 0);e([d.property({readOnly:!0})],c.prototype,"rootNodeVisible",null);return c=e([d.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],c)}(d.declared(E,J,F));var r=new I,n={factorIM:.2,factor3dObject:.05,distancePenalty:10};return l});