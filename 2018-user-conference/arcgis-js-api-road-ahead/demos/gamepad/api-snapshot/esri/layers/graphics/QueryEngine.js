// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define("require exports ../../core/tsSupport/extendsHelper ../../core/tsSupport/decorateHelper ../../core/Accessor ../../core/Error ../../core/promiseUtils ../../core/accessorSupport/decorators ../../geometry/Extent ../../geometry/support/aaBoundingRect ./dehydratedFeatures".split(" "),function(f,t,n,h,p,q,l,g,r,e,m){f=function(f){function b(a){a=f.call(this)||this;a.features=null;a.layer=null;a.objectIdField=null;return a}n(b,f);b.prototype.queryFeatures=function(a){var c=this;if(this.features)if(a)if(this._isSupportedQuery(a)){var b=
this._createFilters(a);a=b.length?this._executeQuery(a,b):this._rejectQuery("Invalid query")}else a=this._rejectQuery("Unsupported query");else a=this._returnAllFeatures();else a=this._rejectQuery("Engine not initialized");return a.then(function(a){return a.map(function(a){return m.hydrateGraphic(a,c.layer)})})};b.prototype.queryObjectIds=function(a){return this.objectIdField?this.queryFeatures(a).then(this._getObjectIds.bind(this)):this._rejectQuery("Unsupported query")};b.prototype.queryFeatureCount=
function(a){return this.queryFeatures(a).then(function(a){return a.length})};b.prototype.queryExtent=function(a){var c=this;return this.queryFeatures(a).then(function(a){return{count:a.length,extent:c._getExtent(a)}})};b.prototype._returnAllFeatures=function(){return l.resolve(this.features.toArray())};b.prototype._executeQuery=function(a,c){var b=this,d=[];this.features.forEach(function(e){c.every(function(c){return c.call(b,e,a)})&&d.push(e)});return l.resolve(d)};b.prototype._isSupportedQuery=
function(a){var c=!0;if(null!=a.distance||null!=a.geometryPrecision||a.groupByFieldsForStatistics&&a.groupByFieldsForStatistics.length||null!=a.maxAllowableOffset||a.multipatchOption||null!=a.num||a.orderByFields&&a.orderByFields.length||a.outFields&&a.outFields.length||a.outSpatialReference||a.outStatistics&&a.outStatistics.length||a.pixelSize||a.quantizationParameters||a.relationParameter||a.returnDistinctValues||null!=a.start||a.text||a.timeExtent||a.where||a.objectIds&&a.objectIds.length&&!this.objectIdField)c=
!1;return c};b.prototype._createFilters=function(a){var c=[];a.objectIds&&a.objectIds.length&&c.push(this._createObjectIdFilter());a.geometry&&"extent"===a.geometry.type&&"intersects"===a.spatialRelationship&&c.push(this._createExtentFilter());return c};b.prototype._createExtentFilter=function(){return function(a,c){a=a.geometry;if(!a)return!1;e.fromExtent(c.geometry,d);m.computeAABR(a,k);return e.intersects(d,k)}};b.prototype._createObjectIdFilter=function(){var a=this;return function(c,b){c=c.attributes;
return-1<b.objectIds.indexOf(c&&c[a.objectIdField])}};b.prototype._rejectQuery=function(a){return l.reject(new q(this.declaredClass,a))};b.prototype._getObjectIds=function(a){var c=this.objectIdField,b=[];a.forEach(function(a){a=(a=a.attributes)&&a[c];null!=a&&b.push(a)});return b};b.prototype._getExtent=function(a){if(0===a.length)return null;e.empty(d);for(var b=0;b<a.length;b++)m.computeAABR(a[b].geometry,k),e.expand(d,k,d);return new r({xmin:d[0],ymin:d[1],xmax:d[2],ymax:d[3],spatialreference:a[0].geometry.spatialReference})};
h([g.property()],b.prototype,"features",void 0);h([g.property({constructOnly:!0})],b.prototype,"layer",void 0);h([g.property()],b.prototype,"objectIdField",void 0);return b=h([g.subclass("esri.layers.graphics.QueryEngine")],b)}(g.declared(p));var d=e.create(),k=e.create();return f});