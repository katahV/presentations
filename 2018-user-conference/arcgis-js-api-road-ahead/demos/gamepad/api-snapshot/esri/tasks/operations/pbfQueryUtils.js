// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.8/esri/copyright.txt for details.
//>>built
define(["require","exports","../../core/Error","../../core/Logger","../../core/pbf"],function(ba,F,J,N,O){function K(a){if(a>=G.length){var b=new J("query:parsing-pbf","Error while parsing FeatureSet PBF payload. Unknown GeometryType");I.error(b)}return G[a]}function P(a){var b,c=b||(b={});c[c.STRING=1]="STRING";c[c.FLOAT=2]="FLOAT";c[c.DOUBLE=3]="DOUBLE";c[c.INT=4]="INT";c[c.UINT=5]="UINT";c[c.SINT=6]="SINT";for(c[c.BOOL=7]="BOOL";a.next();)switch(a.tag()){case b.STRING:return a.getString();case b.FLOAT:return a.getFloat();
case b.DOUBLE:return a.getDouble();case b.INT:return a.getInt64();case b.UINT:return a.getUInt64();case b.SINT:return a.getSInt64();case b.BOOL:return a.getBool();default:return a.skip(),null}return null}function Q(a){var b,c=b||(b={});c[c.NAME=1]="NAME";c[c.TYPE=2]="TYPE";c[c.ALIAS=3]="ALIAS";c[c.SQL_TYPE=4]="SQL_TYPE";c[c.DOMAIN=5]="DOMAIN";c[c.DEFAULT_VALUE=6]="DEFAULT_VALUE";for(c={domain:null,defaultValue:null,sqlType:H[0],type:L[0]};a.next();)switch(a.tag()){case b.NAME:c.name=a.getString();
break;case b.TYPE:c.type=L[a.getEnum()];break;case b.ALIAS:c.alias=a.getString();break;case b.SQL_TYPE:c.sqlType=H[a.getEnum()];break;case b.DOMAIN:c.domain=a.getString();break;case b.DEFAULT_VALUE:c.defaultValue=a.getString();break;default:a.skip()}return c}function R(a,b){var c,h=c||(c={});h[h.ATTRIBUTES=1]="ATTRIBUTES";h[h.GEOMETRY=2]="GEOMETRY";h[h.CENTROID=4]="CENTROID";for(var h={attributes:{}},l=0;a.next();)switch(a.tag()){case c.ATTRIBUTES:var f=a.getMessage(),m=b[l++].name;h.attributes[m]=
P(f);break;case c.GEOMETRY:var f=a.getMessage(),d=(m=void 0,m={});d[d.TYPE=1]="TYPE";d[d.LENGTHS=2]="LENGTHS";d[d.COORDS=3]="COORDS";for(var d=[],g=void 0;f.next();)switch(f.tag()){case m.LENGTHS:for(var e=f.getUInt32(),e=f._pos+e;f._pos<e;)d.push(f.getUInt32());break;case m.COORDS:for(var g=f.getUInt32(),e=f._pos+g,g=Array(g),k=0;f._pos<e;)g[k++]=f.getSInt32();break;default:f.skip()}h.geometry={lengths:d,coords:g};break;case c.CENTROID:f=a.getMessage();d=(m=void 0,m={});d[d.TYPE=1]="TYPE";d[d.LENGTHS=
2]="LENGTHS";d[d.COORDS=3]="COORDS";for(g=void 0;f.next();)switch(f.tag()){case m.COORDS:g=f.getUInt32();d=f._pos+g;g=Array(g);for(e=0;f._pos<d;)g[e++]=f.getSInt32();break;default:f.skip()}h.centroid={coords:g};break;default:a.skip()}return h}function z(a,b){return{x:a[b+0],y:a[b+1]}}function S(a,b){return{x:a[b+0],y:a[b+1],z:a[b+2]}}function T(a,b){return{x:a[b+0],y:a[b+1],m:a[b+2]}}function U(a,b){return{x:a[b+0],y:a[b+1],z:a[b+2],m:a[b+3]}}function V(a,b){for(var c=[],h=0;h<a.length;h++){var l=
a[h],f=l.geometry,l=l.attributes,f=f?b(f.coords,0):void 0;c.push({attributes:l,geometry:f})}return c}function W(a,b,c,h){for(var l=[],f=0;f<a.length;f++){var m=a[f],d=m.geometry,g=m.attributes,m=m.centroid,e=void 0,m=m?z(m.coords,0):void 0;if(d){for(var e=[],k=0;k<d.coords.length;k+=h){for(var r=[],n=0;n<h;n++)r.push(d.coords[k+n]);e.push(r)}e={points:e,hasM:c,hasZ:b}}l.push({attributes:g,centroid:m,geometry:e})}return l}function X(a,b){for(var c=[],h=0;h<a.length;h++){var l=a[h],f=l.geometry,m=l.attributes,
d=l.centroid,l=void 0,d=d?z(d.coords,0):void 0;if(f)for(var g=[],e=0,l={paths:g},k=0,r=f.lengths;k<r.length;k++){for(var n=r[k],t=[],p=0;p<n;p++){for(var v=[],q=0;q<b;q++)v.push(f.coords[e++]);t.push(v)}g.push(t)}c.push({attributes:m,centroid:d,geometry:l})}return c}function Y(a,b){for(var c=[],h=0;h<a.length;h++){var l=a[h],f=l.geometry,m=l.attributes,d=l.centroid,l=void 0,d=d?z(d.coords,0):void 0;if(f)for(var g=[],e=0,l={rings:g},k=0,r=f.lengths;k<r.length;k++){for(var n=r[k],t=[],p=0;p<n;p++){for(var v=
[],q=0;q<b;q++)v.push(f.coords[e++]);t.push(v)}g.push(t)}c.push({attributes:m,centroid:d,geometry:l})}return c}function C(a){var b=a.hasM;return(a=a.hasZ)&&b?4:a||b?3:2}function Z(a){var b=[];switch(a.geometryType){case "esriGeometryPoint":b=z;a.hasZ&&a.hasM?b=U:a.hasZ?b=S:a.hasM&&(b=T);b=V(a.features,b);break;case "esriGeometryMultipoint":b=C(a);b=W(a.features,a.hasZ,a.hasM,b);break;case "esriGeometryPolyline":b=C(a);b=X(a.features,b);break;case "esriGeometryPolygon":b=C(a);b=Y(a.features,b);break;
default:I.error("Unable to parse unknown geometry type ")}return{exceededTransferLimit:a.exceededTransferLimit,features:b,fields:a.fields.map(function(a){return{name:a.name,type:a.type,alias:a.alias,sqlType:a.sqlType,domain:null,defaultValue:a.defaultValue}}),hasM:a.hasM,hasZ:a.hasZ,geometryType:a.geometryType,objectIdFieldName:a.objectIdFieldName,spatialReference:a.spatialReference,transform:a.transform}}Object.defineProperty(F,"__esModule",{value:!0});var I=N.getLogger("esri.tasks.operations.pbfQueryUtils"),
L="esriFieldTypeSmallInteger esriFieldTypeInteger esriFieldTypeSingle esriFieldTypeDouble esriFieldTypeString esriFieldTypeDate esriFieldTypeOID esriFieldTypeGeometry esriFieldTypeBlob esriFieldTypeRaster esriFieldTypeGUID esriFieldTypeGlobalID esriFieldTypeXML".split(" "),H="sqlTypeBigInt sqlTypeBinary sqlTypeBit sqlTypeChar sqlTypeDate sqlTypeDecimal sqlTypeDouble sqlTypeFloat sqlTypeGeometry sqlTypeGUID sqlTypeInteger sqlTypeLongNVarchar sqlTypeLongVarbinary sqlTypeLongVarchar sqlTypeNChar sqlTypeNVarchar sqlTypeOther sqlTypeReal sqlTypeSmallInt sqlTypeSqlXml sqlTypeTime sqlTypeTimestamp sqlTypeTimestamp2 sqlTypeTinyInt sqlTypeVarbinary sqlTypeVarchar".split(" "),
G=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],M=["upperLeft","lowerLeft"];F.parsePBFFeatureQuery=function(a){try{var b,c=b||(b={});c[c.QUERY_RESULT=2]="QUERY_RESULT";for(var h=new O(new Uint8Array(a),new DataView(a)),l;h.next();)switch(h.tag()){case b.QUERY_RESULT:var f=h.getMessage(),m=(a=void 0,a={});m[m.FEATURE_RESULT=1]="FEATURE_RESULT";for(c={};f.next();)switch(f.tag()){case a.FEATURE_RESULT:var d=f.getMessage(),g=void 0,e=g||(g={});e[e.OBJECT_ID_NAME=
1]="OBJECT_ID_NAME";e[e.UNIQUE_ID_NAME=2]="UNIQUE_ID_NAME";e[e.GLOBAL_ID_NAME=3]="GLOBAL_ID_NAME";e[e.GEOHASH_NAME=4]="GEOHASH_NAME";e[e.GEOMETRY_PROPERTIES=5]="GEOMETRY_PROPERTIES";e[e.SERVER_GENS=6]="SERVER_GENS";e[e.GEOMETRY_TYPE=7]="GEOMETRY_TYPE";e[e.SPATIAL_REFERENCE=8]="SPATIAL_REFERENCE";e[e.EXCEEDED_TRANSFER_LIMIT=9]="EXCEEDED_TRANSFER_LIMIT";e[e.HAS_Z=10]="HAS_Z";e[e.HAS_M=11]="HAS_M";e[e.TRANSFORM=12]="TRANSFORM";e[e.FIELDS=13]="FIELDS";e[e.FEATURES=15]="FEATURES";var k={fields:[],features:[]};
for(k.geometryType=K(0);d.next();)switch(d.tag()){case g.OBJECT_ID_NAME:k.objectIdFieldName=d.getString();break;case g.GLOBAL_ID_NAME:k.globalIdFieldName=d.getString();break;case g.GEOHASH_NAME:k.geohashFieldName=d.getString();break;case g.GEOMETRY_PROPERTIES:var r=d.getMessage(),n=void 0,t=n||(n={});t[t.AREA_FIELD_NAME=1]="AREA_FIELD_NAME";t[t.LENGTH_FIELD_NAME=2]="LENGTH_FIELD_NAME";t[t.UNITS=3]="UNITS";for(var p={};r.next();)switch(r.tag()){case n.AREA_FIELD_NAME:p.shapeAreaFieldName=r.getString();
break;case n.LENGTH_FIELD_NAME:p.shapeLengthFieldName=r.getString();break;case n.UNITS:p.units=r.getString();break;default:r.skip()}k.geometryProperties=p;break;case g.GEOMETRY_TYPE:k.geometryType=K(d.getEnum());break;case g.SPATIAL_REFERENCE:var v=d.getMessage(),q=(n=void 0,n={});q[q.WKID=1]="WKID";q[q.LASTEST_WKID=2]="LASTEST_WKID";q[q.VCS_WKID=3]="VCS_WKID";q[q.LATEST_VCS_WKID=4]="LATEST_VCS_WKID";q[q.WKT=5]="WKT";for(p={};v.next();)switch(v.tag()){case n.WKID:p.wkid=v.getUInt32();break;case n.WKT:p.wkt=
v.getString();break;default:v.skip()}k.spatialReference=p;break;case g.HAS_Z:k.hasZ=d.getBool();break;case g.HAS_M:k.hasM=d.getBool();break;case g.TRANSFORM:var D=d.getMessage(),E=(n=void 0,n={});E[E.ORIGIN_POSTION=1]="ORIGIN_POSTION";E[E.SCALE=2]="SCALE";E[E.TRANSLATE=3]="TRANSLATE";for(var z=M[0],C=p=void 0;D.next();)switch(D.tag()){case n.ORIGIN_POSTION:z=M[D.getEnum()];break;case n.SCALE:var A=D.getMessage(),u=void 0,x=u||(u={});x[x.X=1]="X";x[x.Y=2]="Y";x[x.M=3]="M";x[x.Z=4]="Z";for(var w=[0,
0];A.next();)switch(A.tag()){case u.X:w[0]=A.getDouble();break;case u.Y:w[1]=A.getDouble();break;case u.M:w.push(A.getDouble());break;case u.Z:w.push(A.getDouble());break;default:A.skip()}p=w;break;case n.TRANSLATE:var B=D.getMessage(),y=(u=void 0,u={});y[y.X=1]="X";y[y.Y=2]="Y";y[y.M=3]="M";y[y.Z=4]="Z";for(w=[0,0];B.next();)switch(B.tag()){case u.X:w[0]=B.getDouble();break;case u.Y:w[1]=B.getDouble();break;case u.M:w.push(B.getDouble());break;case u.Z:w.push(B.getDouble());break;default:B.skip()}C=
w;break;default:D.skip()}k.transform={originPosition:z,scale:p,translate:C};break;case g.EXCEEDED_TRANSFER_LIMIT:var F=d.getBool();k.exceededTransferLimit=F;break;case g.FIELDS:var G=d.getMessage();k.fields.push(Q(G));break;case g.FEATURES:var H=d.getMessage();k.features.push(R(H,k.fields));break;default:d.skip()}c.featureResult=k;break;default:f.skip()}l=c;break;default:h.skip()}return Z(l.featureResult)}catch(aa){return b=new J("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:aa}),
I.error(b),{features:[]}}}});